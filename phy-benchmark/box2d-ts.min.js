var __extends=this&&this.__extends||function(){var o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])};return function(t,e){function i(){this.constructor=t}o(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)}}();System.register("Common/b2Settings",[],function(t,e){var i,o,n;e&&e.id;return t("b2Assert",function(t){for(var e=[],i=1;i<arguments.length;i++)e[i-1]=arguments[i]}),t("b2Alloc",function(t){return null}),t("b2Free",function(t){}),t("b2Log",function(t){for(var e=[],i=1;i<arguments.length;i++)e[i-1]=arguments[i]}),t("b2ParseInt",function(t){return parseInt(t,10)}),t("b2ParseUInt",function(t){return Math.abs(parseInt(t,10))}),t("b2MakeArray",function(t,e){for(var i=[],o=0;o<t;++o)i.push(e(o));return i}),t("b2MakeNullArray",function(t){for(var e=[],i=0;i<t;++i)e.push(null);return e}),t("b2MakeNumberArray",function(t,e){void 0===e&&(e=0);for(var i=[],o=0;o<t;++o)i.push(e);return i}),{setters:[],execute:function(){t("b2_maxFloat",1e37),t("b2_epsilon",1e-5),t("b2_epsilon_sq",1e-5*1e-5),t("b2_pi",i=3.14159265359),t("b2_maxManifoldPoints",2),t("b2_maxPolygonVertices",8),t("b2_aabbExtension",.1),t("b2_aabbMultiplier",2),t("b2_linearSlop",.008),t("b2_angularSlop",2/180*i),t("b2_polygonRadius",.016),t("b2_maxSubSteps",8),t("b2_maxTOIContacts",32),t("b2_velocityThreshold",1),t("b2_maxLinearCorrection",.2),t("b2_maxAngularCorrection",8/180*i),t("b2_maxTranslation",2),t("b2_maxTranslationSquared",4),t("b2_maxRotation",o=.5*i),t("b2_maxRotationSquared",o*o),t("b2_baumgarte",.2),t("b2_toiBaumgarte",.75),t("b2_invalidParticleIndex",-1),t("b2_maxParticleIndex",2147483647),t("b2_particleStride",.75),t("b2_minParticleWeight",1),t("b2_maxParticlePressure",.25),t("b2_maxParticleForce",.5),t("b2_maxTriadDistance",2),t("b2_maxTriadDistanceSquared",4),t("b2_minParticleSystemBufferCapacity",256),t("b2_barrierCollisionTime",2.5),t("b2_timeToSleep",.5),t("b2_linearSleepTolerance",.01),t("b2_angularSleepTolerance",2/180*i),n=function(){function t(t,e,i){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),this.major=0,this.minor=0,this.revision=0,this.major=t,this.minor=e,this.revision=i}return t.prototype.toString=function(){return this.major+"."+this.minor+"."+this.revision},t}(),t("b2Version",n),t("b2_version",new n(2,3,2)),t("b2_changelist",313)}}}),System.register("Common/b2Math",["Common/b2Settings"],function(t,e){var i,o,n,s,r,m,a,c,_,l,h;e&&e.id;function u(t){return t<0?-t:t}function p(t,e){return t<e?t:e}function f(t,e){return e<t?t:e}function d(t,e,i){return t<e?e:i<t?i:t}function y(t,e,i){return i.x=t.x+e.x,i.y=t.y+e.y,i}function b(t,e,i){return i.x=t.x-e.x,i.y=t.y-e.y,i}function V(t,e){return t.x*e.x+t.y*e.y+t.z*e.z}function v(t,e,i){var o=t.x,n=t.y,s=t.z,r=e.x,a=e.y,m=e.z;return i.x=n*m-s*a,i.y=s*r-o*m,i.z=o*a-n*r,i}function x(t,e,i){var o=t.c,n=t.s,s=e.c,r=e.s;return i.s=n*s+o*r,i.c=o*s-n*r,i}function C(t,e,i){var o=t.c,n=t.s,s=e.c,r=e.s;return i.s=o*r-n*s,i.c=o*s+n*r,i}function S(t,e,i){var o=t.c,n=t.s,s=e.x,r=e.y;return i.x=o*s-n*r,i.y=n*s+o*r,i}function B(t,e,i){var o=t.c,n=t.s,s=e.x,r=e.y;return i.x=o*s+n*r,i.y=-n*s+o*r,i}return t("b2Abs",u),t("b2Min",p),t("b2Max",f),t("b2Clamp",d),t("b2Swap",function(t,e){var i=t[0];t[0]=e[0],e[0]=i}),t("b2IsValid",function(t){return isFinite(t)}),t("b2Sq",function(t){return t*t}),t("b2InvSqrt",function(t){return 1/Math.sqrt(t)}),t("b2Sqrt",function(t){return Math.sqrt(t)}),t("b2Pow",function(t,e){return Math.pow(t,e)}),t("b2DegToRad",function(t){return t*o}),t("b2RadToDeg",function(t){return t*n}),t("b2Cos",function(t){return Math.cos(t)}),t("b2Sin",function(t){return Math.sin(t)}),t("b2Acos",function(t){return Math.acos(t)}),t("b2Asin",function(t){return Math.asin(t)}),t("b2Atan2",function(t,e){return Math.atan2(t,e)}),t("b2NextPowerOfTwo",function(t){return t|=t>>1&2147483647,t|=t>>2&1073741823,t|=t>>4&268435455,t|=t>>8&16777215,1+(t|=t>>16&65535)}),t("b2IsPowerOfTwo",function(t){return 0<t&&0==(t&t-1)}),t("b2Random",function(){return 2*Math.random()-1}),t("b2RandomRange",function(t,e){return(e-t)*Math.random()+t}),{setters:[function(t){i=t}],execute:function(){t("b2_pi_over_180",o=i.b2_pi/180),t("b2_180_over_pi",n=180/i.b2_pi),t("b2_two_pi",s=2*i.b2_pi),r=function(){function e(t,e){void 0===t&&(t=0),void 0===e&&(e=0),this.x=t,this.y=e}return e.prototype.Clone=function(){return new e(this.x,this.y)},e.prototype.SetZero=function(){return this.x=0,this.y=0,this},e.prototype.Set=function(t,e){return this.x=t,this.y=e,this},e.prototype.Copy=function(t){return this.x=t.x,this.y=t.y,this},e.prototype.SelfAdd=function(t){return this.x+=t.x,this.y+=t.y,this},e.prototype.SelfAddXY=function(t,e){return this.x+=t,this.y+=e,this},e.prototype.SelfSub=function(t){return this.x-=t.x,this.y-=t.y,this},e.prototype.SelfSubXY=function(t,e){return this.x-=t,this.y-=e,this},e.prototype.SelfMul=function(t){return this.x*=t,this.y*=t,this},e.prototype.SelfMulAdd=function(t,e){return this.x+=t*e.x,this.y+=t*e.y,this},e.prototype.SelfMulSub=function(t,e){return this.x-=t*e.x,this.y-=t*e.y,this},e.prototype.Dot=function(t){return this.x*t.x+this.y*t.y},e.prototype.Cross=function(t){return this.x*t.y-this.y*t.x},e.prototype.Length=function(){var t=this.x,e=this.y;return Math.sqrt(t*t+e*e)},e.prototype.LengthSquared=function(){var t=this.x,e=this.y;return t*t+e*e},e.prototype.Normalize=function(){var t=this.Length();if(t>=i.b2_epsilon){var e=1/t;this.x*=e,this.y*=e}return t},e.prototype.SelfNormalize=function(){var t=this.Length();if(t>=i.b2_epsilon){var e=1/t;this.x*=e,this.y*=e}return this},e.prototype.SelfRotate=function(t){var e=Math.cos(t),i=Math.sin(t),o=this.x;return this.x=e*o-i*this.y,this.y=i*o+e*this.y,this},e.prototype.IsValid=function(){return isFinite(this.x)&&isFinite(this.y)},e.prototype.SelfCrossVS=function(t){var e=this.x;return this.x=t*this.y,this.y=-t*e,this},e.prototype.SelfCrossSV=function(t){var e=this.x;return this.x=-t*this.y,this.y=t*e,this},e.prototype.SelfMinV=function(t){return this.x=p(this.x,t.x),this.y=p(this.y,t.y),this},e.prototype.SelfMaxV=function(t){return this.x=f(this.x,t.x),this.y=f(this.y,t.y),this},e.prototype.SelfAbs=function(){return this.x=u(this.x),this.y=u(this.y),this},e.prototype.SelfNeg=function(){return this.x=-this.x,this.y=-this.y,this},e.prototype.SelfSkew=function(){var t=this.x;return this.x=-this.y,this.y=t,this},e.MakeArray=function(t){return i.b2MakeArray(t,function(t){return new e})},e.AbsV=function(t,e){return i=t,(o=e).x=u(i.x),o.y=u(i.y),o;var i,o},e.MinV=function(t,e,i){return o=t,n=e,(s=i).x=p(o.x,n.x),s.y=p(o.y,n.y),s;var o,n,s},e.MaxV=function(t,e,i){return o=t,n=e,(s=i).x=f(o.x,n.x),s.y=f(o.y,n.y),s;var o,n,s},e.ClampV=function(t,e,i,o){return n=t,s=e,r=i,(a=o).x=d(n.x,s.x,r.x),a.y=d(n.y,s.y,r.y),a;var n,s,r,a},e.RotateV=function(t,e,i){return n=e,s=i,r=(o=t).x,a=o.y,m=Math.cos(n),c=Math.sin(n),s.x=m*r-c*a,s.y=c*r+m*a,s;var o,n,s,r,a,m,c},e.DotVV=function(t,e){return o=e,(i=t).x*o.x+i.y*o.y;var i,o},e.CrossVV=function(t,e){return o=e,(i=t).x*o.y-i.y*o.x;var i,o},e.CrossVS=function(t,e,i){return n=e,s=i,r=(o=t).x,s.x=n*o.y,s.y=-n*r,s;var o,n,s,r},e.CrossVOne=function(t,e){return o=e,n=(i=t).x,o.x=i.y,o.y=-n,o;var i,o,n},e.CrossSV=function(t,e,i){return o=t,s=i,r=(n=e).x,s.x=-o*n.y,s.y=o*r,s;var o,n,s,r},e.CrossOneV=function(t,e){return o=e,n=(i=t).x,o.x=-i.y,o.y=n,o;var i,o,n},e.AddVV=function(t,e,i){return y(t,e,i)},e.SubVV=function(t,e,i){return b(t,e,i)},e.MulSV=function(t,e,i){return o=t,n=e,(s=i).x=n.x*o,s.y=n.y*o,s;var o,n,s},e.MulVS=function(t,e,i){return o=t,n=e,(s=i).x=o.x*n,s.y=o.y*n,s;var o,n,s},e.AddVMulSV=function(t,e,i,o){return n=t,s=e,r=i,(a=o).x=n.x+s*r.x,a.y=n.y+s*r.y,a;var n,s,r,a},e.SubVMulSV=function(t,e,i,o){return n=t,s=e,r=i,(a=o).x=n.x-s*r.x,a.y=n.y-s*r.y,a;var n,s,r,a},e.AddVCrossSV=function(t,e,i,o){return n=t,s=e,a=o,m=(r=i).x,a.x=n.x-s*r.y,a.y=n.y+s*m,a;var n,s,r,a,m},e.MidVV=function(t,e,i){return o=t,n=e,(s=i).x=.5*(o.x+n.x),s.y=.5*(o.y+n.y),s;var o,n,s},e.ExtVV=function(t,e,i){return o=t,n=e,(s=i).x=.5*(n.x-o.x),s.y=.5*(n.y-o.y),s;var o,n,s},e.IsEqualToV=function(t,e){return o=e,(i=t).x===o.x&&i.y===o.y;var i,o},e.DistanceVV=function(t,e){return o=e,n=(i=t).x-o.x,s=i.y-o.y,Math.sqrt(n*n+s*s);var i,o,n,s},e.DistanceSquaredVV=function(t,e){return o=e,n=(i=t).x-o.x,s=i.y-o.y,n*n+s*s;var i,o,n,s},e.NegV=function(t,e){return i=t,(o=e).x=-i.x,o.y=-i.y,o;var i,o},e.ZERO=new e(0,0),e.UNITX=new e(1,0),e.UNITY=new e(0,1),e.s_t0=new e,e.s_t1=new e,e.s_t2=new e,e.s_t3=new e,e}(),t("b2Vec2",r),t("b2Vec2_zero",new r(0,0)),m=function(){function t(t,e,i){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),this.x=t,this.y=e,this.z=i}return t.prototype.Clone=function(){return new t(this.x,this.y,this.z)},t.prototype.SetZero=function(){return this.x=0,this.y=0,this.z=0,this},t.prototype.SetXYZ=function(t,e,i){return this.x=t,this.y=e,this.z=i,this},t.prototype.Copy=function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this},t.prototype.SelfNeg=function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this},t.prototype.SelfAdd=function(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this},t.prototype.SelfAddXYZ=function(t,e,i){return this.x+=t,this.y+=e,this.z+=i,this},t.prototype.SelfSub=function(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this},t.prototype.SelfSubXYZ=function(t,e,i){return this.x-=t,this.y-=e,this.z-=i,this},t.prototype.SelfMul=function(t){return this.x*=t,this.y*=t,this.z*=t,this},t.DotV3V3=function(t,e){return V(t,e)},t.CrossV3V3=function(t,e,i){return v(t,e,i)},t.ZERO=new t(0,0,0),t.s_t0=new t,t}(),t("b2Vec3",m),a=function(){function n(){this.ex=new r(1,0),this.ey=new r(0,1)}return n.prototype.Clone=function(){return(new n).Copy(this)},n.FromVV=function(t,e){return(new n).SetVV(t,e)},n.FromSSSS=function(t,e,i,o){return(new n).SetSSSS(t,e,i,o)},n.FromAngle=function(t){return(new n).SetAngle(t)},n.prototype.SetSSSS=function(t,e,i,o){return this.ex.Set(t,i),this.ey.Set(e,o),this},n.prototype.SetVV=function(t,e){return this.ex.Copy(t),this.ey.Copy(e),this},n.prototype.SetAngle=function(t){var e=Math.cos(t),i=Math.sin(t);return this.ex.Set(e,i),this.ey.Set(-i,e),this},n.prototype.Copy=function(t){return this.ex.Copy(t.ex),this.ey.Copy(t.ey),this},n.prototype.SetIdentity=function(){return this.ex.Set(1,0),this.ey.Set(0,1),this},n.prototype.SetZero=function(){return this.ex.SetZero(),this.ey.SetZero(),this},n.prototype.GetAngle=function(){return Math.atan2(this.ex.y,this.ex.x)},n.prototype.GetInverse=function(t){var e=this.ex.x,i=this.ey.x,o=this.ex.y,n=this.ey.y,s=e*n-i*o;return 0!==s&&(s=1/s),t.ex.x=s*n,t.ey.x=-s*i,t.ex.y=-s*o,t.ey.y=s*e,t},n.prototype.Solve=function(t,e,i){var o=this.ex.x,n=this.ey.x,s=this.ex.y,r=this.ey.y,a=o*r-n*s;return 0!==a&&(a=1/a),i.x=a*(r*t-n*e),i.y=a*(o*e-s*t),i},n.prototype.SelfAbs=function(){return this.ex.SelfAbs(),this.ey.SelfAbs(),this},n.prototype.SelfInv=function(){return this.GetInverse(this)},n.prototype.SelfAddM=function(t){return this.ex.SelfAdd(t.ex),this.ey.SelfAdd(t.ey),this},n.prototype.SelfSubM=function(t){return this.ex.SelfSub(t.ex),this.ey.SelfSub(t.ey),this},n.AbsM=function(t,e){return o=e,n=(i=t).ex,s=i.ey,o.ex.x=u(n.x),o.ex.y=u(n.y),o.ey.x=u(s.x),o.ey.y=u(s.y),o;var i,o,n,s},n.MulMV=function(t,e,i){return n=e,s=i,r=(o=t).ex,a=o.ey,m=n.x,c=n.y,s.x=r.x*m+a.x*c,s.y=r.y*m+a.y*c,s;var o,n,s,r,a,m,c},n.MulTMV=function(t,e,i){return n=e,s=i,r=(o=t).ex,a=o.ey,m=n.x,c=n.y,s.x=r.x*m+r.y*c,s.y=a.x*m+a.y*c,s;var o,n,s,r,a,m,c},n.AddMM=function(t,e,i){return n=e,s=i,r=(o=t).ex,a=o.ey,m=n.ex,c=n.ey,s.ex.x=r.x+m.x,s.ex.y=r.y+m.y,s.ey.x=a.x+c.x,s.ey.y=a.y+c.y,s;var o,n,s,r,a,m,c},n.MulMM=function(t,e,i){return n=e,s=i,r=(o=t).ex.x,a=o.ex.y,m=o.ey.x,c=o.ey.y,_=n.ex.x,l=n.ex.y,h=n.ey.x,u=n.ey.y,s.ex.x=r*_+m*l,s.ex.y=a*_+c*l,s.ey.x=r*h+m*u,s.ey.y=a*h+c*u,s;var o,n,s,r,a,m,c,_,l,h,u},n.MulTMM=function(t,e,i){return n=e,s=i,r=(o=t).ex.x,a=o.ex.y,m=o.ey.x,c=o.ey.y,_=n.ex.x,l=n.ex.y,h=n.ey.x,u=n.ey.y,s.ex.x=r*_+a*l,s.ex.y=m*_+c*l,s.ey.x=r*h+a*u,s.ey.y=m*h+c*u,s;var o,n,s,r,a,m,c,_,l,h,u},n.IDENTITY=new n,n}(),t("b2Mat22",a),c=function(){function t(){this.ex=new m(1,0,0),this.ey=new m(0,1,0),this.ez=new m(0,0,1)}return t.prototype.Clone=function(){return(new t).Copy(this)},t.prototype.SetVVV=function(t,e,i){return this.ex.Copy(t),this.ey.Copy(e),this.ez.Copy(i),this},t.prototype.Copy=function(t){return this.ex.Copy(t.ex),this.ey.Copy(t.ey),this.ez.Copy(t.ez),this},t.prototype.SetIdentity=function(){return this.ex.SetXYZ(1,0,0),this.ey.SetXYZ(0,1,0),this.ez.SetXYZ(0,0,1),this},t.prototype.SetZero=function(){return this.ex.SetZero(),this.ey.SetZero(),this.ez.SetZero(),this},t.prototype.SelfAddM=function(t){return this.ex.SelfAdd(t.ex),this.ey.SelfAdd(t.ey),this.ez.SelfAdd(t.ez),this},t.prototype.Solve33=function(t,e,i,o){var n=this.ex.x,s=this.ex.y,r=this.ex.z,a=this.ey.x,m=this.ey.y,c=this.ey.z,_=this.ez.x,l=this.ez.y,h=this.ez.z,u=n*(m*h-c*l)+s*(c*_-a*h)+r*(a*l-m*_);return 0!==u&&(u=1/u),o.x=u*(t*(m*h-c*l)+e*(c*_-a*h)+i*(a*l-m*_)),o.y=u*(n*(e*h-i*l)+s*(i*_-t*h)+r*(t*l-e*_)),o.z=u*(n*(m*i-c*e)+s*(c*t-a*i)+r*(a*e-m*t)),o},t.prototype.Solve22=function(t,e,i){var o=this.ex.x,n=this.ey.x,s=this.ex.y,r=this.ey.y,a=o*r-n*s;return 0!==a&&(a=1/a),i.x=a*(r*t-n*e),i.y=a*(o*e-s*t),i},t.prototype.GetInverse22=function(t){var e=this.ex.x,i=this.ey.x,o=this.ex.y,n=this.ey.y,s=e*n-i*o;0!==s&&(s=1/s),t.ex.x=s*n,t.ey.x=-s*i,t.ex.z=0,t.ex.y=-s*o,t.ey.y=s*e,t.ey.z=0,t.ez.x=0,t.ez.y=0,t.ez.z=0},t.prototype.GetSymInverse33=function(t){var e=V(this.ex,v(this.ey,this.ez,m.s_t0));0!==e&&(e=1/e);var i=this.ex.x,o=this.ey.x,n=this.ez.x,s=this.ey.y,r=this.ez.y,a=this.ez.z;t.ex.x=e*(s*a-r*r),t.ex.y=e*(n*r-o*a),t.ex.z=e*(o*r-n*s),t.ey.x=t.ex.y,t.ey.y=e*(i*a-n*n),t.ey.z=e*(n*o-i*r),t.ez.x=t.ex.z,t.ez.y=t.ey.z,t.ez.z=e*(i*s-o*o)},t.MulM33V3=function(t,e,i){return o=t,s=i,r=(n=e).x,a=n.y,m=n.z,s.x=o.ex.x*r+o.ey.x*a+o.ez.x*m,s.y=o.ex.y*r+o.ey.y*a+o.ez.y*m,s.z=o.ex.z*r+o.ey.z*a+o.ez.z*m,s;var o,n,s,r,a,m},t.MulM33XYZ=function(t,e,i,o,n){return s=t,r=e,a=i,m=o,(c=n).x=s.ex.x*r+s.ey.x*a+s.ez.x*m,c.y=s.ex.y*r+s.ey.y*a+s.ez.y*m,c.z=s.ex.z*r+s.ey.z*a+s.ez.z*m,c;var s,r,a,m,c},t.MulM33V2=function(t,e,i){return o=t,s=i,r=(n=e).x,a=n.y,s.x=o.ex.x*r+o.ey.x*a,s.y=o.ex.y*r+o.ey.y*a,s;var o,n,s,r,a},t.MulM33XY=function(t,e,i,o){return n=t,s=e,r=i,(a=o).x=n.ex.x*s+n.ey.x*r,a.y=n.ex.y*s+n.ey.y*r,a;var n,s,r,a},t.IDENTITY=new t,t}(),t("b2Mat33",c),_=function(){function t(t){void 0===t&&(t=0),this.s=0,this.c=1,t&&(this.s=Math.sin(t),this.c=Math.cos(t))}return t.prototype.Clone=function(){return(new t).Copy(this)},t.prototype.Copy=function(t){return this.s=t.s,this.c=t.c,this},t.prototype.SetAngle=function(t){return this.s=Math.sin(t),this.c=Math.cos(t),this},t.prototype.SetIdentity=function(){return this.s=0,this.c=1,this},t.prototype.GetAngle=function(){return Math.atan2(this.s,this.c)},t.prototype.GetXAxis=function(t){return t.x=this.c,t.y=this.s,t},t.prototype.GetYAxis=function(t){return t.x=-this.s,t.y=this.c,t},t.MulRR=function(t,e,i){return x(t,e,i)},t.MulTRR=function(t,e,i){return C(t,e,i)},t.MulRV=function(t,e,i){return S(t,e,i)},t.MulTRV=function(t,e,i){return B(t,e,i)},t.IDENTITY=new t,t}(),t("b2Rot",_),l=function(){function t(){this.p=new r,this.q=new _}return t.prototype.Clone=function(){return(new t).Copy(this)},t.prototype.Copy=function(t){return this.p.Copy(t.p),this.q.Copy(t.q),this},t.prototype.SetIdentity=function(){return this.p.SetZero(),this.q.SetIdentity(),this},t.prototype.SetPositionRotation=function(t,e){return this.p.Copy(t),this.q.Copy(e),this},t.prototype.SetPositionAngle=function(t,e){return this.p.Copy(t),this.q.SetAngle(e),this},t.prototype.SetPosition=function(t){return this.p.Copy(t),this},t.prototype.SetPositionXY=function(t,e){return this.p.Set(t,e),this},t.prototype.SetRotation=function(t){return this.q.Copy(t),this},t.prototype.SetRotationAngle=function(t){return this.q.SetAngle(t),this},t.prototype.GetPosition=function(){return this.p},t.prototype.GetRotation=function(){return this.q},t.prototype.GetRotationAngle=function(){return this.q.GetAngle()},t.prototype.GetAngle=function(){return this.q.GetAngle()},t.MulXV=function(t,e,i){return n=e,s=i,r=(o=t).q.c,a=o.q.s,m=n.x,c=n.y,s.x=r*m-a*c+o.p.x,s.y=a*m+r*c+o.p.y,s;var o,n,s,r,a,m,c},t.MulTXV=function(t,e,i){return n=e,s=i,r=(o=t).q.c,a=o.q.s,m=n.x-o.p.x,c=n.y-o.p.y,s.x=r*m+a*c,s.y=-a*m+r*c,s;var o,n,s,r,a,m,c},t.MulXX=function(t,e,i){return n=e,s=i,x((o=t).q,n.q,s.q),y(S(o.q,n.p,s.p),o.p,s.p),s;var o,n,s},t.MulTXX=function(t,e,i){return n=e,s=i,C((o=t).q,n.q,s.q),B(o.q,b(n.p,o.p,s.p),s.p),s;var o,n,s},t.IDENTITY=new t,t}(),t("b2Transform",l),h=function(){function t(){this.localCenter=new r,this.c0=new r,this.c=new r,this.a0=0,this.a=0,this.alpha0=0}return t.prototype.Clone=function(){return(new t).Copy(this)},t.prototype.Copy=function(t){return this.localCenter.Copy(t.localCenter),this.c0.Copy(t.c0),this.c.Copy(t.c),this.a0=t.a0,this.a=t.a,this.alpha0=t.alpha0,this},t.prototype.GetTransform=function(t,e){var i=1-e;t.p.x=i*this.c0.x+e*this.c.x,t.p.y=i*this.c0.y+e*this.c.y;var o=i*this.a0+e*this.a;return t.q.SetAngle(o),t.p.SelfSub(S(t.q,this.localCenter,r.s_t0)),t},t.prototype.Advance=function(t){var e=(t-this.alpha0)/(1-this.alpha0),i=1-e;this.c0.x=i*this.c0.x+e*this.c.x,this.c0.y=i*this.c0.y+e*this.c.y,this.a0=i*this.a0+e*this.a,this.alpha0=t},t.prototype.Normalize=function(){var t=s*Math.floor(this.a0/s);this.a0-=t,this.a-=t},t}(),t("b2Sweep",h)}}}),System.register("Common/b2Draw",[],function(e,t){var i,o,n;t&&t.id;return{setters:[],execute:function(){var t;i=function(){function n(t,e,i,o){void 0===t&&(t=.5),void 0===e&&(e=.5),void 0===i&&(i=.5),void 0===o&&(o=1),this.r=t,this.g=e,this.b=i,this.a=o}return n.prototype.Clone=function(){return(new n).Copy(this)},n.prototype.Copy=function(t){return this.r=t.r,this.g=t.g,this.b=t.b,this.a=t.a,this},n.prototype.IsEqual=function(t){return this.r===t.r&&this.g===t.g&&this.b===t.b&&this.a===t.a},n.prototype.IsZero=function(){return 0===this.r&&0===this.g&&0===this.b&&0===this.a},n.prototype.GetColor=function(t){return t.Copy(this),t},n.prototype.SetColor=function(t){this.Copy(t)},n.prototype.Set=function(t,e,i,o){void 0===o&&(o=1),t instanceof n?this.Copy(t):this.SetRGBA(t,e,i,o)},n.prototype.SetRGB=function(t,e,i){return this.r=t,this.g=e,this.b=i,this},n.prototype.SetRGBA=function(t,e,i,o){return this.r=t,this.g=e,this.b=i,this.a=o,this},n.prototype.SelfAdd=function(t){return this.r+=t.r,this.g+=t.g,this.b+=t.b,this.a+=t.a,this},n.prototype.Add=function(t,e){return e.r=this.r+t.r,e.g=this.g+t.g,e.b=this.b+t.b,e.a=this.a+t.a,e},n.prototype.SelfSub=function(t){return this.r-=t.r,this.g-=t.g,this.b-=t.b,this.a-=t.a,this},n.prototype.Sub=function(t,e){return e.r=this.r-t.r,e.g=this.g-t.g,e.b=this.b-t.b,e.a=this.a-t.a,e},n.prototype.SelfMul_0_1=function(t){return this.r*=t,this.g*=t,this.b*=t,this.a*=t,this},n.prototype.Mul_0_1=function(t,e){return e.r=this.r*t,e.g=this.g*t,e.b=this.b*t,e.a=this.a*t,this},n.prototype.Mix=function(t,e){n.MixColors(this,t,e)},n.MixColors=function(t,e,i){var o=i*(e.r-t.r),n=i*(e.g-t.g),s=i*(e.b-t.b),r=i*(e.a-t.a);t.r+=o,t.g+=n,t.b+=s,t.a+=r,e.r-=o,e.g-=n,e.b-=s,e.a-=r},n.prototype.MakeStyleString=function(t){return void 0===t&&(t=this.a),n.MakeStyleString(this.r,this.g,this.b,t)},n.MakeStyleString=function(t,e,i,o){return void 0===o&&(o=1),t=Math.round(Math.max(0,Math.min(255,255*t))),e=Math.round(Math.max(0,Math.min(255,255*e))),i=Math.round(Math.max(0,Math.min(255,255*i))),(o=Math.max(0,Math.min(1,o)))<1?"rgba("+t+","+e+","+i+","+o+")":"rgb("+t+","+e+","+i+")"},n.RED=new n(1,0,0),n.GREEN=new n(0,1,0),n.BLUE=new n(0,0,1),n}(),e("b2Color",i),(t=o||(o={}))[t.e_none=0]="e_none",t[t.e_shapeBit=1]="e_shapeBit",t[t.e_jointBit=2]="e_jointBit",t[t.e_aabbBit=4]="e_aabbBit",t[t.e_pairBit=8]="e_pairBit",t[t.e_centerOfMassBit=16]="e_centerOfMassBit",t[t.e_particleBit=32]="e_particleBit",t[t.e_controllerBit=64]="e_controllerBit",t[t.e_all=63]="e_all",e("b2DrawFlags",o),n=function(){function t(){this.m_drawFlags=0}return t.prototype.SetFlags=function(t){this.m_drawFlags=t},t.prototype.GetFlags=function(){return this.m_drawFlags},t.prototype.AppendFlags=function(t){this.m_drawFlags|=t},t.prototype.ClearFlags=function(t){this.m_drawFlags&=~t},t.prototype.PushTransform=function(t){},t.prototype.PopTransform=function(t){},t.prototype.DrawPolygon=function(t,e,i){},t.prototype.DrawSolidPolygon=function(t,e,i){},t.prototype.DrawCircle=function(t,e,i){},t.prototype.DrawSolidCircle=function(t,e,i,o){},t.prototype.DrawParticles=function(t,e,i,o){},t.prototype.DrawSegment=function(t,e,i){},t.prototype.DrawTransform=function(t){},t}(),e("b2Draw",n)}}}),System.register("Common/b2Timer",[],function(t,e){var i,o;e&&e.id;return{setters:[],execute:function(){i=function(){function t(){this.m_start=Date.now()}return t.prototype.Reset=function(){return this.m_start=Date.now(),this},t.prototype.GetMilliseconds=function(){return Date.now()-this.m_start},t}(),t("b2Timer",i),o=function(){function t(){this.m_count=0,this.m_min_count=0,this.m_max_count=0}return t.prototype.GetCount=function(){return this.m_count},t.prototype.GetMinCount=function(){return this.m_min_count},t.prototype.GetMaxCount=function(){return this.m_max_count},t.prototype.ResetCount=function(){var t=this.m_count;return this.m_count=0,t},t.prototype.ResetMinCount=function(){this.m_min_count=0},t.prototype.ResetMaxCount=function(){this.m_max_count=0},t.prototype.Increment=function(){this.m_count++,this.m_max_count<this.m_count&&(this.m_max_count=this.m_count)},t.prototype.Decrement=function(){this.m_count--,this.m_min_count>this.m_count&&(this.m_min_count=this.m_count)},t}(),t("b2Counter",o)}}}),System.register("Common/b2GrowableStack",[],function(t,e){var i;e&&e.id;return{setters:[],execute:function(){i=function(){function t(t){this.m_stack=[],this.m_count=0,this.m_stack=[],this.m_count=0}return t.prototype.Reset=function(){return this.m_count=0,this},t.prototype.Push=function(t){this.m_stack[this.m_count]=t,this.m_count++},t.prototype.Pop=function(){this.m_count--;var t=this.m_stack[this.m_count];return this.m_stack[this.m_count]=null,t},t.prototype.GetCount=function(){return this.m_count},t}(),t("b2GrowableStack",i)}}}),System.register("Common/b2BlockAllocator",[],function(t,e){e&&e.id;return{setters:[],execute:function(){t("b2BlockAllocator",function(){})}}}),System.register("Common/b2StackAllocator",[],function(t,e){e&&e.id;return{setters:[],execute:function(){t("b2StackAllocator",function(){})}}}),System.register("Collision/b2Distance",["Common/b2Settings","Common/b2Math"],function(x,t){var C,B,e,i,o,n,S,A,g,s,r,w,M,P,I,D,G,R,F;t&&t.id;return x("b2Distance",function(t,e,i){x("b2_gjkCalls",++S);var o=i.proxyA,n=i.proxyB,s=i.transformA,r=i.transformB,a=w;a.ReadCache(e,o,s,n,r);for(var m=a.m_vertices,c=M,_=P,l=0,h=(C.b2_maxFloat,0);h<20;){l=a.m_count;for(var u=0;u<l;++u)c[u]=m[u].indexA,_[u]=m[u].indexB;switch(a.m_count){case 1:break;case 2:a.Solve2();break;case 3:a.Solve3()}if(3===a.m_count)break;(v=a.GetClosestPoint(I)).LengthSquared();var p=a.GetSearchDirection(D);if(p.LengthSquared()<C.b2_epsilon_sq)break;var f=m[a.m_count];f.indexA=o.GetSupport(B.b2Rot.MulTRV(s.q,B.b2Vec2.NegV(p,B.b2Vec2.s_t0),R)),B.b2Transform.MulXV(s,o.GetVertex(f.indexA),f.wA),f.indexB=n.GetSupport(B.b2Rot.MulTRV(r.q,p,F)),B.b2Transform.MulXV(r,n.GetVertex(f.indexB),f.wB),B.b2Vec2.SubVV(f.wB,f.wA,f.w),++h,x("b2_gjkIters",++A);var d=!1;for(u=0;u<l;++u)if(f.indexA===c[u]&&f.indexB===_[u]){d=!0;break}if(d)break;++a.m_count}if(x("b2_gjkMaxIters",g=B.b2Max(g,h)),a.GetWitnessPoints(t.pointA,t.pointB),t.distance=B.b2Vec2.DistanceVV(t.pointA,t.pointB),t.iterations=h,a.WriteCache(e),i.useRadii){var y=o.m_radius,b=n.m_radius;if(t.distance>y+b&&t.distance>C.b2_epsilon){t.distance-=y+b;var V=B.b2Vec2.SubVV(t.pointB,t.pointA,G);V.Normalize(),t.pointA.SelfMulAdd(y,V),t.pointB.SelfMulSub(b,V)}else{var v=B.b2Vec2.MidVV(t.pointA,t.pointB,I);t.pointA.Copy(v),t.pointB.Copy(v),t.distance=0}}}),{setters:[function(t){C=t},function(t){B=t}],execute:function(){e=function(){function t(){this.m_buffer=B.b2Vec2.MakeArray(2),this.m_vertices=this.m_buffer,this.m_count=0,this.m_radius=0}return t.prototype.Reset=function(){return this.m_vertices=this.m_buffer,this.m_count=0,this.m_radius=0,this},t.prototype.SetShape=function(t,e){t.SetupDistanceProxy(this,e)},t.prototype.GetSupport=function(t){for(var e=0,i=B.b2Vec2.DotVV(this.m_vertices[0],t),o=1;o<this.m_count;++o){var n=B.b2Vec2.DotVV(this.m_vertices[o],t);i<n&&(e=o,i=n)}return e},t.prototype.GetSupportVertex=function(t){for(var e=0,i=B.b2Vec2.DotVV(this.m_vertices[0],t),o=1;o<this.m_count;++o){var n=B.b2Vec2.DotVV(this.m_vertices[o],t);i<n&&(e=o,i=n)}return this.m_vertices[e]},t.prototype.GetVertexCount=function(){return this.m_count},t.prototype.GetVertex=function(t){return this.m_vertices[t]},t}(),x("b2DistanceProxy",e),i=function(){function t(){this.metric=0,this.count=0,this.indexA=[0,0,0],this.indexB=[0,0,0]}return t.prototype.Reset=function(){return this.metric=0,this.count=0,this},t}(),x("b2SimplexCache",i),o=function(){function t(){this.proxyA=new e,this.proxyB=new e,this.transformA=new B.b2Transform,this.transformB=new B.b2Transform,this.useRadii=!1}return t.prototype.Reset=function(){return this.proxyA.Reset(),this.proxyB.Reset(),this.transformA.SetIdentity(),this.transformB.SetIdentity(),this.useRadii=!1,this},t}(),x("b2DistanceInput",o),n=function(){function t(){this.pointA=new B.b2Vec2,this.pointB=new B.b2Vec2,this.distance=0,this.iterations=0}return t.prototype.Reset=function(){return this.pointA.SetZero(),this.pointB.SetZero(),this.distance=0,this.iterations=0,this},t}(),x("b2DistanceOutput",n),x("b2_gjkCalls",S=0),x("b2_gjkIters",A=0),x("b2_gjkMaxIters",g=0),s=function(){function t(){this.wA=new B.b2Vec2,this.wB=new B.b2Vec2,this.w=new B.b2Vec2,this.a=0,this.indexA=0,this.indexB=0}return t.prototype.Copy=function(t){return this.wA.Copy(t.wA),this.wB.Copy(t.wB),this.w.Copy(t.w),this.a=t.a,this.indexA=t.indexA,this.indexB=t.indexB,this},t}(),x("b2SimplexVertex",s),r=function(){function S(){this.m_v1=new s,this.m_v2=new s,this.m_v3=new s,this.m_vertices=[],this.m_count=0,this.m_vertices[0]=this.m_v1,this.m_vertices[1]=this.m_v2,this.m_vertices[2]=this.m_v3}return S.prototype.ReadCache=function(t,e,i,o,n){this.m_count=t.count;for(var s=this.m_vertices,r=0;r<this.m_count;++r){(l=s[r]).indexA=t.indexA[r],l.indexB=t.indexB[r];var a=e.GetVertex(l.indexA),m=o.GetVertex(l.indexB);B.b2Transform.MulXV(i,a,l.wA),B.b2Transform.MulXV(n,m,l.wB),B.b2Vec2.SubVV(l.wB,l.wA,l.w),l.a=0}if(1<this.m_count){var c=t.metric,_=this.GetMetric();(_<.5*c||2*c<_||_<C.b2_epsilon)&&(this.m_count=0)}if(0===this.m_count){var l;(l=s[0]).indexA=0,l.indexB=0;a=e.GetVertex(0),m=o.GetVertex(0);B.b2Transform.MulXV(i,a,l.wA),B.b2Transform.MulXV(n,m,l.wB),B.b2Vec2.SubVV(l.wB,l.wA,l.w),l.a=1,this.m_count=1}},S.prototype.WriteCache=function(t){t.metric=this.GetMetric(),t.count=this.m_count;for(var e=this.m_vertices,i=0;i<this.m_count;++i)t.indexA[i]=e[i].indexA,t.indexB[i]=e[i].indexB},S.prototype.GetSearchDirection=function(t){switch(this.m_count){case 1:return B.b2Vec2.NegV(this.m_v1.w,t);case 2:var e=B.b2Vec2.SubVV(this.m_v2.w,this.m_v1.w,t);return 0<B.b2Vec2.CrossVV(e,B.b2Vec2.NegV(this.m_v1.w,B.b2Vec2.s_t0))?B.b2Vec2.CrossOneV(e,t):B.b2Vec2.CrossVOne(e,t);default:return t.SetZero()}},S.prototype.GetClosestPoint=function(t){switch(this.m_count){case 0:return t.SetZero();case 1:return t.Copy(this.m_v1.w);case 2:return t.Set(this.m_v1.a*this.m_v1.w.x+this.m_v2.a*this.m_v2.w.x,this.m_v1.a*this.m_v1.w.y+this.m_v2.a*this.m_v2.w.y);case 3:default:return t.SetZero()}},S.prototype.GetWitnessPoints=function(t,e){switch(this.m_count){case 0:break;case 1:t.Copy(this.m_v1.wA),e.Copy(this.m_v1.wB);break;case 2:t.x=this.m_v1.a*this.m_v1.wA.x+this.m_v2.a*this.m_v2.wA.x,t.y=this.m_v1.a*this.m_v1.wA.y+this.m_v2.a*this.m_v2.wA.y,e.x=this.m_v1.a*this.m_v1.wB.x+this.m_v2.a*this.m_v2.wB.x,e.y=this.m_v1.a*this.m_v1.wB.y+this.m_v2.a*this.m_v2.wB.y;break;case 3:e.x=t.x=this.m_v1.a*this.m_v1.wA.x+this.m_v2.a*this.m_v2.wA.x+this.m_v3.a*this.m_v3.wA.x,e.y=t.y=this.m_v1.a*this.m_v1.wA.y+this.m_v2.a*this.m_v2.wA.y+this.m_v3.a*this.m_v3.wA.y}},S.prototype.GetMetric=function(){switch(this.m_count){case 0:case 1:return 0;case 2:return B.b2Vec2.DistanceVV(this.m_v1.w,this.m_v2.w);case 3:return B.b2Vec2.CrossVV(B.b2Vec2.SubVV(this.m_v2.w,this.m_v1.w,B.b2Vec2.s_t0),B.b2Vec2.SubVV(this.m_v3.w,this.m_v1.w,B.b2Vec2.s_t1));default:return 0}},S.prototype.Solve2=function(){var t=this.m_v1.w,e=this.m_v2.w,i=B.b2Vec2.SubVV(e,t,S.s_e12),o=-B.b2Vec2.DotVV(t,i);if(o<=0)return this.m_v1.a=1,void(this.m_count=1);var n=B.b2Vec2.DotVV(e,i);if(n<=0)return this.m_v2.a=1,this.m_count=1,void this.m_v1.Copy(this.m_v2);var s=1/(n+o);this.m_v1.a=n*s,this.m_v2.a=o*s,this.m_count=2},S.prototype.Solve3=function(){var t=this.m_v1.w,e=this.m_v2.w,i=this.m_v3.w,o=B.b2Vec2.SubVV(e,t,S.s_e12),n=B.b2Vec2.DotVV(t,o),s=B.b2Vec2.DotVV(e,o),r=-n,a=B.b2Vec2.SubVV(i,t,S.s_e13),m=B.b2Vec2.DotVV(t,a),c=B.b2Vec2.DotVV(i,a),_=-m,l=B.b2Vec2.SubVV(i,e,S.s_e23),h=B.b2Vec2.DotVV(e,l),u=B.b2Vec2.DotVV(i,l),p=-h,f=B.b2Vec2.CrossVV(o,a),d=f*B.b2Vec2.CrossVV(e,i),y=f*B.b2Vec2.CrossVV(i,t),b=f*B.b2Vec2.CrossVV(t,e);if(r<=0&&_<=0)return this.m_v1.a=1,void(this.m_count=1);if(0<s&&0<r&&b<=0){var V=1/(s+r);return this.m_v1.a=s*V,this.m_v2.a=r*V,void(this.m_count=2)}if(0<c&&0<_&&y<=0){var v=1/(c+_);return this.m_v1.a=c*v,this.m_v3.a=_*v,this.m_count=2,void this.m_v2.Copy(this.m_v3)}if(s<=0&&p<=0)return this.m_v2.a=1,this.m_count=1,void this.m_v1.Copy(this.m_v2);if(c<=0&&u<=0)return this.m_v3.a=1,this.m_count=1,void this.m_v1.Copy(this.m_v3);if(0<u&&0<p&&d<=0){var x=1/(u+p);return this.m_v2.a=u*x,this.m_v3.a=p*x,this.m_count=2,void this.m_v1.Copy(this.m_v3)}var C=1/(d+y+b);this.m_v1.a=d*C,this.m_v2.a=y*C,this.m_v3.a=b*C,this.m_count=3},S.s_e12=new B.b2Vec2,S.s_e13=new B.b2Vec2,S.s_e23=new B.b2Vec2,S}(),x("b2Simplex",r),w=new r,M=[0,0,0],P=[0,0,0],I=new B.b2Vec2,D=new B.b2Vec2,G=new B.b2Vec2,R=new B.b2Vec2,F=new B.b2Vec2}}}),System.register("Collision/Shapes/b2Shape",["Common/b2Math"],function(e,t){var i,o,n;t&&t.id;return{setters:[function(t){i=t}],execute:function(){var t;e("b2MassData",function(){this.mass=0,this.center=new i.b2Vec2(0,0),this.I=0}),(t=o||(o={}))[t.e_unknown=-1]="e_unknown",t[t.e_circleShape=0]="e_circleShape",t[t.e_edgeShape=1]="e_edgeShape",t[t.e_polygonShape=2]="e_polygonShape",t[t.e_chainShape=3]="e_chainShape",t[t.e_shapeTypeCount=4]="e_shapeTypeCount",e("b2ShapeType",o),n=function(){function t(t,e){this.m_type=-1,this.m_radius=0,this.m_type=t,this.m_radius=e}return t.prototype.Copy=function(t){return this.m_radius=t.m_radius,this},t.prototype.GetType=function(){return this.m_type},t}(),e("b2Shape",n)}}}),System.register("Collision/b2Collision",["Common/b2Settings","Common/b2Math","Collision/b2Distance"],function(o,t){var d,y,c,n,s,r,a,m,_,l,h,u,p,f,b,V,v,x;t&&t.id;return o("b2GetPointStates",function(t,e,i,o){var n;for(n=0;n<i.pointCount;++n){var s=i.points[n].id.key;t[n]=3;for(var r=0,a=o.pointCount;r<a;++r)if(o.points[r].id.key===s){t[n]=2;break}}for(;n<d.b2_maxManifoldPoints;++n)t[n]=0;for(n=0;n<o.pointCount;++n)for(s=o.points[n].id.key,e[n]=1,r=0,a=i.pointCount;r<a;++r)if(i.points[r].id.key===s){e[n]=2;break}for(;n<d.b2_maxManifoldPoints;++n)e[n]=0}),o("b2TestOverlapAABB",function(t,e){var i=e.lowerBound.x-t.upperBound.x,o=e.lowerBound.y-t.upperBound.y,n=t.lowerBound.x-e.upperBound.x,s=t.lowerBound.y-e.upperBound.y;return!(0<i||0<o||0<n||0<s)}),o("b2ClipSegmentToLine",function(t,e,i,o,n){var s=0,r=e[0],a=e[1],m=y.b2Vec2.DotVV(i,r.v)-o,c=y.b2Vec2.DotVV(i,a.v)-o;if(m<=0&&t[s++].Copy(r),c<=0&&t[s++].Copy(a),m*c<0){var _=m/(m-c),l=t[s].v;l.x=r.v.x+_*(a.v.x-r.v.x),l.y=r.v.y+_*(a.v.y-r.v.y);var h=t[s].id;h.cf.indexA=n,h.cf.indexB=r.id.cf.indexB,h.cf.typeA=0,h.cf.typeB=1,++s}return s}),o("b2TestOverlapShape",function(t,e,i,o,n,s){var r=V.Reset();r.proxyA.SetShape(t,e),r.proxyB.SetShape(i,o),r.transformA.Copy(n),r.transformB.Copy(s),r.useRadii=!0;var a=v.Reset();a.count=0;var m=x.Reset();return c.b2Distance(m,a,r),m.distance<10*d.b2_epsilon}),{setters:[function(t){d=t},function(t){y=t},function(t){c=t}],execute:function(){var t,e,i;(t=n||(n={}))[t.e_vertex=0]="e_vertex",t[t.e_face=1]="e_face",o("b2ContactFeatureType",n),s=function(){function t(){this._key=0,this._key_invalid=!1,this._indexA=0,this._indexB=0,this._typeA=0,this._typeB=0}return Object.defineProperty(t.prototype,"key",{get:function(){return this._key_invalid&&(this._key_invalid=!1,this._key=this._indexA|this._indexB<<8|this._typeA<<16|this._typeB<<24),this._key},set:function(t){this._key=t,this._key_invalid=!1,this._indexA=255&this._key,this._indexB=this._key>>8&255,this._typeA=this._key>>16&255,this._typeB=this._key>>24&255},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"indexA",{get:function(){return this._indexA},set:function(t){this._indexA=t,this._key_invalid=!0},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"indexB",{get:function(){return this._indexB},set:function(t){this._indexB=t,this._key_invalid=!0},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"typeA",{get:function(){return this._typeA},set:function(t){this._typeA=t,this._key_invalid=!0},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"typeB",{get:function(){return this._typeB},set:function(t){this._typeB=t,this._key_invalid=!0},enumerable:!0,configurable:!0}),t}(),o("b2ContactFeature",s),r=function(){function t(){this.cf=new s}return t.prototype.Copy=function(t){return this.key=t.key,this},t.prototype.Clone=function(){return(new t).Copy(this)},Object.defineProperty(t.prototype,"key",{get:function(){return this.cf.key},set:function(t){this.cf.key=t},enumerable:!0,configurable:!0}),t}(),o("b2ContactID",r),a=function(){function e(){this.localPoint=new y.b2Vec2,this.normalImpulse=0,this.tangentImpulse=0,this.id=new r}return e.MakeArray=function(t){return d.b2MakeArray(t,function(t){return new e})},e.prototype.Reset=function(){this.localPoint.SetZero(),this.normalImpulse=0,this.tangentImpulse=0,this.id.key=0},e.prototype.Copy=function(t){return this.localPoint.Copy(t.localPoint),this.normalImpulse=t.normalImpulse,this.tangentImpulse=t.tangentImpulse,this.id.Copy(t.id),this},e}(),o("b2ManifoldPoint",a),(e=m||(m={}))[e.e_unknown=-1]="e_unknown",e[e.e_circles=0]="e_circles",e[e.e_faceA=1]="e_faceA",e[e.e_faceB=2]="e_faceB",o("b2ManifoldType",m),_=function(){function t(){this.points=a.MakeArray(d.b2_maxManifoldPoints),this.localNormal=new y.b2Vec2,this.localPoint=new y.b2Vec2,this.type=-1,this.pointCount=0}return t.prototype.Reset=function(){for(var t=0;t<d.b2_maxManifoldPoints;++t)this.points[t].Reset();this.localNormal.SetZero(),this.localPoint.SetZero(),this.type=-1,this.pointCount=0},t.prototype.Copy=function(t){this.pointCount=t.pointCount;for(var e=0;e<d.b2_maxManifoldPoints;++e)this.points[e].Copy(t.points[e]);return this.localNormal.Copy(t.localNormal),this.localPoint.Copy(t.localPoint),this.type=t.type,this},t.prototype.Clone=function(){return(new t).Copy(this)},t}(),o("b2Manifold",_),l=function(){function u(){this.normal=new y.b2Vec2,this.points=y.b2Vec2.MakeArray(d.b2_maxManifoldPoints),this.separations=d.b2MakeNumberArray(d.b2_maxManifoldPoints)}return u.prototype.Initialize=function(t,e,i,o,n){if(0!==t.pointCount)switch(t.type){case 0:this.normal.Set(1,0);var s=y.b2Transform.MulXV(e,t.localPoint,u.Initialize_s_pointA),r=y.b2Transform.MulXV(o,t.points[0].localPoint,u.Initialize_s_pointB);y.b2Vec2.DistanceSquaredVV(s,r)>d.b2_epsilon_sq&&y.b2Vec2.SubVV(r,s,this.normal).SelfNormalize();var a=y.b2Vec2.AddVMulSV(s,i,this.normal,u.Initialize_s_cA),m=y.b2Vec2.SubVMulSV(r,n,this.normal,u.Initialize_s_cB);y.b2Vec2.MidVV(a,m,this.points[0]),this.separations[0]=y.b2Vec2.DotVV(y.b2Vec2.SubVV(m,a,y.b2Vec2.s_t0),this.normal);break;case 1:y.b2Rot.MulRV(e.q,t.localNormal,this.normal);for(var c=y.b2Transform.MulXV(e,t.localPoint,u.Initialize_s_planePoint),_=0;_<t.pointCount;++_){var l=y.b2Transform.MulXV(o,t.points[_].localPoint,u.Initialize_s_clipPoint),h=i-y.b2Vec2.DotVV(y.b2Vec2.SubVV(l,c,y.b2Vec2.s_t0),this.normal);a=y.b2Vec2.AddVMulSV(l,h,this.normal,u.Initialize_s_cA),m=y.b2Vec2.SubVMulSV(l,n,this.normal,u.Initialize_s_cB);y.b2Vec2.MidVV(a,m,this.points[_]),this.separations[_]=y.b2Vec2.DotVV(y.b2Vec2.SubVV(m,a,y.b2Vec2.s_t0),this.normal)}break;case 2:y.b2Rot.MulRV(o.q,t.localNormal,this.normal);for(c=y.b2Transform.MulXV(o,t.localPoint,u.Initialize_s_planePoint),_=0;_<t.pointCount;++_){l=y.b2Transform.MulXV(e,t.points[_].localPoint,u.Initialize_s_clipPoint),h=n-y.b2Vec2.DotVV(y.b2Vec2.SubVV(l,c,y.b2Vec2.s_t0),this.normal),m=y.b2Vec2.AddVMulSV(l,h,this.normal,u.Initialize_s_cB),a=y.b2Vec2.SubVMulSV(l,i,this.normal,u.Initialize_s_cA);y.b2Vec2.MidVV(a,m,this.points[_]),this.separations[_]=y.b2Vec2.DotVV(y.b2Vec2.SubVV(a,m,y.b2Vec2.s_t0),this.normal)}this.normal.SelfNeg()}},u.Initialize_s_pointA=new y.b2Vec2,u.Initialize_s_pointB=new y.b2Vec2,u.Initialize_s_cA=new y.b2Vec2,u.Initialize_s_cB=new y.b2Vec2,u.Initialize_s_planePoint=new y.b2Vec2,u.Initialize_s_clipPoint=new y.b2Vec2,u}(),o("b2WorldManifold",l),(i=h||(h={}))[i.b2_nullState=0]="b2_nullState",i[i.b2_addState=1]="b2_addState",i[i.b2_persistState=2]="b2_persistState",i[i.b2_removeState=3]="b2_removeState",o("b2PointState",h),u=function(){function e(){this.v=new y.b2Vec2,this.id=new r}return e.MakeArray=function(t){return d.b2MakeArray(t,function(t){return new e})},e.prototype.Copy=function(t){return this.v.Copy(t.v),this.id.Copy(t.id),this},e}(),o("b2ClipVertex",u),p=function(){function t(){this.p1=new y.b2Vec2,this.p2=new y.b2Vec2,this.maxFraction=1}return t.prototype.Copy=function(t){return this.p1.Copy(t.p1),this.p2.Copy(t.p2),this.maxFraction=t.maxFraction,this},t}(),o("b2RayCastInput",p),f=function(){function t(){this.normal=new y.b2Vec2,this.fraction=0}return t.prototype.Copy=function(t){return this.normal.Copy(t.normal),this.fraction=t.fraction,this},t}(),o("b2RayCastOutput",f),b=function(){function t(){this.lowerBound=new y.b2Vec2,this.upperBound=new y.b2Vec2,this.m_cache_center=new y.b2Vec2,this.m_cache_extent=new y.b2Vec2}return t.prototype.Copy=function(t){return this.lowerBound.Copy(t.lowerBound),this.upperBound.Copy(t.upperBound),this},t.prototype.IsValid=function(){var t=this.upperBound.x-this.lowerBound.x,e=this.upperBound.y-this.lowerBound.y,i=0<=t&&0<=e;return i=i&&this.lowerBound.IsValid()&&this.upperBound.IsValid()},t.prototype.GetCenter=function(){return y.b2Vec2.MidVV(this.lowerBound,this.upperBound,this.m_cache_center)},t.prototype.GetExtents=function(){return y.b2Vec2.ExtVV(this.lowerBound,this.upperBound,this.m_cache_extent)},t.prototype.GetPerimeter=function(){return 2*(this.upperBound.x-this.lowerBound.x+(this.upperBound.y-this.lowerBound.y))},t.prototype.Combine1=function(t){return this.lowerBound.x=y.b2Min(this.lowerBound.x,t.lowerBound.x),this.lowerBound.y=y.b2Min(this.lowerBound.y,t.lowerBound.y),this.upperBound.x=y.b2Max(this.upperBound.x,t.upperBound.x),this.upperBound.y=y.b2Max(this.upperBound.y,t.upperBound.y),this},t.prototype.Combine2=function(t,e){return this.lowerBound.x=y.b2Min(t.lowerBound.x,e.lowerBound.x),this.lowerBound.y=y.b2Min(t.lowerBound.y,e.lowerBound.y),this.upperBound.x=y.b2Max(t.upperBound.x,e.upperBound.x),this.upperBound.y=y.b2Max(t.upperBound.y,e.upperBound.y),this},t.Combine=function(t,e,i){return i.Combine2(t,e),i},t.prototype.Contains=function(t){var e=!0;return e=(e=(e=(e=e&&this.lowerBound.x<=t.lowerBound.x)&&this.lowerBound.y<=t.lowerBound.y)&&t.upperBound.x<=this.upperBound.x)&&t.upperBound.y<=this.upperBound.y},t.prototype.RayCast=function(t,e){var i=-d.b2_maxFloat,o=d.b2_maxFloat,n=e.p1.x,s=e.p1.y,r=e.p2.x-e.p1.x,a=e.p2.y-e.p1.y,m=y.b2Abs(r),c=y.b2Abs(a),_=t.normal;if(m<d.b2_epsilon){if(n<this.lowerBound.x||this.upperBound.x<n)return!1}else{var l=1/r,h=(this.lowerBound.x-n)*l,u=-1;if((f=(this.upperBound.x-n)*l)<h){var p=h;h=f,f=p,u=1}if(i<h&&(_.x=u,_.y=0,i=h),(o=y.b2Min(o,f))<i)return!1}if(c<d.b2_epsilon){if(s<this.lowerBound.y||this.upperBound.y<s)return!1}else{var f;l=1/a,h=(this.lowerBound.y-s)*l,u=-1;if((f=(this.upperBound.y-s)*l)<h){p=h;h=f,f=p,u=1}if(i<h&&(_.x=0,_.y=u,i=h),(o=y.b2Min(o,f))<i)return!1}return!(i<0||e.maxFraction<i)&&(t.fraction=i,!0)},t.prototype.TestOverlap=function(t){var e=t.lowerBound.x-this.upperBound.x,i=t.lowerBound.y-this.upperBound.y,o=this.lowerBound.x-t.upperBound.x,n=this.lowerBound.y-t.upperBound.y;return!(0<e||0<i)&&!(0<o||0<n)},t}(),o("b2AABB",b),V=new c.b2DistanceInput,v=new c.b2SimplexCache,x=new c.b2DistanceOutput}}}),System.register("Collision/b2DynamicTree",["Common/b2Settings","Common/b2Math","Common/b2GrowableStack","Collision/b2Collision"],function(t,e){var s,b,i,V,o,n;e&&e.id;return{setters:[function(t){s=t},function(t){b=t},function(t){i=t},function(t){V=t}],execute:function(){o=function(){function t(t){void 0===t&&(t=0),this.m_id=0,this.aabb=new V.b2AABB,this.userData=null,this.parent=null,this.child1=null,this.child2=null,this.height=0,this.m_id=t}return t.prototype.IsLeaf=function(){return null===this.child1},t}(),t("b2TreeNode",o),n=function(){function y(){this.m_root=null,this.m_freeList=null,this.m_path=0,this.m_insertionCount=0}return y.prototype.GetUserData=function(t){return t.userData},y.prototype.GetFatAABB=function(t){return t.aabb},y.prototype.Query=function(t,e){if(null!==this.m_root){var i=y.s_stack.Reset();for(i.Push(this.m_root);0<i.GetCount();){var o=i.Pop();if(null!==o)if(o.aabb.TestOverlap(e))if(o.IsLeaf()){if(!t(o))return}else i.Push(o.child1),i.Push(o.child2)}}},y.prototype.RayCast=function(t,e){if(null!==this.m_root){var i=e.p1,o=e.p2,n=b.b2Vec2.SubVV(o,i,y.s_r);n.Normalize();var s=b.b2Vec2.CrossOneV(n,y.s_v),r=b.b2Vec2.AbsV(s,y.s_abs_v),a=e.maxFraction,m=y.s_segmentAABB,c=i.x+a*(o.x-i.x),_=i.y+a*(o.y-i.y);m.lowerBound.x=b.b2Min(i.x,c),m.lowerBound.y=b.b2Min(i.y,_),m.upperBound.x=b.b2Max(i.x,c),m.upperBound.y=b.b2Max(i.y,_);var l=y.s_stack.Reset();for(l.Push(this.m_root);0<l.GetCount();){var h=l.Pop();if(null!==h&&V.b2TestOverlapAABB(h.aabb,m)){var u=h.aabb.GetCenter(),p=h.aabb.GetExtents();if(!(0<b.b2Abs(b.b2Vec2.DotVV(s,b.b2Vec2.SubVV(i,u,b.b2Vec2.s_t0)))-b.b2Vec2.DotVV(r,p)))if(h.IsLeaf()){var f=y.s_subInput;f.p1.Copy(e.p1),f.p2.Copy(e.p2),f.maxFraction=a;var d=t(f,h);if(0===d)return;0<d&&(a=d,c=i.x+a*(o.x-i.x),_=i.y+a*(o.y-i.y),m.lowerBound.x=b.b2Min(i.x,c),m.lowerBound.y=b.b2Min(i.y,_),m.upperBound.x=b.b2Max(i.x,c),m.upperBound.y=b.b2Max(i.y,_))}else l.Push(h.child1),l.Push(h.child2)}}}},y.prototype.AllocateNode=function(){if(this.m_freeList){var t=this.m_freeList;return this.m_freeList=t.parent,t.parent=null,t.child1=null,t.child2=null,t.height=0,t.userData=null,t}return new o(y.s_node_id++)},y.prototype.FreeNode=function(t){t.parent=this.m_freeList,t.height=-1,this.m_freeList=t},y.prototype.CreateProxy=function(t,e){var i=this.AllocateNode(),o=s.b2_aabbExtension,n=s.b2_aabbExtension;return i.aabb.lowerBound.x=t.lowerBound.x-o,i.aabb.lowerBound.y=t.lowerBound.y-n,i.aabb.upperBound.x=t.upperBound.x+o,i.aabb.upperBound.y=t.upperBound.y+n,i.userData=e,i.height=0,this.InsertLeaf(i),i},y.prototype.DestroyProxy=function(t){this.RemoveLeaf(t),this.FreeNode(t)},y.prototype.MoveProxy=function(t,e,i){if(t.aabb.Contains(e))return!1;this.RemoveLeaf(t);var o=s.b2_aabbExtension+s.b2_aabbMultiplier*(0<i.x?i.x:-i.x),n=s.b2_aabbExtension+s.b2_aabbMultiplier*(0<i.y?i.y:-i.y);return t.aabb.lowerBound.x=e.lowerBound.x-o,t.aabb.lowerBound.y=e.lowerBound.y-n,t.aabb.upperBound.x=e.upperBound.x+o,t.aabb.upperBound.y=e.upperBound.y+n,this.InsertLeaf(t),!0},y.prototype.InsertLeaf=function(t){if(++this.m_insertionCount,null===this.m_root)return this.m_root=t,void(this.m_root.parent=null);for(var e,i,o=t.aabb,n=this.m_root;!n.IsLeaf();){e=n.child1,i=n.child2;var s=n.aabb.GetPerimeter(),r=y.s_combinedAABB;r.Combine2(n.aabb,o);var a=r.GetPerimeter(),m=2*a,c=2*(a-s),_=void 0,l=y.s_aabb,h=void 0;e.IsLeaf()?(l.Combine2(o,e.aabb),_=l.GetPerimeter()+c):(l.Combine2(o,e.aabb),h=e.aabb.GetPerimeter(),_=l.GetPerimeter()-h+c);var u=void 0;if(i.IsLeaf()?(l.Combine2(o,i.aabb),u=l.GetPerimeter()+c):(l.Combine2(o,i.aabb),h=i.aabb.GetPerimeter(),u=l.GetPerimeter()-h+c),m<_&&m<u)break;n=_<u?e:i}var p=n,f=p.parent,d=this.AllocateNode();for(d.parent=f,d.userData=null,d.aabb.Combine2(o,p.aabb),d.height=p.height+1,f?(f.child1===p?f.child1=d:f.child2=d,d.child1=p,d.child2=t,p.parent=d,t.parent=d):(d.child1=p,d.child2=t,p.parent=d,t.parent=d,this.m_root=d),n=t.parent;null!==n;)e=(n=this.Balance(n)).child1,i=n.child2,n.height=1+b.b2Max(e.height,i.height),n.aabb.Combine2(e.aabb,i.aabb),n=n.parent},y.prototype.RemoveLeaf=function(t){if(t!==this.m_root){var e,i=t.parent,o=i.parent;if(e=i.child1===t?i.child2:i.child1,o){o.child1===i?o.child1=e:o.child2=e,e.parent=o,this.FreeNode(i);for(var n=o;n;){var s=(n=this.Balance(n)).child1,r=n.child2;n.aabb.Combine2(s.aabb,r.aabb),n.height=1+b.b2Max(s.height,r.height),n=n.parent}}else(this.m_root=e).parent=null,this.FreeNode(i)}else this.m_root=null},y.prototype.Balance=function(t){if(t.IsLeaf()||t.height<2)return t;var e=t.child1,i=t.child2,o=i.height-e.height;if(1<o){var n=i.child1,s=i.child2;return i.child1=t,i.parent=t.parent,null!==(t.parent=i).parent?i.parent.child1===t?i.parent.child1=i:i.parent.child2=i:this.m_root=i,n.height>s.height?(i.child2=n,((t.child2=s).parent=t).aabb.Combine2(e.aabb,s.aabb),i.aabb.Combine2(t.aabb,n.aabb),t.height=1+b.b2Max(e.height,s.height),i.height=1+b.b2Max(t.height,n.height)):(i.child2=s,((t.child2=n).parent=t).aabb.Combine2(e.aabb,n.aabb),i.aabb.Combine2(t.aabb,s.aabb),t.height=1+b.b2Max(e.height,n.height),i.height=1+b.b2Max(t.height,s.height)),i}if(o<-1){var r=e.child1,a=e.child2;return e.child1=t,e.parent=t.parent,null!==(t.parent=e).parent?e.parent.child1===t?e.parent.child1=e:e.parent.child2=e:this.m_root=e,r.height>a.height?(e.child2=r,((t.child1=a).parent=t).aabb.Combine2(i.aabb,a.aabb),e.aabb.Combine2(t.aabb,r.aabb),t.height=1+b.b2Max(i.height,a.height),e.height=1+b.b2Max(t.height,r.height)):(e.child2=a,((t.child1=r).parent=t).aabb.Combine2(i.aabb,r.aabb),e.aabb.Combine2(t.aabb,a.aabb),t.height=1+b.b2Max(i.height,r.height),e.height=1+b.b2Max(t.height,a.height)),e}return t},y.prototype.GetHeight=function(){return null===this.m_root?0:this.m_root.height},y.GetAreaNode=function(t){if(null===t)return 0;if(t.IsLeaf())return 0;var e=t.aabb.GetPerimeter();return e+=y.GetAreaNode(t.child1),e+=y.GetAreaNode(t.child2)},y.prototype.GetAreaRatio=function(){if(null===this.m_root)return 0;var t=this.m_root.aabb.GetPerimeter();return y.GetAreaNode(this.m_root)/t},y.prototype.ComputeHeightNode=function(t){if(t.IsLeaf())return 0;var e=this.ComputeHeightNode(t.child1),i=this.ComputeHeightNode(t.child2);return 1+b.b2Max(e,i)},y.prototype.ComputeHeight=function(){return this.ComputeHeightNode(this.m_root)},y.prototype.ValidateStructure=function(t){if(null!==t){this.m_root;var e=t,i=e.child1,o=e.child2;e.IsLeaf()||(this.ValidateStructure(i),this.ValidateStructure(o))}},y.prototype.ValidateMetrics=function(t){if(null!==t){var e=t,i=e.child1,o=e.child2;if(!e.IsLeaf())y.s_aabb.Combine2(i.aabb,o.aabb),this.ValidateMetrics(i),this.ValidateMetrics(o)}},y.prototype.Validate=function(){this.ValidateStructure(this.m_root),this.ValidateMetrics(this.m_root);for(var t=this.m_freeList;null!==t;)t=t.parent},y.GetMaxBalanceNode=function(t,e){if(null===t)return e;if(t.height<=1)return e;var i=t.child1,o=t.child2,n=b.b2Abs(o.height-i.height);return b.b2Max(e,n)},y.prototype.GetMaxBalance=function(){return y.GetMaxBalanceNode(this.m_root,0)},y.prototype.RebuildBottomUp=function(){this.Validate()},y.ShiftOriginNode=function(t,e){if(null!==t&&!(t.height<=1)){var i=t.child1,o=t.child2;y.ShiftOriginNode(i,e),y.ShiftOriginNode(o,e),t.aabb.lowerBound.SelfSub(e),t.aabb.upperBound.SelfSub(e)}},y.prototype.ShiftOrigin=function(t){y.ShiftOriginNode(this.m_root,t)},y.s_stack=new i.b2GrowableStack(256),y.s_r=new b.b2Vec2,y.s_v=new b.b2Vec2,y.s_abs_v=new b.b2Vec2,y.s_segmentAABB=new V.b2AABB,y.s_subInput=new V.b2RayCastInput,y.s_combinedAABB=new V.b2AABB,y.s_aabb=new V.b2AABB,y.s_node_id=0,y}(),t("b2DynamicTree",n)}}}),System.register("Collision/b2TimeOfImpact",["Common/b2Settings","Common/b2Math","Common/b2Timer","Collision/b2Distance"],function(G,t){var R,F,i,T,L,k,q,z,J,j,N,E,O,V,v,x,h,u,o,n,s,X,U,W,Z,H,Q,Y,K,$;t&&t.id;return G("b2TimeOfImpact",function(t,e){var i=X.Reset();G("b2_toiCalls",++q),t.state=0,t.t=e.tMax;var o=e.proxyA,n=e.proxyB,s=K.Copy(e.sweepA),r=$.Copy(e.sweepB);s.Normalize(),r.Normalize();var a=e.tMax,m=o.m_radius+n.m_radius,c=F.b2Max(R.b2_linearSlop,m-3*R.b2_linearSlop),_=.25*R.b2_linearSlop,l=0,h=0,u=U;u.count=0;var p=W;for(p.proxyA=e.proxyA,p.proxyB=e.proxyB,p.useRadii=!1;;){var f=E,d=O;s.GetTransform(f,l),r.GetTransform(d,l),p.transformA.Copy(f),p.transformB.Copy(d);var y=Z;if(T.b2Distance(y,u,p),y.distance<=0){t.state=2,t.t=0;break}if(y.distance<c+_){t.state=3,t.t=l;break}var b=H;b.Initialize(u,o,s,n,r,l);for(var V=!1,v=a,x=0;;){var C=Q,S=Y,B=b.FindMinSeparation(C,S,v);if(c+_<B){t.state=4,t.t=a,V=!0;break}if(c-_<B){l=v;break}var A=b.Evaluate(C[0],S[0],l);if(A<c-_){t.state=1,t.t=l,V=!0;break}if(A<=c+_){t.state=3,t.t=l,V=!0;break}for(var g=0,w=l,M=v;;){var P=0;P=1&g?w+(c-A)*(M-w)/(B-A):.5*(w+M),++g,G("b2_toiRootIters",++j);var I=b.Evaluate(C[0],S[0],P);if(F.b2Abs(I-c)<_){v=P;break}if(c<I?(w=P,A=I):(M=P,B=I),50===g)break}if(G("b2_toiMaxRootIters",N=F.b2Max(N,g)),++x===R.b2_maxPolygonVertices)break}if(++h,G("b2_toiIters",++z),V)break;if(20===h){t.state=1,t.t=l;break}}G("b2_toiMaxIters",J=F.b2Max(J,h));var D=i.GetMilliseconds();G("b2_toiMaxTime",k=F.b2Max(k,D)),G("b2_toiTime",L+=D)}),{setters:[function(t){R=t},function(t){F=t},function(t){i=t},function(t){T=t}],execute:function(){var t,e;G("b2_toiTime",L=0),G("b2_toiMaxTime",k=0),G("b2_toiCalls",q=0),G("b2_toiIters",z=0),G("b2_toiMaxIters",J=0),G("b2_toiRootIters",j=0),G("b2_toiMaxRootIters",N=0),E=new F.b2Transform,O=new F.b2Transform,V=new F.b2Vec2,v=new F.b2Vec2,x=new F.b2Vec2,h=new F.b2Vec2,u=new F.b2Vec2,G("b2TOIInput",function(){this.proxyA=new T.b2DistanceProxy,this.proxyB=new T.b2DistanceProxy,this.sweepA=new F.b2Sweep,this.sweepB=new F.b2Sweep,this.tMax=0}),(t=o||(o={}))[t.e_unknown=0]="e_unknown",t[t.e_failed=1]="e_failed",t[t.e_overlapped=2]="e_overlapped",t[t.e_touching=3]="e_touching",t[t.e_separated=4]="e_separated",G("b2TOIOutputState",o),G("b2TOIOutput",function(){this.state=0,this.t=0}),(e=n||(n={}))[e.e_unknown=-1]="e_unknown",e[e.e_points=0]="e_points",e[e.e_faceA=1]="e_faceA",e[e.e_faceB=2]="e_faceB",G("b2SeparationFunctionType",n),s=function(){function t(){this.m_sweepA=new F.b2Sweep,this.m_sweepB=new F.b2Sweep,this.m_type=-1,this.m_localPoint=new F.b2Vec2,this.m_axis=new F.b2Vec2}return t.prototype.Initialize=function(t,e,i,o,n,s){this.m_proxyA=e,this.m_proxyB=o;var r=t.count;this.m_sweepA.Copy(i),this.m_sweepB.Copy(n);var a=E,m=O;if(this.m_sweepA.GetTransform(a,s),this.m_sweepB.GetTransform(m,s),1===r){this.m_type=0;var c=this.m_proxyA.GetVertex(t.indexA[0]),_=this.m_proxyB.GetVertex(t.indexB[0]),l=F.b2Transform.MulXV(a,c,V),h=F.b2Transform.MulXV(m,_,v);F.b2Vec2.SubVV(h,l,this.m_axis);var u=this.m_axis.Normalize();return this.m_localPoint.SetZero(),u}if(t.indexA[0]===t.indexA[1]){this.m_type=2;var p=this.m_proxyB.GetVertex(t.indexB[0]),f=this.m_proxyB.GetVertex(t.indexB[1]);F.b2Vec2.CrossVOne(F.b2Vec2.SubVV(f,p,F.b2Vec2.s_t0),this.m_axis).SelfNormalize();var d=F.b2Rot.MulRV(m.q,this.m_axis,x);F.b2Vec2.MidVV(p,f,this.m_localPoint);h=F.b2Transform.MulXV(m,this.m_localPoint,v),c=this.m_proxyA.GetVertex(t.indexA[0]),l=F.b2Transform.MulXV(a,c,V);return(u=F.b2Vec2.DotVV(F.b2Vec2.SubVV(l,h,F.b2Vec2.s_t0),d))<0&&(this.m_axis.SelfNeg(),u=-u),u}this.m_type=1;var y=this.m_proxyA.GetVertex(t.indexA[0]),b=this.m_proxyA.GetVertex(t.indexA[1]);F.b2Vec2.CrossVOne(F.b2Vec2.SubVV(b,y,F.b2Vec2.s_t0),this.m_axis).SelfNormalize();d=F.b2Rot.MulRV(a.q,this.m_axis,x);F.b2Vec2.MidVV(y,b,this.m_localPoint);l=F.b2Transform.MulXV(a,this.m_localPoint,V),_=this.m_proxyB.GetVertex(t.indexB[0]),h=F.b2Transform.MulXV(m,_,v);return(u=F.b2Vec2.DotVV(F.b2Vec2.SubVV(h,l,F.b2Vec2.s_t0),d))<0&&(this.m_axis.SelfNeg(),u=-u),u},t.prototype.FindMinSeparation=function(t,e,i){var o=E,n=O;switch(this.m_sweepA.GetTransform(o,i),this.m_sweepB.GetTransform(n,i),this.m_type){case 0:var s=F.b2Rot.MulTRV(o.q,this.m_axis,h),r=F.b2Rot.MulTRV(n.q,F.b2Vec2.NegV(this.m_axis,F.b2Vec2.s_t0),u);t[0]=this.m_proxyA.GetSupport(s),e[0]=this.m_proxyB.GetSupport(r);var a=this.m_proxyA.GetVertex(t[0]),m=this.m_proxyB.GetVertex(e[0]),c=F.b2Transform.MulXV(o,a,V),_=F.b2Transform.MulXV(n,m,v);return F.b2Vec2.DotVV(F.b2Vec2.SubVV(_,c,F.b2Vec2.s_t0),this.m_axis);case 1:var l=F.b2Rot.MulRV(o.q,this.m_axis,x);c=F.b2Transform.MulXV(o,this.m_localPoint,V),r=F.b2Rot.MulTRV(n.q,F.b2Vec2.NegV(l,F.b2Vec2.s_t0),u);t[0]=-1,e[0]=this.m_proxyB.GetSupport(r);m=this.m_proxyB.GetVertex(e[0]),_=F.b2Transform.MulXV(n,m,v);return F.b2Vec2.DotVV(F.b2Vec2.SubVV(_,c,F.b2Vec2.s_t0),l);case 2:l=F.b2Rot.MulRV(n.q,this.m_axis,x),_=F.b2Transform.MulXV(n,this.m_localPoint,v),s=F.b2Rot.MulTRV(o.q,F.b2Vec2.NegV(l,F.b2Vec2.s_t0),h);e[0]=-1,t[0]=this.m_proxyA.GetSupport(s);a=this.m_proxyA.GetVertex(t[0]),c=F.b2Transform.MulXV(o,a,V);return F.b2Vec2.DotVV(F.b2Vec2.SubVV(c,_,F.b2Vec2.s_t0),l);default:return t[0]=-1,e[0]=-1,0}},t.prototype.Evaluate=function(t,e,i){var o=E,n=O;switch(this.m_sweepA.GetTransform(o,i),this.m_sweepB.GetTransform(n,i),this.m_type){case 0:var s=this.m_proxyA.GetVertex(t),r=this.m_proxyB.GetVertex(e),a=F.b2Transform.MulXV(o,s,V),m=F.b2Transform.MulXV(n,r,v);return F.b2Vec2.DotVV(F.b2Vec2.SubVV(m,a,F.b2Vec2.s_t0),this.m_axis);case 1:var c=F.b2Rot.MulRV(o.q,this.m_axis,x);a=F.b2Transform.MulXV(o,this.m_localPoint,V),r=this.m_proxyB.GetVertex(e),m=F.b2Transform.MulXV(n,r,v);return F.b2Vec2.DotVV(F.b2Vec2.SubVV(m,a,F.b2Vec2.s_t0),c);case 2:c=F.b2Rot.MulRV(n.q,this.m_axis,x),m=F.b2Transform.MulXV(n,this.m_localPoint,v),s=this.m_proxyA.GetVertex(t),a=F.b2Transform.MulXV(o,s,V);return F.b2Vec2.DotVV(F.b2Vec2.SubVV(a,m,F.b2Vec2.s_t0),c);default:return 0}},t}(),G("b2SeparationFunction",s),X=new i.b2Timer,U=new T.b2SimplexCache,W=new T.b2DistanceInput,Z=new T.b2DistanceOutput,H=new s,Q=[0],Y=[0],K=new F.b2Sweep,$=new F.b2Sweep}}}),System.register("Dynamics/b2TimeStep",["Common/b2Settings","Common/b2Math"],function(t,e){var i,o,n,s,r,a;e&&e.id;return{setters:[function(t){i=t},function(t){o=t}],execute:function(){n=function(){function t(){this.step=0,this.collide=0,this.solve=0,this.solveInit=0,this.solveVelocity=0,this.solvePosition=0,this.broadphase=0,this.solveTOI=0}return t.prototype.Reset=function(){return this.step=0,this.collide=0,this.solve=0,this.solveInit=0,this.solveVelocity=0,this.solvePosition=0,this.broadphase=0,this.solveTOI=0,this},t}(),t("b2Profile",n),s=function(){function t(){this.dt=0,this.inv_dt=0,this.dtRatio=0,this.velocityIterations=0,this.positionIterations=0,this.particleIterations=0,this.warmStarting=!1}return t.prototype.Copy=function(t){return this.dt=t.dt,this.inv_dt=t.inv_dt,this.dtRatio=t.dtRatio,this.positionIterations=t.positionIterations,this.velocityIterations=t.velocityIterations,this.particleIterations=t.particleIterations,this.warmStarting=t.warmStarting,this},t}(),t("b2TimeStep",s),r=function(){function e(){this.c=new o.b2Vec2,this.a=0}return e.MakeArray=function(t){return i.b2MakeArray(t,function(t){return new e})},e}(),t("b2Position",r),a=function(){function e(){this.v=new o.b2Vec2,this.w=0}return e.MakeArray=function(t){return i.b2MakeArray(t,function(t){return new e})},e}(),t("b2Velocity",a),t("b2SolverData",function(){this.step=new s,this.positions=null,this.velocities=null})}}}),System.register("Dynamics/Joints/b2Joint",["Common/b2Math"],function(i,t){var o,n,s,r,a,m;t&&t.id;return{setters:[function(t){o=t}],execute:function(){var t,e;(t=n||(n={}))[t.e_unknownJoint=0]="e_unknownJoint",t[t.e_revoluteJoint=1]="e_revoluteJoint",t[t.e_prismaticJoint=2]="e_prismaticJoint",t[t.e_distanceJoint=3]="e_distanceJoint",t[t.e_pulleyJoint=4]="e_pulleyJoint",t[t.e_mouseJoint=5]="e_mouseJoint",t[t.e_gearJoint=6]="e_gearJoint",t[t.e_wheelJoint=7]="e_wheelJoint",t[t.e_weldJoint=8]="e_weldJoint",t[t.e_frictionJoint=9]="e_frictionJoint",t[t.e_ropeJoint=10]="e_ropeJoint",t[t.e_motorJoint=11]="e_motorJoint",t[t.e_areaJoint=12]="e_areaJoint",i("b2JointType",n),(e=s||(s={}))[e.e_inactiveLimit=0]="e_inactiveLimit",e[e.e_atLowerLimit=1]="e_atLowerLimit",e[e.e_atUpperLimit=2]="e_atUpperLimit",e[e.e_equalLimits=3]="e_equalLimits",i("b2LimitState",s),r=function(){function t(){this.linear=new o.b2Vec2,this.angularA=0,this.angularB=0}return t.prototype.SetZero=function(){return this.linear.SetZero(),this.angularA=0,this.angularB=0,this},t.prototype.Set=function(t,e,i){return this.linear.Copy(t),this.angularA=e,this.angularB=i,this},t}(),i("b2Jacobian",r),i("b2JointEdge",a=function(){this.other=null,this.joint=null,this.prev=null,this.next=null}),i("b2JointDef",function(t){this.type=0,this.userData=null,this.bodyA=null,this.bodyB=null,this.collideConnected=!1,this.type=t}),m=function(){function t(t){this.m_type=0,this.m_prev=null,this.m_next=null,this.m_edgeA=new a,this.m_edgeB=new a,this.m_bodyA=null,this.m_bodyB=null,this.m_index=0,this.m_islandFlag=!1,this.m_collideConnected=!1,this.m_userData=null,this.m_type=t.type,this.m_bodyA=t.bodyA,this.m_bodyB=t.bodyB,this.m_collideConnected=t.collideConnected,this.m_userData=t.userData}return t.prototype.GetType=function(){return this.m_type},t.prototype.GetBodyA=function(){return this.m_bodyA},t.prototype.GetBodyB=function(){return this.m_bodyB},t.prototype.GetAnchorA=function(t){return t.SetZero()},t.prototype.GetAnchorB=function(t){return t.SetZero()},t.prototype.GetReactionForce=function(t,e){return e.SetZero()},t.prototype.GetReactionTorque=function(t){return 0},t.prototype.GetNext=function(){return this.m_next},t.prototype.GetUserData=function(){return this.m_userData},t.prototype.SetUserData=function(t){this.m_userData=t},t.prototype.IsActive=function(){return this.m_bodyA.IsActive()&&this.m_bodyB.IsActive()},t.prototype.GetCollideConnected=function(){return this.m_collideConnected},t.prototype.Dump=function(t){t("// Dump is not supported for this joint type.\n")},t.prototype.ShiftOrigin=function(t){},t.prototype.InitVelocityConstraints=function(t){},t.prototype.SolveVelocityConstraints=function(t){},t.prototype.SolvePositionConstraints=function(t){return!1},t}(),i("b2Joint",m)}}}),System.register("Dynamics/b2Fixture",["Common/b2Settings","Common/b2Math","Collision/b2Collision","Collision/Shapes/b2Shape"],function(t,e){var i,c,o,n,s,r,a;e&&e.id;return{setters:[function(t){i=t},function(t){c=t},function(t){o=t},function(t){n=t}],execute:function(){s=function(){function t(){this.categoryBits=1,this.maskBits=65535,this.groupIndex=0}return t.prototype.Clone=function(){return(new t).Copy(this)},t.prototype.Copy=function(t){return this.categoryBits=t.categoryBits,this.maskBits=t.maskBits,this.groupIndex=t.groupIndex,this},t}(),t("b2Filter",s),t("b2FixtureDef",function(){this.shape=null,this.userData=null,this.friction=.2,this.restitution=0,this.density=0,this.isSensor=!1,this.filter=new s}),r=function(){function e(){this.aabb=new o.b2AABB,this.fixture=null,this.childIndex=0,this.proxy=null}return e.MakeArray=function(t){return i.b2MakeArray(t,function(t){return new e})},e}(),t("b2FixtureProxy",r),a=function(){function m(){this.m_density=0,this.m_next=null,this.m_body=null,this.m_shape=null,this.m_friction=0,this.m_restitution=0,this.m_proxies=null,this.m_proxyCount=0,this.m_filter=new s,this.m_isSensor=!1,this.m_userData=null}return m.prototype.GetType=function(){return this.m_shape.GetType()},m.prototype.GetShape=function(){return this.m_shape},m.prototype.SetSensor=function(t){t!==this.m_isSensor&&(this.m_body.SetAwake(!0),this.m_isSensor=t)},m.prototype.IsSensor=function(){return this.m_isSensor},m.prototype.SetFilterData=function(t){this.m_filter.Copy(t),this.Refilter()},m.prototype.GetFilterData=function(){return this.m_filter},m.prototype.Refilter=function(){if(!this.m_body){for(var t=this.m_body.GetContactList();t;){var e=t.contact,i=e.GetFixtureA(),o=e.GetFixtureB();i!==this&&o!==this||e.FlagForFiltering(),t=t.next}var n=this.m_body.GetWorld();if(null!==n)for(var s=n.m_contactManager.m_broadPhase,r=0;r<this.m_proxyCount;++r)s.TouchProxy(this.m_proxies[r].proxy)}},m.prototype.GetBody=function(){return this.m_body},m.prototype.GetNext=function(){return this.m_next},m.prototype.GetUserData=function(){return this.m_userData},m.prototype.SetUserData=function(t){this.m_userData=t},m.prototype.TestPoint=function(t){return this.m_shape.TestPoint(this.m_body.GetTransform(),t)},m.prototype.ComputeDistance=function(t,e,i){return this.m_shape.ComputeDistance(this.m_body.GetTransform(),t,e,i)},m.prototype.RayCast=function(t,e,i){return this.m_shape.RayCast(t,e,this.m_body.GetTransform(),i)},m.prototype.GetMassData=function(t){return void 0===t&&(t=new n.b2MassData),this.m_shape.ComputeMass(t,this.m_density),t},m.prototype.SetDensity=function(t){this.m_density=t},m.prototype.GetDensity=function(){return this.m_density},m.prototype.GetFriction=function(){return this.m_friction},m.prototype.SetFriction=function(t){this.m_friction=t},m.prototype.GetRestitution=function(){return this.m_restitution},m.prototype.SetRestitution=function(t){this.m_restitution=t},m.prototype.GetAABB=function(t){return this.m_proxies[t].aabb},m.prototype.Dump=function(t,e){t("    const fd: b2FixtureDef = new b2FixtureDef();\n"),t("    fd.friction = %.15f;\n",this.m_friction),t("    fd.restitution = %.15f;\n",this.m_restitution),t("    fd.density = %.15f;\n",this.m_density),t("    fd.isSensor = %s;\n",this.m_isSensor?"true":"false"),t("    fd.filter.categoryBits = %d;\n",this.m_filter.categoryBits),t("    fd.filter.maskBits = %d;\n",this.m_filter.maskBits),t("    fd.filter.groupIndex = %d;\n",this.m_filter.groupIndex),this.m_shape.Dump(t),t("\n"),t("    fd.shape = shape;\n"),t("\n"),t("    bodies[%d].CreateFixture(fd);\n",e)},m.prototype.Create=function(t,e){this.m_userData=e.userData,this.m_friction=e.friction,this.m_restitution=e.restitution,this.m_body=t,this.m_next=null,this.m_filter.Copy(e.filter),this.m_isSensor=e.isSensor,this.m_shape=e.shape.Clone(),this.m_proxies=r.MakeArray(this.m_shape.GetChildCount()),this.m_proxyCount=0,this.m_density=e.density},m.prototype.Destroy=function(){this.m_shape=null},m.prototype.CreateProxies=function(t,e){this.m_proxyCount=this.m_shape.GetChildCount();for(var i=0;i<this.m_proxyCount;++i){var o=this.m_proxies[i];this.m_shape.ComputeAABB(o.aabb,e,i),o.proxy=t.CreateProxy(o.aabb,o),o.fixture=this,o.childIndex=i}},m.prototype.DestroyProxies=function(t){for(var e=0;e<this.m_proxyCount;++e){var i=this.m_proxies[e];t.DestroyProxy(i.proxy),i.proxy=null}this.m_proxyCount=0},m.prototype.Synchronize=function(t,e,i){if(0!==this.m_proxyCount)for(var o=0;o<this.m_proxyCount;++o){var n=this.m_proxies[o],s=m.Synchronize_s_aabb1,r=m.Synchronize_s_aabb2;this.m_shape.ComputeAABB(s,e,o),this.m_shape.ComputeAABB(r,i,o),n.aabb.Combine2(s,r);var a=c.b2Vec2.SubVV(i.p,e.p,m.Synchronize_s_displacement);t.MoveProxy(n.proxy,n.aabb,a)}},m.Synchronize_s_aabb1=new o.b2AABB,m.Synchronize_s_aabb2=new o.b2AABB,m.Synchronize_s_displacement=new c.b2Vec2,m}(),t("b2Fixture",a)}}}),System.register("Collision/Shapes/b2EdgeShape",["Common/b2Settings","Common/b2Math","Collision/Shapes/b2Shape"],function(t,e){var i,V,o,n;e&&e.id;return{setters:[function(t){i=t},function(t){V=t},function(t){o=t}],execute:function(){n=function(e){function b(){var t=e.call(this,1,i.b2_polygonRadius)||this;return t.m_vertex1=new V.b2Vec2,t.m_vertex2=new V.b2Vec2,t.m_vertex0=new V.b2Vec2,t.m_vertex3=new V.b2Vec2,t.m_hasVertex0=!1,t.m_hasVertex3=!1,t}return __extends(b,e),b.prototype.Set=function(t,e){return this.m_vertex1.Copy(t),this.m_vertex2.Copy(e),this.m_hasVertex0=!1,this.m_hasVertex3=!1,this},b.prototype.Clone=function(){return(new b).Copy(this)},b.prototype.Copy=function(t){return e.prototype.Copy.call(this,t),this.m_vertex1.Copy(t.m_vertex1),this.m_vertex2.Copy(t.m_vertex2),this.m_vertex0.Copy(t.m_vertex0),this.m_vertex3.Copy(t.m_vertex3),this.m_hasVertex0=t.m_hasVertex0,this.m_hasVertex3=t.m_hasVertex3,this},b.prototype.GetChildCount=function(){return 1},b.prototype.TestPoint=function(t,e){return!1},b.prototype.ComputeDistance=function(t,e,i,o){var n=V.b2Transform.MulXV(t,this.m_vertex1,b.ComputeDistance_s_v1),s=V.b2Transform.MulXV(t,this.m_vertex2,b.ComputeDistance_s_v2),r=V.b2Vec2.SubVV(e,n,b.ComputeDistance_s_d),a=V.b2Vec2.SubVV(s,n,b.ComputeDistance_s_s),m=V.b2Vec2.DotVV(r,a);if(0<m){var c=V.b2Vec2.DotVV(a,a);c<m?V.b2Vec2.SubVV(e,s,r):r.SelfMulSub(m/c,a)}return i.Copy(r),i.Normalize()},b.prototype.RayCast=function(t,e,i,o){var n=V.b2Transform.MulTXV(i,e.p1,b.RayCast_s_p1),s=V.b2Transform.MulTXV(i,e.p2,b.RayCast_s_p2),r=V.b2Vec2.SubVV(s,n,b.RayCast_s_d),a=this.m_vertex1,m=this.m_vertex2,c=V.b2Vec2.SubVV(m,a,b.RayCast_s_e),_=t.normal.Set(c.y,-c.x).SelfNormalize(),l=V.b2Vec2.DotVV(_,V.b2Vec2.SubVV(a,n,V.b2Vec2.s_t0)),h=V.b2Vec2.DotVV(_,r);if(0===h)return!1;var u=l/h;if(u<0||e.maxFraction<u)return!1;var p=V.b2Vec2.AddVMulSV(n,u,r,b.RayCast_s_q),f=V.b2Vec2.SubVV(m,a,b.RayCast_s_r),d=V.b2Vec2.DotVV(f,f);if(0===d)return!1;var y=V.b2Vec2.DotVV(V.b2Vec2.SubVV(p,a,V.b2Vec2.s_t0),f)/d;return!(y<0||1<y)&&(t.fraction=u,V.b2Rot.MulRV(i.q,t.normal,t.normal),0<l&&t.normal.SelfNeg(),!0)},b.prototype.ComputeAABB=function(t,e,i){var o=V.b2Transform.MulXV(e,this.m_vertex1,b.ComputeAABB_s_v1),n=V.b2Transform.MulXV(e,this.m_vertex2,b.ComputeAABB_s_v2);V.b2Vec2.MinV(o,n,t.lowerBound),V.b2Vec2.MaxV(o,n,t.upperBound);var s=this.m_radius;t.lowerBound.SelfSubXY(s,s),t.upperBound.SelfAddXY(s,s)},b.prototype.ComputeMass=function(t,e){t.mass=0,V.b2Vec2.MidVV(this.m_vertex1,this.m_vertex2,t.center),t.I=0},b.prototype.SetupDistanceProxy=function(t,e){t.m_vertices=t.m_buffer,t.m_vertices[0].Copy(this.m_vertex1),t.m_vertices[1].Copy(this.m_vertex2),t.m_count=2,t.m_radius=this.m_radius},b.prototype.ComputeSubmergedArea=function(t,e,i,o){return o.SetZero(),0},b.prototype.Dump=function(t){t("    const shape: b2EdgeShape = new b2EdgeShape();\n"),t("    shape.m_radius = %.15f;\n",this.m_radius),t("    shape.m_vertex0.Set(%.15f, %.15f);\n",this.m_vertex0.x,this.m_vertex0.y),t("    shape.m_vertex1.Set(%.15f, %.15f);\n",this.m_vertex1.x,this.m_vertex1.y),t("    shape.m_vertex2.Set(%.15f, %.15f);\n",this.m_vertex2.x,this.m_vertex2.y),t("    shape.m_vertex3.Set(%.15f, %.15f);\n",this.m_vertex3.x,this.m_vertex3.y),t("    shape.m_hasVertex0 = %s;\n",this.m_hasVertex0),t("    shape.m_hasVertex3 = %s;\n",this.m_hasVertex3)},b.ComputeDistance_s_v1=new V.b2Vec2,b.ComputeDistance_s_v2=new V.b2Vec2,b.ComputeDistance_s_d=new V.b2Vec2,b.ComputeDistance_s_s=new V.b2Vec2,b.RayCast_s_p1=new V.b2Vec2,b.RayCast_s_p2=new V.b2Vec2,b.RayCast_s_d=new V.b2Vec2,b.RayCast_s_e=new V.b2Vec2,b.RayCast_s_q=new V.b2Vec2,b.RayCast_s_r=new V.b2Vec2,b.ComputeAABB_s_v1=new V.b2Vec2,b.ComputeAABB_s_v2=new V.b2Vec2,b}(o.b2Shape),t("b2EdgeShape",n)}}}),System.register("Collision/Shapes/b2ChainShape",["Common/b2Settings","Common/b2Math","Collision/Shapes/b2Shape","Collision/Shapes/b2EdgeShape"],function(t,e){var i,m,o,n,s;e&&e.id;return{setters:[function(t){i=t},function(t){m=t},function(t){o=t},function(t){n=t}],execute:function(){s=function(e){function a(){var t=e.call(this,3,i.b2_polygonRadius)||this;return t.m_count=0,t.m_prevVertex=new m.b2Vec2,t.m_nextVertex=new m.b2Vec2,t.m_hasPrevVertex=!1,t.m_hasNextVertex=!1,t}return __extends(a,e),a.prototype.CreateLoop=function(t,e){void 0===e&&(e=t.length),this.m_count=e+1,this.m_vertices=m.b2Vec2.MakeArray(this.m_count);for(var i=0;i<e;++i)this.m_vertices[i].Copy(t[i]);return this.m_vertices[e].Copy(this.m_vertices[0]),this.m_prevVertex.Copy(this.m_vertices[this.m_count-2]),this.m_nextVertex.Copy(this.m_vertices[1]),this.m_hasPrevVertex=!0,this.m_hasNextVertex=!0,this},a.prototype.CreateChain=function(t,e){void 0===e&&(e=t.length),this.m_count=e,this.m_vertices=m.b2Vec2.MakeArray(e);for(var i=0;i<e;++i)this.m_vertices[i].Copy(t[i]);return this.m_hasPrevVertex=!1,this.m_hasNextVertex=!1,this.m_prevVertex.SetZero(),this.m_nextVertex.SetZero(),this},a.prototype.SetPrevVertex=function(t){return this.m_prevVertex.Copy(t),this.m_hasPrevVertex=!0,this},a.prototype.SetNextVertex=function(t){return this.m_nextVertex.Copy(t),this.m_hasNextVertex=!0,this},a.prototype.Clone=function(){return(new a).Copy(this)},a.prototype.Copy=function(t){return e.prototype.Copy.call(this,t),this.CreateChain(t.m_vertices,t.m_count),this.m_prevVertex.Copy(t.m_prevVertex),this.m_nextVertex.Copy(t.m_nextVertex),this.m_hasPrevVertex=t.m_hasPrevVertex,this.m_hasNextVertex=t.m_hasNextVertex,this},a.prototype.GetChildCount=function(){return this.m_count-1},a.prototype.GetChildEdge=function(t,e){t.m_type=1,t.m_radius=this.m_radius,t.m_vertex1.Copy(this.m_vertices[e]),t.m_vertex2.Copy(this.m_vertices[e+1]),0<e?(t.m_vertex0.Copy(this.m_vertices[e-1]),t.m_hasVertex0=!0):(t.m_vertex0.Copy(this.m_prevVertex),t.m_hasVertex0=this.m_hasPrevVertex),e<this.m_count-2?(t.m_vertex3.Copy(this.m_vertices[e+2]),t.m_hasVertex3=!0):(t.m_vertex3.Copy(this.m_nextVertex),t.m_hasVertex3=this.m_hasNextVertex)},a.prototype.TestPoint=function(t,e){return!1},a.prototype.ComputeDistance=function(t,e,i,o){var n=a.ComputeDistance_s_edgeShape;return this.GetChildEdge(n,o),n.ComputeDistance(t,e,i,0)},a.prototype.RayCast=function(t,e,i,o){var n=a.RayCast_s_edgeShape;return n.m_vertex1.Copy(this.m_vertices[o]),n.m_vertex2.Copy(this.m_vertices[(o+1)%this.m_count]),n.RayCast(t,e,i,0)},a.prototype.ComputeAABB=function(t,e,i){var o=this.m_vertices[i],n=this.m_vertices[(i+1)%this.m_count],s=m.b2Transform.MulXV(e,o,a.ComputeAABB_s_v1),r=m.b2Transform.MulXV(e,n,a.ComputeAABB_s_v2);m.b2Vec2.MinV(s,r,t.lowerBound),m.b2Vec2.MaxV(s,r,t.upperBound)},a.prototype.ComputeMass=function(t,e){t.mass=0,t.center.SetZero(),t.I=0},a.prototype.SetupDistanceProxy=function(t,e){t.m_vertices=t.m_buffer,t.m_vertices[0].Copy(this.m_vertices[e]),e+1<this.m_count?t.m_vertices[1].Copy(this.m_vertices[e+1]):t.m_vertices[1].Copy(this.m_vertices[0]),t.m_count=2,t.m_radius=this.m_radius},a.prototype.ComputeSubmergedArea=function(t,e,i,o){return o.SetZero(),0},a.prototype.Dump=function(t){t("    const shape: b2ChainShape = new b2ChainShape();\n"),t("    const vs: b2Vec2[] = b2Vec2.MakeArray(%d);\n",i.b2_maxPolygonVertices);for(var e=0;e<this.m_count;++e)t("    vs[%d].Set(%.15f, %.15f);\n",e,this.m_vertices[e].x,this.m_vertices[e].y);t("    shape.CreateChain(vs, %d);\n",this.m_count),t("    shape.m_prevVertex.Set(%.15f, %.15f);\n",this.m_prevVertex.x,this.m_prevVertex.y),t("    shape.m_nextVertex.Set(%.15f, %.15f);\n",this.m_nextVertex.x,this.m_nextVertex.y),t("    shape.m_hasPrevVertex = %s;\n",this.m_hasPrevVertex?"true":"false"),t("    shape.m_hasNextVertex = %s;\n",this.m_hasNextVertex?"true":"false")},a.ComputeDistance_s_edgeShape=new n.b2EdgeShape,a.RayCast_s_edgeShape=new n.b2EdgeShape,a.ComputeAABB_s_v1=new m.b2Vec2,a.ComputeAABB_s_v2=new m.b2Vec2,a}(o.b2Shape),t("b2ChainShape",s)}}}),System.register("Collision/Shapes/b2CircleShape",["Common/b2Settings","Common/b2Math","Collision/Shapes/b2Shape"],function(t,e){var u,p,i,o;e&&e.id;return{setters:[function(t){u=t},function(t){p=t},function(t){i=t}],execute:function(){o=function(i){function h(t){void 0===t&&(t=0);var e=i.call(this,0,t)||this;return e.m_p=new p.b2Vec2,e}return __extends(h,i),h.prototype.Clone=function(){return(new h).Copy(this)},h.prototype.Copy=function(t){return i.prototype.Copy.call(this,t),this.m_p.Copy(t.m_p),this},h.prototype.GetChildCount=function(){return 1},h.prototype.TestPoint=function(t,e){var i=p.b2Transform.MulXV(t,this.m_p,h.TestPoint_s_center),o=p.b2Vec2.SubVV(e,i,h.TestPoint_s_d);return p.b2Vec2.DotVV(o,o)<=p.b2Sq(this.m_radius)},h.prototype.ComputeDistance=function(t,e,i,o){var n=p.b2Transform.MulXV(t,this.m_p,h.ComputeDistance_s_center);return p.b2Vec2.SubVV(e,n,i),i.Normalize()-this.m_radius},h.prototype.RayCast=function(t,e,i,o){var n=p.b2Transform.MulXV(i,this.m_p,h.RayCast_s_position),s=p.b2Vec2.SubVV(e.p1,n,h.RayCast_s_s),r=p.b2Vec2.DotVV(s,s)-p.b2Sq(this.m_radius),a=p.b2Vec2.SubVV(e.p2,e.p1,h.RayCast_s_r),m=p.b2Vec2.DotVV(s,a),c=p.b2Vec2.DotVV(a,a),_=m*m-c*r;if(_<0||c<u.b2_epsilon)return!1;var l=-(m+p.b2Sqrt(_));return 0<=l&&l<=e.maxFraction*c&&(l/=c,t.fraction=l,p.b2Vec2.AddVMulSV(s,l,a,t.normal).SelfNormalize(),!0)},h.prototype.ComputeAABB=function(t,e,i){var o=p.b2Transform.MulXV(e,this.m_p,h.ComputeAABB_s_p);t.lowerBound.Set(o.x-this.m_radius,o.y-this.m_radius),t.upperBound.Set(o.x+this.m_radius,o.y+this.m_radius)},h.prototype.ComputeMass=function(t,e){var i=p.b2Sq(this.m_radius);t.mass=e*u.b2_pi*i,t.center.Copy(this.m_p),t.I=t.mass*(.5*i+p.b2Vec2.DotVV(this.m_p,this.m_p))},h.prototype.SetupDistanceProxy=function(t,e){t.m_vertices=t.m_buffer,t.m_vertices[0].Copy(this.m_p),t.m_count=1,t.m_radius=this.m_radius},h.prototype.ComputeSubmergedArea=function(t,e,i,o){var n=p.b2Transform.MulXV(i,this.m_p,new p.b2Vec2),s=-(p.b2Vec2.DotVV(t,n)-e);if(s<-this.m_radius+u.b2_epsilon)return 0;if(s>this.m_radius)return o.Copy(n),u.b2_pi*this.m_radius*this.m_radius;var r=this.m_radius*this.m_radius,a=s*s,m=r*(p.b2Asin(s/this.m_radius)+u.b2_pi/2)+s*p.b2Sqrt(r-a),c=-2/3*p.b2Pow(r-a,1.5)/m;return o.x=n.x+t.x*c,o.y=n.y+t.y*c,m},h.prototype.Dump=function(t){t("    const shape: b2CircleShape = new b2CircleShape();\n"),t("    shape.m_radius = %.15f;\n",this.m_radius),t("    shape.m_p.Set(%.15f, %.15f);\n",this.m_p.x,this.m_p.y)},h.TestPoint_s_center=new p.b2Vec2,h.TestPoint_s_d=new p.b2Vec2,h.ComputeDistance_s_center=new p.b2Vec2,h.RayCast_s_position=new p.b2Vec2,h.RayCast_s_s=new p.b2Vec2,h.RayCast_s_r=new p.b2Vec2,h.ComputeAABB_s_p=new p.b2Vec2,h}(i.b2Shape),t("b2CircleShape",o)}}}),System.register("Collision/Shapes/b2PolygonShape",["Common/b2Settings","Common/b2Math","Collision/Shapes/b2Shape"],function(t,e){var w,M,o,i,n;e&&e.id;return{setters:[function(t){w=t},function(t){M=t},function(t){i=o=t}],execute:function(){n=function(i){function g(){var t=i.call(this,2,w.b2_polygonRadius)||this;return t.m_centroid=new M.b2Vec2(0,0),t.m_vertices=M.b2Vec2.MakeArray(w.b2_maxPolygonVertices),t.m_normals=M.b2Vec2.MakeArray(w.b2_maxPolygonVertices),t.m_count=0,t}return __extends(g,i),g.prototype.Clone=function(){return(new g).Copy(this)},g.prototype.Copy=function(t){i.prototype.Copy.call(this,t),this.m_centroid.Copy(t.m_centroid),this.m_count=t.m_count;for(var e=0;e<this.m_count;++e)this.m_vertices[e].Copy(t.m_vertices[e]),this.m_normals[e].Copy(t.m_normals[e]);return this},g.prototype.GetChildCount=function(){return 1},g.prototype.Set=function(t,e,i){if(void 0===e&&(e=t.length),void 0===i&&(i=0),e<3)return this.SetAsBox(1,1);for(var o=M.b2Min(e,w.b2_maxPolygonVertices),n=g.Set_s_ps,s=0,r=0;r<o;++r){for(var a=t[i+r],m=!0,c=0;c<s;++c)if(M.b2Vec2.DistanceSquaredVV(a,n[c])<.5*w.b2_linearSlop*(.5*w.b2_linearSlop)){m=!1;break}m&&n[s++].Copy(a)}if((o=s)<3)return this.SetAsBox(1,1);var _=0,l=n[0].x;for(r=1;r<o;++r){var h=n[r].x;(l<h||h===l&&n[r].y<n[_].y)&&(_=r,l=h)}for(var u=g.Set_s_hull,p=0,f=_;;){u[p]=f;var d=0;for(c=1;c<o;++c)if(d!==f){var y=M.b2Vec2.SubVV(n[d],n[u[p]],g.Set_s_r),b=(a=M.b2Vec2.SubVV(n[c],n[u[p]],g.Set_s_v),M.b2Vec2.CrossVV(y,a));b<0&&(d=c),0===b&&a.LengthSquared()>y.LengthSquared()&&(d=c)}else d=c;if(++p,(f=d)===_)break}this.m_count=p;for(r=0;r<p;++r)this.m_vertices[r].Copy(n[u[r]]);for(r=0;r<p;++r){var V=this.m_vertices[r],v=this.m_vertices[(r+1)%p],x=M.b2Vec2.SubVV(v,V,M.b2Vec2.s_t0);M.b2Vec2.CrossVOne(x,this.m_normals[r]).SelfNormalize()}return g.ComputeCentroid(this.m_vertices,p,this.m_centroid),this},g.prototype.SetAsArray=function(t,e){return void 0===e&&(e=t.length),this.Set(t,e)},g.prototype.SetAsBox=function(t,e,i,o){if(void 0===o&&(o=0),this.m_count=4,this.m_vertices[0].Set(-t,-e),this.m_vertices[1].Set(t,-e),this.m_vertices[2].Set(t,e),this.m_vertices[3].Set(-t,e),this.m_normals[0].Set(0,-1),this.m_normals[1].Set(1,0),this.m_normals[2].Set(0,1),this.m_normals[3].Set(-1,0),this.m_centroid.SetZero(),i instanceof M.b2Vec2){this.m_centroid.Copy(i);var n=new M.b2Transform;n.SetPosition(i),n.SetRotationAngle(o);for(var s=0;s<this.m_count;++s)M.b2Transform.MulXV(n,this.m_vertices[s],this.m_vertices[s]),M.b2Rot.MulRV(n.q,this.m_normals[s],this.m_normals[s])}return this},g.prototype.TestPoint=function(t,e){for(var i=M.b2Transform.MulTXV(t,e,g.TestPoint_s_pLocal),o=0;o<this.m_count;++o){if(0<M.b2Vec2.DotVV(this.m_normals[o],M.b2Vec2.SubVV(i,this.m_vertices[o],M.b2Vec2.s_t0)))return!1}return!0},g.prototype.ComputeDistance=function(t,e,i,o){for(var n=M.b2Transform.MulTXV(t,e,g.ComputeDistance_s_pLocal),s=-w.b2_maxFloat,r=g.ComputeDistance_s_normalForMaxDistance.Copy(n),a=0;a<this.m_count;++a){var m=M.b2Vec2.DotVV(this.m_normals[a],M.b2Vec2.SubVV(n,this.m_vertices[a],M.b2Vec2.s_t0));s<m&&(s=m,r.Copy(this.m_normals[a]))}if(0<s){var c=g.ComputeDistance_s_minDistance.Copy(r),_=s*s;for(a=0;a<this.m_count;++a){var l=M.b2Vec2.SubVV(n,this.m_vertices[a],g.ComputeDistance_s_distance),h=l.LengthSquared();h<_&&(c.Copy(l),_=h)}return M.b2Rot.MulRV(t.q,c,i),i.Normalize(),Math.sqrt(_)}return M.b2Rot.MulRV(t.q,r,i),s},g.prototype.RayCast=function(t,e,i,o){for(var n=M.b2Transform.MulTXV(i,e.p1,g.RayCast_s_p1),s=M.b2Transform.MulTXV(i,e.p2,g.RayCast_s_p2),r=M.b2Vec2.SubVV(s,n,g.RayCast_s_d),a=0,m=e.maxFraction,c=-1,_=0;_<this.m_count;++_){var l=M.b2Vec2.DotVV(this.m_normals[_],M.b2Vec2.SubVV(this.m_vertices[_],n,M.b2Vec2.s_t0)),h=M.b2Vec2.DotVV(this.m_normals[_],r);if(0===h){if(l<0)return!1}else h<0&&l<a*h?(a=l/h,c=_):0<h&&l<m*h&&(m=l/h);if(m<a)return!1}return 0<=c&&(t.fraction=a,M.b2Rot.MulRV(i.q,this.m_normals[c],t.normal),!0)},g.prototype.ComputeAABB=function(t,e,i){for(var o=M.b2Transform.MulXV(e,this.m_vertices[0],t.lowerBound),n=t.upperBound.Copy(o),s=0;s<this.m_count;++s){var r=M.b2Transform.MulXV(e,this.m_vertices[s],g.ComputeAABB_s_v);M.b2Vec2.MinV(r,o,o),M.b2Vec2.MaxV(r,n,n)}var a=this.m_radius;o.SelfSubXY(a,a),n.SelfAddXY(a,a)},g.prototype.ComputeMass=function(t,e){for(var i=g.ComputeMass_s_center.SetZero(),o=0,n=0,s=g.ComputeMass_s_s.SetZero(),r=0;r<this.m_count;++r)s.SelfAdd(this.m_vertices[r]);s.SelfMul(1/this.m_count);for(r=0;r<this.m_count;++r){var a=M.b2Vec2.SubVV(this.m_vertices[r],s,g.ComputeMass_s_e1),m=M.b2Vec2.SubVV(this.m_vertices[(r+1)%this.m_count],s,g.ComputeMass_s_e2),c=M.b2Vec2.CrossVV(a,m),_=.5*c;o+=_,i.SelfAdd(M.b2Vec2.MulSV(_*(1/3),M.b2Vec2.AddVV(a,m,M.b2Vec2.s_t0),M.b2Vec2.s_t1));var l=a.x,h=a.y,u=m.x,p=m.y;n+=1/3*.25*c*(l*l+u*l+u*u+(h*h+p*h+p*p))}t.mass=e*o,i.SelfMul(1/o),M.b2Vec2.AddVV(i,s,t.center),t.I=e*n,t.I+=t.mass*(M.b2Vec2.DotVV(t.center,t.center)-M.b2Vec2.DotVV(i,i))},g.prototype.Validate=function(){for(var t=0;t<this.m_count;++t)for(var e=t,i=(t+1)%this.m_count,o=this.m_vertices[e],n=M.b2Vec2.SubVV(this.m_vertices[i],o,g.Validate_s_e),s=0;s<this.m_count;++s)if(s!==e&&s!==i){var r=M.b2Vec2.SubVV(this.m_vertices[s],o,g.Validate_s_v);if(M.b2Vec2.CrossVV(n,r)<0)return!1}return!0},g.prototype.SetupDistanceProxy=function(t,e){t.m_vertices=this.m_vertices,t.m_count=this.m_count,t.m_radius=this.m_radius},g.prototype.ComputeSubmergedArea=function(t,e,i,o){for(var n=M.b2Rot.MulTRV(i.q,t,g.ComputeSubmergedArea_s_normalL),s=e-M.b2Vec2.DotVV(t,i.p),r=g.ComputeSubmergedArea_s_depths,a=0,m=-1,c=-1,_=!1,l=0;l<this.m_count;++l){r[l]=M.b2Vec2.DotVV(n,this.m_vertices[l])-s;var h=r[l]<-w.b2_epsilon;0<l&&(h?_||(m=l-1,a++):_&&(c=l-1,a++)),_=h}switch(a){case 0:if(_){var u=g.ComputeSubmergedArea_s_md;return this.ComputeMass(u,1),M.b2Transform.MulXV(i,u.center,o),u.mass}return 0;case 1:-1===m?m=this.m_count-1:c=this.m_count-1}for(var p,f=(m+1)%this.m_count,d=(c+1)%this.m_count,y=(0-r[m])/(r[f]-r[m]),b=(0-r[c])/(r[d]-r[c]),V=g.ComputeSubmergedArea_s_intoVec.Set(this.m_vertices[m].x*(1-y)+this.m_vertices[f].x*y,this.m_vertices[m].y*(1-y)+this.m_vertices[f].y*y),v=g.ComputeSubmergedArea_s_outoVec.Set(this.m_vertices[c].x*(1-b)+this.m_vertices[d].x*b,this.m_vertices[c].y*(1-b)+this.m_vertices[d].y*b),x=0,C=g.ComputeSubmergedArea_s_center.SetZero(),S=this.m_vertices[f],B=f;B!==d;){p=(B=(B+1)%this.m_count)===d?v:this.m_vertices[B];var A=.5*((S.x-V.x)*(p.y-V.y)-(S.y-V.y)*(p.x-V.x));x+=A,C.x+=A*(V.x+S.x+p.x)/3,C.y+=A*(V.y+S.y+p.y)/3,S=p}return C.SelfMul(1/x),M.b2Transform.MulXV(i,C,o),x},g.prototype.Dump=function(t){t("    const shape: b2PolygonShape = new b2PolygonShape();\n"),t("    const vs: b2Vec2[] = b2Vec2.MakeArray(%d);\n",w.b2_maxPolygonVertices);for(var e=0;e<this.m_count;++e)t("    vs[%d].Set(%.15f, %.15f);\n",e,this.m_vertices[e].x,this.m_vertices[e].y);t("    shape.Set(vs, %d);\n",this.m_count)},g.ComputeCentroid=function(t,e,i){var o=i;o.SetZero();for(var n=0,s=g.ComputeCentroid_s_pRef.SetZero(),r=0;r<e;++r){var a=s,m=t[r],c=t[(r+1)%e],_=M.b2Vec2.SubVV(m,a,g.ComputeCentroid_s_e1),l=M.b2Vec2.SubVV(c,a,g.ComputeCentroid_s_e2),h=.5*M.b2Vec2.CrossVV(_,l);n+=h,o.x+=h*(1/3)*(a.x+m.x+c.x),o.y+=h*(1/3)*(a.y+m.y+c.y)}return o.SelfMul(1/n),o},g.Set_s_ps=M.b2Vec2.MakeArray(w.b2_maxPolygonVertices),g.Set_s_hull=w.b2MakeNumberArray(w.b2_maxPolygonVertices),g.Set_s_r=new M.b2Vec2,g.Set_s_v=new M.b2Vec2,g.TestPoint_s_pLocal=new M.b2Vec2,g.ComputeDistance_s_pLocal=new M.b2Vec2,g.ComputeDistance_s_normalForMaxDistance=new M.b2Vec2,g.ComputeDistance_s_minDistance=new M.b2Vec2,g.ComputeDistance_s_distance=new M.b2Vec2,g.RayCast_s_p1=new M.b2Vec2,g.RayCast_s_p2=new M.b2Vec2,g.RayCast_s_d=new M.b2Vec2,g.ComputeAABB_s_v=new M.b2Vec2,g.ComputeMass_s_center=new M.b2Vec2,g.ComputeMass_s_s=new M.b2Vec2,g.ComputeMass_s_e1=new M.b2Vec2,g.ComputeMass_s_e2=new M.b2Vec2,g.Validate_s_e=new M.b2Vec2,g.Validate_s_v=new M.b2Vec2,g.ComputeSubmergedArea_s_normalL=new M.b2Vec2,g.ComputeSubmergedArea_s_depths=w.b2MakeNumberArray(w.b2_maxPolygonVertices),g.ComputeSubmergedArea_s_md=new o.b2MassData,g.ComputeSubmergedArea_s_intoVec=new M.b2Vec2,g.ComputeSubmergedArea_s_outoVec=new M.b2Vec2,g.ComputeSubmergedArea_s_center=new M.b2Vec2,g.ComputeCentroid_s_pRef=new M.b2Vec2,g.ComputeCentroid_s_e1=new M.b2Vec2,g.ComputeCentroid_s_e2=new M.b2Vec2,g}(i.b2Shape),t("b2PolygonShape",n)}}}),System.register("Dynamics/Joints/b2DistanceJoint",["Common/b2Settings","Common/b2Math","Dynamics/Joints/b2Joint"],function(t,e){var C,S,i,o,n;e&&e.id;return{setters:[function(t){C=t},function(t){S=t},function(t){i=t}],execute:function(){o=function(e){function t(){var t=e.call(this,3)||this;return t.localAnchorA=new S.b2Vec2,t.localAnchorB=new S.b2Vec2,t.length=1,t.frequencyHz=0,t.dampingRatio=0,t}return __extends(t,e),t.prototype.Initialize=function(t,e,i,o){this.bodyA=t,this.bodyB=e,this.bodyA.GetLocalPoint(i,this.localAnchorA),this.bodyB.GetLocalPoint(o,this.localAnchorB),this.length=S.b2Vec2.DistanceVV(i,o),this.frequencyHz=0,this.dampingRatio=0},t}(i.b2JointDef),t("b2DistanceJointDef",o),n=function(i){function x(t){var e=i.call(this,t)||this;return e.m_frequencyHz=0,e.m_dampingRatio=0,e.m_bias=0,e.m_localAnchorA=new S.b2Vec2,e.m_localAnchorB=new S.b2Vec2,e.m_gamma=0,e.m_impulse=0,e.m_length=0,e.m_indexA=0,e.m_indexB=0,e.m_u=new S.b2Vec2,e.m_rA=new S.b2Vec2,e.m_rB=new S.b2Vec2,e.m_localCenterA=new S.b2Vec2,e.m_localCenterB=new S.b2Vec2,e.m_invMassA=0,e.m_invMassB=0,e.m_invIA=0,e.m_invIB=0,e.m_mass=0,e.m_qA=new S.b2Rot,e.m_qB=new S.b2Rot,e.m_lalcA=new S.b2Vec2,e.m_lalcB=new S.b2Vec2,e.m_frequencyHz=t.frequencyHz,e.m_dampingRatio=t.dampingRatio,e.m_localAnchorA.Copy(t.localAnchorA),e.m_localAnchorB.Copy(t.localAnchorB),e.m_length=t.length,e}return __extends(x,i),x.prototype.GetAnchorA=function(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)},x.prototype.GetAnchorB=function(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)},x.prototype.GetReactionForce=function(t,e){return e.Set(t*this.m_impulse*this.m_u.x,t*this.m_impulse*this.m_u.y)},x.prototype.GetReactionTorque=function(t){return 0},x.prototype.GetLocalAnchorA=function(){return this.m_localAnchorA},x.prototype.GetLocalAnchorB=function(){return this.m_localAnchorB},x.prototype.SetLength=function(t){this.m_length=t},x.prototype.Length=function(){return this.m_length},x.prototype.SetFrequency=function(t){this.m_frequencyHz=t},x.prototype.GetFrequency=function(){return this.m_frequencyHz},x.prototype.SetDampingRatio=function(t){this.m_dampingRatio=t},x.prototype.GetDampingRatio=function(){return this.m_dampingRatio},x.prototype.Dump=function(t){var e=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex;t("  const jd: b2DistanceJointDef = new b2DistanceJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",i),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.m_localAnchorA.x,this.m_localAnchorA.y),t("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.m_localAnchorB.x,this.m_localAnchorB.y),t("  jd.length = %.15f;\n",this.m_length),t("  jd.frequencyHz = %.15f;\n",this.m_frequencyHz),t("  jd.dampingRatio = %.15f;\n",this.m_dampingRatio),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)},x.prototype.InitVelocityConstraints=function(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;var e=t.positions[this.m_indexA].c,i=t.positions[this.m_indexA].a,o=t.velocities[this.m_indexA].v,n=t.velocities[this.m_indexA].w,s=t.positions[this.m_indexB].c,r=t.positions[this.m_indexB].a,a=t.velocities[this.m_indexB].v,m=t.velocities[this.m_indexB].w,c=this.m_qA.SetAngle(i),_=this.m_qB.SetAngle(r);S.b2Vec2.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA),S.b2Rot.MulRV(c,this.m_lalcA,this.m_rA),S.b2Vec2.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB),S.b2Rot.MulRV(_,this.m_lalcB,this.m_rB),this.m_u.x=s.x+this.m_rB.x-e.x-this.m_rA.x,this.m_u.y=s.y+this.m_rB.y-e.y-this.m_rA.y;var l=this.m_u.Length();l>C.b2_linearSlop?this.m_u.SelfMul(1/l):this.m_u.SetZero();var h=S.b2Vec2.CrossVV(this.m_rA,this.m_u),u=S.b2Vec2.CrossVV(this.m_rB,this.m_u),p=this.m_invMassA+this.m_invIA*h*h+this.m_invMassB+this.m_invIB*u*u;if(this.m_mass=0!==p?1/p:0,0<this.m_frequencyHz){var f=l-this.m_length,d=2*C.b2_pi*this.m_frequencyHz,y=2*this.m_mass*this.m_dampingRatio*d,b=this.m_mass*d*d,V=t.step.dt;this.m_gamma=V*(y+V*b),this.m_gamma=0!==this.m_gamma?1/this.m_gamma:0,this.m_bias=f*V*b*this.m_gamma,p+=this.m_gamma,this.m_mass=0!==p?1/p:0}else this.m_gamma=0,this.m_bias=0;if(t.step.warmStarting){this.m_impulse*=t.step.dtRatio;var v=S.b2Vec2.MulSV(this.m_impulse,this.m_u,x.InitVelocityConstraints_s_P);o.SelfMulSub(this.m_invMassA,v),n-=this.m_invIA*S.b2Vec2.CrossVV(this.m_rA,v),a.SelfMulAdd(this.m_invMassB,v),m+=this.m_invIB*S.b2Vec2.CrossVV(this.m_rB,v)}else this.m_impulse=0;t.velocities[this.m_indexA].w=n,t.velocities[this.m_indexB].w=m},x.prototype.SolveVelocityConstraints=function(t){var e=t.velocities[this.m_indexA].v,i=t.velocities[this.m_indexA].w,o=t.velocities[this.m_indexB].v,n=t.velocities[this.m_indexB].w,s=S.b2Vec2.AddVCrossSV(e,i,this.m_rA,x.SolveVelocityConstraints_s_vpA),r=S.b2Vec2.AddVCrossSV(o,n,this.m_rB,x.SolveVelocityConstraints_s_vpB),a=S.b2Vec2.DotVV(this.m_u,S.b2Vec2.SubVV(r,s,S.b2Vec2.s_t0)),m=-this.m_mass*(a+this.m_bias+this.m_gamma*this.m_impulse);this.m_impulse+=m;var c=S.b2Vec2.MulSV(m,this.m_u,x.SolveVelocityConstraints_s_P);e.SelfMulSub(this.m_invMassA,c),i-=this.m_invIA*S.b2Vec2.CrossVV(this.m_rA,c),o.SelfMulAdd(this.m_invMassB,c),n+=this.m_invIB*S.b2Vec2.CrossVV(this.m_rB,c),t.velocities[this.m_indexA].w=i,t.velocities[this.m_indexB].w=n},x.prototype.SolvePositionConstraints=function(t){if(0<this.m_frequencyHz)return!0;var e=t.positions[this.m_indexA].c,i=t.positions[this.m_indexA].a,o=t.positions[this.m_indexB].c,n=t.positions[this.m_indexB].a,s=S.b2Rot.MulRV(this.m_qA,this.m_lalcA,this.m_rA),r=S.b2Rot.MulRV(this.m_qB,this.m_lalcB,this.m_rB),a=this.m_u;a.x=o.x+r.x-e.x-s.x,a.y=o.y+r.y-e.y-s.y;var m=this.m_u.Normalize()-this.m_length;m=S.b2Clamp(m,-C.b2_maxLinearCorrection,C.b2_maxLinearCorrection);var c=-this.m_mass*m,_=S.b2Vec2.MulSV(c,a,x.SolvePositionConstraints_s_P);return e.SelfMulSub(this.m_invMassA,_),i-=this.m_invIA*S.b2Vec2.CrossVV(s,_),o.SelfMulAdd(this.m_invMassB,_),n+=this.m_invIB*S.b2Vec2.CrossVV(r,_),t.positions[this.m_indexA].a=i,t.positions[this.m_indexB].a=n,S.b2Abs(m)<C.b2_linearSlop},x.InitVelocityConstraints_s_P=new S.b2Vec2,x.SolveVelocityConstraints_s_vpA=new S.b2Vec2,x.SolveVelocityConstraints_s_vpB=new S.b2Vec2,x.SolveVelocityConstraints_s_P=new S.b2Vec2,x.SolvePositionConstraints_s_P=new S.b2Vec2,x}(i.b2Joint),t("b2DistanceJoint",n)}}}),System.register("Dynamics/Joints/b2AreaJoint",["Common/b2Settings","Common/b2Math","Dynamics/Joints/b2Joint","Dynamics/Joints/b2DistanceJoint"],function(t,e){var p,f,i,c,o,n;e&&e.id;return{setters:[function(t){p=t},function(t){f=t},function(t){i=t},function(t){c=t}],execute:function(){o=function(e){function t(){var t=e.call(this,12)||this;return t.world=null,t.bodies=[],t.frequencyHz=0,t.dampingRatio=0,t}return __extends(t,e),t.prototype.AddBody=function(t){this.bodies.push(t),1===this.bodies.length?this.bodyA=t:2===this.bodies.length&&(this.bodyB=t)},t}(i.b2JointDef),t("b2AreaJointDef",o),n=function(m){function t(t){var e=m.call(this,t)||this;e.m_bodies=null,e.m_frequencyHz=0,e.m_dampingRatio=0,e.m_impulse=0,e.m_targetLengths=null,e.m_targetArea=0,e.m_normals=null,e.m_joints=null,e.m_deltas=null,e.m_delta=null,e.m_bodies=t.bodies,e.m_frequencyHz=t.frequencyHz,e.m_dampingRatio=t.dampingRatio,e.m_targetLengths=p.b2MakeNumberArray(t.bodies.length),e.m_normals=f.b2Vec2.MakeArray(t.bodies.length),e.m_joints=p.b2MakeNullArray(t.bodies.length),e.m_deltas=f.b2Vec2.MakeArray(t.bodies.length),e.m_delta=new f.b2Vec2;var i=new c.b2DistanceJointDef;i.frequencyHz=t.frequencyHz,i.dampingRatio=t.dampingRatio;for(var o=e.m_targetArea=0;o<e.m_bodies.length;++o){var n=e.m_bodies[o],s=e.m_bodies[(o+1)%e.m_bodies.length],r=n.GetWorldCenter(),a=s.GetWorldCenter();e.m_targetLengths[o]=f.b2Vec2.DistanceVV(r,a),e.m_targetArea+=f.b2Vec2.CrossVV(r,a),i.Initialize(n,s,r,a),e.m_joints[o]=t.world.CreateJoint(i)}return e.m_targetArea*=.5,e}return __extends(t,m),t.prototype.GetAnchorA=function(t){return t.SetZero()},t.prototype.GetAnchorB=function(t){return t.SetZero()},t.prototype.GetReactionForce=function(t,e){return e.SetZero()},t.prototype.GetReactionTorque=function(t){return 0},t.prototype.SetFrequency=function(t){this.m_frequencyHz=t;for(var e=0;e<this.m_joints.length;++e)this.m_joints[e].SetFrequency(t)},t.prototype.GetFrequency=function(){return this.m_frequencyHz},t.prototype.SetDampingRatio=function(t){this.m_dampingRatio=t;for(var e=0;e<this.m_joints.length;++e)this.m_joints[e].SetDampingRatio(t)},t.prototype.GetDampingRatio=function(){return this.m_dampingRatio},t.prototype.Dump=function(t){t("Area joint dumping is not supported.\n")},t.prototype.InitVelocityConstraints=function(t){for(var e=0;e<this.m_bodies.length;++e){var i=this.m_bodies[(e+this.m_bodies.length-1)%this.m_bodies.length],o=this.m_bodies[(e+1)%this.m_bodies.length],n=t.positions[i.m_islandIndex].c,s=t.positions[o.m_islandIndex].c,r=this.m_deltas[e];f.b2Vec2.SubVV(s,n,r)}if(t.step.warmStarting){this.m_impulse*=t.step.dtRatio;for(e=0;e<this.m_bodies.length;++e){var a=this.m_bodies[e],m=t.velocities[a.m_islandIndex].v;r=this.m_deltas[e];m.x+=a.m_invMass*r.y*.5*this.m_impulse,m.y+=a.m_invMass*-r.x*.5*this.m_impulse}}else this.m_impulse=0},t.prototype.SolveVelocityConstraints=function(t){for(var e=0,i=0,o=0;o<this.m_bodies.length;++o){var n=this.m_bodies[o],s=t.velocities[n.m_islandIndex].v;e+=(a=this.m_deltas[o]).LengthSquared()/n.GetMass(),i+=f.b2Vec2.CrossVV(s,a)}var r=-2*i/e;this.m_impulse+=r;for(o=0;o<this.m_bodies.length;++o){n=this.m_bodies[o],s=t.velocities[n.m_islandIndex].v;var a=this.m_deltas[o];s.x+=n.m_invMass*a.y*.5*r,s.y+=n.m_invMass*-a.x*.5*r}},t.prototype.SolvePositionConstraints=function(t){for(var e=0,i=0,o=0;o<this.m_bodies.length;++o){var n=this.m_bodies[o],s=this.m_bodies[(o+1)%this.m_bodies.length],r=t.positions[n.m_islandIndex].c,a=t.positions[s.m_islandIndex].c,m=(l=f.b2Vec2.SubVV(a,r,this.m_delta)).Length();m<p.b2_epsilon&&(m=1),this.m_normals[o].x=l.y/m,this.m_normals[o].y=-l.x/m,e+=m,i+=f.b2Vec2.CrossVV(r,a)}i*=.5;var c=.5*(this.m_targetArea-i)/e,_=!0;for(o=0;o<this.m_bodies.length;++o){n=this.m_bodies[o],r=t.positions[n.m_islandIndex].c;var l,h=(o+1)%this.m_bodies.length;(l=f.b2Vec2.AddVV(this.m_normals[o],this.m_normals[h],this.m_delta)).SelfMul(c);var u=l.LengthSquared();u>f.b2Sq(p.b2_maxLinearCorrection)&&l.SelfMul(p.b2_maxLinearCorrection/f.b2Sqrt(u)),u>f.b2Sq(p.b2_linearSlop)&&(_=!1),r.x+=l.x,r.y+=l.y}return _},t}(i.b2Joint),t("b2AreaJoint",n)}}}),System.register("Dynamics/Joints/b2FrictionJoint",["Common/b2Math","Dynamics/Joints/b2Joint"],function(t,e){var b,i,o,n;e&&e.id;return{setters:[function(t){b=t},function(t){i=t}],execute:function(){o=function(e){function t(){var t=e.call(this,9)||this;return t.localAnchorA=new b.b2Vec2,t.localAnchorB=new b.b2Vec2,t.maxForce=0,t.maxTorque=0,t}return __extends(t,e),t.prototype.Initialize=function(t,e,i){this.bodyA=t,this.bodyB=e,this.bodyA.GetLocalPoint(i,this.localAnchorA),this.bodyB.GetLocalPoint(i,this.localAnchorB)},t}(i.b2JointDef),t("b2FrictionJointDef",o),n=function(i){function y(t){var e=i.call(this,t)||this;return e.m_localAnchorA=new b.b2Vec2,e.m_localAnchorB=new b.b2Vec2,e.m_linearImpulse=new b.b2Vec2,e.m_angularImpulse=0,e.m_maxForce=0,e.m_maxTorque=0,e.m_indexA=0,e.m_indexB=0,e.m_rA=new b.b2Vec2,e.m_rB=new b.b2Vec2,e.m_localCenterA=new b.b2Vec2,e.m_localCenterB=new b.b2Vec2,e.m_invMassA=0,e.m_invMassB=0,e.m_invIA=0,e.m_invIB=0,e.m_linearMass=new b.b2Mat22,e.m_angularMass=0,e.m_qA=new b.b2Rot,e.m_qB=new b.b2Rot,e.m_lalcA=new b.b2Vec2,e.m_lalcB=new b.b2Vec2,e.m_K=new b.b2Mat22,e.m_localAnchorA.Copy(t.localAnchorA),e.m_localAnchorB.Copy(t.localAnchorB),e.m_linearImpulse.SetZero(),e.m_maxForce=t.maxForce,e.m_maxTorque=t.maxTorque,e.m_linearMass.SetZero(),e}return __extends(y,i),y.prototype.InitVelocityConstraints=function(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;var e=t.positions[this.m_indexA].a,i=t.velocities[this.m_indexA].v,o=t.velocities[this.m_indexA].w,n=t.positions[this.m_indexB].a,s=t.velocities[this.m_indexB].v,r=t.velocities[this.m_indexB].w,a=this.m_qA.SetAngle(e),m=this.m_qB.SetAngle(n);b.b2Vec2.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);var c=b.b2Rot.MulRV(a,this.m_lalcA,this.m_rA);b.b2Vec2.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);var _=b.b2Rot.MulRV(m,this.m_lalcB,this.m_rB),l=this.m_invMassA,h=this.m_invMassB,u=this.m_invIA,p=this.m_invIB,f=this.m_K;if(f.ex.x=l+h+u*c.y*c.y+p*_.y*_.y,f.ex.y=-u*c.x*c.y-p*_.x*_.y,f.ey.x=f.ex.y,f.ey.y=l+h+u*c.x*c.x+p*_.x*_.x,f.GetInverse(this.m_linearMass),this.m_angularMass=u+p,0<this.m_angularMass&&(this.m_angularMass=1/this.m_angularMass),t.step.warmStarting){this.m_linearImpulse.SelfMul(t.step.dtRatio),this.m_angularImpulse*=t.step.dtRatio;var d=this.m_linearImpulse;i.SelfMulSub(l,d),o-=u*(b.b2Vec2.CrossVV(this.m_rA,d)+this.m_angularImpulse),s.SelfMulAdd(h,d),r+=p*(b.b2Vec2.CrossVV(this.m_rB,d)+this.m_angularImpulse)}else this.m_linearImpulse.SetZero(),this.m_angularImpulse=0;t.velocities[this.m_indexA].w=o,t.velocities[this.m_indexB].w=r},y.prototype.SolveVelocityConstraints=function(t){var e=t.velocities[this.m_indexA].v,i=t.velocities[this.m_indexA].w,o=t.velocities[this.m_indexB].v,n=t.velocities[this.m_indexB].w,s=this.m_invMassA,r=this.m_invMassB,a=this.m_invIA,m=this.m_invIB,c=t.step.dt,_=n-i,l=-this.m_angularMass*_,h=this.m_angularImpulse,u=c*this.m_maxTorque;this.m_angularImpulse=b.b2Clamp(this.m_angularImpulse+l,-u,u),i-=a*(l=this.m_angularImpulse-h),n+=m*l;var p=b.b2Vec2.SubVV(b.b2Vec2.AddVCrossSV(o,n,this.m_rB,b.b2Vec2.s_t0),b.b2Vec2.AddVCrossSV(e,i,this.m_rA,b.b2Vec2.s_t1),y.SolveVelocityConstraints_s_Cdot_v2),f=b.b2Mat22.MulMV(this.m_linearMass,p,y.SolveVelocityConstraints_s_impulseV).SelfNeg(),d=y.SolveVelocityConstraints_s_oldImpulseV.Copy(this.m_linearImpulse);this.m_linearImpulse.SelfAdd(f);u=c*this.m_maxForce;this.m_linearImpulse.LengthSquared()>u*u&&(this.m_linearImpulse.Normalize(),this.m_linearImpulse.SelfMul(u)),b.b2Vec2.SubVV(this.m_linearImpulse,d,f),e.SelfMulSub(s,f),i-=a*b.b2Vec2.CrossVV(this.m_rA,f),o.SelfMulAdd(r,f),n+=m*b.b2Vec2.CrossVV(this.m_rB,f),t.velocities[this.m_indexA].w=i,t.velocities[this.m_indexB].w=n},y.prototype.SolvePositionConstraints=function(t){return!0},y.prototype.GetAnchorA=function(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)},y.prototype.GetAnchorB=function(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)},y.prototype.GetReactionForce=function(t,e){return e.Set(t*this.m_linearImpulse.x,t*this.m_linearImpulse.y)},y.prototype.GetReactionTorque=function(t){return t*this.m_angularImpulse},y.prototype.GetLocalAnchorA=function(){return this.m_localAnchorA},y.prototype.GetLocalAnchorB=function(){return this.m_localAnchorB},y.prototype.SetMaxForce=function(t){this.m_maxForce=t},y.prototype.GetMaxForce=function(){return this.m_maxForce},y.prototype.SetMaxTorque=function(t){this.m_maxTorque=t},y.prototype.GetMaxTorque=function(){return this.m_maxTorque},y.prototype.Dump=function(t){var e=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex;t("  const jd: b2FrictionJointDef = new b2FrictionJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",i),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.m_localAnchorA.x,this.m_localAnchorA.y),t("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.m_localAnchorB.x,this.m_localAnchorB.y),t("  jd.maxForce = %.15f;\n",this.m_maxForce),t("  jd.maxTorque = %.15f;\n",this.m_maxTorque),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)},y.SolveVelocityConstraints_s_Cdot_v2=new b.b2Vec2,y.SolveVelocityConstraints_s_impulseV=new b.b2Vec2,y.SolveVelocityConstraints_s_oldImpulseV=new b.b2Vec2,y}(i.b2Joint),t("b2FrictionJoint",n)}}}),System.register("Dynamics/Joints/b2PrismaticJoint",["Common/b2Settings","Common/b2Math","Dynamics/Joints/b2Joint"],function(t,e){var j,N,i,o,n;e&&e.id;return{setters:[function(t){j=t},function(t){N=t},function(t){i=t}],execute:function(){o=function(e){function t(){var t=e.call(this,2)||this;return t.localAnchorA=null,t.localAnchorB=null,t.localAxisA=null,t.referenceAngle=0,t.enableLimit=!1,t.lowerTranslation=0,t.upperTranslation=0,t.enableMotor=!1,t.maxMotorForce=0,t.motorSpeed=0,t.localAnchorA=new N.b2Vec2,t.localAnchorB=new N.b2Vec2,t.localAxisA=new N.b2Vec2(1,0),t}return __extends(t,e),t.prototype.Initialize=function(t,e,i,o){this.bodyA=t,this.bodyB=e,this.bodyA.GetLocalPoint(i,this.localAnchorA),this.bodyB.GetLocalPoint(i,this.localAnchorB),this.bodyA.GetLocalVector(o,this.localAxisA),this.referenceAngle=this.bodyB.GetAngle()-this.bodyA.GetAngle()},t}(i.b2JointDef),t("b2PrismaticJointDef",o),n=function(i){function J(t){var e=i.call(this,t)||this;return e.m_localAnchorA=new N.b2Vec2,e.m_localAnchorB=new N.b2Vec2,e.m_localXAxisA=new N.b2Vec2,e.m_localYAxisA=new N.b2Vec2,e.m_referenceAngle=0,e.m_impulse=new N.b2Vec3(0,0,0),e.m_motorImpulse=0,e.m_lowerTranslation=0,e.m_upperTranslation=0,e.m_maxMotorForce=0,e.m_motorSpeed=0,e.m_enableLimit=!1,e.m_enableMotor=!1,e.m_limitState=0,e.m_indexA=0,e.m_indexB=0,e.m_localCenterA=new N.b2Vec2,e.m_localCenterB=new N.b2Vec2,e.m_invMassA=0,e.m_invMassB=0,e.m_invIA=0,e.m_invIB=0,e.m_axis=new N.b2Vec2(0,0),e.m_perp=new N.b2Vec2(0,0),e.m_s1=0,e.m_s2=0,e.m_a1=0,e.m_a2=0,e.m_K=new N.b2Mat33,e.m_K3=new N.b2Mat33,e.m_K2=new N.b2Mat22,e.m_motorMass=0,e.m_qA=new N.b2Rot,e.m_qB=new N.b2Rot,e.m_lalcA=new N.b2Vec2,e.m_lalcB=new N.b2Vec2,e.m_rA=new N.b2Vec2,e.m_rB=new N.b2Vec2,e.m_localAnchorA.Copy(t.localAnchorA),e.m_localAnchorB.Copy(t.localAnchorB),e.m_localXAxisA.Copy(t.localAxisA).SelfNormalize(),N.b2Vec2.CrossOneV(e.m_localXAxisA,e.m_localYAxisA),e.m_referenceAngle=t.referenceAngle,e.m_lowerTranslation=t.lowerTranslation,e.m_upperTranslation=t.upperTranslation,e.m_maxMotorForce=t.maxMotorForce,e.m_motorSpeed=t.motorSpeed,e.m_enableLimit=t.enableLimit,e.m_enableMotor=t.enableMotor,e}return __extends(J,i),J.prototype.InitVelocityConstraints=function(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;var e=t.positions[this.m_indexA].c,i=t.positions[this.m_indexA].a,o=t.velocities[this.m_indexA].v,n=t.velocities[this.m_indexA].w,s=t.positions[this.m_indexB].c,r=t.positions[this.m_indexB].a,a=t.velocities[this.m_indexB].v,m=t.velocities[this.m_indexB].w,c=this.m_qA.SetAngle(i),_=this.m_qB.SetAngle(r);N.b2Vec2.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);var l=N.b2Rot.MulRV(c,this.m_lalcA,this.m_rA);N.b2Vec2.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);var h=N.b2Rot.MulRV(_,this.m_lalcB,this.m_rB),u=N.b2Vec2.AddVV(N.b2Vec2.SubVV(s,e,N.b2Vec2.s_t0),N.b2Vec2.SubVV(h,l,N.b2Vec2.s_t1),J.InitVelocityConstraints_s_d),p=this.m_invMassA,f=this.m_invMassB,d=this.m_invIA,y=this.m_invIB;if(N.b2Rot.MulRV(c,this.m_localXAxisA,this.m_axis),this.m_a1=N.b2Vec2.CrossVV(N.b2Vec2.AddVV(u,l,N.b2Vec2.s_t0),this.m_axis),this.m_a2=N.b2Vec2.CrossVV(h,this.m_axis),this.m_motorMass=p+f+d*this.m_a1*this.m_a1+y*this.m_a2*this.m_a2,0<this.m_motorMass&&(this.m_motorMass=1/this.m_motorMass),N.b2Rot.MulRV(c,this.m_localYAxisA,this.m_perp),this.m_s1=N.b2Vec2.CrossVV(N.b2Vec2.AddVV(u,l,N.b2Vec2.s_t0),this.m_perp),this.m_s2=N.b2Vec2.CrossVV(h,this.m_perp),this.m_K.ex.x=p+f+d*this.m_s1*this.m_s1+y*this.m_s2*this.m_s2,this.m_K.ex.y=d*this.m_s1+y*this.m_s2,this.m_K.ex.z=d*this.m_s1*this.m_a1+y*this.m_s2*this.m_a2,this.m_K.ey.x=this.m_K.ex.y,this.m_K.ey.y=d+y,0===this.m_K.ey.y&&(this.m_K.ey.y=1),this.m_K.ey.z=d*this.m_a1+y*this.m_a2,this.m_K.ez.x=this.m_K.ex.z,this.m_K.ez.y=this.m_K.ey.z,this.m_K.ez.z=p+f+d*this.m_a1*this.m_a1+y*this.m_a2*this.m_a2,this.m_enableLimit){var b=N.b2Vec2.DotVV(this.m_axis,u);N.b2Abs(this.m_upperTranslation-this.m_lowerTranslation)<2*j.b2_linearSlop?this.m_limitState=3:b<=this.m_lowerTranslation?1!==this.m_limitState&&(this.m_limitState=1,this.m_impulse.z=0):b>=this.m_upperTranslation?2!==this.m_limitState&&(this.m_limitState=2,this.m_impulse.z=0):(this.m_limitState=0,this.m_impulse.z=0)}else this.m_limitState=0,this.m_impulse.z=0;if(this.m_enableMotor||(this.m_motorImpulse=0),t.step.warmStarting){this.m_impulse.SelfMul(t.step.dtRatio),this.m_motorImpulse*=t.step.dtRatio;var V=N.b2Vec2.AddVV(N.b2Vec2.MulSV(this.m_impulse.x,this.m_perp,N.b2Vec2.s_t0),N.b2Vec2.MulSV(this.m_motorImpulse+this.m_impulse.z,this.m_axis,N.b2Vec2.s_t1),J.InitVelocityConstraints_s_P),v=this.m_impulse.x*this.m_s1+this.m_impulse.y+(this.m_motorImpulse+this.m_impulse.z)*this.m_a1,x=this.m_impulse.x*this.m_s2+this.m_impulse.y+(this.m_motorImpulse+this.m_impulse.z)*this.m_a2;o.SelfMulSub(p,V),n-=d*v,a.SelfMulAdd(f,V),m+=y*x}else this.m_impulse.SetZero(),this.m_motorImpulse=0;t.velocities[this.m_indexA].w=n,t.velocities[this.m_indexB].w=m},J.prototype.SolveVelocityConstraints=function(t){var e=t.velocities[this.m_indexA].v,i=t.velocities[this.m_indexA].w,o=t.velocities[this.m_indexB].v,n=t.velocities[this.m_indexB].w,s=this.m_invMassA,r=this.m_invMassB,a=this.m_invIA,m=this.m_invIB;if(this.m_enableMotor&&3!==this.m_limitState){var c=N.b2Vec2.DotVV(this.m_axis,N.b2Vec2.SubVV(o,e,N.b2Vec2.s_t0))+this.m_a2*n-this.m_a1*i,_=this.m_motorMass*(this.m_motorSpeed-c),l=this.m_motorImpulse,h=t.step.dt*this.m_maxMotorForce;this.m_motorImpulse=N.b2Clamp(this.m_motorImpulse+_,-h,h),_=this.m_motorImpulse-l;var u=N.b2Vec2.MulSV(_,this.m_axis,J.SolveVelocityConstraints_s_P),p=_*this.m_a1,f=_*this.m_a2;e.SelfMulSub(s,u),i-=a*p,o.SelfMulAdd(r,u),n+=m*f}var d=N.b2Vec2.DotVV(this.m_perp,N.b2Vec2.SubVV(o,e,N.b2Vec2.s_t0))+this.m_s2*n-this.m_s1*i,y=n-i;if(this.m_enableLimit&&0!==this.m_limitState){var b=N.b2Vec2.DotVV(this.m_axis,N.b2Vec2.SubVV(o,e,N.b2Vec2.s_t0))+this.m_a2*n-this.m_a1*i,V=J.SolveVelocityConstraints_s_f1.Copy(this.m_impulse),v=this.m_K.Solve33(-d,-y,-b,J.SolveVelocityConstraints_s_df3);this.m_impulse.SelfAdd(v),1===this.m_limitState?this.m_impulse.z=N.b2Max(this.m_impulse.z,0):2===this.m_limitState&&(this.m_impulse.z=N.b2Min(this.m_impulse.z,0));var x=-d-(this.m_impulse.z-V.z)*this.m_K.ez.x,C=-y-(this.m_impulse.z-V.z)*this.m_K.ez.y,S=this.m_K.Solve22(x,C,J.SolveVelocityConstraints_s_f2r);S.x+=V.x,S.y+=V.y,this.m_impulse.x=S.x,this.m_impulse.y=S.y,v.x=this.m_impulse.x-V.x,v.y=this.m_impulse.y-V.y,v.z=this.m_impulse.z-V.z;u=N.b2Vec2.AddVV(N.b2Vec2.MulSV(v.x,this.m_perp,N.b2Vec2.s_t0),N.b2Vec2.MulSV(v.z,this.m_axis,N.b2Vec2.s_t1),J.SolveVelocityConstraints_s_P),p=v.x*this.m_s1+v.y+v.z*this.m_a1,f=v.x*this.m_s2+v.y+v.z*this.m_a2;e.SelfMulSub(s,u),i-=a*p,o.SelfMulAdd(r,u),n+=m*f}else{var B=this.m_K.Solve22(-d,-y,J.SolveVelocityConstraints_s_df2);this.m_impulse.x+=B.x,this.m_impulse.y+=B.y;u=N.b2Vec2.MulSV(B.x,this.m_perp,J.SolveVelocityConstraints_s_P),p=B.x*this.m_s1+B.y,f=B.x*this.m_s2+B.y;e.SelfMulSub(s,u),i-=a*p,o.SelfMulAdd(r,u),n+=m*f}t.velocities[this.m_indexA].w=i,t.velocities[this.m_indexB].w=n},J.prototype.SolvePositionConstraints=function(t){var e=t.positions[this.m_indexA].c,i=t.positions[this.m_indexA].a,o=t.positions[this.m_indexB].c,n=t.positions[this.m_indexB].a,s=this.m_qA.SetAngle(i),r=this.m_qB.SetAngle(n),a=this.m_invMassA,m=this.m_invMassB,c=this.m_invIA,_=this.m_invIB,l=N.b2Rot.MulRV(s,this.m_lalcA,this.m_rA),h=N.b2Rot.MulRV(r,this.m_lalcB,this.m_rB),u=N.b2Vec2.SubVV(N.b2Vec2.AddVV(o,h,N.b2Vec2.s_t0),N.b2Vec2.AddVV(e,l,N.b2Vec2.s_t1),J.SolvePositionConstraints_s_d),p=N.b2Rot.MulRV(s,this.m_localXAxisA,this.m_axis),f=N.b2Vec2.CrossVV(N.b2Vec2.AddVV(u,l,N.b2Vec2.s_t0),p),d=N.b2Vec2.CrossVV(h,p),y=N.b2Rot.MulRV(s,this.m_localYAxisA,this.m_perp),b=N.b2Vec2.CrossVV(N.b2Vec2.AddVV(u,l,N.b2Vec2.s_t0),y),V=N.b2Vec2.CrossVV(h,y),v=J.SolvePositionConstraints_s_impulse,x=N.b2Vec2.DotVV(y,u),C=n-i-this.m_referenceAngle,S=N.b2Abs(x),B=N.b2Abs(C),A=!1,g=0;if(this.m_enableLimit){var w=N.b2Vec2.DotVV(p,u);N.b2Abs(this.m_upperTranslation-this.m_lowerTranslation)<2*j.b2_linearSlop?(g=N.b2Clamp(w,-j.b2_maxLinearCorrection,j.b2_maxLinearCorrection),S=N.b2Max(S,N.b2Abs(w)),A=!0):w<=this.m_lowerTranslation?(g=N.b2Clamp(w-this.m_lowerTranslation+j.b2_linearSlop,-j.b2_maxLinearCorrection,0),S=N.b2Max(S,this.m_lowerTranslation-w),A=!0):w>=this.m_upperTranslation&&(g=N.b2Clamp(w-this.m_upperTranslation-j.b2_linearSlop,0,j.b2_maxLinearCorrection),S=N.b2Max(S,w-this.m_upperTranslation),A=!0)}if(A){var M=a+m+c*b*b+_*V*V,P=c*b+_*V,I=c*b*f+_*V*d;0===(F=c+_)&&(F=1);var D=c*f+_*d,G=a+m+c*f*f+_*d*d,R=this.m_K3;R.ex.SetXYZ(M,P,I),R.ey.SetXYZ(P,F,D),R.ez.SetXYZ(I,D,G),v=R.Solve33(-x,-C,-g,v)}else{var F;M=a+m+c*b*b+_*V*V,P=c*b+_*V;0===(F=c+_)&&(F=1);var T=this.m_K2;T.ex.Set(M,P),T.ey.Set(P,F);var L=T.Solve(-x,-C,J.SolvePositionConstraints_s_impulse1);v.x=L.x,v.y=L.y,v.z=0}var k=N.b2Vec2.AddVV(N.b2Vec2.MulSV(v.x,y,N.b2Vec2.s_t0),N.b2Vec2.MulSV(v.z,p,N.b2Vec2.s_t1),J.SolvePositionConstraints_s_P),q=v.x*b+v.y+v.z*f,z=v.x*V+v.y+v.z*d;return e.SelfMulSub(a,k),i-=c*q,o.SelfMulAdd(m,k),n+=_*z,t.positions[this.m_indexA].a=i,t.positions[this.m_indexB].a=n,S<=j.b2_linearSlop&&B<=j.b2_angularSlop},J.prototype.GetAnchorA=function(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)},J.prototype.GetAnchorB=function(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)},J.prototype.GetReactionForce=function(t,e){return e.Set(t*(this.m_impulse.x*this.m_perp.x+(this.m_motorImpulse+this.m_impulse.z)*this.m_axis.x),t*(this.m_impulse.x*this.m_perp.y+(this.m_motorImpulse+this.m_impulse.z)*this.m_axis.y))},J.prototype.GetReactionTorque=function(t){return t*this.m_impulse.y},J.prototype.GetLocalAnchorA=function(){return this.m_localAnchorA},J.prototype.GetLocalAnchorB=function(){return this.m_localAnchorB},J.prototype.GetLocalAxisA=function(){return this.m_localXAxisA},J.prototype.GetReferenceAngle=function(){return this.m_referenceAngle},J.prototype.GetJointTranslation=function(){var t=this.m_bodyA.GetWorldPoint(this.m_localAnchorA,J.GetJointTranslation_s_pA),e=this.m_bodyB.GetWorldPoint(this.m_localAnchorB,J.GetJointTranslation_s_pB),i=N.b2Vec2.SubVV(e,t,J.GetJointTranslation_s_d),o=this.m_bodyA.GetWorldVector(this.m_localXAxisA,J.GetJointTranslation_s_axis);return N.b2Vec2.DotVV(i,o)},J.prototype.GetJointSpeed=function(){var t=this.m_bodyA,e=this.m_bodyB;N.b2Vec2.SubVV(this.m_localAnchorA,t.m_sweep.localCenter,this.m_lalcA);var i=N.b2Rot.MulRV(t.m_xf.q,this.m_lalcA,this.m_rA);N.b2Vec2.SubVV(this.m_localAnchorB,e.m_sweep.localCenter,this.m_lalcB);var o=N.b2Rot.MulRV(e.m_xf.q,this.m_lalcB,this.m_rB),n=N.b2Vec2.AddVV(t.m_sweep.c,i,N.b2Vec2.s_t0),s=N.b2Vec2.AddVV(e.m_sweep.c,o,N.b2Vec2.s_t1),r=N.b2Vec2.SubVV(s,n,N.b2Vec2.s_t2),a=t.GetWorldVector(this.m_localXAxisA,this.m_axis),m=t.m_linearVelocity,c=e.m_linearVelocity,_=t.m_angularVelocity,l=e.m_angularVelocity;return N.b2Vec2.DotVV(r,N.b2Vec2.CrossSV(_,a,N.b2Vec2.s_t0))+N.b2Vec2.DotVV(a,N.b2Vec2.SubVV(N.b2Vec2.AddVCrossSV(c,l,o,N.b2Vec2.s_t0),N.b2Vec2.AddVCrossSV(m,_,i,N.b2Vec2.s_t1),N.b2Vec2.s_t0))},J.prototype.IsLimitEnabled=function(){return this.m_enableLimit},J.prototype.EnableLimit=function(t){t!==this.m_enableLimit&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableLimit=t,this.m_impulse.z=0)},J.prototype.GetLowerLimit=function(){return this.m_lowerTranslation},J.prototype.GetUpperLimit=function(){return this.m_upperTranslation},J.prototype.SetLimits=function(t,e){t===this.m_lowerTranslation&&e===this.m_upperTranslation||(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_lowerTranslation=t,this.m_upperTranslation=e,this.m_impulse.z=0)},J.prototype.IsMotorEnabled=function(){return this.m_enableMotor},J.prototype.EnableMotor=function(t){this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableMotor=t},J.prototype.SetMotorSpeed=function(t){this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_motorSpeed=t},J.prototype.GetMotorSpeed=function(){return this.m_motorSpeed},J.prototype.SetMaxMotorForce=function(t){this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_maxMotorForce=t},J.prototype.GetMaxMotorForce=function(){return this.m_maxMotorForce},J.prototype.GetMotorForce=function(t){return t*this.m_motorImpulse},J.prototype.Dump=function(t){var e=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex;t("  const jd: b2PrismaticJointDef = new b2PrismaticJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",i),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.m_localAnchorA.x,this.m_localAnchorA.y),t("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.m_localAnchorB.x,this.m_localAnchorB.y),t("  jd.localAxisA.Set(%.15f, %.15f);\n",this.m_localXAxisA.x,this.m_localXAxisA.y),t("  jd.referenceAngle = %.15f;\n",this.m_referenceAngle),t("  jd.enableLimit = %s;\n",this.m_enableLimit?"true":"false"),t("  jd.lowerTranslation = %.15f;\n",this.m_lowerTranslation),t("  jd.upperTranslation = %.15f;\n",this.m_upperTranslation),t("  jd.enableMotor = %s;\n",this.m_enableMotor?"true":"false"),t("  jd.motorSpeed = %.15f;\n",this.m_motorSpeed),t("  jd.maxMotorForce = %.15f;\n",this.m_maxMotorForce),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)},J.InitVelocityConstraints_s_d=new N.b2Vec2,J.InitVelocityConstraints_s_P=new N.b2Vec2,J.SolveVelocityConstraints_s_P=new N.b2Vec2,J.SolveVelocityConstraints_s_f2r=new N.b2Vec2,J.SolveVelocityConstraints_s_f1=new N.b2Vec3,J.SolveVelocityConstraints_s_df3=new N.b2Vec3,J.SolveVelocityConstraints_s_df2=new N.b2Vec2,J.SolvePositionConstraints_s_d=new N.b2Vec2,J.SolvePositionConstraints_s_impulse=new N.b2Vec3,J.SolvePositionConstraints_s_impulse1=new N.b2Vec2,J.SolvePositionConstraints_s_P=new N.b2Vec2,J.GetJointTranslation_s_pA=new N.b2Vec2,J.GetJointTranslation_s_pB=new N.b2Vec2,J.GetJointTranslation_s_d=new N.b2Vec2,J.GetJointTranslation_s_axis=new N.b2Vec2,J}(i.b2Joint),t("b2PrismaticJoint",n)}}}),System.register("Dynamics/Joints/b2RevoluteJoint",["Common/b2Settings","Common/b2Math","Dynamics/Joints/b2Joint"],function(t,e){var C,B,i,o,n;e&&e.id;return{setters:[function(t){C=t},function(t){B=t},function(t){i=t}],execute:function(){o=function(e){function t(){var t=e.call(this,1)||this;return t.localAnchorA=new B.b2Vec2(0,0),t.localAnchorB=new B.b2Vec2(0,0),t.referenceAngle=0,t.enableLimit=!1,t.lowerAngle=0,t.upperAngle=0,t.enableMotor=!1,t.motorSpeed=0,t.maxMotorTorque=0,t}return __extends(t,e),t.prototype.Initialize=function(t,e,i){this.bodyA=t,this.bodyB=e,this.bodyA.GetLocalPoint(i,this.localAnchorA),this.bodyB.GetLocalPoint(i,this.localAnchorB),this.referenceAngle=this.bodyB.GetAngle()-this.bodyA.GetAngle()},t}(i.b2JointDef),t("b2RevoluteJointDef",o),n=function(i){function S(t){var e=i.call(this,t)||this;return e.m_localAnchorA=new B.b2Vec2,e.m_localAnchorB=new B.b2Vec2,e.m_impulse=new B.b2Vec3,e.m_motorImpulse=0,e.m_enableMotor=!1,e.m_maxMotorTorque=0,e.m_motorSpeed=0,e.m_enableLimit=!1,e.m_referenceAngle=0,e.m_lowerAngle=0,e.m_upperAngle=0,e.m_indexA=0,e.m_indexB=0,e.m_rA=new B.b2Vec2,e.m_rB=new B.b2Vec2,e.m_localCenterA=new B.b2Vec2,e.m_localCenterB=new B.b2Vec2,e.m_invMassA=0,e.m_invMassB=0,e.m_invIA=0,e.m_invIB=0,e.m_mass=new B.b2Mat33,e.m_motorMass=0,e.m_limitState=0,e.m_qA=new B.b2Rot,e.m_qB=new B.b2Rot,e.m_lalcA=new B.b2Vec2,e.m_lalcB=new B.b2Vec2,e.m_K=new B.b2Mat22,e.m_localAnchorA.Copy(t.localAnchorA),e.m_localAnchorB.Copy(t.localAnchorB),e.m_referenceAngle=t.referenceAngle,e.m_impulse.SetZero(),e.m_motorImpulse=0,e.m_lowerAngle=t.lowerAngle,e.m_upperAngle=t.upperAngle,e.m_maxMotorTorque=t.maxMotorTorque,e.m_motorSpeed=t.motorSpeed,e.m_enableLimit=t.enableLimit,e.m_enableMotor=t.enableMotor,e.m_limitState=0,e}return __extends(S,i),S.prototype.InitVelocityConstraints=function(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;var e=t.positions[this.m_indexA].a,i=t.velocities[this.m_indexA].v,o=t.velocities[this.m_indexA].w,n=t.positions[this.m_indexB].a,s=t.velocities[this.m_indexB].v,r=t.velocities[this.m_indexB].w,a=this.m_qA.SetAngle(e),m=this.m_qB.SetAngle(n);B.b2Vec2.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA),B.b2Rot.MulRV(a,this.m_lalcA,this.m_rA),B.b2Vec2.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB),B.b2Rot.MulRV(m,this.m_lalcB,this.m_rB);var c=this.m_invMassA,_=this.m_invMassB,l=this.m_invIA,h=this.m_invIB,u=l+h===0;if(this.m_mass.ex.x=c+_+this.m_rA.y*this.m_rA.y*l+this.m_rB.y*this.m_rB.y*h,this.m_mass.ey.x=-this.m_rA.y*this.m_rA.x*l-this.m_rB.y*this.m_rB.x*h,this.m_mass.ez.x=-this.m_rA.y*l-this.m_rB.y*h,this.m_mass.ex.y=this.m_mass.ey.x,this.m_mass.ey.y=c+_+this.m_rA.x*this.m_rA.x*l+this.m_rB.x*this.m_rB.x*h,this.m_mass.ez.y=this.m_rA.x*l+this.m_rB.x*h,this.m_mass.ex.z=this.m_mass.ez.x,this.m_mass.ey.z=this.m_mass.ez.y,this.m_mass.ez.z=l+h,this.m_motorMass=l+h,0<this.m_motorMass&&(this.m_motorMass=1/this.m_motorMass),this.m_enableMotor&&!u||(this.m_motorImpulse=0),this.m_enableLimit&&!u){var p=n-e-this.m_referenceAngle;B.b2Abs(this.m_upperAngle-this.m_lowerAngle)<2*C.b2_angularSlop?this.m_limitState=3:p<=this.m_lowerAngle?(1!==this.m_limitState&&(this.m_impulse.z=0),this.m_limitState=1):p>=this.m_upperAngle?(2!==this.m_limitState&&(this.m_impulse.z=0),this.m_limitState=2):(this.m_limitState=0,this.m_impulse.z=0)}else this.m_limitState=0;if(t.step.warmStarting){this.m_impulse.SelfMul(t.step.dtRatio),this.m_motorImpulse*=t.step.dtRatio;var f=S.InitVelocityConstraints_s_P.Set(this.m_impulse.x,this.m_impulse.y);i.SelfMulSub(c,f),o-=l*(B.b2Vec2.CrossVV(this.m_rA,f)+this.m_motorImpulse+this.m_impulse.z),s.SelfMulAdd(_,f),r+=h*(B.b2Vec2.CrossVV(this.m_rB,f)+this.m_motorImpulse+this.m_impulse.z)}else this.m_impulse.SetZero(),this.m_motorImpulse=0;t.velocities[this.m_indexA].w=o,t.velocities[this.m_indexB].w=r},S.prototype.SolveVelocityConstraints=function(t){var e=t.velocities[this.m_indexA].v,i=t.velocities[this.m_indexA].w,o=t.velocities[this.m_indexB].v,n=t.velocities[this.m_indexB].w,s=this.m_invMassA,r=this.m_invMassB,a=this.m_invIA,m=this.m_invIB,c=a+m===0;if(this.m_enableMotor&&3!==this.m_limitState&&!c){var _=n-i-this.m_motorSpeed,l=-this.m_motorMass*_,h=this.m_motorImpulse,u=t.step.dt*this.m_maxMotorTorque;this.m_motorImpulse=B.b2Clamp(this.m_motorImpulse+l,-u,u),i-=a*(l=this.m_motorImpulse-h),n+=m*l}if(this.m_enableLimit&&0!==this.m_limitState&&!c){var p=B.b2Vec2.SubVV(B.b2Vec2.AddVCrossSV(o,n,this.m_rB,B.b2Vec2.s_t0),B.b2Vec2.AddVCrossSV(e,i,this.m_rA,B.b2Vec2.s_t1),S.SolveVelocityConstraints_s_Cdot1),f=n-i,d=this.m_mass.Solve33(p.x,p.y,f,S.SolveVelocityConstraints_s_impulse_v3).SelfNeg();if(3===this.m_limitState)this.m_impulse.SelfAdd(d);else if(1===this.m_limitState){if(this.m_impulse.z+d.z<0){var y=-p.x+this.m_impulse.z*this.m_mass.ez.x,b=-p.y+this.m_impulse.z*this.m_mass.ez.y,V=this.m_mass.Solve22(y,b,S.SolveVelocityConstraints_s_reduced_v2);d.x=V.x,d.y=V.y,d.z=-this.m_impulse.z,this.m_impulse.x+=V.x,this.m_impulse.y+=V.y,this.m_impulse.z=0}else this.m_impulse.SelfAdd(d)}else if(2===this.m_limitState){if(0<this.m_impulse.z+d.z){y=-p.x+this.m_impulse.z*this.m_mass.ez.x,b=-p.y+this.m_impulse.z*this.m_mass.ez.y,V=this.m_mass.Solve22(y,b,S.SolveVelocityConstraints_s_reduced_v2);d.x=V.x,d.y=V.y,d.z=-this.m_impulse.z,this.m_impulse.x+=V.x,this.m_impulse.y+=V.y,this.m_impulse.z=0}else this.m_impulse.SelfAdd(d)}var v=S.SolveVelocityConstraints_s_P.Set(d.x,d.y);e.SelfMulSub(s,v),i-=a*(B.b2Vec2.CrossVV(this.m_rA,v)+d.z),o.SelfMulAdd(r,v),n+=m*(B.b2Vec2.CrossVV(this.m_rB,v)+d.z)}else{var x=B.b2Vec2.SubVV(B.b2Vec2.AddVCrossSV(o,n,this.m_rB,B.b2Vec2.s_t0),B.b2Vec2.AddVCrossSV(e,i,this.m_rA,B.b2Vec2.s_t1),S.SolveVelocityConstraints_s_Cdot_v2),C=this.m_mass.Solve22(-x.x,-x.y,S.SolveVelocityConstraints_s_impulse_v2);this.m_impulse.x+=C.x,this.m_impulse.y+=C.y,e.SelfMulSub(s,C),i-=a*B.b2Vec2.CrossVV(this.m_rA,C),o.SelfMulAdd(r,C),n+=m*B.b2Vec2.CrossVV(this.m_rB,C)}t.velocities[this.m_indexA].w=i,t.velocities[this.m_indexB].w=n},S.prototype.SolvePositionConstraints=function(t){var e,i=t.positions[this.m_indexA].c,o=t.positions[this.m_indexA].a,n=t.positions[this.m_indexB].c,s=t.positions[this.m_indexB].a,r=this.m_qA.SetAngle(o),a=this.m_qB.SetAngle(s),m=0,c=this.m_invIA+this.m_invIB===0;if(this.m_enableLimit&&0!==this.m_limitState&&!c){var _=s-o-this.m_referenceAngle,l=0;if(3===this.m_limitState){var h=B.b2Clamp(_-this.m_lowerAngle,-C.b2_maxAngularCorrection,C.b2_maxAngularCorrection);l=-this.m_motorMass*h,m=B.b2Abs(h)}else if(1===this.m_limitState){m=-(h=_-this.m_lowerAngle),h=B.b2Clamp(h+C.b2_angularSlop,-C.b2_maxAngularCorrection,0),l=-this.m_motorMass*h}else if(2===this.m_limitState){m=h=_-this.m_upperAngle,h=B.b2Clamp(h-C.b2_angularSlop,0,C.b2_maxAngularCorrection),l=-this.m_motorMass*h}o-=this.m_invIA*l,s+=this.m_invIB*l}r.SetAngle(o),a.SetAngle(s),B.b2Vec2.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);var u=B.b2Rot.MulRV(r,this.m_lalcA,this.m_rA);B.b2Vec2.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);var p=B.b2Rot.MulRV(a,this.m_lalcB,this.m_rB),f=B.b2Vec2.SubVV(B.b2Vec2.AddVV(n,p,B.b2Vec2.s_t0),B.b2Vec2.AddVV(i,u,B.b2Vec2.s_t1),S.SolvePositionConstraints_s_C_v2);e=f.Length();var d=this.m_invMassA,y=this.m_invMassB,b=this.m_invIA,V=this.m_invIB,v=this.m_K;v.ex.x=d+y+b*u.y*u.y+V*p.y*p.y,v.ex.y=-b*u.x*u.y-V*p.x*p.y,v.ey.x=v.ex.y,v.ey.y=d+y+b*u.x*u.x+V*p.x*p.x;var x=v.Solve(f.x,f.y,S.SolvePositionConstraints_s_impulse).SelfNeg();return i.SelfMulSub(d,x),o-=b*B.b2Vec2.CrossVV(u,x),n.SelfMulAdd(y,x),s+=V*B.b2Vec2.CrossVV(p,x),t.positions[this.m_indexA].a=o,t.positions[this.m_indexB].a=s,e<=C.b2_linearSlop&&m<=C.b2_angularSlop},S.prototype.GetAnchorA=function(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)},S.prototype.GetAnchorB=function(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)},S.prototype.GetReactionForce=function(t,e){return e.Set(t*this.m_impulse.x,t*this.m_impulse.y)},S.prototype.GetReactionTorque=function(t){return t*this.m_impulse.z},S.prototype.GetLocalAnchorA=function(){return this.m_localAnchorA},S.prototype.GetLocalAnchorB=function(){return this.m_localAnchorB},S.prototype.GetReferenceAngle=function(){return this.m_referenceAngle},S.prototype.GetJointAngle=function(){return this.m_bodyB.m_sweep.a-this.m_bodyA.m_sweep.a-this.m_referenceAngle},S.prototype.GetJointSpeed=function(){return this.m_bodyB.m_angularVelocity-this.m_bodyA.m_angularVelocity},S.prototype.IsMotorEnabled=function(){return this.m_enableMotor},S.prototype.EnableMotor=function(t){this.m_enableMotor!==t&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableMotor=t)},S.prototype.GetMotorTorque=function(t){return t*this.m_motorImpulse},S.prototype.GetMotorSpeed=function(){return this.m_motorSpeed},S.prototype.SetMaxMotorTorque=function(t){this.m_maxMotorTorque=t},S.prototype.GetMaxMotorTorque=function(){return this.m_maxMotorTorque},S.prototype.IsLimitEnabled=function(){return this.m_enableLimit},S.prototype.EnableLimit=function(t){t!==this.m_enableLimit&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableLimit=t,this.m_impulse.z=0)},S.prototype.GetLowerLimit=function(){return this.m_lowerAngle},S.prototype.GetUpperLimit=function(){return this.m_upperAngle},S.prototype.SetLimits=function(t,e){t===this.m_lowerAngle&&e===this.m_upperAngle||(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_impulse.z=0,this.m_lowerAngle=t,this.m_upperAngle=e)},S.prototype.SetMotorSpeed=function(t){this.m_motorSpeed!==t&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_motorSpeed=t)},S.prototype.Dump=function(t){var e=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex;t("  const jd: b2RevoluteJointDef = new b2RevoluteJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",i),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.m_localAnchorA.x,this.m_localAnchorA.y),t("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.m_localAnchorB.x,this.m_localAnchorB.y),t("  jd.referenceAngle = %.15f;\n",this.m_referenceAngle),t("  jd.enableLimit = %s;\n",this.m_enableLimit?"true":"false"),t("  jd.lowerAngle = %.15f;\n",this.m_lowerAngle),t("  jd.upperAngle = %.15f;\n",this.m_upperAngle),t("  jd.enableMotor = %s;\n",this.m_enableMotor?"true":"false"),t("  jd.motorSpeed = %.15f;\n",this.m_motorSpeed),t("  jd.maxMotorTorque = %.15f;\n",this.m_maxMotorTorque),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)},S.InitVelocityConstraints_s_P=new B.b2Vec2,S.SolveVelocityConstraints_s_P=new B.b2Vec2,S.SolveVelocityConstraints_s_Cdot_v2=new B.b2Vec2,S.SolveVelocityConstraints_s_Cdot1=new B.b2Vec2,S.SolveVelocityConstraints_s_impulse_v3=new B.b2Vec3,S.SolveVelocityConstraints_s_reduced_v2=new B.b2Vec2,S.SolveVelocityConstraints_s_impulse_v2=new B.b2Vec2,S.SolvePositionConstraints_s_C_v2=new B.b2Vec2,S.SolvePositionConstraints_s_impulse=new B.b2Vec2,S}(i.b2Joint),t("b2RevoluteJoint",n)}}}),System.register("Dynamics/Joints/b2GearJoint",["Common/b2Settings","Common/b2Math","Dynamics/Joints/b2Joint"],function(t,e){var F,T,i,o,n;e&&e.id;return{setters:[function(t){F=t},function(t){T=t},function(t){i=t}],execute:function(){o=function(e){function t(){var t=e.call(this,6)||this;return t.joint1=null,t.joint2=null,t.ratio=1,t}return __extends(t,e),t}(i.b2JointDef),t("b2GearJointDef",o),n=function(b){function R(t){var e,i,o=b.call(this,t)||this;o.m_joint1=null,o.m_joint2=null,o.m_typeA=0,o.m_typeB=0,o.m_bodyC=null,o.m_bodyD=null,o.m_localAnchorA=new T.b2Vec2,o.m_localAnchorB=new T.b2Vec2,o.m_localAnchorC=new T.b2Vec2,o.m_localAnchorD=new T.b2Vec2,o.m_localAxisC=new T.b2Vec2,o.m_localAxisD=new T.b2Vec2,o.m_referenceAngleA=0,o.m_referenceAngleB=0,o.m_constant=0,o.m_ratio=0,o.m_impulse=0,o.m_indexA=0,o.m_indexB=0,o.m_indexC=0,o.m_indexD=0,o.m_lcA=new T.b2Vec2,o.m_lcB=new T.b2Vec2,o.m_lcC=new T.b2Vec2,o.m_lcD=new T.b2Vec2,o.m_mA=0,o.m_mB=0,o.m_mC=0,o.m_mD=0,o.m_iA=0,o.m_iB=0,o.m_iC=0,o.m_iD=0,o.m_JvAC=new T.b2Vec2,o.m_JvBD=new T.b2Vec2,o.m_JwA=0,o.m_JwB=0,o.m_JwC=0,o.m_JwD=0,o.m_mass=0,o.m_qA=new T.b2Rot,o.m_qB=new T.b2Rot,o.m_qC=new T.b2Rot,o.m_qD=new T.b2Rot,o.m_lalcA=new T.b2Vec2,o.m_lalcB=new T.b2Vec2,o.m_lalcC=new T.b2Vec2,o.m_lalcD=new T.b2Vec2,o.m_joint1=t.joint1,o.m_joint2=t.joint2,o.m_typeA=o.m_joint1.GetType(),o.m_typeB=o.m_joint2.GetType(),o.m_bodyC=o.m_joint1.GetBodyA(),o.m_bodyA=o.m_joint1.GetBodyB();var n=o.m_bodyA.m_xf,s=o.m_bodyA.m_sweep.a,r=o.m_bodyC.m_xf,a=o.m_bodyC.m_sweep.a;if(1===o.m_typeA){var m=t.joint1;o.m_localAnchorC.Copy(m.m_localAnchorA),o.m_localAnchorA.Copy(m.m_localAnchorB),o.m_referenceAngleA=m.m_referenceAngle,o.m_localAxisC.SetZero(),e=s-a-o.m_referenceAngleA}else{var c=t.joint1;o.m_localAnchorC.Copy(c.m_localAnchorA),o.m_localAnchorA.Copy(c.m_localAnchorB),o.m_referenceAngleA=c.m_referenceAngle,o.m_localAxisC.Copy(c.m_localXAxisA);var _=o.m_localAnchorC,l=T.b2Rot.MulTRV(r.q,T.b2Vec2.AddVV(T.b2Rot.MulRV(n.q,o.m_localAnchorA,T.b2Vec2.s_t0),T.b2Vec2.SubVV(n.p,r.p,T.b2Vec2.s_t1),T.b2Vec2.s_t0),T.b2Vec2.s_t0);e=T.b2Vec2.DotVV(T.b2Vec2.SubVV(l,_,T.b2Vec2.s_t0),o.m_localAxisC)}o.m_bodyD=o.m_joint2.GetBodyA(),o.m_bodyB=o.m_joint2.GetBodyB();var h=o.m_bodyB.m_xf,u=o.m_bodyB.m_sweep.a,p=o.m_bodyD.m_xf,f=o.m_bodyD.m_sweep.a;if(1===o.m_typeB){m=t.joint2;o.m_localAnchorD.Copy(m.m_localAnchorA),o.m_localAnchorB.Copy(m.m_localAnchorB),o.m_referenceAngleB=m.m_referenceAngle,o.m_localAxisD.SetZero(),i=u-f-o.m_referenceAngleB}else{c=t.joint2;o.m_localAnchorD.Copy(c.m_localAnchorA),o.m_localAnchorB.Copy(c.m_localAnchorB),o.m_referenceAngleB=c.m_referenceAngle,o.m_localAxisD.Copy(c.m_localXAxisA);var d=o.m_localAnchorD,y=T.b2Rot.MulTRV(p.q,T.b2Vec2.AddVV(T.b2Rot.MulRV(h.q,o.m_localAnchorB,T.b2Vec2.s_t0),T.b2Vec2.SubVV(h.p,p.p,T.b2Vec2.s_t1),T.b2Vec2.s_t0),T.b2Vec2.s_t0);i=T.b2Vec2.DotVV(T.b2Vec2.SubVV(y,d,T.b2Vec2.s_t0),o.m_localAxisD)}return o.m_ratio=t.ratio,o.m_constant=e+o.m_ratio*i,o.m_impulse=0,o}return __extends(R,b),R.prototype.InitVelocityConstraints=function(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_indexC=this.m_bodyC.m_islandIndex,this.m_indexD=this.m_bodyD.m_islandIndex,this.m_lcA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_lcB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_lcC.Copy(this.m_bodyC.m_sweep.localCenter),this.m_lcD.Copy(this.m_bodyD.m_sweep.localCenter),this.m_mA=this.m_bodyA.m_invMass,this.m_mB=this.m_bodyB.m_invMass,this.m_mC=this.m_bodyC.m_invMass,this.m_mD=this.m_bodyD.m_invMass,this.m_iA=this.m_bodyA.m_invI,this.m_iB=this.m_bodyB.m_invI,this.m_iC=this.m_bodyC.m_invI,this.m_iD=this.m_bodyD.m_invI;var e=t.positions[this.m_indexA].a,i=t.velocities[this.m_indexA].v,o=t.velocities[this.m_indexA].w,n=t.positions[this.m_indexB].a,s=t.velocities[this.m_indexB].v,r=t.velocities[this.m_indexB].w,a=t.positions[this.m_indexC].a,m=t.velocities[this.m_indexC].v,c=t.velocities[this.m_indexC].w,_=t.positions[this.m_indexD].a,l=t.velocities[this.m_indexD].v,h=t.velocities[this.m_indexD].w,u=this.m_qA.SetAngle(e),p=this.m_qB.SetAngle(n),f=this.m_qC.SetAngle(a),d=this.m_qD.SetAngle(_);if(this.m_mass=0,1===this.m_typeA)this.m_JvAC.SetZero(),this.m_JwA=1,this.m_JwC=1,this.m_mass+=this.m_iA+this.m_iC;else{var y=T.b2Rot.MulRV(f,this.m_localAxisC,R.InitVelocityConstraints_s_u);T.b2Vec2.SubVV(this.m_localAnchorC,this.m_lcC,this.m_lalcC);var b=T.b2Rot.MulRV(f,this.m_lalcC,R.InitVelocityConstraints_s_rC);T.b2Vec2.SubVV(this.m_localAnchorA,this.m_lcA,this.m_lalcA);var V=T.b2Rot.MulRV(u,this.m_lalcA,R.InitVelocityConstraints_s_rA);this.m_JvAC.Copy(y),this.m_JwC=T.b2Vec2.CrossVV(b,y),this.m_JwA=T.b2Vec2.CrossVV(V,y),this.m_mass+=this.m_mC+this.m_mA+this.m_iC*this.m_JwC*this.m_JwC+this.m_iA*this.m_JwA*this.m_JwA}if(1===this.m_typeB)this.m_JvBD.SetZero(),this.m_JwB=this.m_ratio,this.m_JwD=this.m_ratio,this.m_mass+=this.m_ratio*this.m_ratio*(this.m_iB+this.m_iD);else{y=T.b2Rot.MulRV(d,this.m_localAxisD,R.InitVelocityConstraints_s_u);T.b2Vec2.SubVV(this.m_localAnchorD,this.m_lcD,this.m_lalcD);var v=T.b2Rot.MulRV(d,this.m_lalcD,R.InitVelocityConstraints_s_rD);T.b2Vec2.SubVV(this.m_localAnchorB,this.m_lcB,this.m_lalcB);var x=T.b2Rot.MulRV(p,this.m_lalcB,R.InitVelocityConstraints_s_rB);T.b2Vec2.MulSV(this.m_ratio,y,this.m_JvBD),this.m_JwD=this.m_ratio*T.b2Vec2.CrossVV(v,y),this.m_JwB=this.m_ratio*T.b2Vec2.CrossVV(x,y),this.m_mass+=this.m_ratio*this.m_ratio*(this.m_mD+this.m_mB)+this.m_iD*this.m_JwD*this.m_JwD+this.m_iB*this.m_JwB*this.m_JwB}this.m_mass=0<this.m_mass?1/this.m_mass:0,t.step.warmStarting?(i.SelfMulAdd(this.m_mA*this.m_impulse,this.m_JvAC),o+=this.m_iA*this.m_impulse*this.m_JwA,s.SelfMulAdd(this.m_mB*this.m_impulse,this.m_JvBD),r+=this.m_iB*this.m_impulse*this.m_JwB,m.SelfMulSub(this.m_mC*this.m_impulse,this.m_JvAC),c-=this.m_iC*this.m_impulse*this.m_JwC,l.SelfMulSub(this.m_mD*this.m_impulse,this.m_JvBD),h-=this.m_iD*this.m_impulse*this.m_JwD):this.m_impulse=0,t.velocities[this.m_indexA].w=o,t.velocities[this.m_indexB].w=r,t.velocities[this.m_indexC].w=c,t.velocities[this.m_indexD].w=h},R.prototype.SolveVelocityConstraints=function(t){var e=t.velocities[this.m_indexA].v,i=t.velocities[this.m_indexA].w,o=t.velocities[this.m_indexB].v,n=t.velocities[this.m_indexB].w,s=t.velocities[this.m_indexC].v,r=t.velocities[this.m_indexC].w,a=t.velocities[this.m_indexD].v,m=t.velocities[this.m_indexD].w,c=T.b2Vec2.DotVV(this.m_JvAC,T.b2Vec2.SubVV(e,s,T.b2Vec2.s_t0))+T.b2Vec2.DotVV(this.m_JvBD,T.b2Vec2.SubVV(o,a,T.b2Vec2.s_t0));c+=this.m_JwA*i-this.m_JwC*r+(this.m_JwB*n-this.m_JwD*m);var _=-this.m_mass*c;this.m_impulse+=_,e.SelfMulAdd(this.m_mA*_,this.m_JvAC),i+=this.m_iA*_*this.m_JwA,o.SelfMulAdd(this.m_mB*_,this.m_JvBD),n+=this.m_iB*_*this.m_JwB,s.SelfMulSub(this.m_mC*_,this.m_JvAC),r-=this.m_iC*_*this.m_JwC,a.SelfMulSub(this.m_mD*_,this.m_JvBD),m-=this.m_iD*_*this.m_JwD,t.velocities[this.m_indexA].w=i,t.velocities[this.m_indexB].w=n,t.velocities[this.m_indexC].w=r,t.velocities[this.m_indexD].w=m},R.prototype.SolvePositionConstraints=function(t){var e,i,o,n,s,r,a=t.positions[this.m_indexA].c,m=t.positions[this.m_indexA].a,c=t.positions[this.m_indexB].c,_=t.positions[this.m_indexB].a,l=t.positions[this.m_indexC].c,h=t.positions[this.m_indexC].a,u=t.positions[this.m_indexD].c,p=t.positions[this.m_indexD].a,f=this.m_qA.SetAngle(m),d=this.m_qB.SetAngle(_),y=this.m_qC.SetAngle(h),b=this.m_qD.SetAngle(p),V=this.m_JvAC,v=this.m_JvBD,x=0;if(1===this.m_typeA)V.SetZero(),s=o=1,x+=this.m_iA+this.m_iC,e=m-h-this.m_referenceAngleA;else{var C=T.b2Rot.MulRV(y,this.m_localAxisC,R.SolvePositionConstraints_s_u),S=T.b2Rot.MulRV(y,this.m_lalcC,R.SolvePositionConstraints_s_rC),B=T.b2Rot.MulRV(f,this.m_lalcA,R.SolvePositionConstraints_s_rA);V.Copy(C),s=T.b2Vec2.CrossVV(S,C),o=T.b2Vec2.CrossVV(B,C),x+=this.m_mC+this.m_mA+this.m_iC*s*s+this.m_iA*o*o;var A=this.m_lalcC,g=T.b2Rot.MulTRV(y,T.b2Vec2.AddVV(B,T.b2Vec2.SubVV(a,l,T.b2Vec2.s_t0),T.b2Vec2.s_t0),T.b2Vec2.s_t0);e=T.b2Vec2.DotVV(T.b2Vec2.SubVV(g,A,T.b2Vec2.s_t0),this.m_localAxisC)}if(1===this.m_typeB)v.SetZero(),n=this.m_ratio,r=this.m_ratio,x+=this.m_ratio*this.m_ratio*(this.m_iB+this.m_iD),i=_-p-this.m_referenceAngleB;else{C=T.b2Rot.MulRV(b,this.m_localAxisD,R.SolvePositionConstraints_s_u);var w=T.b2Rot.MulRV(b,this.m_lalcD,R.SolvePositionConstraints_s_rD),M=T.b2Rot.MulRV(d,this.m_lalcB,R.SolvePositionConstraints_s_rB);T.b2Vec2.MulSV(this.m_ratio,C,v),r=this.m_ratio*T.b2Vec2.CrossVV(w,C),n=this.m_ratio*T.b2Vec2.CrossVV(M,C),x+=this.m_ratio*this.m_ratio*(this.m_mD+this.m_mB)+this.m_iD*r*r+this.m_iB*n*n;var P=this.m_lalcD,I=T.b2Rot.MulTRV(b,T.b2Vec2.AddVV(M,T.b2Vec2.SubVV(c,u,T.b2Vec2.s_t0),T.b2Vec2.s_t0),T.b2Vec2.s_t0);i=T.b2Vec2.DotVV(T.b2Vec2.SubVV(I,P,T.b2Vec2.s_t0),this.m_localAxisD)}var D=e+this.m_ratio*i-this.m_constant,G=0;return 0<x&&(G=-D/x),a.SelfMulAdd(this.m_mA*G,V),m+=this.m_iA*G*o,c.SelfMulAdd(this.m_mB*G,v),_+=this.m_iB*G*n,l.SelfMulSub(this.m_mC*G,V),h-=this.m_iC*G*s,u.SelfMulSub(this.m_mD*G,v),p-=this.m_iD*G*r,t.positions[this.m_indexA].a=m,t.positions[this.m_indexB].a=_,t.positions[this.m_indexC].a=h,t.positions[this.m_indexD].a=p,0<F.b2_linearSlop},R.prototype.GetAnchorA=function(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)},R.prototype.GetAnchorB=function(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)},R.prototype.GetReactionForce=function(t,e){return T.b2Vec2.MulSV(t*this.m_impulse,this.m_JvAC,e)},R.prototype.GetReactionTorque=function(t){return t*this.m_impulse*this.m_JwA},R.prototype.GetJoint1=function(){return this.m_joint1},R.prototype.GetJoint2=function(){return this.m_joint2},R.prototype.GetRatio=function(){return this.m_ratio},R.prototype.SetRatio=function(t){this.m_ratio=t},R.prototype.Dump=function(t){var e=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex,o=this.m_joint1.m_index,n=this.m_joint2.m_index;t("  const jd: b2GearJointDef = new b2GearJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",i),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.joint1 = joints[%d];\n",o),t("  jd.joint2 = joints[%d];\n",n),t("  jd.ratio = %.15f;\n",this.m_ratio),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)},R.InitVelocityConstraints_s_u=new T.b2Vec2,R.InitVelocityConstraints_s_rA=new T.b2Vec2,R.InitVelocityConstraints_s_rB=new T.b2Vec2,R.InitVelocityConstraints_s_rC=new T.b2Vec2,R.InitVelocityConstraints_s_rD=new T.b2Vec2,R.SolvePositionConstraints_s_u=new T.b2Vec2,R.SolvePositionConstraints_s_rA=new T.b2Vec2,R.SolvePositionConstraints_s_rB=new T.b2Vec2,R.SolvePositionConstraints_s_rC=new T.b2Vec2,R.SolvePositionConstraints_s_rD=new T.b2Vec2,R}(i.b2Joint),t("b2GearJoint",n)}}}),System.register("Dynamics/Joints/b2MotorJoint",["Common/b2Math","Dynamics/Joints/b2Joint"],function(t,e){var x,i,o,n;e&&e.id;return{setters:[function(t){x=t},function(t){i=t}],execute:function(){o=function(e){function t(){var t=e.call(this,11)||this;return t.linearOffset=new x.b2Vec2(0,0),t.angularOffset=0,t.maxForce=1,t.maxTorque=1,t.correctionFactor=.3,t}return __extends(t,e),t.prototype.Initialize=function(t,e){this.bodyA=t,this.bodyB=e,this.bodyA.GetLocalPoint(this.bodyB.GetPosition(),this.linearOffset);var i=this.bodyA.GetAngle(),o=this.bodyB.GetAngle();this.angularOffset=o-i},t}(i.b2JointDef),t("b2MotorJointDef",o),n=function(i){function v(t){var e=i.call(this,t)||this;return e.m_linearOffset=new x.b2Vec2,e.m_angularOffset=0,e.m_linearImpulse=new x.b2Vec2,e.m_angularImpulse=0,e.m_maxForce=0,e.m_maxTorque=0,e.m_correctionFactor=.3,e.m_indexA=0,e.m_indexB=0,e.m_rA=new x.b2Vec2,e.m_rB=new x.b2Vec2,e.m_localCenterA=new x.b2Vec2,e.m_localCenterB=new x.b2Vec2,e.m_linearError=new x.b2Vec2,e.m_angularError=0,e.m_invMassA=0,e.m_invMassB=0,e.m_invIA=0,e.m_invIB=0,e.m_linearMass=new x.b2Mat22,e.m_angularMass=0,e.m_qA=new x.b2Rot,e.m_qB=new x.b2Rot,e.m_K=new x.b2Mat22,e.m_linearOffset.Copy(t.linearOffset),e.m_linearImpulse.SetZero(),e.m_maxForce=t.maxForce,e.m_maxTorque=t.maxTorque,e.m_correctionFactor=t.correctionFactor,e}return __extends(v,i),v.prototype.GetAnchorA=function(){return this.m_bodyA.GetPosition()},v.prototype.GetAnchorB=function(){return this.m_bodyB.GetPosition()},v.prototype.GetReactionForce=function(t,e){return x.b2Vec2.MulSV(t,this.m_linearImpulse,e)},v.prototype.GetReactionTorque=function(t){return t*this.m_angularImpulse},v.prototype.SetLinearOffset=function(t){x.b2Vec2.IsEqualToV(t,this.m_linearOffset)||(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_linearOffset.Copy(t))},v.prototype.GetLinearOffset=function(){return this.m_linearOffset},v.prototype.SetAngularOffset=function(t){t!==this.m_angularOffset&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_angularOffset=t)},v.prototype.GetAngularOffset=function(){return this.m_angularOffset},v.prototype.SetMaxForce=function(t){this.m_maxForce=t},v.prototype.GetMaxForce=function(){return this.m_maxForce},v.prototype.SetMaxTorque=function(t){this.m_maxTorque=t},v.prototype.GetMaxTorque=function(){return this.m_maxTorque},v.prototype.InitVelocityConstraints=function(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;var e=t.positions[this.m_indexA].c,i=t.positions[this.m_indexA].a,o=t.velocities[this.m_indexA].v,n=t.velocities[this.m_indexA].w,s=t.positions[this.m_indexB].c,r=t.positions[this.m_indexB].a,a=t.velocities[this.m_indexB].v,m=t.velocities[this.m_indexB].w,c=this.m_qA.SetAngle(i),_=this.m_qB.SetAngle(r),l=x.b2Rot.MulRV(c,x.b2Vec2.NegV(this.m_localCenterA,x.b2Vec2.s_t0),this.m_rA),h=x.b2Rot.MulRV(_,x.b2Vec2.NegV(this.m_localCenterB,x.b2Vec2.s_t0),this.m_rB),u=this.m_invMassA,p=this.m_invMassB,f=this.m_invIA,d=this.m_invIB,y=this.m_K;if(y.ex.x=u+p+f*l.y*l.y+d*h.y*h.y,y.ex.y=-f*l.x*l.y-d*h.x*h.y,y.ey.x=y.ex.y,y.ey.y=u+p+f*l.x*l.x+d*h.x*h.x,y.GetInverse(this.m_linearMass),this.m_angularMass=f+d,0<this.m_angularMass&&(this.m_angularMass=1/this.m_angularMass),x.b2Vec2.SubVV(x.b2Vec2.SubVV(x.b2Vec2.AddVV(s,h,x.b2Vec2.s_t0),x.b2Vec2.AddVV(e,l,x.b2Vec2.s_t1),x.b2Vec2.s_t2),x.b2Rot.MulRV(c,this.m_linearOffset,x.b2Vec2.s_t3),this.m_linearError),this.m_angularError=r-i-this.m_angularOffset,t.step.warmStarting){this.m_linearImpulse.SelfMul(t.step.dtRatio),this.m_angularImpulse*=t.step.dtRatio;var b=this.m_linearImpulse;o.SelfMulSub(u,b),n-=f*(x.b2Vec2.CrossVV(l,b)+this.m_angularImpulse),a.SelfMulAdd(p,b),m+=d*(x.b2Vec2.CrossVV(h,b)+this.m_angularImpulse)}else this.m_linearImpulse.SetZero(),this.m_angularImpulse=0;t.velocities[this.m_indexA].w=n,t.velocities[this.m_indexB].w=m},v.prototype.SolveVelocityConstraints=function(t){var e=t.velocities[this.m_indexA].v,i=t.velocities[this.m_indexA].w,o=t.velocities[this.m_indexB].v,n=t.velocities[this.m_indexB].w,s=this.m_invMassA,r=this.m_invMassB,a=this.m_invIA,m=this.m_invIB,c=t.step.dt,_=t.step.inv_dt,l=n-i+_*this.m_correctionFactor*this.m_angularError,h=-this.m_angularMass*l,u=this.m_angularImpulse,p=c*this.m_maxTorque;this.m_angularImpulse=x.b2Clamp(this.m_angularImpulse+h,-p,p),i-=a*(h=this.m_angularImpulse-u),n+=m*h;var f=this.m_rA,d=this.m_rB,y=x.b2Vec2.AddVV(x.b2Vec2.SubVV(x.b2Vec2.AddVV(o,x.b2Vec2.CrossSV(n,d,x.b2Vec2.s_t0),x.b2Vec2.s_t0),x.b2Vec2.AddVV(e,x.b2Vec2.CrossSV(i,f,x.b2Vec2.s_t1),x.b2Vec2.s_t1),x.b2Vec2.s_t2),x.b2Vec2.MulSV(_*this.m_correctionFactor,this.m_linearError,x.b2Vec2.s_t3),v.SolveVelocityConstraints_s_Cdot_v2),b=x.b2Mat22.MulMV(this.m_linearMass,y,v.SolveVelocityConstraints_s_impulse_v2).SelfNeg(),V=v.SolveVelocityConstraints_s_oldImpulse_v2.Copy(this.m_linearImpulse);this.m_linearImpulse.SelfAdd(b);p=c*this.m_maxForce;this.m_linearImpulse.LengthSquared()>p*p&&(this.m_linearImpulse.Normalize(),this.m_linearImpulse.SelfMul(p)),x.b2Vec2.SubVV(this.m_linearImpulse,V,b),e.SelfMulSub(s,b),i-=a*x.b2Vec2.CrossVV(f,b),o.SelfMulAdd(r,b),n+=m*x.b2Vec2.CrossVV(d,b),t.velocities[this.m_indexA].w=i,t.velocities[this.m_indexB].w=n},v.prototype.SolvePositionConstraints=function(t){return!0},v.prototype.Dump=function(t){var e=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex;t("  const jd: b2MotorJointDef = new b2MotorJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",i),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.linearOffset.Set(%.15f, %.15f);\n",this.m_linearOffset.x,this.m_linearOffset.y),t("  jd.angularOffset = %.15f;\n",this.m_angularOffset),t("  jd.maxForce = %.15f;\n",this.m_maxForce),t("  jd.maxTorque = %.15f;\n",this.m_maxTorque),t("  jd.correctionFactor = %.15f;\n",this.m_correctionFactor),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)},v.SolveVelocityConstraints_s_Cdot_v2=new x.b2Vec2,v.SolveVelocityConstraints_s_impulse_v2=new x.b2Vec2,v.SolveVelocityConstraints_s_oldImpulse_v2=new x.b2Vec2,v}(i.b2Joint),t("b2MotorJoint",n)}}}),System.register("Dynamics/Joints/b2MouseJoint",["Common/b2Settings","Common/b2Math","Dynamics/Joints/b2Joint"],function(t,e){var h,u,i,o,n;e&&e.id;return{setters:[function(t){h=t},function(t){u=t},function(t){i=t}],execute:function(){o=function(e){function t(){var t=e.call(this,5)||this;return t.target=new u.b2Vec2,t.maxForce=0,t.frequencyHz=5,t.dampingRatio=.7,t}return __extends(t,e),t}(i.b2JointDef),t("b2MouseJointDef",o),n=function(i){function a(t){var e=i.call(this,t)||this;return e.m_localAnchorB=null,e.m_targetA=null,e.m_frequencyHz=0,e.m_dampingRatio=0,e.m_beta=0,e.m_impulse=null,e.m_maxForce=0,e.m_gamma=0,e.m_indexA=0,e.m_indexB=0,e.m_rB=null,e.m_localCenterB=null,e.m_invMassB=0,e.m_invIB=0,e.m_mass=null,e.m_C=null,e.m_qB=null,e.m_lalcB=null,e.m_K=null,e.m_localAnchorB=new u.b2Vec2,e.m_targetA=new u.b2Vec2,e.m_impulse=new u.b2Vec2,e.m_rB=new u.b2Vec2,e.m_localCenterB=new u.b2Vec2,e.m_mass=new u.b2Mat22,e.m_C=new u.b2Vec2,e.m_qB=new u.b2Rot,e.m_lalcB=new u.b2Vec2,e.m_K=new u.b2Mat22,e.m_targetA.Copy(t.target),u.b2Transform.MulTXV(e.m_bodyB.GetTransform(),e.m_targetA,e.m_localAnchorB),e.m_maxForce=t.maxForce,e.m_impulse.SetZero(),e.m_frequencyHz=t.frequencyHz,e.m_dampingRatio=t.dampingRatio,e.m_beta=0,e.m_gamma=0,e}return __extends(a,i),a.prototype.SetTarget=function(t){this.m_bodyB.IsAwake()||this.m_bodyB.SetAwake(!0),this.m_targetA.Copy(t)},a.prototype.GetTarget=function(){return this.m_targetA},a.prototype.SetMaxForce=function(t){this.m_maxForce=t},a.prototype.GetMaxForce=function(){return this.m_maxForce},a.prototype.SetFrequency=function(t){this.m_frequencyHz=t},a.prototype.GetFrequency=function(){return this.m_frequencyHz},a.prototype.SetDampingRatio=function(t){this.m_dampingRatio=t},a.prototype.GetDampingRatio=function(){return this.m_dampingRatio},a.prototype.InitVelocityConstraints=function(t){this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIB=this.m_bodyB.m_invI;var e=t.positions[this.m_indexB].c,i=t.positions[this.m_indexB].a,o=t.velocities[this.m_indexB].v,n=t.velocities[this.m_indexB].w,s=this.m_qB.SetAngle(i),r=this.m_bodyB.GetMass(),a=2*h.b2_pi*this.m_frequencyHz,m=2*r*this.m_dampingRatio*a,c=r*(a*a),_=t.step.dt;this.m_gamma=_*(m+_*c),0!==this.m_gamma&&(this.m_gamma=1/this.m_gamma),this.m_beta=_*c*this.m_gamma,u.b2Vec2.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB),u.b2Rot.MulRV(s,this.m_lalcB,this.m_rB);var l=this.m_K;l.ex.x=this.m_invMassB+this.m_invIB*this.m_rB.y*this.m_rB.y+this.m_gamma,l.ex.y=-this.m_invIB*this.m_rB.x*this.m_rB.y,l.ey.x=l.ex.y,l.ey.y=this.m_invMassB+this.m_invIB*this.m_rB.x*this.m_rB.x+this.m_gamma,l.GetInverse(this.m_mass),this.m_C.x=e.x+this.m_rB.x-this.m_targetA.x,this.m_C.y=e.y+this.m_rB.y-this.m_targetA.y,this.m_C.SelfMul(this.m_beta),n*=.98,t.step.warmStarting?(this.m_impulse.SelfMul(t.step.dtRatio),o.x+=this.m_invMassB*this.m_impulse.x,o.y+=this.m_invMassB*this.m_impulse.y,n+=this.m_invIB*u.b2Vec2.CrossVV(this.m_rB,this.m_impulse)):this.m_impulse.SetZero(),t.velocities[this.m_indexB].w=n},a.prototype.SolveVelocityConstraints=function(t){var e=t.velocities[this.m_indexB].v,i=t.velocities[this.m_indexB].w,o=u.b2Vec2.AddVCrossSV(e,i,this.m_rB,a.SolveVelocityConstraints_s_Cdot),n=u.b2Mat22.MulMV(this.m_mass,u.b2Vec2.AddVV(o,u.b2Vec2.AddVV(this.m_C,u.b2Vec2.MulSV(this.m_gamma,this.m_impulse,u.b2Vec2.s_t0),u.b2Vec2.s_t0),u.b2Vec2.s_t0).SelfNeg(),a.SolveVelocityConstraints_s_impulse),s=a.SolveVelocityConstraints_s_oldImpulse.Copy(this.m_impulse);this.m_impulse.SelfAdd(n);var r=t.step.dt*this.m_maxForce;this.m_impulse.LengthSquared()>r*r&&this.m_impulse.SelfMul(r/this.m_impulse.Length()),u.b2Vec2.SubVV(this.m_impulse,s,n),e.SelfMulAdd(this.m_invMassB,n),i+=this.m_invIB*u.b2Vec2.CrossVV(this.m_rB,n),t.velocities[this.m_indexB].w=i},a.prototype.SolvePositionConstraints=function(t){return!0},a.prototype.GetAnchorA=function(t){return t.Copy(this.m_targetA)},a.prototype.GetAnchorB=function(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)},a.prototype.GetReactionForce=function(t,e){return u.b2Vec2.MulSV(t,this.m_impulse,e)},a.prototype.GetReactionTorque=function(t){return 0},a.prototype.Dump=function(t){t("Mouse joint dumping is not supported.\n")},a.prototype.ShiftOrigin=function(t){this.m_targetA.SelfSub(t)},a.SolveVelocityConstraints_s_Cdot=new u.b2Vec2,a.SolveVelocityConstraints_s_impulse=new u.b2Vec2,a.SolveVelocityConstraints_s_oldImpulse=new u.b2Vec2,a}(i.b2Joint),t("b2MouseJoint",n)}}}),System.register("Dynamics/Joints/b2PulleyJoint",["Common/b2Settings","Common/b2Math","Dynamics/Joints/b2Joint"],function(t,e){var B,A,i,o,n;e&&e.id;return{setters:[function(t){B=t},function(t){A=t},function(t){i=t}],execute:function(){t("b2_minPulleyLength",2),o=function(e){function t(){var t=e.call(this,4)||this;return t.groundAnchorA=new A.b2Vec2(-1,1),t.groundAnchorB=new A.b2Vec2(1,1),t.localAnchorA=new A.b2Vec2(-1,0),t.localAnchorB=new A.b2Vec2(1,0),t.lengthA=0,t.lengthB=0,t.ratio=1,t.collideConnected=!0,t}return __extends(t,e),t.prototype.Initialize=function(t,e,i,o,n,s,r){this.bodyA=t,this.bodyB=e,this.groundAnchorA.Copy(i),this.groundAnchorB.Copy(o),this.bodyA.GetLocalPoint(n,this.localAnchorA),this.bodyB.GetLocalPoint(s,this.localAnchorB),this.lengthA=A.b2Vec2.DistanceVV(n,i),this.lengthB=A.b2Vec2.DistanceVV(s,o),this.ratio=r},t}(i.b2JointDef),t("b2PulleyJointDef",o),n=function(i){function S(t){var e=i.call(this,t)||this;return e.m_groundAnchorA=new A.b2Vec2,e.m_groundAnchorB=new A.b2Vec2,e.m_lengthA=0,e.m_lengthB=0,e.m_localAnchorA=new A.b2Vec2,e.m_localAnchorB=new A.b2Vec2,e.m_constant=0,e.m_ratio=0,e.m_impulse=0,e.m_indexA=0,e.m_indexB=0,e.m_uA=new A.b2Vec2,e.m_uB=new A.b2Vec2,e.m_rA=new A.b2Vec2,e.m_rB=new A.b2Vec2,e.m_localCenterA=new A.b2Vec2,e.m_localCenterB=new A.b2Vec2,e.m_invMassA=0,e.m_invMassB=0,e.m_invIA=0,e.m_invIB=0,e.m_mass=0,e.m_qA=new A.b2Rot,e.m_qB=new A.b2Rot,e.m_lalcA=new A.b2Vec2,e.m_lalcB=new A.b2Vec2,e.m_groundAnchorA.Copy(t.groundAnchorA),e.m_groundAnchorB.Copy(t.groundAnchorB),e.m_localAnchorA.Copy(t.localAnchorA),e.m_localAnchorB.Copy(t.localAnchorB),e.m_lengthA=t.lengthA,e.m_lengthB=t.lengthB,e.m_ratio=t.ratio,e.m_constant=t.lengthA+e.m_ratio*t.lengthB,e.m_impulse=0,e}return __extends(S,i),S.prototype.InitVelocityConstraints=function(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;var e=t.positions[this.m_indexA].c,i=t.positions[this.m_indexA].a,o=t.velocities[this.m_indexA].v,n=t.velocities[this.m_indexA].w,s=t.positions[this.m_indexB].c,r=t.positions[this.m_indexB].a,a=t.velocities[this.m_indexB].v,m=t.velocities[this.m_indexB].w,c=this.m_qA.SetAngle(i),_=this.m_qB.SetAngle(r);A.b2Vec2.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA),A.b2Rot.MulRV(c,this.m_lalcA,this.m_rA),A.b2Vec2.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB),A.b2Rot.MulRV(_,this.m_lalcB,this.m_rB),this.m_uA.Copy(e).SelfAdd(this.m_rA).SelfSub(this.m_groundAnchorA),this.m_uB.Copy(s).SelfAdd(this.m_rB).SelfSub(this.m_groundAnchorB);var l=this.m_uA.Length(),h=this.m_uB.Length();l>10*B.b2_linearSlop?this.m_uA.SelfMul(1/l):this.m_uA.SetZero(),h>10*B.b2_linearSlop?this.m_uB.SelfMul(1/h):this.m_uB.SetZero();var u=A.b2Vec2.CrossVV(this.m_rA,this.m_uA),p=A.b2Vec2.CrossVV(this.m_rB,this.m_uB),f=this.m_invMassA+this.m_invIA*u*u,d=this.m_invMassB+this.m_invIB*p*p;if(this.m_mass=f+this.m_ratio*this.m_ratio*d,0<this.m_mass&&(this.m_mass=1/this.m_mass),t.step.warmStarting){this.m_impulse*=t.step.dtRatio;var y=A.b2Vec2.MulSV(-this.m_impulse,this.m_uA,S.InitVelocityConstraints_s_PA),b=A.b2Vec2.MulSV(-this.m_ratio*this.m_impulse,this.m_uB,S.InitVelocityConstraints_s_PB);o.SelfMulAdd(this.m_invMassA,y),n+=this.m_invIA*A.b2Vec2.CrossVV(this.m_rA,y),a.SelfMulAdd(this.m_invMassB,b),m+=this.m_invIB*A.b2Vec2.CrossVV(this.m_rB,b)}else this.m_impulse=0;t.velocities[this.m_indexA].w=n,t.velocities[this.m_indexB].w=m},S.prototype.SolveVelocityConstraints=function(t){var e=t.velocities[this.m_indexA].v,i=t.velocities[this.m_indexA].w,o=t.velocities[this.m_indexB].v,n=t.velocities[this.m_indexB].w,s=A.b2Vec2.AddVCrossSV(e,i,this.m_rA,S.SolveVelocityConstraints_s_vpA),r=A.b2Vec2.AddVCrossSV(o,n,this.m_rB,S.SolveVelocityConstraints_s_vpB),a=-A.b2Vec2.DotVV(this.m_uA,s)-this.m_ratio*A.b2Vec2.DotVV(this.m_uB,r),m=-this.m_mass*a;this.m_impulse+=m;var c=A.b2Vec2.MulSV(-m,this.m_uA,S.SolveVelocityConstraints_s_PA),_=A.b2Vec2.MulSV(-this.m_ratio*m,this.m_uB,S.SolveVelocityConstraints_s_PB);e.SelfMulAdd(this.m_invMassA,c),i+=this.m_invIA*A.b2Vec2.CrossVV(this.m_rA,c),o.SelfMulAdd(this.m_invMassB,_),n+=this.m_invIB*A.b2Vec2.CrossVV(this.m_rB,_),t.velocities[this.m_indexA].w=i,t.velocities[this.m_indexB].w=n},S.prototype.SolvePositionConstraints=function(t){var e=t.positions[this.m_indexA].c,i=t.positions[this.m_indexA].a,o=t.positions[this.m_indexB].c,n=t.positions[this.m_indexB].a,s=this.m_qA.SetAngle(i),r=this.m_qB.SetAngle(n);A.b2Vec2.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);var a=A.b2Rot.MulRV(s,this.m_lalcA,this.m_rA);A.b2Vec2.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);var m=A.b2Rot.MulRV(r,this.m_lalcB,this.m_rB),c=this.m_uA.Copy(e).SelfAdd(a).SelfSub(this.m_groundAnchorA),_=this.m_uB.Copy(o).SelfAdd(m).SelfSub(this.m_groundAnchorB),l=c.Length(),h=_.Length();l>10*B.b2_linearSlop?c.SelfMul(1/l):c.SetZero(),h>10*B.b2_linearSlop?_.SelfMul(1/h):_.SetZero();var u=A.b2Vec2.CrossVV(a,c),p=A.b2Vec2.CrossVV(m,_),f=this.m_invMassA+this.m_invIA*u*u,d=this.m_invMassB+this.m_invIB*p*p,y=f+this.m_ratio*this.m_ratio*d;0<y&&(y=1/y);var b=this.m_constant-l-this.m_ratio*h,V=A.b2Abs(b),v=-y*b,x=A.b2Vec2.MulSV(-v,c,S.SolvePositionConstraints_s_PA),C=A.b2Vec2.MulSV(-this.m_ratio*v,_,S.SolvePositionConstraints_s_PB);return e.SelfMulAdd(this.m_invMassA,x),i+=this.m_invIA*A.b2Vec2.CrossVV(a,x),o.SelfMulAdd(this.m_invMassB,C),n+=this.m_invIB*A.b2Vec2.CrossVV(m,C),t.positions[this.m_indexA].a=i,t.positions[this.m_indexB].a=n,V<B.b2_linearSlop},S.prototype.GetAnchorA=function(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)},S.prototype.GetAnchorB=function(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)},S.prototype.GetReactionForce=function(t,e){return e.Set(t*this.m_impulse*this.m_uB.x,t*this.m_impulse*this.m_uB.y)},S.prototype.GetReactionTorque=function(t){return 0},S.prototype.GetGroundAnchorA=function(){return this.m_groundAnchorA},S.prototype.GetGroundAnchorB=function(){return this.m_groundAnchorB},S.prototype.GetLengthA=function(){return this.m_lengthA},S.prototype.GetLengthB=function(){return this.m_lengthB},S.prototype.GetRatio=function(){return this.m_ratio},S.prototype.GetCurrentLengthA=function(){var t=this.m_bodyA.GetWorldPoint(this.m_localAnchorA,S.GetCurrentLengthA_s_p),e=this.m_groundAnchorA;return A.b2Vec2.DistanceVV(t,e)},S.prototype.GetCurrentLengthB=function(){var t=this.m_bodyB.GetWorldPoint(this.m_localAnchorB,S.GetCurrentLengthB_s_p),e=this.m_groundAnchorB;return A.b2Vec2.DistanceVV(t,e)},S.prototype.Dump=function(t){var e=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex;t("  const jd: b2PulleyJointDef = new b2PulleyJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",i),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.groundAnchorA.Set(%.15f, %.15f);\n",this.m_groundAnchorA.x,this.m_groundAnchorA.y),t("  jd.groundAnchorB.Set(%.15f, %.15f);\n",this.m_groundAnchorB.x,this.m_groundAnchorB.y),t("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.m_localAnchorA.x,this.m_localAnchorA.y),t("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.m_localAnchorB.x,this.m_localAnchorB.y),t("  jd.lengthA = %.15f;\n",this.m_lengthA),t("  jd.lengthB = %.15f;\n",this.m_lengthB),t("  jd.ratio = %.15f;\n",this.m_ratio),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)},S.prototype.ShiftOrigin=function(t){this.m_groundAnchorA.SelfSub(t),this.m_groundAnchorB.SelfSub(t)},S.InitVelocityConstraints_s_PA=new A.b2Vec2,S.InitVelocityConstraints_s_PB=new A.b2Vec2,S.SolveVelocityConstraints_s_vpA=new A.b2Vec2,S.SolveVelocityConstraints_s_vpB=new A.b2Vec2,S.SolveVelocityConstraints_s_PA=new A.b2Vec2,S.SolveVelocityConstraints_s_PB=new A.b2Vec2,S.SolvePositionConstraints_s_PA=new A.b2Vec2,S.SolvePositionConstraints_s_PB=new A.b2Vec2,S.GetCurrentLengthA_s_p=new A.b2Vec2,S.GetCurrentLengthB_s_p=new A.b2Vec2,S}(i.b2Joint),t("b2PulleyJoint",n)}}}),System.register("Dynamics/Joints/b2RopeJoint",["Common/b2Settings","Common/b2Math","Dynamics/Joints/b2Joint"],function(t,e){var y,b,i,o,n;e&&e.id;return{setters:[function(t){y=t},function(t){b=t},function(t){i=t}],execute:function(){o=function(e){function t(){var t=e.call(this,10)||this;return t.localAnchorA=new b.b2Vec2(-1,0),t.localAnchorB=new b.b2Vec2(1,0),t.maxLength=0,t}return __extends(t,e),t}(i.b2JointDef),t("b2RopeJointDef",o),n=function(i){function d(t){var e=i.call(this,t)||this;return e.m_localAnchorA=new b.b2Vec2,e.m_localAnchorB=new b.b2Vec2,e.m_maxLength=0,e.m_length=0,e.m_impulse=0,e.m_indexA=0,e.m_indexB=0,e.m_u=new b.b2Vec2,e.m_rA=new b.b2Vec2,e.m_rB=new b.b2Vec2,e.m_localCenterA=new b.b2Vec2,e.m_localCenterB=new b.b2Vec2,e.m_invMassA=0,e.m_invMassB=0,e.m_invIA=0,e.m_invIB=0,e.m_mass=0,e.m_state=0,e.m_qA=new b.b2Rot,e.m_qB=new b.b2Rot,e.m_lalcA=new b.b2Vec2,e.m_lalcB=new b.b2Vec2,e.m_localAnchorA.Copy(t.localAnchorA),e.m_localAnchorB.Copy(t.localAnchorB),e.m_maxLength=t.maxLength,e}return __extends(d,i),d.prototype.InitVelocityConstraints=function(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;var e=t.positions[this.m_indexA].c,i=t.positions[this.m_indexA].a,o=t.velocities[this.m_indexA].v,n=t.velocities[this.m_indexA].w,s=t.positions[this.m_indexB].c,r=t.positions[this.m_indexB].a,a=t.velocities[this.m_indexB].v,m=t.velocities[this.m_indexB].w,c=this.m_qA.SetAngle(i),_=this.m_qB.SetAngle(r);b.b2Vec2.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA),b.b2Rot.MulRV(c,this.m_lalcA,this.m_rA),b.b2Vec2.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB),b.b2Rot.MulRV(_,this.m_lalcB,this.m_rB),this.m_u.Copy(s).SelfAdd(this.m_rB).SelfSub(e).SelfSub(this.m_rA),this.m_length=this.m_u.Length();var l=this.m_length-this.m_maxLength;if(this.m_state=0<l?2:0,!(this.m_length>y.b2_linearSlop))return this.m_u.SetZero(),this.m_mass=0,void(this.m_impulse=0);this.m_u.SelfMul(1/this.m_length);var h=b.b2Vec2.CrossVV(this.m_rA,this.m_u),u=b.b2Vec2.CrossVV(this.m_rB,this.m_u),p=this.m_invMassA+this.m_invIA*h*h+this.m_invMassB+this.m_invIB*u*u;if(this.m_mass=0!==p?1/p:0,t.step.warmStarting){this.m_impulse*=t.step.dtRatio;var f=b.b2Vec2.MulSV(this.m_impulse,this.m_u,d.InitVelocityConstraints_s_P);o.SelfMulSub(this.m_invMassA,f),n-=this.m_invIA*b.b2Vec2.CrossVV(this.m_rA,f),a.SelfMulAdd(this.m_invMassB,f),m+=this.m_invIB*b.b2Vec2.CrossVV(this.m_rB,f)}else this.m_impulse=0;t.velocities[this.m_indexA].w=n,t.velocities[this.m_indexB].w=m},d.prototype.SolveVelocityConstraints=function(t){var e=t.velocities[this.m_indexA].v,i=t.velocities[this.m_indexA].w,o=t.velocities[this.m_indexB].v,n=t.velocities[this.m_indexB].w,s=b.b2Vec2.AddVCrossSV(e,i,this.m_rA,d.SolveVelocityConstraints_s_vpA),r=b.b2Vec2.AddVCrossSV(o,n,this.m_rB,d.SolveVelocityConstraints_s_vpB),a=this.m_length-this.m_maxLength,m=b.b2Vec2.DotVV(this.m_u,b.b2Vec2.SubVV(r,s,b.b2Vec2.s_t0));a<0&&(m+=t.step.inv_dt*a);var c=-this.m_mass*m,_=this.m_impulse;this.m_impulse=b.b2Min(0,this.m_impulse+c),c=this.m_impulse-_;var l=b.b2Vec2.MulSV(c,this.m_u,d.SolveVelocityConstraints_s_P);e.SelfMulSub(this.m_invMassA,l),i-=this.m_invIA*b.b2Vec2.CrossVV(this.m_rA,l),o.SelfMulAdd(this.m_invMassB,l),n+=this.m_invIB*b.b2Vec2.CrossVV(this.m_rB,l),t.velocities[this.m_indexA].w=i,t.velocities[this.m_indexB].w=n},d.prototype.SolvePositionConstraints=function(t){var e=t.positions[this.m_indexA].c,i=t.positions[this.m_indexA].a,o=t.positions[this.m_indexB].c,n=t.positions[this.m_indexB].a,s=this.m_qA.SetAngle(i),r=this.m_qB.SetAngle(n);b.b2Vec2.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);var a=b.b2Rot.MulRV(s,this.m_lalcA,this.m_rA);b.b2Vec2.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);var m=b.b2Rot.MulRV(r,this.m_lalcB,this.m_rB),c=this.m_u.Copy(o).SelfAdd(m).SelfSub(e).SelfSub(a),_=c.Normalize(),l=_-this.m_maxLength;l=b.b2Clamp(l,0,y.b2_maxLinearCorrection);var h=-this.m_mass*l,u=b.b2Vec2.MulSV(h,c,d.SolvePositionConstraints_s_P);return e.SelfMulSub(this.m_invMassA,u),i-=this.m_invIA*b.b2Vec2.CrossVV(a,u),o.SelfMulAdd(this.m_invMassB,u),n+=this.m_invIB*b.b2Vec2.CrossVV(m,u),t.positions[this.m_indexA].a=i,t.positions[this.m_indexB].a=n,_-this.m_maxLength<y.b2_linearSlop},d.prototype.GetAnchorA=function(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)},d.prototype.GetAnchorB=function(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)},d.prototype.GetReactionForce=function(t,e){return b.b2Vec2.MulSV(t*this.m_impulse,this.m_u,e)},d.prototype.GetReactionTorque=function(t){return 0},d.prototype.GetLocalAnchorA=function(){return this.m_localAnchorA},d.prototype.GetLocalAnchorB=function(){return this.m_localAnchorB},d.prototype.SetMaxLength=function(t){this.m_maxLength=t},d.prototype.GetMaxLength=function(){return this.m_maxLength},d.prototype.GetLimitState=function(){return this.m_state},d.prototype.Dump=function(t){var e=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex;t("  const jd: b2RopeJointDef = new b2RopeJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",i),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.m_localAnchorA.x,this.m_localAnchorA.y),t("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.m_localAnchorB.x,this.m_localAnchorB.y),t("  jd.maxLength = %.15f;\n",this.m_maxLength),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)},d.InitVelocityConstraints_s_P=new b.b2Vec2,d.SolveVelocityConstraints_s_vpA=new b.b2Vec2,d.SolveVelocityConstraints_s_vpB=new b.b2Vec2,d.SolveVelocityConstraints_s_P=new b.b2Vec2,d.SolvePositionConstraints_s_P=new b.b2Vec2,d}(i.b2Joint),t("b2RopeJoint",n)}}}),System.register("Dynamics/Joints/b2WeldJoint",["Common/b2Settings","Common/b2Math","Dynamics/Joints/b2Joint"],function(t,e){var S,B,i,o,n;e&&e.id;return{setters:[function(t){S=t},function(t){B=t},function(t){i=t}],execute:function(){o=function(e){function t(){var t=e.call(this,8)||this;return t.localAnchorA=new B.b2Vec2,t.localAnchorB=new B.b2Vec2,t.referenceAngle=0,t.frequencyHz=0,t.dampingRatio=0,t}return __extends(t,e),t.prototype.Initialize=function(t,e,i){this.bodyA=t,this.bodyB=e,this.bodyA.GetLocalPoint(i,this.localAnchorA),this.bodyB.GetLocalPoint(i,this.localAnchorB),this.referenceAngle=this.bodyB.GetAngle()-this.bodyA.GetAngle()},t}(i.b2JointDef),t("b2WeldJointDef",o),n=function(i){function C(t){var e=i.call(this,t)||this;return e.m_frequencyHz=0,e.m_dampingRatio=0,e.m_bias=0,e.m_localAnchorA=new B.b2Vec2,e.m_localAnchorB=new B.b2Vec2,e.m_referenceAngle=0,e.m_gamma=0,e.m_impulse=new B.b2Vec3(0,0,0),e.m_indexA=0,e.m_indexB=0,e.m_rA=new B.b2Vec2,e.m_rB=new B.b2Vec2,e.m_localCenterA=new B.b2Vec2,e.m_localCenterB=new B.b2Vec2,e.m_invMassA=0,e.m_invMassB=0,e.m_invIA=0,e.m_invIB=0,e.m_mass=new B.b2Mat33,e.m_qA=new B.b2Rot,e.m_qB=new B.b2Rot,e.m_lalcA=new B.b2Vec2,e.m_lalcB=new B.b2Vec2,e.m_K=new B.b2Mat33,e.m_frequencyHz=t.frequencyHz,e.m_dampingRatio=t.dampingRatio,e.m_localAnchorA.Copy(t.localAnchorA),e.m_localAnchorB.Copy(t.localAnchorB),e.m_referenceAngle=t.referenceAngle,e.m_impulse.SetZero(),e}return __extends(C,i),C.prototype.InitVelocityConstraints=function(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;var e=t.positions[this.m_indexA].a,i=t.velocities[this.m_indexA].v,o=t.velocities[this.m_indexA].w,n=t.positions[this.m_indexB].a,s=t.velocities[this.m_indexB].v,r=t.velocities[this.m_indexB].w,a=this.m_qA.SetAngle(e),m=this.m_qB.SetAngle(n);B.b2Vec2.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA),B.b2Rot.MulRV(a,this.m_lalcA,this.m_rA),B.b2Vec2.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB),B.b2Rot.MulRV(m,this.m_lalcB,this.m_rB);var c=this.m_invMassA,_=this.m_invMassB,l=this.m_invIA,h=this.m_invIB,u=this.m_K;if(u.ex.x=c+_+this.m_rA.y*this.m_rA.y*l+this.m_rB.y*this.m_rB.y*h,u.ey.x=-this.m_rA.y*this.m_rA.x*l-this.m_rB.y*this.m_rB.x*h,u.ez.x=-this.m_rA.y*l-this.m_rB.y*h,u.ex.y=u.ey.x,u.ey.y=c+_+this.m_rA.x*this.m_rA.x*l+this.m_rB.x*this.m_rB.x*h,u.ez.y=this.m_rA.x*l+this.m_rB.x*h,u.ex.z=u.ez.x,u.ey.z=u.ez.y,u.ez.z=l+h,0<this.m_frequencyHz){u.GetInverse22(this.m_mass);var p=l+h,f=0<p?1/p:0,d=n-e-this.m_referenceAngle,y=2*S.b2_pi*this.m_frequencyHz,b=2*f*this.m_dampingRatio*y,V=f*y*y,v=t.step.dt;this.m_gamma=v*(b+v*V),this.m_gamma=0!==this.m_gamma?1/this.m_gamma:0,this.m_bias=d*v*V*this.m_gamma,p+=this.m_gamma,this.m_mass.ez.z=0!==p?1/p:0}else u.GetSymInverse33(this.m_mass),this.m_gamma=0,this.m_bias=0;if(t.step.warmStarting){this.m_impulse.SelfMul(t.step.dtRatio);var x=C.InitVelocityConstraints_s_P.Set(this.m_impulse.x,this.m_impulse.y);i.SelfMulSub(c,x),o-=l*(B.b2Vec2.CrossVV(this.m_rA,x)+this.m_impulse.z),s.SelfMulAdd(_,x),r+=h*(B.b2Vec2.CrossVV(this.m_rB,x)+this.m_impulse.z)}else this.m_impulse.SetZero();t.velocities[this.m_indexA].w=o,t.velocities[this.m_indexB].w=r},C.prototype.SolveVelocityConstraints=function(t){var e=t.velocities[this.m_indexA].v,i=t.velocities[this.m_indexA].w,o=t.velocities[this.m_indexB].v,n=t.velocities[this.m_indexB].w,s=this.m_invMassA,r=this.m_invMassB,a=this.m_invIA,m=this.m_invIB;if(0<this.m_frequencyHz){var c=n-i,_=-this.m_mass.ez.z*(c+this.m_bias+this.m_gamma*this.m_impulse.z);this.m_impulse.z+=_,i-=a*_,n+=m*_;var l=B.b2Vec2.SubVV(B.b2Vec2.AddVCrossSV(o,n,this.m_rB,B.b2Vec2.s_t0),B.b2Vec2.AddVCrossSV(e,i,this.m_rA,B.b2Vec2.s_t1),C.SolveVelocityConstraints_s_Cdot1),h=B.b2Mat33.MulM33XY(this.m_mass,l.x,l.y,C.SolveVelocityConstraints_s_impulse1).SelfNeg();this.m_impulse.x+=h.x,this.m_impulse.y+=h.y;var u=h;e.SelfMulSub(s,u),i-=a*B.b2Vec2.CrossVV(this.m_rA,u),o.SelfMulAdd(r,u),n+=m*B.b2Vec2.CrossVV(this.m_rB,u)}else{l=B.b2Vec2.SubVV(B.b2Vec2.AddVCrossSV(o,n,this.m_rB,B.b2Vec2.s_t0),B.b2Vec2.AddVCrossSV(e,i,this.m_rA,B.b2Vec2.s_t1),C.SolveVelocityConstraints_s_Cdot1),c=n-i;var p=B.b2Mat33.MulM33XYZ(this.m_mass,l.x,l.y,c,C.SolveVelocityConstraints_s_impulse).SelfNeg();this.m_impulse.SelfAdd(p);u=C.SolveVelocityConstraints_s_P.Set(p.x,p.y);e.SelfMulSub(s,u),i-=a*(B.b2Vec2.CrossVV(this.m_rA,u)+p.z),o.SelfMulAdd(r,u),n+=m*(B.b2Vec2.CrossVV(this.m_rB,u)+p.z)}t.velocities[this.m_indexA].w=i,t.velocities[this.m_indexB].w=n},C.prototype.SolvePositionConstraints=function(t){var e=t.positions[this.m_indexA].c,i=t.positions[this.m_indexA].a,o=t.positions[this.m_indexB].c,n=t.positions[this.m_indexB].a,s=this.m_qA.SetAngle(i),r=this.m_qB.SetAngle(n),a=this.m_invMassA,m=this.m_invMassB,c=this.m_invIA,_=this.m_invIB;B.b2Vec2.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);var l=B.b2Rot.MulRV(s,this.m_lalcA,this.m_rA);B.b2Vec2.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);var h,u,p=B.b2Rot.MulRV(r,this.m_lalcB,this.m_rB),f=this.m_K;if(f.ex.x=a+m+l.y*l.y*c+p.y*p.y*_,f.ey.x=-l.y*l.x*c-p.y*p.x*_,f.ez.x=-l.y*c-p.y*_,f.ex.y=f.ey.x,f.ey.y=a+m+l.x*l.x*c+p.x*p.x*_,f.ez.y=l.x*c+p.x*_,f.ex.z=f.ez.x,f.ey.z=f.ez.y,f.ez.z=c+_,0<this.m_frequencyHz){h=(y=B.b2Vec2.SubVV(B.b2Vec2.AddVV(o,p,B.b2Vec2.s_t0),B.b2Vec2.AddVV(e,l,B.b2Vec2.s_t1),C.SolvePositionConstraints_s_C1)).Length(),u=0;var d=f.Solve22(y.x,y.y,C.SolvePositionConstraints_s_P).SelfNeg();e.SelfMulSub(a,d),i-=c*B.b2Vec2.CrossVV(l,d),o.SelfMulAdd(m,d),n+=_*B.b2Vec2.CrossVV(p,d)}else{var y=B.b2Vec2.SubVV(B.b2Vec2.AddVV(o,p,B.b2Vec2.s_t0),B.b2Vec2.AddVV(e,l,B.b2Vec2.s_t1),C.SolvePositionConstraints_s_C1),b=n-i-this.m_referenceAngle;h=y.Length(),u=B.b2Abs(b);var V=f.Solve33(y.x,y.y,b,C.SolvePositionConstraints_s_impulse).SelfNeg();d=C.SolvePositionConstraints_s_P.Set(V.x,V.y);e.SelfMulSub(a,d),i-=c*(B.b2Vec2.CrossVV(this.m_rA,d)+V.z),o.SelfMulAdd(m,d),n+=_*(B.b2Vec2.CrossVV(this.m_rB,d)+V.z)}return t.positions[this.m_indexA].a=i,t.positions[this.m_indexB].a=n,h<=S.b2_linearSlop&&u<=S.b2_angularSlop},C.prototype.GetAnchorA=function(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)},C.prototype.GetAnchorB=function(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)},C.prototype.GetReactionForce=function(t,e){return e.Set(t*this.m_impulse.x,t*this.m_impulse.y)},C.prototype.GetReactionTorque=function(t){return t*this.m_impulse.z},C.prototype.GetLocalAnchorA=function(){return this.m_localAnchorA},C.prototype.GetLocalAnchorB=function(){return this.m_localAnchorB},C.prototype.GetReferenceAngle=function(){return this.m_referenceAngle},C.prototype.SetFrequency=function(t){this.m_frequencyHz=t},C.prototype.GetFrequency=function(){return this.m_frequencyHz},C.prototype.SetDampingRatio=function(t){this.m_dampingRatio=t},C.prototype.GetDampingRatio=function(){return this.m_dampingRatio},C.prototype.Dump=function(t){var e=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex;t("  const jd: b2WeldJointDef = new b2WeldJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",i),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.m_localAnchorA.x,this.m_localAnchorA.y),t("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.m_localAnchorB.x,this.m_localAnchorB.y),t("  jd.referenceAngle = %.15f;\n",this.m_referenceAngle),t("  jd.frequencyHz = %.15f;\n",this.m_frequencyHz),t("  jd.dampingRatio = %.15f;\n",this.m_dampingRatio),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)},C.InitVelocityConstraints_s_P=new B.b2Vec2,C.SolveVelocityConstraints_s_Cdot1=new B.b2Vec2,C.SolveVelocityConstraints_s_impulse1=new B.b2Vec2,C.SolveVelocityConstraints_s_impulse=new B.b2Vec3,C.SolveVelocityConstraints_s_P=new B.b2Vec2,C.SolvePositionConstraints_s_C1=new B.b2Vec2,C.SolvePositionConstraints_s_P=new B.b2Vec2,C.SolvePositionConstraints_s_impulse=new B.b2Vec3,C}(i.b2Joint),t("b2WeldJoint",n)}}}),System.register("Dynamics/Joints/b2WheelJoint",["Common/b2Settings","Common/b2Math","Dynamics/Joints/b2Joint"],function(t,e){var M,P,i,o,n;e&&e.id;return{setters:[function(t){M=t},function(t){P=t},function(t){i=t}],execute:function(){o=function(e){function t(){var t=e.call(this,7)||this;return t.localAnchorA=new P.b2Vec2(0,0),t.localAnchorB=new P.b2Vec2(0,0),t.localAxisA=new P.b2Vec2(1,0),t.enableMotor=!1,t.maxMotorTorque=0,t.motorSpeed=0,t.frequencyHz=2,t.dampingRatio=.7,t}return __extends(t,e),t.prototype.Initialize=function(t,e,i,o){this.bodyA=t,this.bodyB=e,this.bodyA.GetLocalPoint(i,this.localAnchorA),this.bodyB.GetLocalPoint(i,this.localAnchorB),this.bodyA.GetLocalVector(o,this.localAxisA)},t}(i.b2JointDef),t("b2WheelJointDef",o),n=function(i){function w(t){var e=i.call(this,t)||this;return e.m_frequencyHz=0,e.m_dampingRatio=0,e.m_localAnchorA=new P.b2Vec2,e.m_localAnchorB=new P.b2Vec2,e.m_localXAxisA=new P.b2Vec2,e.m_localYAxisA=new P.b2Vec2,e.m_impulse=0,e.m_motorImpulse=0,e.m_springImpulse=0,e.m_maxMotorTorque=0,e.m_motorSpeed=0,e.m_enableMotor=!1,e.m_indexA=0,e.m_indexB=0,e.m_localCenterA=new P.b2Vec2,e.m_localCenterB=new P.b2Vec2,e.m_invMassA=0,e.m_invMassB=0,e.m_invIA=0,e.m_invIB=0,e.m_ax=new P.b2Vec2,e.m_ay=new P.b2Vec2,e.m_sAx=0,e.m_sBx=0,e.m_sAy=0,e.m_sBy=0,e.m_mass=0,e.m_motorMass=0,e.m_springMass=0,e.m_bias=0,e.m_gamma=0,e.m_qA=new P.b2Rot,e.m_qB=new P.b2Rot,e.m_lalcA=new P.b2Vec2,e.m_lalcB=new P.b2Vec2,e.m_rA=new P.b2Vec2,e.m_rB=new P.b2Vec2,e.m_frequencyHz=t.frequencyHz,e.m_dampingRatio=t.dampingRatio,e.m_localAnchorA.Copy(t.localAnchorA),e.m_localAnchorB.Copy(t.localAnchorB),e.m_localXAxisA.Copy(t.localAxisA),P.b2Vec2.CrossOneV(e.m_localXAxisA,e.m_localYAxisA),e.m_maxMotorTorque=t.maxMotorTorque,e.m_motorSpeed=t.motorSpeed,e.m_enableMotor=t.enableMotor,e.m_ax.SetZero(),e.m_ay.SetZero(),e}return __extends(w,i),w.prototype.GetMotorSpeed=function(){return this.m_motorSpeed},w.prototype.GetMaxMotorTorque=function(){return this.m_maxMotorTorque},w.prototype.SetSpringFrequencyHz=function(t){this.m_frequencyHz=t},w.prototype.GetSpringFrequencyHz=function(){return this.m_frequencyHz},w.prototype.SetSpringDampingRatio=function(t){this.m_dampingRatio=t},w.prototype.GetSpringDampingRatio=function(){return this.m_dampingRatio},w.prototype.InitVelocityConstraints=function(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;var e=this.m_invMassA,i=this.m_invMassB,o=this.m_invIA,n=this.m_invIB,s=t.positions[this.m_indexA].c,r=t.positions[this.m_indexA].a,a=t.velocities[this.m_indexA].v,m=t.velocities[this.m_indexA].w,c=t.positions[this.m_indexB].c,_=t.positions[this.m_indexB].a,l=t.velocities[this.m_indexB].v,h=t.velocities[this.m_indexB].w,u=this.m_qA.SetAngle(r),p=this.m_qB.SetAngle(_);P.b2Vec2.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);var f=P.b2Rot.MulRV(u,this.m_lalcA,this.m_rA);P.b2Vec2.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);var d=P.b2Rot.MulRV(p,this.m_lalcB,this.m_rB),y=P.b2Vec2.SubVV(P.b2Vec2.AddVV(c,d,P.b2Vec2.s_t0),P.b2Vec2.AddVV(s,f,P.b2Vec2.s_t1),w.InitVelocityConstraints_s_d);if(P.b2Rot.MulRV(u,this.m_localYAxisA,this.m_ay),this.m_sAy=P.b2Vec2.CrossVV(P.b2Vec2.AddVV(y,f,P.b2Vec2.s_t0),this.m_ay),this.m_sBy=P.b2Vec2.CrossVV(d,this.m_ay),this.m_mass=e+i+o*this.m_sAy*this.m_sAy+n*this.m_sBy*this.m_sBy,0<this.m_mass&&(this.m_mass=1/this.m_mass),this.m_springMass=0,this.m_bias=0,(this.m_gamma=0)<this.m_frequencyHz){P.b2Rot.MulRV(u,this.m_localXAxisA,this.m_ax),this.m_sAx=P.b2Vec2.CrossVV(P.b2Vec2.AddVV(y,f,P.b2Vec2.s_t0),this.m_ax),this.m_sBx=P.b2Vec2.CrossVV(d,this.m_ax);var b=e+i+o*this.m_sAx*this.m_sAx+n*this.m_sBx*this.m_sBx;if(0<b){this.m_springMass=1/b;var V=P.b2Vec2.DotVV(y,this.m_ax),v=2*M.b2_pi*this.m_frequencyHz,x=2*this.m_springMass*this.m_dampingRatio*v,C=this.m_springMass*v*v,S=t.step.dt;this.m_gamma=S*(x+S*C),0<this.m_gamma&&(this.m_gamma=1/this.m_gamma),this.m_bias=V*S*C*this.m_gamma,this.m_springMass=b+this.m_gamma,0<this.m_springMass&&(this.m_springMass=1/this.m_springMass)}}else this.m_springImpulse=0;if(this.m_enableMotor?(this.m_motorMass=o+n,0<this.m_motorMass&&(this.m_motorMass=1/this.m_motorMass)):(this.m_motorMass=0,this.m_motorImpulse=0),t.step.warmStarting){this.m_impulse*=t.step.dtRatio,this.m_springImpulse*=t.step.dtRatio,this.m_motorImpulse*=t.step.dtRatio;var B=P.b2Vec2.AddVV(P.b2Vec2.MulSV(this.m_impulse,this.m_ay,P.b2Vec2.s_t0),P.b2Vec2.MulSV(this.m_springImpulse,this.m_ax,P.b2Vec2.s_t1),w.InitVelocityConstraints_s_P),A=this.m_impulse*this.m_sAy+this.m_springImpulse*this.m_sAx+this.m_motorImpulse,g=this.m_impulse*this.m_sBy+this.m_springImpulse*this.m_sBx+this.m_motorImpulse;a.SelfMulSub(this.m_invMassA,B),m-=this.m_invIA*A,l.SelfMulAdd(this.m_invMassB,B),h+=this.m_invIB*g}else this.m_impulse=0,this.m_springImpulse=0,this.m_motorImpulse=0;t.velocities[this.m_indexA].w=m,t.velocities[this.m_indexB].w=h},w.prototype.SolveVelocityConstraints=function(t){var e=this.m_invMassA,i=this.m_invMassB,o=this.m_invIA,n=this.m_invIB,s=t.velocities[this.m_indexA].v,r=t.velocities[this.m_indexA].w,a=t.velocities[this.m_indexB].v,m=t.velocities[this.m_indexB].w,c=P.b2Vec2.DotVV(this.m_ax,P.b2Vec2.SubVV(a,s,P.b2Vec2.s_t0))+this.m_sBx*m-this.m_sAx*r,_=-this.m_springMass*(c+this.m_bias+this.m_gamma*this.m_springImpulse);this.m_springImpulse+=_;var l=P.b2Vec2.MulSV(_,this.m_ax,w.SolveVelocityConstraints_s_P),h=_*this.m_sAx,u=_*this.m_sBx;s.SelfMulSub(e,l),r-=o*h,a.SelfMulAdd(i,l);c=(m+=n*u)-r-this.m_motorSpeed,_=-this.m_motorMass*c;var p=this.m_motorImpulse,f=t.step.dt*this.m_maxMotorTorque;this.m_motorImpulse=P.b2Clamp(this.m_motorImpulse+_,-f,f),r-=o*(_=this.m_motorImpulse-p),m+=n*_;c=P.b2Vec2.DotVV(this.m_ay,P.b2Vec2.SubVV(a,s,P.b2Vec2.s_t0))+this.m_sBy*m-this.m_sAy*r,_=-this.m_mass*c;this.m_impulse+=_;l=P.b2Vec2.MulSV(_,this.m_ay,w.SolveVelocityConstraints_s_P),h=_*this.m_sAy,u=_*this.m_sBy;s.SelfMulSub(e,l),r-=o*h,a.SelfMulAdd(i,l),m+=n*u,t.velocities[this.m_indexA].w=r,t.velocities[this.m_indexB].w=m},w.prototype.SolvePositionConstraints=function(t){var e=t.positions[this.m_indexA].c,i=t.positions[this.m_indexA].a,o=t.positions[this.m_indexB].c,n=t.positions[this.m_indexB].a,s=this.m_qA.SetAngle(i),r=this.m_qB.SetAngle(n);P.b2Vec2.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);var a=P.b2Rot.MulRV(s,this.m_lalcA,this.m_rA);P.b2Vec2.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);var m,c=P.b2Rot.MulRV(r,this.m_lalcB,this.m_rB),_=P.b2Vec2.AddVV(P.b2Vec2.SubVV(o,e,P.b2Vec2.s_t0),P.b2Vec2.SubVV(c,a,P.b2Vec2.s_t1),w.SolvePositionConstraints_s_d),l=P.b2Rot.MulRV(s,this.m_localYAxisA,this.m_ay),h=P.b2Vec2.CrossVV(P.b2Vec2.AddVV(_,a,P.b2Vec2.s_t0),l),u=P.b2Vec2.CrossVV(c,l),p=P.b2Vec2.DotVV(_,this.m_ay),f=this.m_invMassA+this.m_invMassB+this.m_invIA*this.m_sAy*this.m_sAy+this.m_invIB*this.m_sBy*this.m_sBy;m=0!==f?-p/f:0;var d=P.b2Vec2.MulSV(m,l,w.SolvePositionConstraints_s_P),y=m*h,b=m*u;return e.SelfMulSub(this.m_invMassA,d),i-=this.m_invIA*y,o.SelfMulAdd(this.m_invMassB,d),n+=this.m_invIB*b,t.positions[this.m_indexA].a=i,t.positions[this.m_indexB].a=n,P.b2Abs(p)<=M.b2_linearSlop},w.prototype.GetDefinition=function(t){return t},w.prototype.GetAnchorA=function(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)},w.prototype.GetAnchorB=function(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)},w.prototype.GetReactionForce=function(t,e){return e.x=t*(this.m_impulse*this.m_ay.x+this.m_springImpulse*this.m_ax.x),e.y=t*(this.m_impulse*this.m_ay.y+this.m_springImpulse*this.m_ax.y),e},w.prototype.GetReactionTorque=function(t){return t*this.m_motorImpulse},w.prototype.GetLocalAnchorA=function(){return this.m_localAnchorA},w.prototype.GetLocalAnchorB=function(){return this.m_localAnchorB},w.prototype.GetLocalAxisA=function(){return this.m_localXAxisA},w.prototype.GetJointTranslation=function(){return this.GetPrismaticJointTranslation()},w.prototype.GetJointSpeed=function(){return this.GetRevoluteJointSpeed()},w.prototype.GetPrismaticJointTranslation=function(){var t=this.m_bodyA,e=this.m_bodyB,i=t.GetWorldPoint(this.m_localAnchorA,new P.b2Vec2),o=e.GetWorldPoint(this.m_localAnchorB,new P.b2Vec2),n=P.b2Vec2.SubVV(o,i,new P.b2Vec2),s=t.GetWorldVector(this.m_localXAxisA,new P.b2Vec2);return P.b2Vec2.DotVV(n,s)},w.prototype.GetPrismaticJointSpeed=function(){var t=this.m_bodyA,e=this.m_bodyB;P.b2Vec2.SubVV(this.m_localAnchorA,t.m_sweep.localCenter,this.m_lalcA);var i=P.b2Rot.MulRV(t.m_xf.q,this.m_lalcA,this.m_rA);P.b2Vec2.SubVV(this.m_localAnchorB,e.m_sweep.localCenter,this.m_lalcB);var o=P.b2Rot.MulRV(e.m_xf.q,this.m_lalcB,this.m_rB),n=P.b2Vec2.AddVV(t.m_sweep.c,i,P.b2Vec2.s_t0),s=P.b2Vec2.AddVV(e.m_sweep.c,o,P.b2Vec2.s_t1),r=P.b2Vec2.SubVV(s,n,P.b2Vec2.s_t2),a=t.GetWorldVector(this.m_localXAxisA,new P.b2Vec2),m=t.m_linearVelocity,c=e.m_linearVelocity,_=t.m_angularVelocity,l=e.m_angularVelocity;return P.b2Vec2.DotVV(r,P.b2Vec2.CrossSV(_,a,P.b2Vec2.s_t0))+P.b2Vec2.DotVV(a,P.b2Vec2.SubVV(P.b2Vec2.AddVCrossSV(c,l,o,P.b2Vec2.s_t0),P.b2Vec2.AddVCrossSV(m,_,i,P.b2Vec2.s_t1),P.b2Vec2.s_t0))},w.prototype.GetRevoluteJointAngle=function(){return this.m_bodyB.m_sweep.a-this.m_bodyA.m_sweep.a},w.prototype.GetRevoluteJointSpeed=function(){var t=this.m_bodyA.m_angularVelocity;return this.m_bodyB.m_angularVelocity-t},w.prototype.IsMotorEnabled=function(){return this.m_enableMotor},w.prototype.EnableMotor=function(t){this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableMotor=t},w.prototype.SetMotorSpeed=function(t){this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_motorSpeed=t},w.prototype.SetMaxMotorTorque=function(t){this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_maxMotorTorque=t},w.prototype.GetMotorTorque=function(t){return t*this.m_motorImpulse},w.prototype.Dump=function(t){var e=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex;t("  const jd: b2WheelJointDef = new b2WheelJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",i),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.m_localAnchorA.x,this.m_localAnchorA.y),t("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.m_localAnchorB.x,this.m_localAnchorB.y),t("  jd.localAxisA.Set(%.15f, %.15f);\n",this.m_localXAxisA.x,this.m_localXAxisA.y),t("  jd.enableMotor = %s;\n",this.m_enableMotor?"true":"false"),t("  jd.motorSpeed = %.15f;\n",this.m_motorSpeed),t("  jd.maxMotorTorque = %.15f;\n",this.m_maxMotorTorque),t("  jd.frequencyHz = %.15f;\n",this.m_frequencyHz),t("  jd.dampingRatio = %.15f;\n",this.m_dampingRatio),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)},w.InitVelocityConstraints_s_d=new P.b2Vec2,w.InitVelocityConstraints_s_P=new P.b2Vec2,w.SolveVelocityConstraints_s_P=new P.b2Vec2,w.SolvePositionConstraints_s_d=new P.b2Vec2,w.SolvePositionConstraints_s_P=new P.b2Vec2,w}(i.b2Joint),t("b2WheelJoint",n)}}}),System.register("Dynamics/Joints/b2JointFactory",["Dynamics/Joints/b2AreaJoint","Dynamics/Joints/b2DistanceJoint","Dynamics/Joints/b2FrictionJoint","Dynamics/Joints/b2GearJoint","Dynamics/Joints/b2MotorJoint","Dynamics/Joints/b2MouseJoint","Dynamics/Joints/b2PrismaticJoint","Dynamics/Joints/b2PulleyJoint","Dynamics/Joints/b2RevoluteJoint","Dynamics/Joints/b2RopeJoint","Dynamics/Joints/b2WeldJoint","Dynamics/Joints/b2WheelJoint"],function(t,e){var o,n,s,r,a,m,c,_,l,h,u,p,i;e&&e.id;return{setters:[function(t){o=t},function(t){n=t},function(t){s=t},function(t){r=t},function(t){a=t},function(t){m=t},function(t){c=t},function(t){_=t},function(t){l=t},function(t){h=t},function(t){u=t},function(t){p=t}],execute:function(){i=function(){function t(){}return t.Create=function(t,e){var i=null;switch(t.type){case 3:i=new n.b2DistanceJoint(t);break;case 5:i=new m.b2MouseJoint(t);break;case 2:i=new c.b2PrismaticJoint(t);break;case 1:i=new l.b2RevoluteJoint(t);break;case 4:i=new _.b2PulleyJoint(t);break;case 6:i=new r.b2GearJoint(t);break;case 7:i=new p.b2WheelJoint(t);break;case 8:i=new u.b2WeldJoint(t);break;case 9:i=new s.b2FrictionJoint(t);break;case 10:i=new h.b2RopeJoint(t);break;case 11:i=new a.b2MotorJoint(t);break;case 12:i=new o.b2AreaJoint(t)}return i},t.Destroy=function(t,e){},t}(),t("b2JointFactory",i)}}}),System.register("Dynamics/Contacts/b2ContactSolver",["Common/b2Settings","Common/b2Math","Collision/b2Collision","Dynamics/b2TimeStep"],function(t,e){var U,W,i,o,n,V,v,s,r;e&&e.id;return{setters:[function(t){U=t},function(t){W=t},function(t){i=t},function(t){o=t}],execute:function(){n=function(){function e(){this.rA=new W.b2Vec2,this.rB=new W.b2Vec2,this.normalImpulse=0,this.tangentImpulse=0,this.normalMass=0,this.tangentMass=0,this.velocityBias=0}return e.MakeArray=function(t){return U.b2MakeArray(t,function(t){return new e})},e}(),t("b2VelocityConstraintPoint",n),V=function(){function e(){this.points=n.MakeArray(U.b2_maxManifoldPoints),this.normal=new W.b2Vec2,this.tangent=new W.b2Vec2,this.normalMass=new W.b2Mat22,this.K=new W.b2Mat22,this.indexA=0,this.indexB=0,this.invMassA=0,this.invMassB=0,this.invIA=0,this.invIB=0,this.friction=0,this.restitution=0,this.tangentSpeed=0,this.pointCount=0,this.contactIndex=0}return e.MakeArray=function(t){return U.b2MakeArray(t,function(t){return new e})},e}(),t("b2ContactVelocityConstraint",V),v=function(){function e(){this.localPoints=W.b2Vec2.MakeArray(U.b2_maxManifoldPoints),this.localNormal=new W.b2Vec2,this.localPoint=new W.b2Vec2,this.indexA=0,this.indexB=0,this.invMassA=0,this.invMassB=0,this.localCenterA=new W.b2Vec2,this.localCenterB=new W.b2Vec2,this.invIA=0,this.invIB=0,this.type=-1,this.radiusA=0,this.radiusB=0,this.pointCount=0}return e.MakeArray=function(t){return U.b2MakeArray(t,function(t){return new e})},e}(),t("b2ContactPositionConstraint",v),t("b2ContactSolverDef",function(){this.step=new o.b2TimeStep,this.contacts=null,this.count=0,this.positions=null,this.velocities=null,this.allocator=null}),s=function(){function m(){this.normal=new W.b2Vec2,this.point=new W.b2Vec2,this.separation=0}return m.prototype.Initialize=function(t,e,i,o){var n=m.Initialize_s_pointA,s=m.Initialize_s_pointB,r=m.Initialize_s_planePoint,a=m.Initialize_s_clipPoint;switch(t.type){case 0:W.b2Transform.MulXV(e,t.localPoint,n),W.b2Transform.MulXV(i,t.localPoints[0],s),W.b2Vec2.SubVV(s,n,this.normal).SelfNormalize(),W.b2Vec2.MidVV(n,s,this.point),this.separation=W.b2Vec2.DotVV(W.b2Vec2.SubVV(s,n,W.b2Vec2.s_t0),this.normal)-t.radiusA-t.radiusB;break;case 1:W.b2Rot.MulRV(e.q,t.localNormal,this.normal),W.b2Transform.MulXV(e,t.localPoint,r),W.b2Transform.MulXV(i,t.localPoints[o],a),this.separation=W.b2Vec2.DotVV(W.b2Vec2.SubVV(a,r,W.b2Vec2.s_t0),this.normal)-t.radiusA-t.radiusB,this.point.Copy(a);break;case 2:W.b2Rot.MulRV(i.q,t.localNormal,this.normal),W.b2Transform.MulXV(i,t.localPoint,r),W.b2Transform.MulXV(e,t.localPoints[o],a),this.separation=W.b2Vec2.DotVV(W.b2Vec2.SubVV(a,r,W.b2Vec2.s_t0),this.normal)-t.radiusA-t.radiusB,this.point.Copy(a),this.normal.SelfNeg()}},m.Initialize_s_pointA=new W.b2Vec2,m.Initialize_s_pointB=new W.b2Vec2,m.Initialize_s_planePoint=new W.b2Vec2,m.Initialize_s_clipPoint=new W.b2Vec2,m}(),t("b2PositionSolverManifold",s),r=function(){function X(){this.m_step=new o.b2TimeStep,this.m_positions=null,this.m_velocities=null,this.m_allocator=null,this.m_positionConstraints=v.MakeArray(1024),this.m_velocityConstraints=V.MakeArray(1024),this.m_contacts=null,this.m_count=0}return X.prototype.Initialize=function(t){if(this.m_step.Copy(t.step),this.m_allocator=t.allocator,this.m_count=t.count,this.m_positionConstraints.length<this.m_count)for(var e=W.b2Max(2*this.m_positionConstraints.length,this.m_count);this.m_positionConstraints.length<e;)this.m_positionConstraints[this.m_positionConstraints.length]=new v;if(this.m_velocityConstraints.length<this.m_count)for(e=W.b2Max(2*this.m_velocityConstraints.length,this.m_count);this.m_velocityConstraints.length<e;)this.m_velocityConstraints[this.m_velocityConstraints.length]=new V;this.m_positions=t.positions,this.m_velocities=t.velocities,this.m_contacts=t.contacts;for(var i=0;i<this.m_count;++i){var o=this.m_contacts[i],n=o.m_fixtureA,s=o.m_fixtureB,r=n.GetShape(),a=s.GetShape(),m=r.m_radius,c=a.m_radius,_=n.GetBody(),l=s.GetBody(),h=o.GetManifold(),u=h.pointCount,p=this.m_velocityConstraints[i];p.friction=o.m_friction,p.restitution=o.m_restitution,p.tangentSpeed=o.m_tangentSpeed,p.indexA=_.m_islandIndex,p.indexB=l.m_islandIndex,p.invMassA=_.m_invMass,p.invMassB=l.m_invMass,p.invIA=_.m_invI,p.invIB=l.m_invI,p.contactIndex=i,p.pointCount=u,p.K.SetZero(),p.normalMass.SetZero();var f=this.m_positionConstraints[i];f.indexA=_.m_islandIndex,f.indexB=l.m_islandIndex,f.invMassA=_.m_invMass,f.invMassB=l.m_invMass,f.localCenterA.Copy(_.m_sweep.localCenter),f.localCenterB.Copy(l.m_sweep.localCenter),f.invIA=_.m_invI,f.invIB=l.m_invI,f.localNormal.Copy(h.localNormal),f.localPoint.Copy(h.localPoint),f.pointCount=u,f.radiusA=m,f.radiusB=c,f.type=h.type;for(var d=0;d<u;++d){var y=h.points[d],b=p.points[d];this.m_step.warmStarting?(b.normalImpulse=this.m_step.dtRatio*y.normalImpulse,b.tangentImpulse=this.m_step.dtRatio*y.tangentImpulse):(b.normalImpulse=0,b.tangentImpulse=0),b.rA.SetZero(),b.rB.SetZero(),b.normalMass=0,b.tangentMass=0,b.velocityBias=0,f.localPoints[d].Copy(y.localPoint)}}return this},X.prototype.InitializeVelocityConstraints=function(){for(var t=X.InitializeVelocityConstraints_s_xfA,e=X.InitializeVelocityConstraints_s_xfB,i=X.InitializeVelocityConstraints_s_worldManifold,o=0;o<this.m_count;++o){var n=this.m_velocityConstraints[o],s=this.m_positionConstraints[o],r=s.radiusA,a=s.radiusB,m=this.m_contacts[n.contactIndex].GetManifold(),c=n.indexA,_=n.indexB,l=n.invMassA,h=n.invMassB,u=n.invIA,p=n.invIB,f=s.localCenterA,d=s.localCenterB,y=this.m_positions[c].c,b=this.m_positions[c].a,V=this.m_velocities[c].v,v=this.m_velocities[c].w,x=this.m_positions[_].c,C=this.m_positions[_].a,S=this.m_velocities[_].v,B=this.m_velocities[_].w;t.q.SetAngle(b),e.q.SetAngle(C),W.b2Vec2.SubVV(y,W.b2Rot.MulRV(t.q,f,W.b2Vec2.s_t0),t.p),W.b2Vec2.SubVV(x,W.b2Rot.MulRV(e.q,d,W.b2Vec2.s_t0),e.p),i.Initialize(m,t,r,e,a),n.normal.Copy(i.normal),W.b2Vec2.CrossVOne(n.normal,n.tangent);for(var A=n.pointCount,g=0;g<A;++g){var w=n.points[g];W.b2Vec2.SubVV(i.points[g],y,w.rA),W.b2Vec2.SubVV(i.points[g],x,w.rB);var M=W.b2Vec2.CrossVV(w.rA,n.normal),P=W.b2Vec2.CrossVV(w.rB,n.normal),I=l+h+u*M*M+p*P*P;w.normalMass=0<I?1/I:0;var D=n.tangent,G=W.b2Vec2.CrossVV(w.rA,D),R=W.b2Vec2.CrossVV(w.rB,D),F=l+h+u*G*G+p*R*R;w.tangentMass=0<F?1/F:0,w.velocityBias=0;var T=W.b2Vec2.DotVV(n.normal,W.b2Vec2.SubVV(W.b2Vec2.AddVCrossSV(S,B,w.rB,W.b2Vec2.s_t0),W.b2Vec2.AddVCrossSV(V,v,w.rA,W.b2Vec2.s_t1),W.b2Vec2.s_t0));T<-U.b2_velocityThreshold&&(w.velocityBias+=-n.restitution*T)}if(2===n.pointCount){var L=n.points[0],k=n.points[1],q=W.b2Vec2.CrossVV(L.rA,n.normal),z=W.b2Vec2.CrossVV(L.rB,n.normal),J=W.b2Vec2.CrossVV(k.rA,n.normal),j=W.b2Vec2.CrossVV(k.rB,n.normal),N=l+h+u*q*q+p*z*z,E=l+h+u*J*J+p*j*j,O=l+h+u*q*J+p*z*j;N*N<1e3*(N*E-O*O)?(n.K.ex.Set(N,O),n.K.ey.Set(O,E),n.K.GetInverse(n.normalMass)):n.pointCount=1}}},X.prototype.WarmStart=function(){for(var t=X.WarmStart_s_P,e=0;e<this.m_count;++e){for(var i=this.m_velocityConstraints[e],o=i.indexA,n=i.indexB,s=i.invMassA,r=i.invIA,a=i.invMassB,m=i.invIB,c=i.pointCount,_=this.m_velocities[o].v,l=this.m_velocities[o].w,h=this.m_velocities[n].v,u=this.m_velocities[n].w,p=i.normal,f=i.tangent,d=0;d<c;++d){var y=i.points[d];W.b2Vec2.AddVV(W.b2Vec2.MulSV(y.normalImpulse,p,W.b2Vec2.s_t0),W.b2Vec2.MulSV(y.tangentImpulse,f,W.b2Vec2.s_t1),t),l-=r*W.b2Vec2.CrossVV(y.rA,t),_.SelfMulSub(s,t),u+=m*W.b2Vec2.CrossVV(y.rB,t),h.SelfMulAdd(a,t)}this.m_velocities[o].w=l,this.m_velocities[n].w=u}},X.prototype.SolveVelocityConstraints=function(){for(var t=X.SolveVelocityConstraints_s_dv,e=X.SolveVelocityConstraints_s_dv1,i=X.SolveVelocityConstraints_s_dv2,o=X.SolveVelocityConstraints_s_P,n=X.SolveVelocityConstraints_s_a,s=X.SolveVelocityConstraints_s_b,r=X.SolveVelocityConstraints_s_x,a=X.SolveVelocityConstraints_s_d,m=X.SolveVelocityConstraints_s_P1,c=X.SolveVelocityConstraints_s_P2,_=X.SolveVelocityConstraints_s_P1P2,l=0;l<this.m_count;++l){for(var h=this.m_velocityConstraints[l],u=h.indexA,p=h.indexB,f=h.invMassA,d=h.invIA,y=h.invMassB,b=h.invIB,V=h.pointCount,v=this.m_velocities[u].v,x=this.m_velocities[u].w,C=this.m_velocities[p].v,S=this.m_velocities[p].w,B=h.normal,A=h.tangent,g=h.friction,w=0;w<V;++w){var M=h.points[w];W.b2Vec2.SubVV(W.b2Vec2.AddVCrossSV(C,S,M.rB,W.b2Vec2.s_t0),W.b2Vec2.AddVCrossSV(v,x,M.rA,W.b2Vec2.s_t1),t);var P=W.b2Vec2.DotVV(t,A)-h.tangentSpeed,I=M.tangentMass*-P,D=g*M.normalImpulse;I=(G=W.b2Clamp(M.tangentImpulse+I,-D,D))-M.tangentImpulse,M.tangentImpulse=G,W.b2Vec2.MulSV(I,A,o),v.SelfMulSub(f,o),x-=d*W.b2Vec2.CrossVV(M.rA,o),C.SelfMulAdd(y,o),S+=b*W.b2Vec2.CrossVV(M.rB,o)}if(1===h.pointCount){M=h.points[0];W.b2Vec2.SubVV(W.b2Vec2.AddVCrossSV(C,S,M.rB,W.b2Vec2.s_t0),W.b2Vec2.AddVCrossSV(v,x,M.rA,W.b2Vec2.s_t1),t);var G,R=W.b2Vec2.DotVV(t,B);I=-M.normalMass*(R-M.velocityBias);I=(G=W.b2Max(M.normalImpulse+I,0))-M.normalImpulse,M.normalImpulse=G,W.b2Vec2.MulSV(I,B,o),v.SelfMulSub(f,o),x-=d*W.b2Vec2.CrossVV(M.rA,o),C.SelfMulAdd(y,o),S+=b*W.b2Vec2.CrossVV(M.rB,o)}else{var F=h.points[0],T=h.points[1];n.Set(F.normalImpulse,T.normalImpulse),W.b2Vec2.SubVV(W.b2Vec2.AddVCrossSV(C,S,F.rB,W.b2Vec2.s_t0),W.b2Vec2.AddVCrossSV(v,x,F.rA,W.b2Vec2.s_t1),e),W.b2Vec2.SubVV(W.b2Vec2.AddVCrossSV(C,S,T.rB,W.b2Vec2.s_t0),W.b2Vec2.AddVCrossSV(v,x,T.rA,W.b2Vec2.s_t1),i);var L=W.b2Vec2.DotVV(e,B),k=W.b2Vec2.DotVV(i,B);for(s.x=L-F.velocityBias,s.y=k-T.velocityBias,s.SelfSub(W.b2Mat22.MulMV(h.K,n,W.b2Vec2.s_t0));;){if(W.b2Mat22.MulMV(h.normalMass,s,r).SelfNeg(),0<=r.x&&0<=r.y){W.b2Vec2.SubVV(r,n,a),W.b2Vec2.MulSV(a.x,B,m),W.b2Vec2.MulSV(a.y,B,c),W.b2Vec2.AddVV(m,c,_),v.SelfMulSub(f,_),x-=d*(W.b2Vec2.CrossVV(F.rA,m)+W.b2Vec2.CrossVV(T.rA,c)),C.SelfMulAdd(y,_),S+=b*(W.b2Vec2.CrossVV(F.rB,m)+W.b2Vec2.CrossVV(T.rB,c)),F.normalImpulse=r.x,T.normalImpulse=r.y;break}if(r.x=-F.normalMass*s.x,L=r.y=0,k=h.K.ex.y*r.x+s.y,0<=r.x&&0<=k){W.b2Vec2.SubVV(r,n,a),W.b2Vec2.MulSV(a.x,B,m),W.b2Vec2.MulSV(a.y,B,c),W.b2Vec2.AddVV(m,c,_),v.SelfMulSub(f,_),x-=d*(W.b2Vec2.CrossVV(F.rA,m)+W.b2Vec2.CrossVV(T.rA,c)),C.SelfMulAdd(y,_),S+=b*(W.b2Vec2.CrossVV(F.rB,m)+W.b2Vec2.CrossVV(T.rB,c)),F.normalImpulse=r.x,T.normalImpulse=r.y;break}if(r.x=0,r.y=-T.normalMass*s.y,L=h.K.ey.x*r.y+s.x,(k=0)<=r.y&&0<=L){W.b2Vec2.SubVV(r,n,a),W.b2Vec2.MulSV(a.x,B,m),W.b2Vec2.MulSV(a.y,B,c),W.b2Vec2.AddVV(m,c,_),v.SelfMulSub(f,_),x-=d*(W.b2Vec2.CrossVV(F.rA,m)+W.b2Vec2.CrossVV(T.rA,c)),C.SelfMulAdd(y,_),S+=b*(W.b2Vec2.CrossVV(F.rB,m)+W.b2Vec2.CrossVV(T.rB,c)),F.normalImpulse=r.x,T.normalImpulse=r.y;break}if(r.x=0,r.y=0,L=s.x,k=s.y,0<=L&&0<=k){W.b2Vec2.SubVV(r,n,a),W.b2Vec2.MulSV(a.x,B,m),W.b2Vec2.MulSV(a.y,B,c),W.b2Vec2.AddVV(m,c,_),v.SelfMulSub(f,_),x-=d*(W.b2Vec2.CrossVV(F.rA,m)+W.b2Vec2.CrossVV(T.rA,c)),C.SelfMulAdd(y,_),S+=b*(W.b2Vec2.CrossVV(F.rB,m)+W.b2Vec2.CrossVV(T.rB,c)),F.normalImpulse=r.x,T.normalImpulse=r.y;break}break}}this.m_velocities[u].w=x,this.m_velocities[p].w=S}},X.prototype.StoreImpulses=function(){for(var t=0;t<this.m_count;++t)for(var e=this.m_velocityConstraints[t],i=this.m_contacts[e.contactIndex].GetManifold(),o=0;o<e.pointCount;++o)i.points[o].normalImpulse=e.points[o].normalImpulse,i.points[o].tangentImpulse=e.points[o].tangentImpulse},X.prototype.SolvePositionConstraints=function(){for(var t=X.SolvePositionConstraints_s_xfA,e=X.SolvePositionConstraints_s_xfB,i=X.SolvePositionConstraints_s_psm,o=X.SolvePositionConstraints_s_rA,n=X.SolvePositionConstraints_s_rB,s=X.SolvePositionConstraints_s_P,r=0,a=0;a<this.m_count;++a){for(var m=this.m_positionConstraints[a],c=m.indexA,_=m.indexB,l=m.localCenterA,h=m.invMassA,u=m.invIA,p=m.localCenterB,f=m.invMassB,d=m.invIB,y=m.pointCount,b=this.m_positions[c].c,V=this.m_positions[c].a,v=this.m_positions[_].c,x=this.m_positions[_].a,C=0;C<y;++C){t.q.SetAngle(V),e.q.SetAngle(x),W.b2Vec2.SubVV(b,W.b2Rot.MulRV(t.q,l,W.b2Vec2.s_t0),t.p),W.b2Vec2.SubVV(v,W.b2Rot.MulRV(e.q,p,W.b2Vec2.s_t0),e.p),i.Initialize(m,t,e,C);var S=i.normal,B=i.point,A=i.separation;W.b2Vec2.SubVV(B,b,o),W.b2Vec2.SubVV(B,v,n),r=W.b2Min(r,A);var g=W.b2Clamp(U.b2_baumgarte*(A+U.b2_linearSlop),-U.b2_maxLinearCorrection,0),w=W.b2Vec2.CrossVV(o,S),M=W.b2Vec2.CrossVV(n,S),P=h+f+u*w*w+d*M*M,I=0<P?-g/P:0;W.b2Vec2.MulSV(I,S,s),b.SelfMulSub(h,s),V-=u*W.b2Vec2.CrossVV(o,s),v.SelfMulAdd(f,s),x+=d*W.b2Vec2.CrossVV(n,s)}this.m_positions[c].a=V,this.m_positions[_].a=x}return r>-3*U.b2_linearSlop},X.prototype.SolveTOIPositionConstraints=function(t,e){for(var i=X.SolveTOIPositionConstraints_s_xfA,o=X.SolveTOIPositionConstraints_s_xfB,n=X.SolveTOIPositionConstraints_s_psm,s=X.SolveTOIPositionConstraints_s_rA,r=X.SolveTOIPositionConstraints_s_rB,a=X.SolveTOIPositionConstraints_s_P,m=0,c=0;c<this.m_count;++c){var _=this.m_positionConstraints[c],l=_.indexA,h=_.indexB,u=_.localCenterA,p=_.localCenterB,f=_.pointCount,d=0,y=0;l!==t&&l!==e||(d=_.invMassA,y=_.invIA);var b=0,V=0;h!==t&&h!==e||(b=_.invMassB,V=_.invIB);for(var v=this.m_positions[l].c,x=this.m_positions[l].a,C=this.m_positions[h].c,S=this.m_positions[h].a,B=0;B<f;++B){i.q.SetAngle(x),o.q.SetAngle(S),W.b2Vec2.SubVV(v,W.b2Rot.MulRV(i.q,u,W.b2Vec2.s_t0),i.p),W.b2Vec2.SubVV(C,W.b2Rot.MulRV(o.q,p,W.b2Vec2.s_t0),o.p),n.Initialize(_,i,o,B);var A=n.normal,g=n.point,w=n.separation;W.b2Vec2.SubVV(g,v,s),W.b2Vec2.SubVV(g,C,r),m=W.b2Min(m,w);var M=W.b2Clamp(U.b2_toiBaumgarte*(w+U.b2_linearSlop),-U.b2_maxLinearCorrection,0),P=W.b2Vec2.CrossVV(s,A),I=W.b2Vec2.CrossVV(r,A),D=d+b+y*P*P+V*I*I,G=0<D?-M/D:0;W.b2Vec2.MulSV(G,A,a),v.SelfMulSub(d,a),x-=y*W.b2Vec2.CrossVV(s,a),C.SelfMulAdd(b,a),S+=V*W.b2Vec2.CrossVV(r,a)}this.m_positions[l].a=x,this.m_positions[h].a=S}return m>=-1.5*U.b2_linearSlop},X.InitializeVelocityConstraints_s_xfA=new W.b2Transform,X.InitializeVelocityConstraints_s_xfB=new W.b2Transform,X.InitializeVelocityConstraints_s_worldManifold=new i.b2WorldManifold,X.WarmStart_s_P=new W.b2Vec2,X.SolveVelocityConstraints_s_dv=new W.b2Vec2,X.SolveVelocityConstraints_s_dv1=new W.b2Vec2,X.SolveVelocityConstraints_s_dv2=new W.b2Vec2,X.SolveVelocityConstraints_s_P=new W.b2Vec2,X.SolveVelocityConstraints_s_a=new W.b2Vec2,X.SolveVelocityConstraints_s_b=new W.b2Vec2,X.SolveVelocityConstraints_s_x=new W.b2Vec2,X.SolveVelocityConstraints_s_d=new W.b2Vec2,X.SolveVelocityConstraints_s_P1=new W.b2Vec2,X.SolveVelocityConstraints_s_P2=new W.b2Vec2,X.SolveVelocityConstraints_s_P1P2=new W.b2Vec2,X.SolvePositionConstraints_s_xfA=new W.b2Transform,X.SolvePositionConstraints_s_xfB=new W.b2Transform,X.SolvePositionConstraints_s_psm=new s,X.SolvePositionConstraints_s_rA=new W.b2Vec2,X.SolvePositionConstraints_s_rB=new W.b2Vec2,X.SolvePositionConstraints_s_P=new W.b2Vec2,X.SolveTOIPositionConstraints_s_xfA=new W.b2Transform,X.SolveTOIPositionConstraints_s_xfB=new W.b2Transform,X.SolveTOIPositionConstraints_s_psm=new s,X.SolveTOIPositionConstraints_s_rA=new W.b2Vec2,X.SolveTOIPositionConstraints_s_rB=new W.b2Vec2,X.SolveTOIPositionConstraints_s_P=new W.b2Vec2,X}(),t("b2ContactSolver",r)}}}),System.register("Particle/b2Particle",["Common/b2Settings","Common/b2Math","Common/b2Draw"],function(e,t){var i,n,o,s,r;t&&t.id;return e("b2CalculateParticleIterations",function(t,e,i){var o=Math.ceil(Math.sqrt(t/(.01*e))*i);return n.b2Clamp(o,1,8)}),{setters:[function(t){i=t},function(t){n=t},function(t){o=t}],execute:function(){var t;(t=s||(s={}))[t.b2_waterParticle=0]="b2_waterParticle",t[t.b2_zombieParticle=2]="b2_zombieParticle",t[t.b2_wallParticle=4]="b2_wallParticle",t[t.b2_springParticle=8]="b2_springParticle",t[t.b2_elasticParticle=16]="b2_elasticParticle",t[t.b2_viscousParticle=32]="b2_viscousParticle",t[t.b2_powderParticle=64]="b2_powderParticle",t[t.b2_tensileParticle=128]="b2_tensileParticle",t[t.b2_colorMixingParticle=256]="b2_colorMixingParticle",t[t.b2_destructionListenerParticle=512]="b2_destructionListenerParticle",t[t.b2_barrierParticle=1024]="b2_barrierParticle",t[t.b2_staticPressureParticle=2048]="b2_staticPressureParticle",t[t.b2_reactiveParticle=4096]="b2_reactiveParticle",t[t.b2_repulsiveParticle=8192]="b2_repulsiveParticle",t[t.b2_fixtureContactListenerParticle=16384]="b2_fixtureContactListenerParticle",t[t.b2_particleContactListenerParticle=32768]="b2_particleContactListenerParticle",t[t.b2_fixtureContactFilterParticle=65536]="b2_fixtureContactFilterParticle",t[t.b2_particleContactFilterParticle=131072]="b2_particleContactFilterParticle",e("b2ParticleFlag",s),e("b2ParticleDef",function(){this.flags=0,this.position=new n.b2Vec2,this.velocity=new n.b2Vec2,this.color=new o.b2Color,this.lifetime=0,this.userData=null,this.group=null}),r=function(){function t(){this.m_index=i.b2_invalidParticleIndex}return t.prototype.GetIndex=function(){return this.m_index},t.prototype.SetIndex=function(t){this.m_index=t},t}(),e("b2ParticleHandle",r)}}}),System.register("Particle/b2StackQueue",["Common/b2Settings"],function(t,e){var i,o;e&&e.id;return{setters:[function(t){i=t}],execute:function(){o=function(){function t(t){this.m_front=0,this.m_back=0,this.m_capacity=0,this.m_buffer=i.b2MakeArray(t,function(t){return null}),this.m_capacity=t}return t.prototype.Push=function(t){if(this.m_back>=this.m_capacity){for(var e=this.m_front;e<this.m_back;e++)this.m_buffer[e-this.m_front]=this.m_buffer[e];this.m_back-=this.m_front,this.m_front=0,this.m_back>=this.m_capacity&&(0<this.m_capacity?(this.m_buffer.concat(i.b2MakeArray(this.m_capacity,function(t){return null})),this.m_capacity*=2):(this.m_buffer.concat(i.b2MakeArray(1,function(t){return null})),this.m_capacity=1))}this.m_buffer[this.m_back]=t,this.m_back++},t.prototype.Pop=function(){this.m_front,this.m_back,delete this.m_buffer[this.m_front],this.m_front++},t.prototype.Empty=function(){return this.m_front,this.m_back,this.m_front===this.m_back},t.prototype.Front=function(){return this.m_buffer[this.m_front]},t}(),t("b2StackQueue",o)}}}),System.register("Particle/b2VoronoiDiagram",["Common/b2Settings","Common/b2Math","Particle/b2StackQueue"],function(t,e){var v,x,C,i;e&&e.id;return{setters:[function(t){v=t},function(t){x=t},function(t){C=t}],execute:function(){i=function(){function V(t){this.m_generatorBuffer=null,this.m_generatorCapacity=0,this.m_generatorCount=0,this.m_countX=0,this.m_countY=0,this.m_diagram=null,this.m_generatorBuffer=v.b2MakeArray(t,function(t){return new V.Generator}),this.m_generatorCapacity=t}return V.prototype.AddGenerator=function(t,e,i){this.m_generatorCount,this.m_generatorCapacity;var o=this.m_generatorBuffer[this.m_generatorCount++];o.center.Copy(t),o.tag=e,o.necessary=i},V.prototype.Generate=function(t,e){this.m_diagram;for(var i=1/t,o=new x.b2Vec2(+v.b2_maxFloat,+v.b2_maxFloat),n=new x.b2Vec2(-v.b2_maxFloat,-v.b2_maxFloat),s=0,r=0;r<this.m_generatorCount;r++){(l=this.m_generatorBuffer[r]).necessary&&(x.b2Vec2.MinV(o,l.center,o),x.b2Vec2.MaxV(n,l.center,n),++s)}if(0===s)return this.m_countX=0,void(this.m_countY=0);o.x-=e,o.y-=e,n.x+=e,n.y+=e,this.m_countX=1+Math.floor(i*(n.x-o.x)),this.m_countY=1+Math.floor(i*(n.y-o.y)),this.m_diagram=v.b2MakeArray(this.m_countX*this.m_countY,function(t){return null});var a=new C.b2StackQueue(4*this.m_countX*this.m_countY);for(r=0;r<this.m_generatorCount;r++){(l=this.m_generatorBuffer[r]).center.SelfSub(o).SelfMul(i);var m=Math.floor(l.center.x),c=Math.floor(l.center.y);0<=m&&0<=c&&m<this.m_countX&&c<this.m_countY&&a.Push(new V.Task(m,c,m+c*this.m_countX,l))}for(;!a.Empty();){m=(h=a.Front()).m_x,c=h.m_y;var _=h.m_i,l=h.m_generator;a.Pop(),this.m_diagram[_]||(this.m_diagram[_]=l,0<m&&a.Push(new V.Task(m-1,c,_-1,l)),0<c&&a.Push(new V.Task(m,c-1,_-this.m_countX,l)),m<this.m_countX-1&&a.Push(new V.Task(m+1,c,_+1,l)),c<this.m_countY-1&&a.Push(new V.Task(m,c+1,_+this.m_countX,l)))}for(c=0;c<this.m_countY;c++)for(m=0;m<this.m_countX-1;m++){_=m+c*this.m_countX;(u=this.m_diagram[_])!==(p=this.m_diagram[_+1])&&(a.Push(new V.Task(m,c,_,p)),a.Push(new V.Task(m+1,c,_+1,u)))}for(c=0;c<this.m_countY-1;c++)for(m=0;m<this.m_countX;m++){_=m+c*this.m_countX;(u=this.m_diagram[_])!==(p=this.m_diagram[_+this.m_countX])&&(a.Push(new V.Task(m,c,_,p)),a.Push(new V.Task(m,c+1,_+this.m_countX,u)))}for(;!a.Empty();){var h,u,p;m=(h=a.Front()).m_x,c=h.m_y,_=h.m_i,r=h.m_generator;if(a.Pop(),(u=this.m_diagram[_])!==(p=r)){var f=u.center.x-m,d=u.center.y-c,y=p.center.x-m,b=p.center.y-c;y*y+b*b<f*f+d*d&&(this.m_diagram[_]=p,0<m&&a.Push(new V.Task(m-1,c,_-1,p)),0<c&&a.Push(new V.Task(m,c-1,_-this.m_countX,p)),m<this.m_countX-1&&a.Push(new V.Task(m+1,c,_+1,p)),c<this.m_countY-1&&a.Push(new V.Task(m,c+1,_+this.m_countX,p)))}}},V.prototype.GetNodes=function(t){for(var e=0;e<this.m_countY-1;e++)for(var i=0;i<this.m_countX-1;i++){var o=i+e*this.m_countX,n=this.m_diagram[o],s=this.m_diagram[o+1],r=this.m_diagram[o+this.m_countX],a=this.m_diagram[o+1+this.m_countX];s!==r&&(n!==s&&n!==r&&(n.necessary||s.necessary||r.necessary)&&t(n.tag,s.tag,r.tag),a!==s&&a!==r&&(n.necessary||s.necessary||r.necessary)&&t(s.tag,a.tag,r.tag))}},V}(),t("b2VoronoiDiagram",i),function(t){var e=function(){this.center=new x.b2Vec2,this.tag=0,this.necessary=!1};t.Generator=e;var i=function(t,e,i,o){this.m_x=0,this.m_y=0,this.m_i=0,this.m_generator=null,this.m_x=t,this.m_y=e,this.m_i=i,this.m_generator=o};t.Task=i}(i||(i={})),t("b2VoronoiDiagram",i)}}}),System.register("Particle/b2ParticleSystem",["Common/b2Settings","Common/b2Math","Common/b2Draw","Collision/b2Collision","Collision/Shapes/b2Shape","Collision/Shapes/b2EdgeShape","Dynamics/b2TimeStep","Dynamics/b2WorldCallbacks","Particle/b2Particle","Particle/b2ParticleGroup","Particle/b2VoronoiDiagram"],function(t,e){var et,x,it,a,d,y,i,o,b,s,l,A,n,v,r,m,c,_,h,u;e&&e.id;function p(t,e,i){var o=t[e];t[e]=t[i],t[i]=o}function f(t,e){return t<e}function V(t,e,i,o){void 0===e&&(e=0),void 0===i&&(i=t.length-e),void 0===o&&(o=f);for(var n=e,s=[],r=0;;){for(;n+1<i;i++){var a=t[n+Math.floor(Math.random()*(i-n))];s[r++]=i;for(var m=n-1;;){for(;o(t[++m],a););for(;o(a,t[--i]););if(i<=m)break;p(t,m,i)}}if(0===r)break;n=i,i=s[--r]}return t}function g(t,e,i,o){return void 0===e&&(e=0),void 0===i&&(i=t.length-e),void 0===o&&(o=f),V(t,e,i,o)}function C(t,e,i){void 0===i&&(i=t.length);for(var o=0,n=0;n<i;++n)e(t[n])||(n!==o?p(t,o++,n):++o);return o}function S(t,e,i,o,n){void 0===n&&(n=f);for(var s=i-e;0<s;){var r=Math.floor(s/2),a=e+r;n(t[a],o)?(e=++a,s-=r+1):s=r}return e}function B(t,e,i,o,n){void 0===n&&(n=f);for(var s=i-e;0<s;){var r=Math.floor(s/2),a=e+r;n(o,t[a])?s=r:(e=++a,s-=r+1)}return e}function w(t,e,i,o){for(var n=i;e!==n;)p(t,e++,n++),n===o?n=i:e===i&&(i=n)}return{setters:[function(t){x=et=t},function(t){it=t},function(t){a=t},function(t){d=t},function(t){y=t},function(t){i=t},function(t){o=t},function(t){b=t},function(t){s=t},function(t){l=t},function(t){A=t}],execute:function(){n=function(){function t(t){this.data=[],this.count=0,this.capacity=0,this.allocator=t}return t.prototype.Append=function(){return this.count>=this.capacity&&this.Grow(),this.count++},t.prototype.Reserve=function(t){if(!(this.capacity>=t)){this.capacity,this.data.length;for(var e=this.capacity;e<t;++e)this.data[e]=this.allocator();this.capacity=t}},t.prototype.Grow=function(){var t=this.capacity?2*this.capacity:et.b2_minParticleSystemBufferCapacity;this.capacity,this.Reserve(t)},t.prototype.Free=function(){0!==this.data.length&&(this.data=[],this.capacity=0,this.count=0)},t.prototype.Shorten=function(t){},t.prototype.Data=function(){return this.data},t.prototype.GetCount=function(){return this.count},t.prototype.SetCount=function(t){this.count=t},t.prototype.GetCapacity=function(){return this.capacity},t.prototype.RemoveIf=function(t){for(var e=0;e<this.count;++e)t(this.data[e])||0;this.count=C(this.data,t,this.count),this.count},t.prototype.Unique=function(t){this.count=function(t,e,i,o){if(e===i)return i;for(var n=e;++e!==i;)o(t[n],t[e])||p(t,++n,e);return++n}(this.data,0,this.count,t)},t}(),t("b2GrowableBuffer",n),v=function(i){function t(t){var e=i.call(this)||this;return e.m_system=t,e}return __extends(t,i),t.prototype.ShouldQueryParticleSystem=function(t){return!1},t.prototype.ReportFixture=function(t){if(t.IsSensor())return!0;for(var e=t.GetShape().GetChildCount(),i=0;i<e;i++)for(var o=t.GetAABB(i),n=this.m_system.GetInsideBoundsEnumerator(o),s=void 0;0<=(s=n.GetNext());)this.ReportFixtureAndParticle(t,i,s);return!0},t.prototype.ReportParticle=function(t,e){return!1},t.prototype.ReportFixtureAndParticle=function(t,e,i){},t}(b.b2QueryCallback),t("b2FixtureParticleQueryCallback",v),r=function(){function t(){this.indexA=0,this.indexB=0,this.weight=0,this.normal=new it.b2Vec2,this.flags=0}return t.prototype.SetIndices=function(t,e){t<=et.b2_maxParticleIndex&&et.b2_maxParticleIndex,this.indexA=t,this.indexB=e},t.prototype.SetWeight=function(t){this.weight=t},t.prototype.SetNormal=function(t){this.normal.Copy(t)},t.prototype.SetFlags=function(t){this.flags=t},t.prototype.GetIndexA=function(){return this.indexA},t.prototype.GetIndexB=function(){return this.indexB},t.prototype.GetWeight=function(){return this.weight},t.prototype.GetNormal=function(){return this.normal},t.prototype.GetFlags=function(){return this.flags},t.prototype.IsEqual=function(t){return this.indexA===t.indexA&&this.indexB===t.indexB&&this.flags===t.flags&&this.weight===t.weight&&this.normal.x===t.normal.x&&this.normal.y===t.normal.y},t.prototype.IsNotEqual=function(t){return!this.IsEqual(t)},t.prototype.ApproximatelyEqual=function(t){return this.indexA===t.indexA&&this.indexB===t.indexB&&this.flags===t.flags&&it.b2Abs(this.weight-t.weight)<.01&&it.b2Vec2.DistanceSquaredVV(this.normal,t.normal)<1e-4},t}(),t("b2ParticleContact",r),t("b2ParticleBodyContact",m=function(){this.index=0,this.body=null,this.fixture=null,this.weight=0,this.normal=new it.b2Vec2,this.mass=0}),t("b2ParticlePair",c=function(){this.indexA=0,this.indexB=0,this.flags=0,this.strength=0,this.distance=0}),t("b2ParticleTriad",_=function(){this.indexA=0,this.indexB=0,this.indexC=0,this.flags=0,this.strength=0,this.pa=new it.b2Vec2(0,0),this.pb=new it.b2Vec2(0,0),this.pc=new it.b2Vec2(0,0),this.ka=0,this.kb=0,this.kc=0,this.s=0}),h=function(){function t(){this.strictContactCheck=!1,this.density=1,this.gravityScale=1,this.radius=1,this.maxCount=0,this.pressureStrength=.005,this.dampingStrength=1,this.elasticStrength=.25,this.springStrength=.25,this.viscousStrength=.25,this.surfaceTensionPressureStrength=.2,this.surfaceTensionNormalStrength=.2,this.repulsiveStrength=1,this.powderStrength=.5,this.ejectionStrength=.5,this.staticPressureStrength=.2,this.staticPressureRelaxation=.2,this.staticPressureIterations=8,this.colorMixingStrength=.5,this.destroyByAge=!0,this.lifetimeGranularity=1/60}return t.prototype.Copy=function(t){return this.strictContactCheck=t.strictContactCheck,this.density=t.density,this.gravityScale=t.gravityScale,this.radius=t.radius,this.maxCount=t.maxCount,this.pressureStrength=t.pressureStrength,this.dampingStrength=t.dampingStrength,this.elasticStrength=t.elasticStrength,this.springStrength=t.springStrength,this.viscousStrength=t.viscousStrength,this.surfaceTensionPressureStrength=t.surfaceTensionPressureStrength,this.surfaceTensionNormalStrength=t.surfaceTensionNormalStrength,this.repulsiveStrength=t.repulsiveStrength,this.powderStrength=t.powderStrength,this.ejectionStrength=t.ejectionStrength,this.staticPressureStrength=t.staticPressureStrength,this.staticPressureRelaxation=t.staticPressureRelaxation,this.staticPressureIterations=t.staticPressureIterations,this.colorMixingStrength=t.colorMixingStrength,this.destroyByAge=t.destroyByAge,this.lifetimeGranularity=t.lifetimeGranularity,this},t.prototype.Clone=function(){return(new t).Copy(this)},t}(),t("b2ParticleSystemDef",h),u=function(){function tt(t,e){this.m_paused=!1,this.m_timestamp=0,this.m_allParticleFlags=0,this.m_needsUpdateAllParticleFlags=!1,this.m_allGroupFlags=0,this.m_needsUpdateAllGroupFlags=!1,this.m_hasForce=!1,this.m_iterationIndex=0,this.m_inverseDensity=0,this.m_particleDiameter=0,this.m_inverseDiameter=0,this.m_squaredDiameter=0,this.m_count=0,this.m_internalAllocatedCapacity=0,this.m_handleIndexBuffer=new tt.UserOverridableBuffer,this.m_flagsBuffer=new tt.UserOverridableBuffer,this.m_positionBuffer=new tt.UserOverridableBuffer,this.m_velocityBuffer=new tt.UserOverridableBuffer,this.m_forceBuffer=[],this.m_weightBuffer=[],this.m_staticPressureBuffer=[],this.m_accumulationBuffer=[],this.m_accumulation2Buffer=[],this.m_depthBuffer=[],this.m_colorBuffer=new tt.UserOverridableBuffer,this.m_groupBuffer=[],this.m_userDataBuffer=new tt.UserOverridableBuffer,this.m_stuckThreshold=0,this.m_lastBodyContactStepBuffer=new tt.UserOverridableBuffer,this.m_bodyContactCountBuffer=new tt.UserOverridableBuffer,this.m_consecutiveContactStepsBuffer=new tt.UserOverridableBuffer,this.m_stuckParticleBuffer=new n(function(){return 0}),this.m_proxyBuffer=new n(function(){return new tt.Proxy}),this.m_contactBuffer=new n(function(){return new r}),this.m_bodyContactBuffer=new n(function(){return new m}),this.m_pairBuffer=new n(function(){return new c}),this.m_triadBuffer=new n(function(){return new _}),this.m_expirationTimeBuffer=new tt.UserOverridableBuffer,this.m_indexByExpirationTimeBuffer=new tt.UserOverridableBuffer,this.m_timeElapsed=0,this.m_expirationTimeBufferRequiresSorting=!1,this.m_groupCount=0,this.m_groupList=null,this.m_def=new h,this.m_world=null,this.m_prev=null,this.m_next=null,this.SetStrictContactCheck(t.strictContactCheck),this.SetDensity(t.density),this.SetGravityScale(t.gravityScale),this.SetRadius(t.radius),this.SetMaxParticleCount(t.maxCount),t.lifetimeGranularity,this.m_def=t.Clone(),this.m_world=e,this.SetDestructionByAge(this.m_def.destroyByAge)}return tt.computeTag=function(t,e){return(e+tt.yOffset>>>0<<tt.yShift)+(tt.xScale*t+tt.xOffset>>>0)>>>0},tt.computeRelativeTag=function(t,e,i){return t+(i<<tt.yShift)+(e<<tt.xShift)>>>0},tt.prototype.Drop=function(){for(;this.m_groupList;)this.DestroyParticleGroup(this.m_groupList);this.FreeUserOverridableBuffer(this.m_handleIndexBuffer),this.FreeUserOverridableBuffer(this.m_flagsBuffer),this.FreeUserOverridableBuffer(this.m_lastBodyContactStepBuffer),this.FreeUserOverridableBuffer(this.m_bodyContactCountBuffer),this.FreeUserOverridableBuffer(this.m_consecutiveContactStepsBuffer),this.FreeUserOverridableBuffer(this.m_positionBuffer),this.FreeUserOverridableBuffer(this.m_velocityBuffer),this.FreeUserOverridableBuffer(this.m_colorBuffer),this.FreeUserOverridableBuffer(this.m_userDataBuffer),this.FreeUserOverridableBuffer(this.m_expirationTimeBuffer),this.FreeUserOverridableBuffer(this.m_indexByExpirationTimeBuffer),this.FreeBuffer(this.m_forceBuffer,this.m_internalAllocatedCapacity),this.FreeBuffer(this.m_weightBuffer,this.m_internalAllocatedCapacity),this.FreeBuffer(this.m_staticPressureBuffer,this.m_internalAllocatedCapacity),this.FreeBuffer(this.m_accumulationBuffer,this.m_internalAllocatedCapacity),this.FreeBuffer(this.m_accumulation2Buffer,this.m_internalAllocatedCapacity),this.FreeBuffer(this.m_depthBuffer,this.m_internalAllocatedCapacity),this.FreeBuffer(this.m_groupBuffer,this.m_internalAllocatedCapacity)},tt.prototype.CreateParticle=function(t){if(this.m_world.IsLocked(),this.m_world.IsLocked())return 0;if(this.m_count>=this.m_internalAllocatedCapacity){var e=this.m_count?2*this.m_count:et.b2_minParticleSystemBufferCapacity;this.ReallocateInternalAllocatedBuffers(e)}if(this.m_count>=this.m_internalAllocatedCapacity){if(!this.m_def.destroyByAge)return et.b2_invalidParticleIndex;this.DestroyOldestParticle(0,!1),this.SolveZombie()}var i=this.m_count++;this.m_flagsBuffer.data[i]=0,this.m_lastBodyContactStepBuffer.data&&(this.m_lastBodyContactStepBuffer.data[i]=0),this.m_bodyContactCountBuffer.data&&(this.m_bodyContactCountBuffer.data[i]=0),this.m_consecutiveContactStepsBuffer.data&&(this.m_consecutiveContactStepsBuffer.data[i]=0),this.m_positionBuffer.data[i]=(this.m_positionBuffer.data[i]||new it.b2Vec2).Copy(t.position),this.m_velocityBuffer.data[i]=(this.m_velocityBuffer.data[i]||new it.b2Vec2).Copy(t.velocity),this.m_weightBuffer[i]=0,this.m_forceBuffer[i]=(this.m_forceBuffer[i]||new it.b2Vec2).SetZero(),this.m_staticPressureBuffer&&(this.m_staticPressureBuffer[i]=0),this.m_depthBuffer&&(this.m_depthBuffer[i]=0),!this.m_colorBuffer.data&&t.color.IsZero()||(this.m_colorBuffer.data=this.RequestBuffer(this.m_colorBuffer.data),this.m_colorBuffer.data[i]=(this.m_colorBuffer.data[i]||new a.b2Color).Copy(t.color)),(this.m_userDataBuffer.data||t.userData)&&(this.m_userDataBuffer.data=this.RequestBuffer(this.m_userDataBuffer.data),this.m_userDataBuffer.data[i]=t.userData),this.m_handleIndexBuffer.data&&(this.m_handleIndexBuffer.data[i]=null);var o=this.m_proxyBuffer.data[this.m_proxyBuffer.Append()],n=0<t.lifetime;(this.m_expirationTimeBuffer.data||n)&&(this.SetParticleLifetime(i,n?t.lifetime:this.ExpirationTimeToLifetime(-this.GetQuantizedTimeElapsed())),this.m_indexByExpirationTimeBuffer.data[i]=i),o.index=i;var s=t.group;return(this.m_groupBuffer[i]=s)&&(s.m_firstIndex<s.m_lastIndex?(this.RotateBuffer(s.m_firstIndex,s.m_lastIndex,i),s.m_lastIndex):s.m_firstIndex=i,s.m_lastIndex=i+1),this.SetParticleFlags(i,t.flags),i},tt.prototype.GetParticleHandleFromIndex=function(t){0<=t&&t<this.GetParticleCount()&&et.b2_invalidParticleIndex,this.m_handleIndexBuffer.data=this.RequestBuffer(this.m_handleIndexBuffer.data);var e=this.m_handleIndexBuffer.data[t];return e||((e=new s.b2ParticleHandle).SetIndex(t),this.m_handleIndexBuffer.data[t]=e)},tt.prototype.DestroyParticle=function(t,e){void 0===e&&(e=!1);var i=2;e&&(i|=512),this.SetParticleFlags(t,this.m_flagsBuffer.data[t]|i)},tt.prototype.DestroyOldestParticle=function(t,e){void 0===e&&(e=!1);var i=this.GetParticleCount();this.m_indexByExpirationTimeBuffer.data;var o=this.m_indexByExpirationTimeBuffer.data[i-(t+1)],n=this.m_indexByExpirationTimeBuffer.data[t];this.DestroyParticle(0<this.m_expirationTimeBuffer.data[o]?o:n,e)},tt.prototype.DestroyParticlesInShape=function(t,e,i){void 0===i&&(i=!1);var o=tt.DestroyParticlesInShape_s_aabb;if(this.m_world.IsLocked(),this.m_world.IsLocked())return 0;var n=new tt.DestroyParticlesInShapeCallback(this,t,e,i),s=o;return t.ComputeAABB(s,e,0),this.m_world.QueryAABB(n,s),n.Destroyed()},tt.prototype.CreateParticleGroup=function(t){var e=tt.CreateParticleGroup_s_transform;if(this.m_world.IsLocked(),this.m_world.IsLocked())return null;var i=e;i.SetPositionAngle(t.position,t.angle);var o=this.m_count;if(t.shape&&this.CreateParticlesWithShapeForGroup(t.shape,t,i),t.shapes&&this.CreateParticlesWithShapesForGroup(t.shapes,t.shapeCount,t,i),t.particleCount){t.positionData;for(var n=0;n<t.particleCount;n++){var s=t.positionData[n];this.CreateParticleForGroup(t,i,s)}}var r=this.m_count,a=new l.b2ParticleGroup;a.m_system=this,a.m_firstIndex=o,a.m_lastIndex=r,a.m_strength=t.strength,a.m_userData=t.userData,a.m_transform.Copy(i),a.m_prev=null,a.m_next=this.m_groupList,this.m_groupList&&(this.m_groupList.m_prev=a),this.m_groupList=a,++this.m_groupCount;for(n=o;n<r;n++)this.m_groupBuffer[n]=a;this.SetGroupFlags(a,t.groupFlags);var m=new tt.ConnectionFilter;return this.UpdateContacts(!0),this.UpdatePairsAndTriads(o,r,m),t.group&&(this.JoinParticleGroups(t.group,a),a=t.group),a},tt.prototype.JoinParticleGroups=function(t,e){if(this.m_world.IsLocked(),!this.m_world.IsLocked()){this.RotateBuffer(e.m_firstIndex,e.m_lastIndex,this.m_count),e.m_lastIndex,this.m_count,this.RotateBuffer(t.m_firstIndex,t.m_lastIndex,e.m_firstIndex),t.m_lastIndex,e.m_firstIndex;var i=new tt.JoinParticleGroupsFilter(e.m_firstIndex);this.UpdateContacts(!0),this.UpdatePairsAndTriads(t.m_firstIndex,e.m_lastIndex,i);for(var o=e.m_firstIndex;o<e.m_lastIndex;o++)this.m_groupBuffer[o]=t;var n=t.m_groupFlags|e.m_groupFlags;this.SetGroupFlags(t,n),t.m_lastIndex=e.m_lastIndex,e.m_firstIndex=e.m_lastIndex,this.DestroyParticleGroup(e)}},tt.prototype.SplitParticleGroup=function(t){this.UpdateContacts(!0);var e=t.GetParticleCount(),i=et.b2MakeArray(e,function(t){return new tt.ParticleListNode});tt.InitializeParticleLists(t,i),this.MergeParticleListsInContact(t,i);var o=tt.FindLongestParticleList(t,i);this.MergeZombieParticleListNodes(t,i,o),this.CreateParticleGroupsFromParticleList(t,i,o),this.UpdatePairsAndTriadsWithParticleList(t,i)},tt.prototype.GetParticleGroupList=function(){return this.m_groupList},tt.prototype.GetParticleGroupCount=function(){return this.m_groupCount},tt.prototype.GetParticleCount=function(){return this.m_count},tt.prototype.GetMaxParticleCount=function(){return this.m_def.maxCount},tt.prototype.SetMaxParticleCount=function(t){this.m_count,this.m_def.maxCount=t},tt.prototype.GetAllParticleFlags=function(){return this.m_allParticleFlags},tt.prototype.GetAllGroupFlags=function(){return this.m_allGroupFlags},tt.prototype.SetPaused=function(t){this.m_paused=t},tt.prototype.GetPaused=function(){return this.m_paused},tt.prototype.SetDensity=function(t){this.m_def.density=t,this.m_inverseDensity=1/this.m_def.density},tt.prototype.GetDensity=function(){return this.m_def.density},tt.prototype.SetGravityScale=function(t){this.m_def.gravityScale=t},tt.prototype.GetGravityScale=function(){return this.m_def.gravityScale},tt.prototype.SetDamping=function(t){this.m_def.dampingStrength=t},tt.prototype.GetDamping=function(){return this.m_def.dampingStrength},tt.prototype.SetStaticPressureIterations=function(t){this.m_def.staticPressureIterations=t},tt.prototype.GetStaticPressureIterations=function(){return this.m_def.staticPressureIterations},tt.prototype.SetRadius=function(t){this.m_particleDiameter=2*t,this.m_squaredDiameter=this.m_particleDiameter*this.m_particleDiameter,this.m_inverseDiameter=1/this.m_particleDiameter},tt.prototype.GetRadius=function(){return this.m_particleDiameter/2},tt.prototype.GetPositionBuffer=function(){return this.m_positionBuffer.data},tt.prototype.GetVelocityBuffer=function(){return this.m_velocityBuffer.data},tt.prototype.GetColorBuffer=function(){return this.m_colorBuffer.data=this.RequestBuffer(this.m_colorBuffer.data),this.m_colorBuffer.data},tt.prototype.GetGroupBuffer=function(){return this.m_groupBuffer},tt.prototype.GetWeightBuffer=function(){return this.m_weightBuffer},tt.prototype.GetUserDataBuffer=function(){return this.m_userDataBuffer.data=this.RequestBuffer(this.m_userDataBuffer.data),this.m_userDataBuffer.data},tt.prototype.GetFlagsBuffer=function(){return this.m_flagsBuffer.data},tt.prototype.SetParticleFlags=function(t,e){this.m_flagsBuffer.data[t]&~e&&(this.m_needsUpdateAllParticleFlags=!0),~this.m_allParticleFlags&e&&(128&e&&(this.m_accumulation2Buffer=this.RequestBuffer(this.m_accumulation2Buffer)),256&e&&(this.m_colorBuffer.data=this.RequestBuffer(this.m_colorBuffer.data)),this.m_allParticleFlags|=e),this.m_flagsBuffer.data[t]=e},tt.prototype.GetParticleFlags=function(t){return this.m_flagsBuffer.data[t]},tt.prototype.SetFlagsBuffer=function(t,e){this.SetUserOverridableBuffer(this.m_flagsBuffer,t,e)},tt.prototype.SetPositionBuffer=function(t,e){this.SetUserOverridableBuffer(this.m_positionBuffer,t,e)},tt.prototype.SetVelocityBuffer=function(t,e){this.SetUserOverridableBuffer(this.m_velocityBuffer,t,e)},tt.prototype.SetColorBuffer=function(t,e){this.SetUserOverridableBuffer(this.m_colorBuffer,t,e)},tt.prototype.SetUserDataBuffer=function(t,e){this.SetUserOverridableBuffer(this.m_userDataBuffer,t,e)},tt.prototype.GetContacts=function(){return this.m_contactBuffer.data},tt.prototype.GetContactCount=function(){return this.m_contactBuffer.count},tt.prototype.GetBodyContacts=function(){return this.m_bodyContactBuffer.data},tt.prototype.GetBodyContactCount=function(){return this.m_bodyContactBuffer.count},tt.prototype.GetPairs=function(){return this.m_pairBuffer.data},tt.prototype.GetPairCount=function(){return this.m_pairBuffer.count},tt.prototype.GetTriads=function(){return this.m_triadBuffer.data},tt.prototype.GetTriadCount=function(){return this.m_triadBuffer.count},tt.prototype.SetStuckThreshold=function(t){0<(this.m_stuckThreshold=t)&&(this.m_lastBodyContactStepBuffer.data=this.RequestBuffer(this.m_lastBodyContactStepBuffer.data),this.m_bodyContactCountBuffer.data=this.RequestBuffer(this.m_bodyContactCountBuffer.data),this.m_consecutiveContactStepsBuffer.data=this.RequestBuffer(this.m_consecutiveContactStepsBuffer.data))},tt.prototype.GetStuckCandidates=function(){return this.m_stuckParticleBuffer.Data()},tt.prototype.GetStuckCandidateCount=function(){return this.m_stuckParticleBuffer.GetCount()},tt.prototype.ComputeCollisionEnergy=function(){for(var t=tt.ComputeCollisionEnergy_s_v,e=this.m_velocityBuffer.data,i=0,o=0;o<this.m_contactBuffer.count;o++){var n=this.m_contactBuffer.data[o],s=n.indexA,r=n.indexB,a=n.normal,m=it.b2Vec2.SubVV(e[r],e[s],t),c=it.b2Vec2.DotVV(m,a);c<0&&(i+=c*c)}return.5*this.GetParticleMass()*i},tt.prototype.SetStrictContactCheck=function(t){this.m_def.strictContactCheck=t},tt.prototype.GetStrictContactCheck=function(){return this.m_def.strictContactCheck},tt.prototype.SetParticleLifetime=function(t,e){this.ValidateParticleIndex(t);var i=null===this.m_indexByExpirationTimeBuffer.data;if(this.m_expirationTimeBuffer.data=this.RequestBuffer(this.m_expirationTimeBuffer.data),this.m_indexByExpirationTimeBuffer.data=this.RequestBuffer(this.m_indexByExpirationTimeBuffer.data),i)for(var o=this.GetParticleCount(),n=0;n<o;++n)this.m_indexByExpirationTimeBuffer.data[n]=n;var s=e/this.m_def.lifetimeGranularity,r=0<s?this.GetQuantizedTimeElapsed()+s:s;r!==this.m_expirationTimeBuffer.data[t]&&(this.m_expirationTimeBuffer.data[t]=r,this.m_expirationTimeBufferRequiresSorting=!0)},tt.prototype.GetParticleLifetime=function(t){return this.ValidateParticleIndex(t),this.ExpirationTimeToLifetime(this.GetExpirationTimeBuffer()[t])},tt.prototype.SetDestructionByAge=function(t){t&&this.GetExpirationTimeBuffer(),this.m_def.destroyByAge=t},tt.prototype.GetDestructionByAge=function(){return this.m_def.destroyByAge},tt.prototype.GetExpirationTimeBuffer=function(){return this.m_expirationTimeBuffer.data=this.RequestBuffer(this.m_expirationTimeBuffer.data),this.m_expirationTimeBuffer.data},tt.prototype.ExpirationTimeToLifetime=function(t){return(0<t?t-this.GetQuantizedTimeElapsed():t)*this.m_def.lifetimeGranularity},tt.prototype.GetIndexByExpirationTimeBuffer=function(){return this.GetParticleCount()?this.SetParticleLifetime(0,this.GetParticleLifetime(0)):this.m_indexByExpirationTimeBuffer.data=this.RequestBuffer(this.m_indexByExpirationTimeBuffer.data),this.m_indexByExpirationTimeBuffer.data},tt.prototype.ParticleApplyLinearImpulse=function(t,e){this.ApplyLinearImpulse(t,t+1,e)},tt.prototype.ApplyLinearImpulse=function(t,e,i){for(var o=this.m_velocityBuffer.data,n=(e-t)*this.GetParticleMass(),s=i.Clone().SelfMul(1/n),r=t;r<e;r++)o[r].SelfAdd(s)},tt.IsSignificantForce=function(t){return 0!==t.x||0!==t.y},tt.prototype.ParticleApplyForce=function(t,e){tt.IsSignificantForce(e)&&this.ForceCanBeApplied(this.m_flagsBuffer.data[t])&&(this.PrepareForceBuffer(),this.m_forceBuffer[t].SelfAdd(e))},tt.prototype.ApplyForce=function(t,e,i){var o=i.Clone().SelfMul(1/(e-t));if(tt.IsSignificantForce(o)){this.PrepareForceBuffer();for(var n=t;n<e;n++)this.m_forceBuffer[n].SelfAdd(o)}},tt.prototype.GetNext=function(){return this.m_next},tt.prototype.QueryAABB=function(t,e){if(0!==this.m_proxyBuffer.count)for(var i=this.m_proxyBuffer.count,o=S(this.m_proxyBuffer.data,0,i,tt.computeTag(this.m_inverseDiameter*e.lowerBound.x,this.m_inverseDiameter*e.lowerBound.y),tt.Proxy.CompareProxyTag),n=B(this.m_proxyBuffer.data,o,i,tt.computeTag(this.m_inverseDiameter*e.upperBound.x,this.m_inverseDiameter*e.upperBound.y),tt.Proxy.CompareTagProxy),s=this.m_positionBuffer.data,r=o;r<n;++r){var a=this.m_proxyBuffer.data[r].index,m=s[a];if(e.lowerBound.x<m.x&&m.x<e.upperBound.x&&e.lowerBound.y<m.y&&m.y<e.upperBound.y&&!t.ReportParticle(this,a))break}},tt.prototype.QueryShapeAABB=function(t,e,i,o){void 0===o&&(o=0);var n=tt.QueryShapeAABB_s_aabb;e.ComputeAABB(n,i,o),this.QueryAABB(t,n)},tt.prototype.QueryPointAABB=function(t,e,i){void 0===i&&(i=et.b2_linearSlop);var o=tt.QueryPointAABB_s_aabb;o.lowerBound.Set(e.x-i,e.y-i),o.upperBound.Set(e.x+i,e.y+i),this.QueryAABB(t,o)},tt.prototype.RayCast=function(t,e,i){var o=tt.RayCast_s_aabb,n=tt.RayCast_s_p,s=tt.RayCast_s_v,r=tt.RayCast_s_n,a=tt.RayCast_s_point;if(0!==this.m_proxyBuffer.count){var m=this.m_positionBuffer.data,c=o;it.b2Vec2.MinV(e,i,c.lowerBound),it.b2Vec2.MaxV(e,i,c.upperBound);for(var _,l=1,h=it.b2Vec2.SubVV(i,e,s),u=it.b2Vec2.DotVV(h,h),p=this.GetInsideBoundsEnumerator(c);0<=(_=p.GetNext());){var f=it.b2Vec2.SubVV(e,m[_],n),d=it.b2Vec2.DotVV(f,h),y=d*d-u*(it.b2Vec2.DotVV(f,f)-this.m_squaredDiameter);if(0<=y){var b=it.b2Sqrt(y),V=(-d-b)/u;if(l<V)continue;if(V<0&&((V=(-d+b)/u)<0||l<V))continue;var v=it.b2Vec2.AddVMulSV(f,V,h,r);v.Normalize();var x=t.ReportParticle(this,_,it.b2Vec2.AddVMulSV(e,V,h,a),v,V);if((l=it.b2Min(l,x))<=0)break}}}},tt.prototype.ComputeAABB=function(t){var e=this.GetParticleCount();t.lowerBound.x=+et.b2_maxFloat,t.lowerBound.y=+et.b2_maxFloat,t.upperBound.x=-et.b2_maxFloat,t.upperBound.y=-et.b2_maxFloat;for(var i=this.m_positionBuffer.data,o=0;o<e;o++){var n=i[o];it.b2Vec2.MinV(t.lowerBound,n,t.lowerBound),it.b2Vec2.MaxV(t.upperBound,n,t.upperBound)}t.lowerBound.x-=this.m_particleDiameter,t.lowerBound.y-=this.m_particleDiameter,t.upperBound.x+=this.m_particleDiameter,t.upperBound.y+=this.m_particleDiameter},tt.prototype.FreeBuffer=function(t,e){null!==t&&(t.length=0)},tt.prototype.FreeUserOverridableBuffer=function(t){0===t.userSuppliedCapacity&&this.FreeBuffer(t.data,this.m_internalAllocatedCapacity)},tt.prototype.ReallocateBuffer3=function(t,e,i){var o=t?t.slice():[];return o.length=i,o},tt.prototype.ReallocateBuffer5=function(t,e,i,o,n){return n&&!t||e||(t=this.ReallocateBuffer3(t,i,o)),t},tt.prototype.ReallocateBuffer4=function(t,e,i,o){return this.ReallocateBuffer5(t.data,t.userSuppliedCapacity,e,i,o)},tt.prototype.RequestBuffer=function(t){return t||(0===this.m_internalAllocatedCapacity&&this.ReallocateInternalAllocatedBuffers(et.b2_minParticleSystemBufferCapacity),(t=[]).length=this.m_internalAllocatedCapacity),t},tt.prototype.ReallocateHandleBuffers=function(t){this.m_internalAllocatedCapacity,this.m_handleIndexBuffer.data=this.ReallocateBuffer4(this.m_handleIndexBuffer,this.m_internalAllocatedCapacity,t,!0)},tt.prototype.ReallocateInternalAllocatedBuffers=function(t){function e(t,e){return e&&e<t?e:t}if(t=e(t=e(t=e(t=e(t=e(t=e(t,this.m_def.maxCount),this.m_flagsBuffer.userSuppliedCapacity),this.m_positionBuffer.userSuppliedCapacity),this.m_velocityBuffer.userSuppliedCapacity),this.m_colorBuffer.userSuppliedCapacity),this.m_userDataBuffer.userSuppliedCapacity),this.m_internalAllocatedCapacity<t){this.ReallocateHandleBuffers(t),this.m_flagsBuffer.data=this.ReallocateBuffer4(this.m_flagsBuffer,this.m_internalAllocatedCapacity,t,!1);var i=0<this.m_stuckThreshold;this.m_lastBodyContactStepBuffer.data=this.ReallocateBuffer4(this.m_lastBodyContactStepBuffer,this.m_internalAllocatedCapacity,t,i),this.m_bodyContactCountBuffer.data=this.ReallocateBuffer4(this.m_bodyContactCountBuffer,this.m_internalAllocatedCapacity,t,i),this.m_consecutiveContactStepsBuffer.data=this.ReallocateBuffer4(this.m_consecutiveContactStepsBuffer,this.m_internalAllocatedCapacity,t,i),this.m_positionBuffer.data=this.ReallocateBuffer4(this.m_positionBuffer,this.m_internalAllocatedCapacity,t,!1),this.m_velocityBuffer.data=this.ReallocateBuffer4(this.m_velocityBuffer,this.m_internalAllocatedCapacity,t,!1),this.m_forceBuffer=this.ReallocateBuffer5(this.m_forceBuffer,0,this.m_internalAllocatedCapacity,t,!1),this.m_weightBuffer=this.ReallocateBuffer5(this.m_weightBuffer,0,this.m_internalAllocatedCapacity,t,!1),this.m_staticPressureBuffer=this.ReallocateBuffer5(this.m_staticPressureBuffer,0,this.m_internalAllocatedCapacity,t,!0),this.m_accumulationBuffer=this.ReallocateBuffer5(this.m_accumulationBuffer,0,this.m_internalAllocatedCapacity,t,!1),this.m_accumulation2Buffer=this.ReallocateBuffer5(this.m_accumulation2Buffer,0,this.m_internalAllocatedCapacity,t,!0),this.m_depthBuffer=this.ReallocateBuffer5(this.m_depthBuffer,0,this.m_internalAllocatedCapacity,t,!0),this.m_colorBuffer.data=this.ReallocateBuffer4(this.m_colorBuffer,this.m_internalAllocatedCapacity,t,!0),this.m_groupBuffer=this.ReallocateBuffer5(this.m_groupBuffer,0,this.m_internalAllocatedCapacity,t,!1),this.m_userDataBuffer.data=this.ReallocateBuffer4(this.m_userDataBuffer,this.m_internalAllocatedCapacity,t,!0),this.m_expirationTimeBuffer.data=this.ReallocateBuffer4(this.m_expirationTimeBuffer,this.m_internalAllocatedCapacity,t,!0),this.m_indexByExpirationTimeBuffer.data=this.ReallocateBuffer4(this.m_indexByExpirationTimeBuffer,this.m_internalAllocatedCapacity,t,!1),this.m_internalAllocatedCapacity=t}},tt.prototype.CreateParticleForGroup=function(t,e,i){var o=new s.b2ParticleDef;o.flags=t.flags,it.b2Transform.MulXV(e,i,o.position),it.b2Vec2.AddVV(t.linearVelocity,it.b2Vec2.CrossSV(t.angularVelocity,it.b2Vec2.SubVV(o.position,t.position,it.b2Vec2.s_t0),it.b2Vec2.s_t0),o.velocity),o.color.Copy(t.color),o.lifetime=t.lifetime,o.userData=t.userData,this.CreateParticle(o)},tt.prototype.CreateParticlesStrokeShapeForGroup=function(t,e,i){var o=tt.CreateParticlesStrokeShapeForGroup_s_edge,n=tt.CreateParticlesStrokeShapeForGroup_s_d,s=tt.CreateParticlesStrokeShapeForGroup_s_p,r=e.stride;0===r&&(r=this.GetParticleStride());for(var a=0,m=t.GetChildCount(),c=0;c<m;c++){var _=null;1===t.GetType()?_=t:(t.GetType(),_=o,t.GetChildEdge(_,c));for(var l=it.b2Vec2.SubVV(_.m_vertex2,_.m_vertex1,n),h=l.Length();a<h;){var u=it.b2Vec2.AddVMulSV(_.m_vertex1,a/h,l,s);this.CreateParticleForGroup(e,i,u),a+=r}a-=h}},tt.prototype.CreateParticlesFillShapeForGroup=function(t,e,i){var o=tt.CreateParticlesFillShapeForGroup_s_aabb,n=tt.CreateParticlesFillShapeForGroup_s_p,s=e.stride;0===s&&(s=this.GetParticleStride());var r=it.b2Transform.IDENTITY,a=o;t.GetChildCount(),t.ComputeAABB(a,r,0);for(var m=Math.floor(a.lowerBound.y/s)*s;m<a.upperBound.y;m+=s)for(var c=Math.floor(a.lowerBound.x/s)*s;c<a.upperBound.x;c+=s){var _=n.Set(c,m);t.TestPoint(r,_)&&this.CreateParticleForGroup(e,i,_)}},tt.prototype.CreateParticlesWithShapeForGroup=function(t,e,i){switch(t.GetType()){case 1:case 3:this.CreateParticlesStrokeShapeForGroup(t,e,i);break;case 2:case 0:this.CreateParticlesFillShapeForGroup(t,e,i)}},tt.prototype.CreateParticlesWithShapesForGroup=function(t,e,i,o){var n=new tt.CompositeShape(t,e);this.CreateParticlesFillShapeForGroup(n,i,o)},tt.prototype.CloneParticle=function(t,e){var i=new s.b2ParticleDef;i.flags=this.m_flagsBuffer.data[t],i.position.Copy(this.m_positionBuffer.data[t]),i.velocity.Copy(this.m_velocityBuffer.data[t]),this.m_colorBuffer.data&&i.color.Copy(this.m_colorBuffer.data[t]),this.m_userDataBuffer.data&&(i.userData=this.m_userDataBuffer.data[t]),i.group=e;var o=this.CreateParticle(i);if(this.m_handleIndexBuffer.data){var n=this.m_handleIndexBuffer.data[t];n&&n.SetIndex(o),this.m_handleIndexBuffer.data[o]=n,this.m_handleIndexBuffer.data[t]=null}return this.m_lastBodyContactStepBuffer.data&&(this.m_lastBodyContactStepBuffer.data[o]=this.m_lastBodyContactStepBuffer.data[t]),this.m_bodyContactCountBuffer.data&&(this.m_bodyContactCountBuffer.data[o]=this.m_bodyContactCountBuffer.data[t]),this.m_consecutiveContactStepsBuffer.data&&(this.m_consecutiveContactStepsBuffer.data[o]=this.m_consecutiveContactStepsBuffer.data[t]),this.m_hasForce&&this.m_forceBuffer[o].Copy(this.m_forceBuffer[t]),this.m_staticPressureBuffer&&(this.m_staticPressureBuffer[o]=this.m_staticPressureBuffer[t]),this.m_depthBuffer&&(this.m_depthBuffer[o]=this.m_depthBuffer[t]),this.m_expirationTimeBuffer.data&&(this.m_expirationTimeBuffer.data[o]=this.m_expirationTimeBuffer.data[t]),o},tt.prototype.DestroyParticlesInGroup=function(t,e){void 0===e&&(e=!1);for(var i=t.m_firstIndex;i<t.m_lastIndex;i++)this.DestroyParticle(i,e)},tt.prototype.DestroyParticleGroup=function(t){this.m_groupCount,this.m_world.m_destructionListener&&this.m_world.m_destructionListener.SayGoodbyeParticleGroup(t),this.SetGroupFlags(t,0);for(var e=t.m_firstIndex;e<t.m_lastIndex;e++)this.m_groupBuffer[e]=null;t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),t===this.m_groupList&&(this.m_groupList=t.m_next),--this.m_groupCount},tt.ParticleCanBeConnected=function(t,e){return 0!=(28&t)||null!==e&&0!=(2&e.GetGroupFlags())},tt.prototype.UpdatePairsAndTriads=function(t,e,V){for(var v=tt.UpdatePairsAndTriads_s_dab,x=tt.UpdatePairsAndTriads_s_dbc,C=tt.UpdatePairsAndTriads_s_dca,S=this.m_positionBuffer.data,i=0,o=t;o<e;o++)i|=this.m_flagsBuffer.data[o];if(i&tt.k_pairFlags)for(var n=0;n<this.m_contactBuffer.count;n++){var s=this.m_contactBuffer.data[n],r=s.indexA,a=s.indexB,m=this.m_flagsBuffer.data[r],c=this.m_flagsBuffer.data[a],_=this.m_groupBuffer[r],l=this.m_groupBuffer[a];if(t<=r&&r<e&&t<=a&&a<e&&!(2&(m|c))&&(m|c)&tt.k_pairFlags&&(V.IsNecessary(r)||V.IsNecessary(a))&&tt.ParticleCanBeConnected(m,_)&&tt.ParticleCanBeConnected(c,l)&&V.ShouldCreatePair(r,a)){var h=this.m_pairBuffer.data[this.m_pairBuffer.Append()];h.indexA=r,h.indexB=a,h.flags=s.flags,h.strength=it.b2Min(_?_.m_strength:1,l?l.m_strength:1),h.distance=it.b2Vec2.DistanceVV(S[r],S[a])}g(this.m_pairBuffer.data,0,this.m_pairBuffer.count,tt.ComparePairIndices),this.m_pairBuffer.Unique(tt.MatchPairIndices)}if(i&tt.k_triadFlags){var u=new A.b2VoronoiDiagram(e-t);for(o=t;o<e;o++){var p=this.m_flagsBuffer.data[o],f=this.m_groupBuffer[o];2&p||!tt.ParticleCanBeConnected(p,f)||u.AddGenerator(S[o],o,V.IsNecessary(o))}var d=this.GetParticleStride();u.Generate(d/2,2*d);var B=this;u.GetNodes(function(t,e,i){var o=B.m_flagsBuffer.data[t],n=B.m_flagsBuffer.data[e],s=B.m_flagsBuffer.data[i];if((o|n|s)&tt.k_triadFlags&&V.ShouldCreateTriad(t,e,i)){var r=S[t],a=S[e],m=S[i],c=it.b2Vec2.SubVV(r,a,v),_=it.b2Vec2.SubVV(a,m,x),l=it.b2Vec2.SubVV(m,r,C),h=et.b2_maxTriadDistanceSquared*B.m_squaredDiameter;if(it.b2Vec2.DotVV(c,c)>h||it.b2Vec2.DotVV(_,_)>h||it.b2Vec2.DotVV(l,l)>h)return;var u=B.m_groupBuffer[t],p=B.m_groupBuffer[e],f=B.m_groupBuffer[i],d=B.m_triadBuffer.data[B.m_triadBuffer.Append()];d.indexA=t,d.indexB=e,d.indexC=i,d.flags=o|n|s,d.strength=it.b2Min(it.b2Min(u?u.m_strength:1,p?p.m_strength:1),f?f.m_strength:1);var y=(r.x+a.x+m.x)/3,b=(r.y+a.y+m.y)/3;d.pa.x=r.x-y,d.pa.y=r.y-b,d.pb.x=a.x-y,d.pb.y=a.y-b,d.pc.x=m.x-y,d.pc.y=m.y-b,d.ka=-it.b2Vec2.DotVV(l,c),d.kb=-it.b2Vec2.DotVV(c,_),d.kc=-it.b2Vec2.DotVV(_,l),d.s=it.b2Vec2.CrossVV(r,a)+it.b2Vec2.CrossVV(a,m)+it.b2Vec2.CrossVV(m,r)}}),g(this.m_triadBuffer.data,0,this.m_triadBuffer.count,tt.CompareTriadIndices),this.m_triadBuffer.Unique(tt.MatchTriadIndices)}},tt.prototype.UpdatePairsAndTriadsWithReactiveParticles=function(){var t=new tt.ReactiveFilter(this.m_flagsBuffer);this.UpdatePairsAndTriads(0,this.m_count,t);for(var e=0;e<this.m_count;e++)this.m_flagsBuffer.data[e]&=-4097;this.m_allParticleFlags&=-4097},tt.ComparePairIndices=function(t,e){var i=t.indexA-e.indexA;return 0!==i?i<0:t.indexB<e.indexB},tt.MatchPairIndices=function(t,e){return t.indexA===e.indexA&&t.indexB===e.indexB},tt.CompareTriadIndices=function(t,e){var i=t.indexA-e.indexA;if(0!==i)return i<0;var o=t.indexB-e.indexB;return 0!==o?o<0:t.indexC<e.indexC},tt.MatchTriadIndices=function(t,e){return t.indexA===e.indexA&&t.indexB===e.indexB&&t.indexC===e.indexC},tt.InitializeParticleLists=function(t,e){for(var i=t.GetBufferIndex(),o=t.GetParticleCount(),n=0;n<o;n++){var s=e[n];(s.list=s).next=null,s.count=1,s.index=n+i}},tt.prototype.MergeParticleListsInContact=function(t,e){for(var i=t.GetBufferIndex(),o=0;o<this.m_contactBuffer.count;o++){var n=this.m_contactBuffer.data[o],s=n.indexA,r=n.indexB;if(t.ContainsParticle(s)&&t.ContainsParticle(r)){var a=e[s-i].list,m=e[r-i].list;if(a!==m){if(a.count<m.count){var c=a;a=m,m=c}a.count,m.count,tt.MergeParticleLists(a,m)}}}},tt.MergeParticleLists=function(t,e){for(var i=e;;){i.list=t;var o=i.next;if(!o){i.next=t.next;break}i=o}t.next=e,t.count+=e.count,e.count=0},tt.FindLongestParticleList=function(t,e){for(var i=t.GetParticleCount(),o=e[0],n=0;n<i;n++){var s=e[n];o.count<s.count&&(o=s)}return o},tt.prototype.MergeZombieParticleListNodes=function(t,e,i){for(var o=t.GetParticleCount(),n=0;n<o;n++){var s=e[n];s!==i&&2&this.m_flagsBuffer.data[s.index]&&tt.MergeParticleListAndNode(i,s)}},tt.MergeParticleListAndNode=function(t,e){e.list,e.count,e.list=t,e.next=t.next,t.next=e,t.count++,e.count=0},tt.prototype.CreateParticleGroupsFromParticleList=function(t,e,i){var o=t.GetParticleCount(),n=new l.b2ParticleGroupDef;n.groupFlags=t.GetGroupFlags(),n.userData=t.GetUserData();for(var s=0;s<o;s++){var r=e[s];if(r.count&&r!==i){r.list;for(var a=this.CreateParticleGroup(n),m=r;m;m=m.next){var c=m.index,_=(this.m_flagsBuffer.data[c],this.CloneParticle(c,a));this.m_flagsBuffer.data[c]|=2,m.index=_}}}},tt.prototype.UpdatePairsAndTriadsWithParticleList=function(t,e){for(var i=t.GetBufferIndex(),o=0;o<this.m_pairBuffer.count;o++){var n=this.m_pairBuffer.data[o],s=n.indexA,r=n.indexB;t.ContainsParticle(s)&&(n.indexA=e[s-i].index),t.ContainsParticle(r)&&(n.indexB=e[r-i].index)}for(o=0;o<this.m_triadBuffer.count;o++){var a=this.m_triadBuffer.data[o],m=(s=a.indexA,r=a.indexB,a.indexC);t.ContainsParticle(s)&&(a.indexA=e[s-i].index),t.ContainsParticle(r)&&(a.indexB=e[r-i].index),t.ContainsParticle(m)&&(a.indexC=e[m-i].index)}},tt.prototype.ComputeDepth=function(){for(var t=[],e=0,i=0;i<this.m_contactBuffer.count;i++){var o=(d=this.m_contactBuffer.data[i]).indexA,n=d.indexB,s=this.m_groupBuffer[o],r=this.m_groupBuffer[n];s&&s===r&&16&s.m_groupFlags&&(t[e++]=d)}for(var a=[],m=0,c=this.m_groupList;c;c=c.GetNext())if(16&c.m_groupFlags){a[m++]=c,this.SetGroupFlags(c,-17&c.m_groupFlags);for(var _=c.m_firstIndex;_<c.m_lastIndex;_++)this.m_accumulationBuffer[_]=0}for(i=0;i<e;i++){o=(d=t[i]).indexA,n=d.indexB;var l=d.weight;this.m_accumulationBuffer[o]+=l,this.m_accumulationBuffer[n]+=l}this.m_depthBuffer;for(_=0;_<m;_++)for(var h=(c=a[_]).m_firstIndex;h<c.m_lastIndex;h++){l=this.m_accumulationBuffer[h];this.m_depthBuffer[h]=l<.8?0:et.b2_maxFloat}for(var u=it.b2Sqrt(this.m_count)>>0,p=0;p<u;p++){var f=!1;for(i=0;i<e;i++){o=(d=t[i]).indexA,n=d.indexB;var d,y=1-d.weight,b=this.m_depthBuffer[o],V=this.m_depthBuffer[n],v=V+y,x=b+y;v<b&&(this.m_depthBuffer[o]=v,f=!0),x<V&&(this.m_depthBuffer[n]=x,f=!0)}if(!f)break}for(_=0;_<m;_++)for(var C=(c=a[_]).m_firstIndex;C<c.m_lastIndex;C++)this.m_depthBuffer[C]<et.b2_maxFloat?this.m_depthBuffer[C]*=this.m_particleDiameter:this.m_depthBuffer[C]=0},tt.prototype.GetInsideBoundsEnumerator=function(t){var e=tt.computeTag(this.m_inverseDiameter*t.lowerBound.x-1,this.m_inverseDiameter*t.lowerBound.y-1),i=tt.computeTag(this.m_inverseDiameter*t.upperBound.x+1,this.m_inverseDiameter*t.upperBound.y+1),o=this.m_proxyBuffer.count,n=S(this.m_proxyBuffer.data,0,o,e,tt.Proxy.CompareProxyTag),s=B(this.m_proxyBuffer.data,0,o,i,tt.Proxy.CompareTagProxy);return new tt.InsideBoundsEnumerator(this,e,i,n,s)},tt.prototype.UpdateAllParticleFlags=function(){for(var t=this.m_allParticleFlags=0;t<this.m_count;t++)this.m_allParticleFlags|=this.m_flagsBuffer.data[t];this.m_needsUpdateAllParticleFlags=!1},tt.prototype.UpdateAllGroupFlags=function(){this.m_allGroupFlags=0;for(var t=this.m_groupList;t;t=t.GetNext())this.m_allGroupFlags|=t.m_groupFlags;this.m_needsUpdateAllGroupFlags=!1},tt.prototype.AddContact=function(t,e,i){var o=tt.AddContact_s_d,n=this.m_positionBuffer.data;this.m_contactBuffer;var s=it.b2Vec2.SubVV(n[e],n[t],o),r=it.b2Vec2.DotVV(s,s);if(r<this.m_squaredDiameter){var a=it.b2InvSqrt(r);isFinite(a)||(a=198177537e11);var m=this.m_contactBuffer.data[this.m_contactBuffer.Append()];m.indexA=t,m.indexB=e,m.flags=this.m_flagsBuffer.data[t]|this.m_flagsBuffer.data[e],m.weight=1-r*a*this.m_inverseDiameter,it.b2Vec2.MulSV(a,s,m.normal)}},tt.prototype.FindContacts_Reference=function(t){this.m_contactBuffer;for(var e=this.m_proxyBuffer.count,i=this.m_contactBuffer.count=0,o=0;i<e;i++){for(var n=tt.computeRelativeTag(this.m_proxyBuffer.data[i].tag,1,0),s=i+1;s<e&&!(n<this.m_proxyBuffer.data[s].tag);s++)this.AddContact(this.m_proxyBuffer.data[i].index,this.m_proxyBuffer.data[s].index,this.m_contactBuffer);for(var r=tt.computeRelativeTag(this.m_proxyBuffer.data[i].tag,-1,1);o<e&&!(r<=this.m_proxyBuffer.data[o].tag);o++);var a=tt.computeRelativeTag(this.m_proxyBuffer.data[i].tag,1,1);for(s=o;s<e&&!(a<this.m_proxyBuffer.data[s].tag);s++)this.AddContact(this.m_proxyBuffer.data[i].index,this.m_proxyBuffer.data[s].index,this.m_contactBuffer)}},tt.prototype.FindContacts=function(t){this.FindContacts_Reference(t)},tt.prototype.UpdateProxies_Reference=function(t){this.m_proxyBuffer;for(var e=this.m_positionBuffer.data,i=this.m_inverseDiameter,o=0;o<this.m_proxyBuffer.count;++o){var n=this.m_proxyBuffer.data[o],s=e[n.index];n.tag=tt.computeTag(i*s.x,i*s.y)}},tt.prototype.UpdateProxies=function(t){this.UpdateProxies_Reference(t)},tt.prototype.SortProxies=function(t){this.m_proxyBuffer,V(this.m_proxyBuffer.data,0,this.m_proxyBuffer.count,tt.Proxy.CompareProxyProxy)},tt.prototype.FilterContacts=function(t){var e=this.GetParticleContactFilter();if(null!==e){this.m_contactBuffer;var i=this;this.m_contactBuffer.RemoveIf(function(t){return 131072&t.flags&&!e.ShouldCollideParticleParticle(i,t.indexA,t.indexB)})}},tt.prototype.NotifyContactListenerPreContact=function(t){if(null!==this.GetParticleContactListener())throw t.Initialize(this.m_contactBuffer,this.m_flagsBuffer),new Error},tt.prototype.NotifyContactListenerPostContact=function(t){var e=this.GetParticleContactListener();if(null!==e){for(var i=0;i<this.m_contactBuffer.count;++i){var o=this.m_contactBuffer.data[i];e.BeginContactParticleParticle(this,o)}throw new Error}},tt.b2ParticleContactIsZombie=function(t){return 2==(2&t.flags)},tt.prototype.UpdateContacts=function(t){this.UpdateProxies(this.m_proxyBuffer),this.SortProxies(this.m_proxyBuffer);var e=new tt.b2ParticlePairSet;this.NotifyContactListenerPreContact(e),this.FindContacts(this.m_contactBuffer),this.FilterContacts(this.m_contactBuffer),this.NotifyContactListenerPostContact(e),t&&this.m_contactBuffer.RemoveIf(tt.b2ParticleContactIsZombie)},tt.prototype.NotifyBodyContactListenerPreContact=function(t){if(null!==this.GetFixtureContactListener())throw t.Initialize(this.m_bodyContactBuffer,this.m_flagsBuffer),new Error},tt.prototype.NotifyBodyContactListenerPostContact=function(t){var e=this.GetFixtureContactListener();if(null!==e){for(var i=0;i<this.m_bodyContactBuffer.count;i++){var o=this.m_bodyContactBuffer.data[i];e.BeginContactFixtureParticle(this,o)}throw new Error}},tt.prototype.UpdateBodyContacts=function(){var t=tt.UpdateBodyContacts_s_aabb,e=new tt.FixtureParticleSet;if(this.NotifyBodyContactListenerPreContact(e),0<this.m_stuckThreshold)for(var i=this.GetParticleCount(),o=0;o<i;o++)this.m_bodyContactCountBuffer.data[o]=0,this.m_timestamp>this.m_lastBodyContactStepBuffer.data[o]+1&&(this.m_consecutiveContactStepsBuffer.data[o]=0);this.m_bodyContactBuffer.SetCount(0),this.m_stuckParticleBuffer.SetCount(0);var n=t;this.ComputeAABB(n);var s=new tt.UpdateBodyContactsCallback(this,this.GetFixtureContactFilter());this.m_world.QueryAABB(s,n),this.m_def.strictContactCheck&&this.RemoveSpuriousBodyContacts(),this.NotifyBodyContactListenerPostContact(e)},tt.prototype.Solve=function(t){var e=tt.Solve_s_subStep;if(0!==this.m_count&&(this.m_expirationTimeBuffer.data&&this.SolveLifetimes(t),2&this.m_allParticleFlags&&this.SolveZombie(),this.m_needsUpdateAllParticleFlags&&this.UpdateAllParticleFlags(),this.m_needsUpdateAllGroupFlags&&this.UpdateAllGroupFlags(),!this.m_paused))for(this.m_iterationIndex=0;this.m_iterationIndex<t.particleIterations;this.m_iterationIndex++){++this.m_timestamp;var i=e.Copy(t);i.dt/=t.particleIterations,i.inv_dt*=t.particleIterations,this.UpdateContacts(!1),this.UpdateBodyContacts(),this.ComputeWeight(),16&this.m_allGroupFlags&&this.ComputeDepth(),4096&this.m_allParticleFlags&&this.UpdatePairsAndTriadsWithReactiveParticles(),this.m_hasForce&&this.SolveForce(i),32&this.m_allParticleFlags&&this.SolveViscous(),8192&this.m_allParticleFlags&&this.SolveRepulsive(i),64&this.m_allParticleFlags&&this.SolvePowder(i),128&this.m_allParticleFlags&&this.SolveTensile(i),1&this.m_allGroupFlags&&this.SolveSolid(i),256&this.m_allParticleFlags&&this.SolveColorMixing(),this.SolveGravity(i),2048&this.m_allParticleFlags&&this.SolveStaticPressure(i),this.SolvePressure(i),this.SolveDamping(i),this.m_allParticleFlags&tt.k_extraDampingFlags&&this.SolveExtraDamping(),16&this.m_allParticleFlags&&this.SolveElastic(i),8&this.m_allParticleFlags&&this.SolveSpring(i),this.LimitVelocity(i),2&this.m_allGroupFlags&&this.SolveRigidDamping(),1024&this.m_allParticleFlags&&this.SolveBarrier(i),this.SolveCollision(i),2&this.m_allGroupFlags&&this.SolveRigid(i),4&this.m_allParticleFlags&&this.SolveWall();for(var o=0;o<this.m_count;o++)this.m_positionBuffer.data[o].SelfMulAdd(i.dt,this.m_velocityBuffer.data[o])}},tt.prototype.SolveCollision=function(t){var e=tt.SolveCollision_s_aabb,i=this.m_positionBuffer.data,o=this.m_velocityBuffer.data,n=e;n.lowerBound.x=+et.b2_maxFloat,n.lowerBound.y=+et.b2_maxFloat,n.upperBound.x=-et.b2_maxFloat,n.upperBound.y=-et.b2_maxFloat;for(var s=0;s<this.m_count;s++){var r=o[s],a=i[s],m=a.x+t.dt*r.x,c=a.y+t.dt*r.y;n.lowerBound.x=it.b2Min(n.lowerBound.x,it.b2Min(a.x,m)),n.lowerBound.y=it.b2Min(n.lowerBound.y,it.b2Min(a.y,c)),n.upperBound.x=it.b2Max(n.upperBound.x,it.b2Max(a.x,m)),n.upperBound.y=it.b2Max(n.upperBound.y,it.b2Max(a.y,c))}var _=new tt.SolveCollisionCallback(this,t);this.m_world.QueryAABB(_,n)},tt.prototype.LimitVelocity=function(t){for(var e=this.m_velocityBuffer.data,i=this.GetCriticalVelocitySquared(t),o=0;o<this.m_count;o++){var n=e[o],s=it.b2Vec2.DotVV(n,n);i<s&&n.SelfMul(it.b2Sqrt(i/s))}},tt.prototype.SolveGravity=function(t){for(var e=tt.SolveGravity_s_gravity,i=this.m_velocityBuffer.data,o=it.b2Vec2.MulSV(t.dt*this.m_def.gravityScale,this.m_world.GetGravity(),e),n=0;n<this.m_count;n++)i[n].SelfAdd(o)},tt.prototype.SolveBarrier=function(t){for(var e=tt.SolveBarrier_s_aabb,i=tt.SolveBarrier_s_va,o=tt.SolveBarrier_s_vb,n=tt.SolveBarrier_s_pba,s=tt.SolveBarrier_s_vba,r=tt.SolveBarrier_s_vc,a=tt.SolveBarrier_s_pca,m=tt.SolveBarrier_s_vca,c=tt.SolveBarrier_s_qba,_=tt.SolveBarrier_s_qca,l=tt.SolveBarrier_s_dv,h=tt.SolveBarrier_s_f,u=this.m_positionBuffer.data,p=this.m_velocityBuffer.data,f=0;f<this.m_count;f++){0!=(this.m_flagsBuffer.data[f]&tt.k_barrierWallFlags)&&p[f].SetZero()}for(var d=et.b2_barrierCollisionTime*t.dt,y=this.GetParticleMass(),b=0;b<this.m_pairBuffer.count;b++){var V=this.m_pairBuffer.data[b];if(1024&V.flags){var v=V.indexA,x=V.indexB,C=u[v],S=u[x],B=e;it.b2Vec2.MinV(C,S,B.lowerBound),it.b2Vec2.MaxV(C,S,B.upperBound);for(var A=this.m_groupBuffer[v],g=this.m_groupBuffer[x],w=this.GetLinearVelocity(A,v,C,i),M=this.GetLinearVelocity(g,x,S,o),P=it.b2Vec2.SubVV(S,C,n),I=it.b2Vec2.SubVV(M,w,s),D=this.GetInsideBoundsEnumerator(B),G=void 0;0<=(G=D.GetNext());){var R=u[G],F=this.m_groupBuffer[G];if(A!==F&&g!==F){var T=this.GetLinearVelocity(F,G,R,r),L=it.b2Vec2.SubVV(R,C,a),k=it.b2Vec2.SubVV(T,w,m),q=it.b2Vec2.CrossVV(I,k),z=it.b2Vec2.CrossVV(P,k)-it.b2Vec2.CrossVV(L,I),J=it.b2Vec2.CrossVV(P,L),j=void 0,N=void 0,E=c,O=_;if(0===q){if(0===z)continue;if(!(0<=(N=-J/z)&&N<d))continue;if(it.b2Vec2.AddVMulSV(P,N,I,E),it.b2Vec2.AddVMulSV(L,N,k,O),!(0<=(j=it.b2Vec2.DotVV(E,O)/it.b2Vec2.DotVV(E,E))&&j<=1))continue}else{var X=z*z-4*J*q;if(X<0)continue;var U=it.b2Sqrt(X),W=(-z-U)/(2*q),Z=(-z+U)/(2*q);if(Z<W){var H=W;W=Z,Z=H}if(N=W,it.b2Vec2.AddVMulSV(P,N,I,E),it.b2Vec2.AddVMulSV(L,N,k,O),j=it.b2Vec2.DotVV(E,O)/it.b2Vec2.DotVV(E,E),!(0<=N&&N<d&&0<=j&&j<=1)){if(!(0<=(N=Z)&&N<d))continue;if(it.b2Vec2.AddVMulSV(P,N,I,E),it.b2Vec2.AddVMulSV(L,N,k,O),!(0<=(j=it.b2Vec2.DotVV(E,O)/it.b2Vec2.DotVV(E,E))&&j<=1))continue}}var Q=l;Q.x=w.x+j*I.x-T.x,Q.y=w.y+j*I.y-T.y;var Y=it.b2Vec2.MulSV(y,Q,h);if(this.IsRigidGroup(F)){var K=F.GetMass(),$=F.GetInertia();0<K&&F.m_linearVelocity.SelfMulAdd(1/K,Y),0<$&&(F.m_angularVelocity+=it.b2Vec2.CrossVV(it.b2Vec2.SubVV(R,F.GetCenter(),it.b2Vec2.s_t0),Y)/$)}else p[G].SelfAdd(Q);this.ParticleApplyForce(G,Y.SelfMul(-t.inv_dt))}}}}},tt.prototype.SolveStaticPressure=function(t){this.m_staticPressureBuffer=this.RequestBuffer(this.m_staticPressureBuffer);for(var e=this.GetCriticalPressure(t),i=this.m_def.staticPressureStrength*e,o=x.b2_maxParticlePressure*e,n=this.m_def.staticPressureRelaxation,s=0;s<this.m_def.staticPressureIterations;s++){for(var r=0;r<this.m_count;r++)this.m_accumulationBuffer[r]=0;for(var a=0;a<this.m_contactBuffer.count;a++){var m=this.m_contactBuffer.data[a];if(2048&m.flags){var c=m.indexA,_=m.indexB,l=m.weight;this.m_accumulationBuffer[c]+=l*this.m_staticPressureBuffer[_],this.m_accumulationBuffer[_]+=l*this.m_staticPressureBuffer[c]}}for(r=0;r<this.m_count;r++){l=this.m_weightBuffer[r];if(2048&this.m_flagsBuffer.data[r]){var h=(this.m_accumulationBuffer[r]+i*(l-x.b2_minParticleWeight))/(l+n);this.m_staticPressureBuffer[r]=it.b2Clamp(h,0,o)}else this.m_staticPressureBuffer[r]=0}}},tt.prototype.ComputeWeight=function(){for(var t=0;t<this.m_count;t++)this.m_weightBuffer[t]=0;for(t=0;t<this.m_bodyContactBuffer.count;t++){var e=(o=this.m_bodyContactBuffer.data[t]).index,i=o.weight;this.m_weightBuffer[e]+=i}for(t=0;t<this.m_contactBuffer.count;t++){e=(o=this.m_contactBuffer.data[t]).indexA;var o,n=o.indexB;i=o.weight;this.m_weightBuffer[e]+=i,this.m_weightBuffer[n]+=i}},tt.prototype.SolvePressure=function(t){for(var e=tt.SolvePressure_s_f,i=this.m_positionBuffer.data,o=this.m_velocityBuffer.data,n=this.GetCriticalPressure(t),s=this.m_def.pressureStrength*n,r=x.b2_maxParticlePressure*n,a=0;a<this.m_count;a++){var m=this.m_weightBuffer[a],c=s*it.b2Max(0,m-x.b2_minParticleWeight);this.m_accumulationBuffer[a]=it.b2Min(c,r)}if(this.m_allParticleFlags&tt.k_noPressureFlags)for(a=0;a<this.m_count;a++)this.m_flagsBuffer.data[a]&tt.k_noPressureFlags&&(this.m_accumulationBuffer[a]=0);if(2048&this.m_allParticleFlags){this.m_staticPressureBuffer;for(a=0;a<this.m_count;a++)2048&this.m_flagsBuffer.data[a]&&(this.m_accumulationBuffer[a]+=this.m_staticPressureBuffer[a])}for(var _=t.dt/(this.m_def.density*this.m_particleDiameter),l=this.GetParticleInvMass(),h=0;h<this.m_bodyContactBuffer.count;h++){var u=(V=this.m_bodyContactBuffer.data[h]).index,p=V.body,f=(m=V.weight,V.mass),d=V.normal,y=i[u],b=(c=this.m_accumulationBuffer[u]+s*m,it.b2Vec2.MulSV(_*m*f*c,d,e));o[u].SelfMulSub(l,b),p.ApplyLinearImpulse(b,y,!0)}for(h=0;h<this.m_contactBuffer.count;h++){var V;u=(V=this.m_contactBuffer.data[h]).indexA,p=V.indexB,m=V.weight,d=V.normal,c=this.m_accumulationBuffer[u]+this.m_accumulationBuffer[p],b=it.b2Vec2.MulSV(_*m*c,d,e);o[u].SelfSub(b),o[p].SelfAdd(b)}},tt.prototype.SolveDamping=function(t){for(var e=tt.SolveDamping_s_v,i=tt.SolveDamping_s_f,o=this.m_positionBuffer.data,n=this.m_velocityBuffer.data,s=this.m_def.dampingStrength,r=1/this.GetCriticalVelocity(t),a=this.GetParticleInvMass(),m=0;m<this.m_bodyContactBuffer.count;m++){var c=(b=this.m_bodyContactBuffer.data[m]).index,_=b.body,l=b.weight,h=b.mass,u=b.normal,p=o[c],f=it.b2Vec2.SubVV(_.GetLinearVelocityFromWorldPoint(p,it.b2Vec2.s_t0),n[c],e);if((V=it.b2Vec2.DotVV(f,u))<0){var d=it.b2Max(s*l,it.b2Min(-r*V,.5)),y=it.b2Vec2.MulSV(d*h*V,u,i);n[c].SelfMulAdd(a,y),_.ApplyLinearImpulse(y.SelfNeg(),p,!0)}}for(m=0;m<this.m_contactBuffer.count;m++){var b,V;c=(b=this.m_contactBuffer.data[m]).indexA,_=b.indexB,l=b.weight,u=b.normal,f=it.b2Vec2.SubVV(n[_],n[c],e);if((V=it.b2Vec2.DotVV(f,u))<0){d=it.b2Max(s*l,it.b2Min(-r*V,.5)),y=it.b2Vec2.MulSV(d*V,u,i);n[c].SelfAdd(y),n[_].SelfSub(y)}}},tt.prototype.SolveRigidDamping=function(){for(var t=tt.SolveRigidDamping_s_t0,e=tt.SolveRigidDamping_s_t1,i=tt.SolveRigidDamping_s_p,o=tt.SolveRigidDamping_s_v,n=[0],s=[0],r=[0],a=[0],m=[0],c=[0],_=this.m_positionBuffer.data,l=this.m_def.dampingStrength,h=0;h<this.m_bodyContactBuffer.count;h++){var u=(x=this.m_bodyContactBuffer.data[h]).index,p=this.m_groupBuffer[u];if(this.IsRigidGroup(p)){var f=x.body,d=x.normal,y=x.weight,b=_[u],V=it.b2Vec2.SubVV(f.GetLinearVelocityFromWorldPoint(b,t),p.GetLinearVelocityFromWorldPoint(b,e),o);if((A=it.b2Vec2.DotVV(V,d))<0){this.InitDampingParameterWithRigidGroupOrParticle(n,s,r,!0,p,u,b,d),this.InitDampingParameter(a,m,c,f.GetMass(),f.GetInertia()-f.GetMass()*f.GetLocalCenter().LengthSquared(),f.GetWorldCenter(),b,d);var v=l*it.b2Min(y,1)*this.ComputeDampingImpulse(n[0],s[0],r[0],a[0],m[0],c[0],A);this.ApplyDamping(n[0],s[0],r[0],!0,p,u,v,d),f.ApplyLinearImpulse(it.b2Vec2.MulSV(-v,d,it.b2Vec2.s_t0),b,!0)}}}for(h=0;h<this.m_contactBuffer.count;h++){u=(x=this.m_contactBuffer.data[h]).indexA,f=x.indexB,d=x.normal,y=x.weight,p=this.m_groupBuffer[u];var x,C=this.m_groupBuffer[f],S=this.IsRigidGroup(p),B=this.IsRigidGroup(C);if(p!==C&&(S||B)){var A;b=it.b2Vec2.MidVV(_[u],_[f],i),V=it.b2Vec2.SubVV(this.GetLinearVelocity(C,f,b,t),this.GetLinearVelocity(p,u,b,e),o);if((A=it.b2Vec2.DotVV(V,d))<0){this.InitDampingParameterWithRigidGroupOrParticle(n,s,r,S,p,u,b,d),this.InitDampingParameterWithRigidGroupOrParticle(a,m,c,B,C,f,b,d);v=l*y*this.ComputeDampingImpulse(n[0],s[0],r[0],a[0],m[0],c[0],A);this.ApplyDamping(n[0],s[0],r[0],S,p,u,v,d),this.ApplyDamping(a[0],m[0],c[0],B,C,f,-v,d)}}}},tt.prototype.SolveExtraDamping=function(){for(var t=tt.SolveExtraDamping_s_v,e=tt.SolveExtraDamping_s_f,i=this.m_velocityBuffer.data,o=this.m_positionBuffer.data,n=this.GetParticleInvMass(),s=0;s<this.m_bodyContactBuffer.count;s++){var r=this.m_bodyContactBuffer.data[s],a=r.index;if(this.m_flagsBuffer.data[a]&tt.k_extraDampingFlags){var m=r.body,c=r.mass,_=r.normal,l=o[a],h=it.b2Vec2.SubVV(m.GetLinearVelocityFromWorldPoint(l,it.b2Vec2.s_t0),i[a],t),u=it.b2Vec2.DotVV(h,_);if(u<0){var p=it.b2Vec2.MulSV(.5*c*u,_,e);i[a].SelfMulAdd(n,p),m.ApplyLinearImpulse(p.SelfNeg(),l,!0)}}}},tt.prototype.SolveWall=function(){for(var t=this.m_velocityBuffer.data,e=0;e<this.m_count;e++)4&this.m_flagsBuffer.data[e]&&t[e].SetZero()},tt.prototype.SolveRigid=function(t){for(var e=tt.SolveRigid_s_position,i=tt.SolveRigid_s_rotation,o=tt.SolveRigid_s_transform,n=tt.SolveRigid_s_velocityTransform,s=this.m_positionBuffer.data,r=this.m_velocityBuffer.data,a=this.m_groupList;a;a=a.GetNext())if(2&a.m_groupFlags){a.UpdateStatistics();var m=i;m.SetAngle(t.dt*a.m_angularVelocity);var c=it.b2Vec2.AddVV(a.m_center,it.b2Vec2.SubVV(it.b2Vec2.MulSV(t.dt,a.m_linearVelocity,it.b2Vec2.s_t0),it.b2Rot.MulRV(m,a.m_center,it.b2Vec2.s_t1),it.b2Vec2.s_t0),e),_=o;_.SetPositionRotation(c,m),it.b2Transform.MulXX(_,a.m_transform,a.m_transform);var l=n;l.p.x=t.inv_dt*_.p.x,l.p.y=t.inv_dt*_.p.y,l.q.s=t.inv_dt*_.q.s,l.q.c=t.inv_dt*(_.q.c-1);for(var h=a.m_firstIndex;h<a.m_lastIndex;h++)it.b2Transform.MulXV(l,s[h],r[h])}},tt.prototype.SolveElastic=function(t){for(var e=tt.SolveElastic_s_pa,i=tt.SolveElastic_s_pb,o=tt.SolveElastic_s_pc,n=tt.SolveElastic_s_r,s=tt.SolveElastic_s_t0,r=this.m_positionBuffer.data,a=this.m_velocityBuffer.data,m=t.inv_dt*this.m_def.elasticStrength,c=0;c<this.m_triadBuffer.count;c++){var _=this.m_triadBuffer.data[c];if(16&_.flags){var l=_.indexA,h=_.indexB,u=_.indexC,p=_.pa,f=_.pb,d=_.pc,y=e.Copy(r[l]),b=i.Copy(r[h]),V=o.Copy(r[u]),v=a[l],x=a[h],C=a[u];y.SelfMulAdd(t.dt,v),b.SelfMulAdd(t.dt,x),V.SelfMulAdd(t.dt,C);var S=(y.x+b.x+V.x)/3,B=(y.y+b.y+V.y)/3;y.x-=S,y.y-=B,b.x-=S,b.y-=B,V.x-=S,V.y-=B;var A=n;A.s=it.b2Vec2.CrossVV(p,y)+it.b2Vec2.CrossVV(f,b)+it.b2Vec2.CrossVV(d,V),A.c=it.b2Vec2.DotVV(p,y)+it.b2Vec2.DotVV(f,b)+it.b2Vec2.DotVV(d,V);var g=A.s*A.s+A.c*A.c,w=it.b2InvSqrt(g);isFinite(w)||(w=198177537e11),A.s*=w,A.c*=w;var M=m*_.strength;it.b2Rot.MulRV(A,p,s),it.b2Vec2.SubVV(s,y,s),it.b2Vec2.MulSV(M,s,s),v.SelfAdd(s),it.b2Rot.MulRV(A,f,s),it.b2Vec2.SubVV(s,b,s),it.b2Vec2.MulSV(M,s,s),x.SelfAdd(s),it.b2Rot.MulRV(A,d,s),it.b2Vec2.SubVV(s,V,s),it.b2Vec2.MulSV(M,s,s),C.SelfAdd(s)}}},tt.prototype.SolveSpring=function(t){for(var e=tt.SolveSpring_s_pa,i=tt.SolveSpring_s_pb,o=tt.SolveSpring_s_d,n=tt.SolveSpring_s_f,s=this.m_positionBuffer.data,r=this.m_velocityBuffer.data,a=t.inv_dt*this.m_def.springStrength,m=0;m<this.m_pairBuffer.count;m++){var c=this.m_pairBuffer.data[m];if(8&c.flags){var _=c.indexA,l=c.indexB,h=e.Copy(s[_]),u=i.Copy(s[l]),p=r[_],f=r[l];h.SelfMulAdd(t.dt,p),u.SelfMulAdd(t.dt,f);var d=it.b2Vec2.SubVV(u,h,o),y=c.distance,b=d.Length(),V=a*c.strength,v=it.b2Vec2.MulSV(V*(y-b)/b,d,n);p.SelfSub(v),f.SelfAdd(v)}}},tt.prototype.SolveTensile=function(t){var e=tt.SolveTensile_s_weightedNormal,i=tt.SolveTensile_s_s,o=tt.SolveTensile_s_f,n=this.m_velocityBuffer.data;this.m_accumulation2Buffer;for(var s=0;s<this.m_count;s++)this.m_accumulation2Buffer[s]=new it.b2Vec2,this.m_accumulation2Buffer[s].SetZero();for(var r=0;r<this.m_contactBuffer.count;r++){if(128&(d=this.m_contactBuffer.data[r]).flags){var a=d.indexA,m=d.indexB,c=d.weight,_=d.normal,l=it.b2Vec2.MulSV((1-c)*c,_,e);this.m_accumulation2Buffer[a].SelfSub(l),this.m_accumulation2Buffer[m].SelfAdd(l)}}var h=this.GetCriticalVelocity(t),u=this.m_def.surfaceTensionPressureStrength*h,p=this.m_def.surfaceTensionNormalStrength*h,f=x.b2_maxParticleForce*h;for(r=0;r<this.m_contactBuffer.count;r++){var d;if(128&(d=this.m_contactBuffer.data[r]).flags){a=d.indexA,m=d.indexB,c=d.weight,_=d.normal;var y=this.m_weightBuffer[a]+this.m_weightBuffer[m],b=it.b2Vec2.SubVV(this.m_accumulation2Buffer[m],this.m_accumulation2Buffer[a],i),V=it.b2Min(u*(y-2)+p*it.b2Vec2.DotVV(b,_),f)*c,v=it.b2Vec2.MulSV(V,_,o);n[a].SelfSub(v),n[m].SelfAdd(v)}}},tt.prototype.SolveViscous=function(){for(var t=tt.SolveViscous_s_v,e=tt.SolveViscous_s_f,i=this.m_positionBuffer.data,o=this.m_velocityBuffer.data,n=this.m_def.viscousStrength,s=this.GetParticleInvMass(),r=0;r<this.m_bodyContactBuffer.count;r++){var a=(p=this.m_bodyContactBuffer.data[r]).index;if(32&this.m_flagsBuffer.data[a]){var m=p.body,c=p.weight,_=p.mass,l=i[a],h=it.b2Vec2.SubVV(m.GetLinearVelocityFromWorldPoint(l,it.b2Vec2.s_t0),o[a],t),u=it.b2Vec2.MulSV(n*_*c,h,e);o[a].SelfMulAdd(s,u),m.ApplyLinearImpulse(u.SelfNeg(),l,!0)}}for(r=0;r<this.m_contactBuffer.count;r++){var p;if(32&(p=this.m_contactBuffer.data[r]).flags){a=p.indexA,m=p.indexB,c=p.weight,h=it.b2Vec2.SubVV(o[m],o[a],t),u=it.b2Vec2.MulSV(n*c,h,e);o[a].SelfAdd(u),o[m].SelfSub(u)}}},tt.prototype.SolveRepulsive=function(t){for(var e=tt.SolveRepulsive_s_f,i=this.m_velocityBuffer.data,o=this.m_def.repulsiveStrength*this.GetCriticalVelocity(t),n=0;n<this.m_contactBuffer.count;n++){var s=this.m_contactBuffer.data[n];if(8192&s.flags){var r=s.indexA,a=s.indexB;if(this.m_groupBuffer[r]!==this.m_groupBuffer[a]){var m=s.weight,c=s.normal,_=it.b2Vec2.MulSV(o*m,c,e);i[r].SelfSub(_),i[a].SelfAdd(_)}}}},tt.prototype.SolvePowder=function(t){for(var e=tt.SolvePowder_s_f,i=this.m_positionBuffer.data,o=this.m_velocityBuffer.data,n=this.m_def.powderStrength*this.GetCriticalVelocity(t),s=1-x.b2_particleStride,r=this.GetParticleInvMass(),a=0;a<this.m_bodyContactBuffer.count;a++){var m=(p=this.m_bodyContactBuffer.data[a]).index;if(64&this.m_flagsBuffer.data[m])if(s<(f=p.weight)){var c=p.body,_=p.mass,l=i[m],h=p.normal,u=it.b2Vec2.MulSV(n*_*(f-s),h,e);o[m].SelfMulSub(r,u),c.ApplyLinearImpulse(u,l,!0)}}for(a=0;a<this.m_contactBuffer.count;a++){var p,f;if(64&(p=this.m_contactBuffer.data[a]).flags)if(s<(f=p.weight)){m=p.indexA,c=p.indexB,h=p.normal,u=it.b2Vec2.MulSV(n*(f-s),h,e);o[m].SelfSub(u),o[c].SelfAdd(u)}}},tt.prototype.SolveSolid=function(t){var e=tt.SolveSolid_s_f,i=this.m_velocityBuffer.data;this.m_depthBuffer=this.RequestBuffer(this.m_depthBuffer);for(var o=t.inv_dt*this.m_def.ejectionStrength,n=0;n<this.m_contactBuffer.count;n++){var s=this.m_contactBuffer.data[n],r=s.indexA,a=s.indexB;if(this.m_groupBuffer[r]!==this.m_groupBuffer[a]){var m=s.weight,c=s.normal,_=this.m_depthBuffer[r]+this.m_depthBuffer[a],l=it.b2Vec2.MulSV(o*_*m,c,e);i[r].SelfSub(l),i[a].SelfAdd(l)}}},tt.prototype.SolveForce=function(t){for(var e=this.m_velocityBuffer.data,i=t.dt*this.GetParticleInvMass(),o=0;o<this.m_count;o++)e[o].SelfMulAdd(i,this.m_forceBuffer[o]);this.m_hasForce=!1},tt.prototype.SolveColorMixing=function(){this.m_colorBuffer.data;var t=.5*this.m_def.colorMixingStrength;if(t)for(var e=0;e<this.m_contactBuffer.count;e++){var i=this.m_contactBuffer.data[e],o=i.indexA,n=i.indexB;if(this.m_flagsBuffer.data[o]&this.m_flagsBuffer.data[n]&256){var s=this.m_colorBuffer.data[o],r=this.m_colorBuffer.data[n];a.b2Color.MixColors(s,r,t)}}},tt.prototype.SolveZombie=function(){for(var t=0,e=[],i=0;i<this.m_count;i++)e[i]=et.b2_invalidParticleIndex;e.length,this.m_count;var o=0;for(i=0;i<this.m_count;i++){var n=this.m_flagsBuffer.data[i];if(2&n){var s=this.m_world.m_destructionListener;if(512&n&&s&&s.SayGoodbyeParticle(this,i),this.m_handleIndexBuffer.data)(r=this.m_handleIndexBuffer.data[i])&&(r.SetIndex(et.b2_invalidParticleIndex),this.m_handleIndexBuffer.data[i]=null);e[i]=et.b2_invalidParticleIndex}else{if(i!==(e[i]=t)){var r;if(this.m_handleIndexBuffer.data)(r=this.m_handleIndexBuffer.data[i])&&r.SetIndex(t),this.m_handleIndexBuffer.data[t]=r;this.m_flagsBuffer.data[t]=this.m_flagsBuffer.data[i],this.m_lastBodyContactStepBuffer.data&&(this.m_lastBodyContactStepBuffer.data[t]=this.m_lastBodyContactStepBuffer.data[i]),this.m_bodyContactCountBuffer.data&&(this.m_bodyContactCountBuffer.data[t]=this.m_bodyContactCountBuffer.data[i]),this.m_consecutiveContactStepsBuffer.data&&(this.m_consecutiveContactStepsBuffer.data[t]=this.m_consecutiveContactStepsBuffer.data[i]),this.m_positionBuffer.data[t].Copy(this.m_positionBuffer.data[i]),this.m_velocityBuffer.data[t].Copy(this.m_velocityBuffer.data[i]),this.m_groupBuffer[t]=this.m_groupBuffer[i],this.m_hasForce&&this.m_forceBuffer[t].Copy(this.m_forceBuffer[i]),this.m_staticPressureBuffer&&(this.m_staticPressureBuffer[t]=this.m_staticPressureBuffer[i]),this.m_depthBuffer&&(this.m_depthBuffer[t]=this.m_depthBuffer[i]),this.m_colorBuffer.data&&this.m_colorBuffer.data[t].Copy(this.m_colorBuffer.data[i]),this.m_userDataBuffer.data&&(this.m_userDataBuffer.data[t]=this.m_userDataBuffer.data[i]),this.m_expirationTimeBuffer.data&&(this.m_expirationTimeBuffer.data[t]=this.m_expirationTimeBuffer.data[i])}t++,o|=n}}for(var a=function(t){return t.index<0},m=function(t){return t.indexA<0||t.indexB<0},c=function(t){return t.index<0},_=function(t){return t.indexA<0||t.indexB<0},l=function(t){return t.indexA<0||t.indexB<0||t.indexC<0},h=0;h<this.m_proxyBuffer.count;h++){var u=this.m_proxyBuffer.data[h];u.index=e[u.index]}this.m_proxyBuffer.RemoveIf(a);for(h=0;h<this.m_contactBuffer.count;h++){(p=this.m_contactBuffer.data[h]).indexA=e[p.indexA],p.indexB=e[p.indexB]}this.m_contactBuffer.RemoveIf(m);for(h=0;h<this.m_bodyContactBuffer.count;h++){var p;(p=this.m_bodyContactBuffer.data[h]).index=e[p.index]}this.m_bodyContactBuffer.RemoveIf(c);for(h=0;h<this.m_pairBuffer.count;h++){var f=this.m_pairBuffer.data[h];f.indexA=e[f.indexA],f.indexB=e[f.indexB]}this.m_pairBuffer.RemoveIf(_);for(h=0;h<this.m_triadBuffer.count;h++){var d=this.m_triadBuffer.data[h];d.indexA=e[d.indexA],d.indexB=e[d.indexB],d.indexC=e[d.indexC]}if(this.m_triadBuffer.RemoveIf(l),this.m_indexByExpirationTimeBuffer.data)for(var y=0,b=0;b<this.m_count;b++){var V=e[this.m_indexByExpirationTimeBuffer.data[b]];V!==et.b2_invalidParticleIndex&&(this.m_indexByExpirationTimeBuffer.data[y++]=V)}for(var v=this.m_groupList;v;v=v.GetNext()){var x=t,C=0,S=!1;for(i=v.m_firstIndex;i<v.m_lastIndex;i++){var B=e[i];0<=B?(x=it.b2Min(x,B),C=it.b2Max(C,B+1)):S=!0}x<C?(v.m_firstIndex=x,v.m_lastIndex=C,S&&1&v.m_groupFlags&&this.SetGroupFlags(v,16|v.m_groupFlags)):(v.m_firstIndex=0,v.m_lastIndex=0,4&v.m_groupFlags||this.SetGroupFlags(v,8|v.m_groupFlags))}this.m_count=t,this.m_allParticleFlags=o,this.m_needsUpdateAllParticleFlags=!1;for(v=this.m_groupList;v;){var A=v.GetNext();8&v.m_groupFlags&&this.DestroyParticleGroup(v),v=A}},tt.prototype.SolveLifetimes=function(t){this.m_expirationTimeBuffer.data,this.m_indexByExpirationTimeBuffer.data,this.m_timeElapsed=this.LifetimeToExpirationTime(t.dt);var e=this.GetQuantizedTimeElapsed(),s=this.m_expirationTimeBuffer.data,i=this.m_indexByExpirationTimeBuffer.data,o=this.GetParticleCount();if(this.m_expirationTimeBufferRequiresSorting){V(i,0,o,function(t,e){var i=s[t],o=s[e],n=i<=0;return n===o<=0?o<i:n}),this.m_expirationTimeBufferRequiresSorting=!1}for(var n=o-1;0<=n;--n){var r=i[n],a=s[r];if(e<a||a<=0)break;this.DestroyParticle(r)}},tt.prototype.RotateBuffer=function(e,i,o){if(e!==i&&i!==o){if(w(this.m_flagsBuffer.data,e,i,o),this.m_lastBodyContactStepBuffer.data&&w(this.m_lastBodyContactStepBuffer.data,e,i,o),this.m_bodyContactCountBuffer.data&&w(this.m_bodyContactCountBuffer.data,e,i,o),this.m_consecutiveContactStepsBuffer.data&&w(this.m_consecutiveContactStepsBuffer.data,e,i,o),w(this.m_positionBuffer.data,e,i,o),w(this.m_velocityBuffer.data,e,i,o),w(this.m_groupBuffer,e,i,o),this.m_hasForce&&w(this.m_forceBuffer,e,i,o),this.m_staticPressureBuffer&&w(this.m_staticPressureBuffer,e,i,o),this.m_depthBuffer&&w(this.m_depthBuffer,e,i,o),this.m_colorBuffer.data&&w(this.m_colorBuffer.data,e,i,o),this.m_userDataBuffer.data&&w(this.m_userDataBuffer.data,e,i,o),this.m_handleIndexBuffer.data){w(this.m_handleIndexBuffer.data,e,i,o);for(var t=e;t<o;++t){var n=this.m_handleIndexBuffer.data[t];n&&n.SetIndex(u(n.GetIndex()))}}if(this.m_expirationTimeBuffer.data){w(this.m_expirationTimeBuffer.data,e,i,o);var s=this.GetParticleCount(),r=this.m_indexByExpirationTimeBuffer.data;for(t=0;t<s;++t)r[t]=u(r[t])}for(var a=0;a<this.m_proxyBuffer.count;a++){var m=this.m_proxyBuffer.data[a];m.index=u(m.index)}for(a=0;a<this.m_contactBuffer.count;a++){(c=this.m_contactBuffer.data[a]).indexA=u(c.indexA),c.indexB=u(c.indexB)}for(a=0;a<this.m_bodyContactBuffer.count;a++){var c;(c=this.m_bodyContactBuffer.data[a]).index=u(c.index)}for(a=0;a<this.m_pairBuffer.count;a++){var _=this.m_pairBuffer.data[a];_.indexA=u(_.indexA),_.indexB=u(_.indexB)}for(a=0;a<this.m_triadBuffer.count;a++){var l=this.m_triadBuffer.data[a];l.indexA=u(l.indexA),l.indexB=u(l.indexB),l.indexC=u(l.indexC)}for(var h=this.m_groupList;h;h=h.GetNext())h.m_firstIndex=u(h.m_firstIndex),h.m_lastIndex=u(h.m_lastIndex-1)+1}function u(t){return t<e?t:t<i?t+o-i:t<o?t+e-i:t}},tt.prototype.GetCriticalVelocity=function(t){return this.m_particleDiameter*t.inv_dt},tt.prototype.GetCriticalVelocitySquared=function(t){var e=this.GetCriticalVelocity(t);return e*e},tt.prototype.GetCriticalPressure=function(t){return this.m_def.density*this.GetCriticalVelocitySquared(t)},tt.prototype.GetParticleStride=function(){return x.b2_particleStride*this.m_particleDiameter},tt.prototype.GetParticleMass=function(){var t=this.GetParticleStride();return this.m_def.density*t*t},tt.prototype.GetParticleInvMass=function(){var t=this.m_inverseDiameter*(1/x.b2_particleStride);return this.m_inverseDensity*t*t},tt.prototype.GetFixtureContactFilter=function(){return 65536&this.m_allParticleFlags?this.m_world.m_contactManager.m_contactFilter:null},tt.prototype.GetParticleContactFilter=function(){return 131072&this.m_allParticleFlags?this.m_world.m_contactManager.m_contactFilter:null},tt.prototype.GetFixtureContactListener=function(){return 16384&this.m_allParticleFlags?this.m_world.m_contactManager.m_contactListener:null},tt.prototype.GetParticleContactListener=function(){return 32768&this.m_allParticleFlags?this.m_world.m_contactManager.m_contactListener:null},tt.prototype.SetUserOverridableBuffer=function(t,e,i){t.data=e,t.userSuppliedCapacity=i},tt.prototype.SetGroupFlags=function(t,e){var i=t.m_groupFlags;1&(i^e)&&(e|=16),i&~e&&(this.m_needsUpdateAllGroupFlags=!0),~this.m_allGroupFlags&e&&(1&e&&(this.m_depthBuffer=this.RequestBuffer(this.m_depthBuffer)),this.m_allGroupFlags|=e),t.m_groupFlags=e},tt.BodyContactCompare=function(t,e){return t.index===e.index?t.weight>e.weight:t.index<e.index},tt.prototype.RemoveSpuriousBodyContacts=function(){V(this.m_bodyContactBuffer.data,0,this.m_bodyContactBuffer.count,tt.BodyContactCompare);var r=tt.RemoveSpuriousBodyContacts_s_n,a=tt.RemoveSpuriousBodyContacts_s_pos,m=tt.RemoveSpuriousBodyContacts_s_normal,c=this,_=-1,l=0;this.m_bodyContactBuffer.count=C(this.m_bodyContactBuffer.data,function(t){if(t.index!==_&&(l=0,_=t.index),3<l++)return!0;var e=r.Copy(t.normal);e.SelfMul(c.m_particleDiameter*(1-t.weight));var i=it.b2Vec2.AddVV(c.m_positionBuffer.data[t.index],e,a);if(!t.fixture.TestPoint(i)){for(var o=t.fixture.GetShape().GetChildCount(),n=0;n<o;n++){var s=m;if(t.fixture.ComputeDistance(i,s,n)<et.b2_linearSlop)return!1}return!0}return!1},this.m_bodyContactBuffer.count)},tt.prototype.DetectStuckParticle=function(t){this.m_stuckThreshold<=0||(++this.m_bodyContactCountBuffer.data[t],2===this.m_bodyContactCountBuffer.data[t]&&(++this.m_consecutiveContactStepsBuffer.data[t],this.m_consecutiveContactStepsBuffer.data[t]>this.m_stuckThreshold&&(this.m_stuckParticleBuffer.data[this.m_stuckParticleBuffer.Append()]=t)),this.m_lastBodyContactStepBuffer.data[t]=this.m_timestamp)},tt.prototype.ValidateParticleIndex=function(t){return 0<=t&&t<this.GetParticleCount()&&t!==et.b2_invalidParticleIndex},tt.prototype.GetQuantizedTimeElapsed=function(){return Math.floor(this.m_timeElapsed/4294967296)},tt.prototype.LifetimeToExpirationTime=function(t){return this.m_timeElapsed+Math.floor(t/this.m_def.lifetimeGranularity*4294967296)},tt.prototype.ForceCanBeApplied=function(t){return!(4&t)},tt.prototype.PrepareForceBuffer=function(){if(!this.m_hasForce){for(var t=0;t<this.m_count;t++)this.m_forceBuffer[t].SetZero();this.m_hasForce=!0}},tt.prototype.IsRigidGroup=function(t){return null!==t&&0!=(2&t.m_groupFlags)},tt.prototype.GetLinearVelocity=function(t,e,i,o){return this.IsRigidGroup(t)?t.GetLinearVelocityFromWorldPoint(i,o):o.Copy(this.m_velocityBuffer.data[e])},tt.prototype.InitDampingParameter=function(t,e,i,o,n,s,r,a){t[0]=0<o?1/o:0,e[0]=0<n?1/n:0,i[0]=it.b2Vec2.CrossVV(it.b2Vec2.SubVV(r,s,it.b2Vec2.s_t0),a)},tt.prototype.InitDampingParameterWithRigidGroupOrParticle=function(t,e,i,o,n,s,r,a){if(o)this.InitDampingParameter(t,e,i,n.GetMass(),n.GetInertia(),n.GetCenter(),r,a);else{var m=this.m_flagsBuffer.data[s];this.InitDampingParameter(t,e,i,4&m?0:this.GetParticleMass(),0,r,r,a)}},tt.prototype.ComputeDampingImpulse=function(t,e,i,o,n,s,r){var a=t+e*i*i+o+n*s*s;return 0<a?r/a:0},tt.prototype.ApplyDamping=function(t,e,i,o,n,s,r,a){o?(n.m_linearVelocity.SelfMulAdd(r*t,a),n.m_angularVelocity+=r*i*e):this.m_velocityBuffer.data[s].SelfMulAdd(r*t,a)},tt.xTruncBits=12,tt.yTruncBits=12,tt.tagBits=32,tt.yOffset=1<<tt.yTruncBits-1,tt.yShift=tt.tagBits-tt.yTruncBits,tt.xOffset=(tt.xScale=1<<(tt.xShift=tt.tagBits-tt.yTruncBits-tt.xTruncBits))*(1<<tt.xTruncBits-1),tt.xMask=~(tt.yMask=(1<<tt.yTruncBits)-1<<tt.yShift),tt.DestroyParticlesInShape_s_aabb=new d.b2AABB,tt.CreateParticleGroup_s_transform=new it.b2Transform,tt.ComputeCollisionEnergy_s_v=new it.b2Vec2,tt.QueryShapeAABB_s_aabb=new d.b2AABB,tt.QueryPointAABB_s_aabb=new d.b2AABB,tt.RayCast_s_aabb=new d.b2AABB,tt.RayCast_s_p=new it.b2Vec2,tt.RayCast_s_v=new it.b2Vec2,tt.RayCast_s_n=new it.b2Vec2,tt.RayCast_s_point=new it.b2Vec2,tt.k_pairFlags=8,tt.k_triadFlags=16,tt.k_noPressureFlags=192,tt.k_extraDampingFlags=2048,tt.k_barrierWallFlags=1028,tt.CreateParticlesStrokeShapeForGroup_s_edge=new i.b2EdgeShape,tt.CreateParticlesStrokeShapeForGroup_s_d=new it.b2Vec2,tt.CreateParticlesStrokeShapeForGroup_s_p=new it.b2Vec2,tt.CreateParticlesFillShapeForGroup_s_aabb=new d.b2AABB,tt.CreateParticlesFillShapeForGroup_s_p=new it.b2Vec2,tt.UpdatePairsAndTriads_s_dab=new it.b2Vec2,tt.UpdatePairsAndTriads_s_dbc=new it.b2Vec2,tt.UpdatePairsAndTriads_s_dca=new it.b2Vec2,tt.AddContact_s_d=new it.b2Vec2,tt.UpdateBodyContacts_s_aabb=new d.b2AABB,tt.Solve_s_subStep=new o.b2TimeStep,tt.SolveCollision_s_aabb=new d.b2AABB,tt.SolveGravity_s_gravity=new it.b2Vec2,tt.SolveBarrier_s_aabb=new d.b2AABB,tt.SolveBarrier_s_va=new it.b2Vec2,tt.SolveBarrier_s_vb=new it.b2Vec2,tt.SolveBarrier_s_pba=new it.b2Vec2,tt.SolveBarrier_s_vba=new it.b2Vec2,tt.SolveBarrier_s_vc=new it.b2Vec2,tt.SolveBarrier_s_pca=new it.b2Vec2,tt.SolveBarrier_s_vca=new it.b2Vec2,tt.SolveBarrier_s_qba=new it.b2Vec2,tt.SolveBarrier_s_qca=new it.b2Vec2,tt.SolveBarrier_s_dv=new it.b2Vec2,tt.SolveBarrier_s_f=new it.b2Vec2,tt.SolvePressure_s_f=new it.b2Vec2,tt.SolveDamping_s_v=new it.b2Vec2,tt.SolveDamping_s_f=new it.b2Vec2,tt.SolveRigidDamping_s_t0=new it.b2Vec2,tt.SolveRigidDamping_s_t1=new it.b2Vec2,tt.SolveRigidDamping_s_p=new it.b2Vec2,tt.SolveRigidDamping_s_v=new it.b2Vec2,tt.SolveExtraDamping_s_v=new it.b2Vec2,tt.SolveExtraDamping_s_f=new it.b2Vec2,tt.SolveRigid_s_position=new it.b2Vec2,tt.SolveRigid_s_rotation=new it.b2Rot,tt.SolveRigid_s_transform=new it.b2Transform,tt.SolveRigid_s_velocityTransform=new it.b2Transform,tt.SolveElastic_s_pa=new it.b2Vec2,tt.SolveElastic_s_pb=new it.b2Vec2,tt.SolveElastic_s_pc=new it.b2Vec2,tt.SolveElastic_s_r=new it.b2Rot,tt.SolveElastic_s_t0=new it.b2Vec2,tt.SolveSpring_s_pa=new it.b2Vec2,tt.SolveSpring_s_pb=new it.b2Vec2,tt.SolveSpring_s_d=new it.b2Vec2,tt.SolveSpring_s_f=new it.b2Vec2,tt.SolveTensile_s_weightedNormal=new it.b2Vec2,tt.SolveTensile_s_s=new it.b2Vec2,tt.SolveTensile_s_f=new it.b2Vec2,tt.SolveViscous_s_v=new it.b2Vec2,tt.SolveViscous_s_f=new it.b2Vec2,tt.SolveRepulsive_s_f=new it.b2Vec2,tt.SolvePowder_s_f=new it.b2Vec2,tt.SolveSolid_s_f=new it.b2Vec2,tt.RemoveSpuriousBodyContacts_s_n=new it.b2Vec2,tt.RemoveSpuriousBodyContacts_s_pos=new it.b2Vec2,tt.RemoveSpuriousBodyContacts_s_normal=new it.b2Vec2,tt}(),t("b2ParticleSystem",u),function(V){var t=function(){this.data=null,this.userSuppliedCapacity=0};V.UserOverridableBuffer=t;var e=function(){function t(){this.index=et.b2_invalidParticleIndex,this.tag=0}return t.CompareProxyProxy=function(t,e){return t.tag<e.tag},t.CompareTagProxy=function(t,e){return t<e.tag},t.CompareProxyTag=function(t,e){return t.tag<e},t}();V.Proxy=e;var i=function(){function t(t,e,i,o,n){this.m_system=t,this.m_xLower=(e&V.xMask)>>>0,this.m_xUpper=(i&V.xMask)>>>0,this.m_yLower=(e&V.yMask)>>>0,this.m_yUpper=(i&V.yMask)>>>0,this.m_first=o,this.m_last=n,this.m_first,this.m_last}return t.prototype.GetNext=function(){for(;this.m_first<this.m_last;){var t=(this.m_system.m_proxyBuffer.data[this.m_first].tag&V.xMask)>>>0;if(t>=this.m_xLower&&t<=this.m_xUpper)return this.m_system.m_proxyBuffer.data[this.m_first++].index;this.m_first++}return et.b2_invalidParticleIndex},t}();V.InsideBoundsEnumerator=i;var o=function(){this.list=null,this.next=null,this.count=0,this.index=0};V.ParticleListNode=o;var n=function(){function t(){}return t.prototype.Allocate=function(t,e){return e},t.prototype.Clear=function(){},t.prototype.GetCount=function(){return 0},t.prototype.Invalidate=function(t){},t.prototype.GetValidBuffer=function(){return[]},t.prototype.GetBuffer=function(){return[]},t.prototype.SetCount=function(t){},t}();V.FixedSetAllocator=n;var s=function(t,e){this.first=null,this.second=et.b2_invalidParticleIndex,this.first=t,this.second=e};V.FixtureParticle=s;var r=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e.prototype.Initialize=function(t,e){},e.prototype.Find=function(t){return et.b2_invalidParticleIndex},e}(V.FixedSetAllocator);V.FixtureParticleSet=r;var a=function(t,e){this.first=et.b2_invalidParticleIndex,this.second=et.b2_invalidParticleIndex,this.first=t,this.second=e};V.ParticlePair=a;var m=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e.prototype.Initialize=function(t,e){},e.prototype.Find=function(t){return et.b2_invalidParticleIndex},e}(V.FixedSetAllocator);V.b2ParticlePairSet=m;var c=function(){function t(){}return t.prototype.IsNecessary=function(t){return!0},t.prototype.ShouldCreatePair=function(t,e){return!0},t.prototype.ShouldCreateTriad=function(t,e,i){return!0},t}();V.ConnectionFilter=c;var _=function(s){function t(t,e,i,o){var n=s.call(this)||this;return n.m_system=null,n.m_shape=null,n.m_xf=null,n.m_callDestructionListener=!1,n.m_destroyed=0,n.m_system=t,n.m_shape=e,n.m_xf=i,n.m_callDestructionListener=o,n.m_destroyed=0,n}return __extends(t,s),t.prototype.ReportFixture=function(t){return!1},t.prototype.ReportParticle=function(t,e){return t===this.m_system&&(0<=e&&this.m_system.m_count,this.m_shape.TestPoint(this.m_xf,this.m_system.m_positionBuffer.data[e])&&(this.m_system.DestroyParticle(e,this.m_callDestructionListener),this.m_destroyed++),!0)},t.prototype.Destroyed=function(){return this.m_destroyed},t}(b.b2QueryCallback);V.DestroyParticlesInShapeCallback=_;var l=function(i){function t(t){var e=i.call(this)||this;return e.m_threshold=0,e.m_threshold=t,e}return __extends(t,i),t.prototype.ShouldCreatePair=function(t,e){return t<this.m_threshold&&this.m_threshold<=e||e<this.m_threshold&&this.m_threshold<=t},t.prototype.ShouldCreateTriad=function(t,e,i){return(t<this.m_threshold||e<this.m_threshold||i<this.m_threshold)&&(this.m_threshold<=t||this.m_threshold<=e||this.m_threshold<=i)},t}(V.ConnectionFilter);V.JoinParticleGroupsFilter=l;var h=function(o){function t(t,e){var i=o.call(this,-1,0)||this;return i.m_shapes=null,i.m_shapeCount=0,i.m_shapes=t,i.m_shapeCount=e,i}return __extends(t,o),t.prototype.Clone=function(){return null},t.prototype.GetChildCount=function(){return 1},t.prototype.TestPoint=function(t,e){for(var i=0;i<this.m_shapeCount;i++)if(this.m_shapes[i].TestPoint(t,e))return!0;return!1},t.prototype.ComputeDistance=function(t,e,i,o){return 0},t.prototype.RayCast=function(t,e,i,o){return!1},t.prototype.ComputeAABB=function(t,e,i){var o=new d.b2AABB;t.lowerBound.x=+et.b2_maxFloat,t.lowerBound.y=+et.b2_maxFloat,t.upperBound.x=-et.b2_maxFloat,t.upperBound.y=-et.b2_maxFloat;for(var n=0;n<this.m_shapeCount;n++)for(var s=this.m_shapes[n].GetChildCount(),r=0;r<s;r++){var a=o;this.m_shapes[n].ComputeAABB(a,e,r),t.Combine1(a)}},t.prototype.ComputeMass=function(t,e){},t.prototype.SetupDistanceProxy=function(t,e){},t.prototype.ComputeSubmergedArea=function(t,e,i,o){return 0},t.prototype.Dump=function(t){},t}(y.b2Shape);V.CompositeShape=h;var u=function(i){function t(t){var e=i.call(this)||this;return e.m_flagsBuffer=null,e.m_flagsBuffer=t,e}return __extends(t,i),t.prototype.IsNecessary=function(t){return 0!=(4096&this.m_flagsBuffer.data[t])},t}(V.ConnectionFilter);V.ReactiveFilter=u;var p=function(o){function t(t,e){var i=o.call(this,t)||this;return i.m_contactFilter=e,i}return __extends(t,o),t.prototype.ShouldCollideFixtureParticle=function(t,e,i){if(this.m_contactFilter&&65536&this.m_system.GetFlagsBuffer()[i])return this.m_contactFilter.ShouldCollideFixtureParticle(t,this.m_system,i);return!0},t.prototype.ReportFixtureAndParticle=function(t,e,i){var o=V.UpdateBodyContactsCallback.ReportFixtureAndParticle_s_n,n=V.UpdateBodyContactsCallback.ReportFixtureAndParticle_s_rp,s=this.m_system.m_positionBuffer.data[i],r=o,a=t.ComputeDistance(s,r,e);if(a<this.m_system.m_particleDiameter&&this.ShouldCollideFixtureParticle(t,this.m_system,i)){var m=t.GetBody(),c=m.GetWorldCenter(),_=m.GetMass(),l=m.GetInertia()-_*m.GetLocalCenter().LengthSquared(),h=0<_?1/_:0,u=0<l?1/l:0,p=4&this.m_system.m_flagsBuffer.data[i]?0:this.m_system.GetParticleInvMass(),f=it.b2Vec2.SubVV(s,c,n),d=it.b2Vec2.CrossVV(f,r),y=p+h+u*d*d,b=this.m_system.m_bodyContactBuffer.data[this.m_system.m_bodyContactBuffer.Append()];b.index=i,b.body=m,b.fixture=t,b.weight=1-a*this.m_system.m_inverseDiameter,b.normal.Copy(r.SelfNeg()),b.mass=0<y?1/y:0,this.m_system.DetectStuckParticle(i)}},t.ReportFixtureAndParticle_s_n=new it.b2Vec2,t.ReportFixtureAndParticle_s_rp=new it.b2Vec2,t}(v);V.UpdateBodyContactsCallback=p;var f=function(o){function t(t,e){var i=o.call(this,t)||this;return i.m_step=e,i}return __extends(t,o),t.prototype.ReportFixtureAndParticle=function(t,e,i){var o=V.SolveCollisionCallback.ReportFixtureAndParticle_s_p1,n=V.SolveCollisionCallback.ReportFixtureAndParticle_s_output,s=V.SolveCollisionCallback.ReportFixtureAndParticle_s_input,r=V.SolveCollisionCallback.ReportFixtureAndParticle_s_p,a=V.SolveCollisionCallback.ReportFixtureAndParticle_s_v,m=V.SolveCollisionCallback.ReportFixtureAndParticle_s_f,c=t.GetBody(),_=this.m_system.m_positionBuffer.data[i],l=this.m_system.m_velocityBuffer.data[i],h=n,u=s;if(0===this.m_system.m_iterationIndex){var p=it.b2Transform.MulTXV(c.m_xf0,_,o);0===t.GetShape().GetType()&&(p.SelfSub(c.GetLocalCenter()),it.b2Rot.MulRV(c.m_xf0.q,p,p),it.b2Rot.MulTRV(c.m_xf.q,p,p),p.SelfAdd(c.GetLocalCenter())),it.b2Transform.MulXV(c.m_xf,p,u.p1)}else u.p1.Copy(_);if(it.b2Vec2.AddVMulSV(_,this.m_step.dt,l,u.p2),u.maxFraction=1,t.RayCast(h,u,e)){var f=h.normal,d=r;d.x=(1-h.fraction)*u.p1.x+h.fraction*u.p2.x+et.b2_linearSlop*f.x,d.y=(1-h.fraction)*u.p1.y+h.fraction*u.p2.y+et.b2_linearSlop*f.y;var y=a;y.x=this.m_step.inv_dt*(d.x-_.x),y.y=this.m_step.inv_dt*(d.y-_.y),this.m_system.m_velocityBuffer.data[i].Copy(y);var b=m;b.x=this.m_step.inv_dt*this.m_system.GetParticleMass()*(l.x-y.x),b.y=this.m_step.inv_dt*this.m_system.GetParticleMass()*(l.y-y.y),this.m_system.ParticleApplyForce(i,b)}},t.prototype.ReportParticle=function(t,e){return!1},t.ReportFixtureAndParticle_s_p1=new it.b2Vec2,t.ReportFixtureAndParticle_s_output=new d.b2RayCastOutput,t.ReportFixtureAndParticle_s_input=new d.b2RayCastInput,t.ReportFixtureAndParticle_s_p=new it.b2Vec2,t.ReportFixtureAndParticle_s_v=new it.b2Vec2,t.ReportFixtureAndParticle_s_f=new it.b2Vec2,t}(v);V.SolveCollisionCallback=f}(u||(u={})),t("b2ParticleSystem",u)}}}),System.register("Particle/b2ParticleGroup",["Common/b2Math","Common/b2Draw"],function(e,t){var s,i,o,n;t&&t.id;return{setters:[function(t){s=t},function(t){i=t}],execute:function(){var t;(t=o||(o={}))[t.b2_solidParticleGroup=1]="b2_solidParticleGroup",t[t.b2_rigidParticleGroup=2]="b2_rigidParticleGroup",t[t.b2_particleGroupCanBeEmpty=4]="b2_particleGroupCanBeEmpty",t[t.b2_particleGroupWillBeDestroyed=8]="b2_particleGroupWillBeDestroyed",t[t.b2_particleGroupNeedsUpdateDepth=16]="b2_particleGroupNeedsUpdateDepth",t[t.b2_particleGroupInternalMask=24]="b2_particleGroupInternalMask",e("b2ParticleGroupFlag",o),e("b2ParticleGroupDef",function(){this.flags=0,this.groupFlags=0,this.position=new s.b2Vec2,this.angle=0,this.linearVelocity=new s.b2Vec2,this.angularVelocity=0,this.color=new i.b2Color,this.strength=1,this.shape=null,this.shapes=null,this.shapeCount=0,this.stride=0,this.particleCount=0,this.positionData=null,this.lifetime=0,this.userData=null,this.group=null}),n=function(){function o(){this.m_system=null,this.m_firstIndex=0,this.m_lastIndex=0,this.m_groupFlags=0,this.m_strength=1,this.m_prev=null,this.m_next=null,this.m_timestamp=-1,this.m_mass=0,this.m_inertia=0,this.m_center=new s.b2Vec2,this.m_linearVelocity=new s.b2Vec2,this.m_angularVelocity=0,this.m_transform=new s.b2Transform,this.m_userData=null}return o.prototype.GetNext=function(){return this.m_next},o.prototype.GetParticleSystem=function(){return this.m_system},o.prototype.GetParticleCount=function(){return this.m_lastIndex-this.m_firstIndex},o.prototype.GetBufferIndex=function(){return this.m_firstIndex},o.prototype.ContainsParticle=function(t){return this.m_firstIndex<=t&&t<this.m_lastIndex},o.prototype.GetAllParticleFlags=function(){for(var t=0,e=this.m_firstIndex;e<this.m_lastIndex;e++)t|=this.m_system.m_flagsBuffer.data[e];return t},o.prototype.GetGroupFlags=function(){return this.m_groupFlags},o.prototype.SetGroupFlags=function(t){t|=24&this.m_groupFlags,this.m_system.SetGroupFlags(this,t)},o.prototype.GetMass=function(){return this.UpdateStatistics(),this.m_mass},o.prototype.GetInertia=function(){return this.UpdateStatistics(),this.m_inertia},o.prototype.GetCenter=function(){return this.UpdateStatistics(),this.m_center},o.prototype.GetLinearVelocity=function(){return this.UpdateStatistics(),this.m_linearVelocity},o.prototype.GetAngularVelocity=function(){return this.UpdateStatistics(),this.m_angularVelocity},o.prototype.GetTransform=function(){return this.m_transform},o.prototype.GetPosition=function(){return this.m_transform.p},o.prototype.GetAngle=function(){return this.m_transform.q.GetAngle()},o.prototype.GetLinearVelocityFromWorldPoint=function(t,e){var i=o.GetLinearVelocityFromWorldPoint_s_t0;return this.UpdateStatistics(),s.b2Vec2.AddVCrossSV(this.m_linearVelocity,this.m_angularVelocity,s.b2Vec2.SubVV(t,this.m_center,i),e)},o.prototype.GetUserData=function(){return this.m_userData},o.prototype.SetUserData=function(t){this.m_userData=t},o.prototype.ApplyForce=function(t){this.m_system.ApplyForce(this.m_firstIndex,this.m_lastIndex,t)},o.prototype.ApplyLinearImpulse=function(t){this.m_system.ApplyLinearImpulse(this.m_firstIndex,this.m_lastIndex,t)},o.prototype.DestroyParticles=function(t){if(!this.m_system.m_world.IsLocked())for(var e=this.m_firstIndex;e<this.m_lastIndex;e++)this.m_system.DestroyParticle(e,t)},o.prototype.UpdateStatistics=function(){var t=new s.b2Vec2,e=new s.b2Vec2;if(this.m_timestamp!==this.m_system.m_timestamp){var i=this.m_system.GetParticleMass();this.m_mass=i*(this.m_lastIndex-this.m_firstIndex),this.m_center.SetZero(),this.m_linearVelocity.SetZero();for(var o=this.m_firstIndex;o<this.m_lastIndex;o++)this.m_center.SelfMulAdd(i,this.m_system.m_positionBuffer.data[o]),this.m_linearVelocity.SelfMulAdd(i,this.m_system.m_velocityBuffer.data[o]);if(0<this.m_mass){var n=1/this.m_mass;this.m_center.SelfMul(n),this.m_linearVelocity.SelfMul(n)}this.m_inertia=0,this.m_angularVelocity=0;for(o=this.m_firstIndex;o<this.m_lastIndex;o++)s.b2Vec2.SubVV(this.m_system.m_positionBuffer.data[o],this.m_center,t),s.b2Vec2.SubVV(this.m_system.m_velocityBuffer.data[o],this.m_linearVelocity,e),this.m_inertia+=i*s.b2Vec2.DotVV(t,t),this.m_angularVelocity+=i*s.b2Vec2.CrossVV(t,e);0<this.m_inertia&&(this.m_angularVelocity*=1/this.m_inertia),this.m_timestamp=this.m_system.m_timestamp}},o.GetLinearVelocityFromWorldPoint_s_t0=new s.b2Vec2,o}(),e("b2ParticleGroup",n)}}}),System.register("Dynamics/b2WorldCallbacks",["Common/b2Settings"],function(t,e){var i,o,n,s,r,a;e&&e.id;return{setters:[function(t){i=t}],execute:function(){o=function(){function t(){}return t.prototype.SayGoodbyeJoint=function(t){},t.prototype.SayGoodbyeFixture=function(t){},t.prototype.SayGoodbyeParticleGroup=function(t){},t.prototype.SayGoodbyeParticle=function(t,e){},t}(),t("b2DestructionListener",o),n=function(){function t(){}return t.prototype.ShouldCollide=function(t,e){var i=t.GetBody(),o=e.GetBody();if(0===o.GetType()&&0===i.GetType())return!1;if(!o.ShouldCollideConnected(i))return!1;var n=t.GetFilterData(),s=e.GetFilterData();return n.groupIndex===s.groupIndex&&0!==n.groupIndex?0<n.groupIndex:0!=(n.maskBits&s.categoryBits)&&0!=(n.categoryBits&s.maskBits)},t.prototype.ShouldCollideFixtureParticle=function(t,e,i){return!0},t.prototype.ShouldCollideParticleParticle=function(t,e,i){return!0},t.b2_defaultFilter=new t,t}(),t("b2ContactFilter",n),t("b2ContactImpulse",function(){this.normalImpulses=i.b2MakeNumberArray(i.b2_maxManifoldPoints),this.tangentImpulses=i.b2MakeNumberArray(i.b2_maxManifoldPoints),this.count=0}),s=function(){function t(){}return t.prototype.BeginContact=function(t){},t.prototype.EndContact=function(t){},t.prototype.BeginContactFixtureParticle=function(t,e){},t.prototype.EndContactFixtureParticle=function(t,e){},t.prototype.BeginContactParticleParticle=function(t,e){},t.prototype.EndContactParticleParticle=function(t,e){},t.prototype.PreSolve=function(t,e){},t.prototype.PostSolve=function(t,e){},t.b2_defaultListener=new t,t}(),t("b2ContactListener",s),r=function(){function t(){}return t.prototype.ReportFixture=function(t){return!0},t.prototype.ReportParticle=function(t,e){return!1},t.prototype.ShouldQueryParticleSystem=function(t){return!0},t}(),t("b2QueryCallback",r),a=function(){function t(){}return t.prototype.ReportFixture=function(t,e,i,o){return o},t.prototype.ReportParticle=function(t,e,i,o,n){return 0},t.prototype.ShouldQueryParticleSystem=function(t){return!0},t}(),t("b2RayCastCallback",a)}}}),System.register("Dynamics/b2Island",["Common/b2Settings","Common/b2Math","Common/b2Timer","Dynamics/Contacts/b2ContactSolver","Dynamics/b2TimeStep","Dynamics/b2WorldCallbacks"],function(t,e){var M,P,I,D,G,i,o,r,n,s;e&&e.id;return{setters:[function(t){D=I=P=M=t},function(t){G=t},function(t){i=t},function(t){o=t},function(t){r=t},function(t){n=t}],execute:function(){s=function(){function w(){this.m_allocator=null,this.m_listener=null,this.m_bodies=[],this.m_contacts=[],this.m_joints=[],this.m_positions=r.b2Position.MakeArray(1024),this.m_velocities=r.b2Velocity.MakeArray(1024),this.m_bodyCount=0,this.m_jointCount=0,this.m_contactCount=0,this.m_bodyCapacity=0,this.m_contactCapacity=0,this.m_jointCapacity=0}return w.prototype.Initialize=function(t,e,i,o,n){for(this.m_bodyCapacity=t,this.m_contactCapacity=e,this.m_jointCapacity=i,this.m_bodyCount=0,this.m_contactCount=0,this.m_jointCount=0,this.m_allocator=o,this.m_listener=n;this.m_bodies.length<t;)this.m_bodies[this.m_bodies.length]=null;for(;this.m_contacts.length<e;)this.m_contacts[this.m_contacts.length]=null;for(;this.m_joints.length<i;)this.m_joints[this.m_joints.length]=null;if(this.m_positions.length<t)for(var s=G.b2Max(2*this.m_positions.length,t);this.m_positions.length<s;)this.m_positions[this.m_positions.length]=new r.b2Position;if(this.m_velocities.length<t)for(s=G.b2Max(2*this.m_velocities.length,t);this.m_velocities.length<s;)this.m_velocities[this.m_velocities.length]=new r.b2Velocity},w.prototype.Clear=function(){this.m_bodyCount=0,this.m_contactCount=0,this.m_jointCount=0},w.prototype.AddBody=function(t){t.m_islandIndex=this.m_bodyCount,this.m_bodies[this.m_bodyCount++]=t},w.prototype.AddContact=function(t){this.m_contacts[this.m_contactCount++]=t},w.prototype.AddJoint=function(t){this.m_joints[this.m_jointCount++]=t},w.prototype.Solve=function(t,e,i,o){for(var n=w.s_timer.Reset(),s=e.dt,r=0;r<this.m_bodyCount;++r){var a=this.m_bodies[r];this.m_positions[r].c.Copy(a.m_sweep.c);var m=a.m_sweep.a,c=this.m_velocities[r].v.Copy(a.m_linearVelocity),_=a.m_angularVelocity;a.m_sweep.c0.Copy(a.m_sweep.c),a.m_sweep.a0=a.m_sweep.a,2===a.m_type&&(c.x+=s*(a.m_gravityScale*i.x+a.m_invMass*a.m_force.x),c.y+=s*(a.m_gravityScale*i.y+a.m_invMass*a.m_force.y),_+=s*a.m_invI*a.m_torque,c.SelfMul(1/(1+s*a.m_linearDamping)),_*=1/(1+s*a.m_angularDamping)),this.m_positions[r].a=m,this.m_velocities[r].w=_}n.Reset();var l=w.s_solverData;l.step.Copy(e),l.positions=this.m_positions,l.velocities=this.m_velocities;var h=w.s_contactSolverDef;h.step.Copy(e),h.contacts=this.m_contacts,h.count=this.m_contactCount,h.positions=this.m_positions,h.velocities=this.m_velocities,h.allocator=this.m_allocator;var u=w.s_contactSolver.Initialize(h);u.InitializeVelocityConstraints(),e.warmStarting&&u.WarmStart();for(r=0;r<this.m_jointCount;++r)this.m_joints[r].InitVelocityConstraints(l);t.solveInit=n.GetMilliseconds(),n.Reset();for(r=0;r<e.velocityIterations;++r){for(var p=0;p<this.m_jointCount;++p)this.m_joints[p].SolveVelocityConstraints(l);u.SolveVelocityConstraints()}u.StoreImpulses(),t.solveVelocity=n.GetMilliseconds();for(r=0;r<this.m_bodyCount;++r){var f=this.m_positions[r].c,d=(m=this.m_positions[r].a,c=this.m_velocities[r].v,_=this.m_velocities[r].w,G.b2Vec2.MulSV(s,c,w.s_translation));if(G.b2Vec2.DotVV(d,d)>P.b2_maxTranslationSquared){var y=P.b2_maxTranslation/d.Length();c.SelfMul(y)}var b=s*_;if(b*b>I.b2_maxRotationSquared)_*=y=I.b2_maxRotation/G.b2Abs(b);f.x+=s*c.x,f.y+=s*c.y,m+=s*_,this.m_positions[r].a=m,this.m_velocities[r].w=_}n.Reset();var V=!1;for(r=0;r<e.positionIterations;++r){var v=u.SolvePositionConstraints(),x=!0;for(p=0;p<this.m_jointCount;++p){var C=this.m_joints[p].SolvePositionConstraints(l);x=x&&C}if(v&&x){V=!0;break}}for(r=0;r<this.m_bodyCount;++r){var S=this.m_bodies[r];S.m_sweep.c.Copy(this.m_positions[r].c),S.m_sweep.a=this.m_positions[r].a,S.m_linearVelocity.Copy(this.m_velocities[r].v),S.m_angularVelocity=this.m_velocities[r].w,S.SynchronizeTransform()}if(t.solvePosition=n.GetMilliseconds(),this.Report(u.m_velocityConstraints),o){var B=M.b2_maxFloat,A=D.b2_linearSleepTolerance*D.b2_linearSleepTolerance,g=D.b2_angularSleepTolerance*D.b2_angularSleepTolerance;for(r=0;r<this.m_bodyCount;++r){0!==(a=this.m_bodies[r]).GetType()&&(!a.m_autoSleepFlag||a.m_angularVelocity*a.m_angularVelocity>g||G.b2Vec2.DotVV(a.m_linearVelocity,a.m_linearVelocity)>A?B=a.m_sleepTime=0:(a.m_sleepTime+=s,B=G.b2Min(B,a.m_sleepTime)))}if(B>=M.b2_timeToSleep&&V)for(r=0;r<this.m_bodyCount;++r){(a=this.m_bodies[r]).SetAwake(!1)}}},w.prototype.SolveTOI=function(t,e,i){for(var o=0;o<this.m_bodyCount;++o){var n=this.m_bodies[o];this.m_positions[o].c.Copy(n.m_sweep.c),this.m_positions[o].a=n.m_sweep.a,this.m_velocities[o].v.Copy(n.m_linearVelocity),this.m_velocities[o].w=n.m_angularVelocity}var s=w.s_contactSolverDef;s.contacts=this.m_contacts,s.count=this.m_contactCount,s.allocator=this.m_allocator,s.step.Copy(t),s.positions=this.m_positions,s.velocities=this.m_velocities;var r=w.s_contactSolver.Initialize(s);for(o=0;o<t.positionIterations;++o){if(r.SolveTOIPositionConstraints(e,i))break}this.m_bodies[e].m_sweep.c0.Copy(this.m_positions[e].c),this.m_bodies[e].m_sweep.a0=this.m_positions[e].a,this.m_bodies[i].m_sweep.c0.Copy(this.m_positions[i].c),this.m_bodies[i].m_sweep.a0=this.m_positions[i].a,r.InitializeVelocityConstraints();for(o=0;o<t.velocityIterations;++o)r.SolveVelocityConstraints();var a=t.dt;for(o=0;o<this.m_bodyCount;++o){var m=this.m_positions[o].c,c=this.m_positions[o].a,_=this.m_velocities[o].v,l=this.m_velocities[o].w,h=G.b2Vec2.MulSV(a,_,w.s_translation);if(G.b2Vec2.DotVV(h,h)>P.b2_maxTranslationSquared){var u=P.b2_maxTranslation/h.Length();_.SelfMul(u)}var p=a*l;if(p*p>I.b2_maxRotationSquared)l*=u=I.b2_maxRotation/G.b2Abs(p);m.SelfMulAdd(a,_),c+=a*l,this.m_positions[o].a=c,this.m_velocities[o].w=l;var f=this.m_bodies[o];f.m_sweep.c.Copy(m),f.m_sweep.a=c,f.m_linearVelocity.Copy(_),f.m_angularVelocity=l,f.SynchronizeTransform()}this.Report(r.m_velocityConstraints)},w.prototype.Report=function(t){if(null!==this.m_listener)for(var e=0;e<this.m_contactCount;++e){var i=this.m_contacts[e];if(i){var o=t[e],n=w.s_impulse;n.count=o.pointCount;for(var s=0;s<o.pointCount;++s)n.normalImpulses[s]=o.points[s].normalImpulse,n.tangentImpulses[s]=o.points[s].tangentImpulse;this.m_listener.PostSolve(i,n)}}},w.s_timer=new i.b2Timer,w.s_solverData=new r.b2SolverData,w.s_contactSolverDef=new o.b2ContactSolverDef,w.s_contactSolver=new o.b2ContactSolver,w.s_translation=new G.b2Vec2,w.s_impulse=new n.b2ContactImpulse,w}(),t("b2Island",s)}}}),System.register("Dynamics/b2World",["Common/b2Settings","Common/b2Math","Common/b2Timer","Common/b2Draw","Collision/b2Collision","Collision/b2TimeOfImpact","Dynamics/Joints/b2JointFactory","Dynamics/b2Body","Dynamics/b2ContactManager","Dynamics/b2Island","Dynamics/b2TimeStep","Dynamics/b2WorldCallbacks","Particle/b2Particle","Particle/b2ParticleSystem"],function(t,e){var z,J,y,i,r,j,s,o,n,a,b,m,h,c,_,l,u;e&&e.id;return{setters:[function(t){c=z=t},function(t){J=t},function(t){y=t},function(t){i=t},function(t){r=t},function(t){j=t},function(t){s=t},function(t){o=t},function(t){n=t},function(t){a=t},function(t){b=t},function(t){h=m=t},function(t){_=t},function(t){l=t}],execute:function(){u=function(){function q(t){this.m_newFixture=!1,this.m_locked=!1,this.m_clearForces=!0,this.m_contactManager=new n.b2ContactManager,this.m_bodyList=null,this.m_jointList=null,this.m_particleSystemList=null,this.m_bodyCount=0,this.m_jointCount=0,this.m_gravity=new J.b2Vec2,this.m_allowSleep=!0,this.m_destructionListener=null,this.m_debugDraw=null,this.m_inv_dt0=0,this.m_warmStarting=!0,this.m_continuousPhysics=!0,this.m_subStepping=!1,this.m_stepComplete=!0,this.m_profile=new b.b2Profile,this.m_island=new a.b2Island,this.s_stack=[],this.m_gravity.Copy(t)}return q.prototype.SetDestructionListener=function(t){this.m_destructionListener=t},q.prototype.SetContactFilter=function(t){this.m_contactManager.m_contactFilter=t},q.prototype.SetContactListener=function(t){this.m_contactManager.m_contactListener=t},q.prototype.SetDebugDraw=function(t){this.m_debugDraw=t},q.prototype.CreateBody=function(t){if(this.IsLocked())return null;var e=new o.b2Body(t,this);return e.m_prev=null,e.m_next=this.m_bodyList,this.m_bodyList&&(this.m_bodyList.m_prev=e),this.m_bodyList=e,++this.m_bodyCount,e},q.prototype.DestroyBody=function(t){if(!this.IsLocked()){for(var e=t.m_jointList;e;){var i=e;e=e.next,this.m_destructionListener&&this.m_destructionListener.SayGoodbyeJoint(i.joint),this.DestroyJoint(i.joint),t.m_jointList=e}t.m_jointList=null;for(var o=t.m_contactList;o;){var n=o;o=o.next,this.m_contactManager.Destroy(n.contact)}t.m_contactList=null;for(var s=t.m_fixtureList;s;){var r=s;s=s.m_next,this.m_destructionListener&&this.m_destructionListener.SayGoodbyeFixture(r),r.DestroyProxies(this.m_contactManager.m_broadPhase),r.Destroy(),t.m_fixtureList=s,t.m_fixtureCount-=1}t.m_fixtureList=null,t.m_fixtureCount=0,t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),t===this.m_bodyList&&(this.m_bodyList=t.m_next),--this.m_bodyCount}},q.prototype.CreateJoint=function(t){if(this.IsLocked())return null;var e=s.b2JointFactory.Create(t,null);e.m_prev=null,e.m_next=this.m_jointList,this.m_jointList&&(this.m_jointList.m_prev=e),this.m_jointList=e,++this.m_jointCount,(e.m_edgeA.joint=e).m_edgeA.other=e.m_bodyB,e.m_edgeA.prev=null,e.m_edgeA.next=e.m_bodyA.m_jointList,e.m_bodyA.m_jointList&&(e.m_bodyA.m_jointList.prev=e.m_edgeA),e.m_bodyA.m_jointList=e.m_edgeA,(e.m_edgeB.joint=e).m_edgeB.other=e.m_bodyA,e.m_edgeB.prev=null,e.m_edgeB.next=e.m_bodyB.m_jointList,e.m_bodyB.m_jointList&&(e.m_bodyB.m_jointList.prev=e.m_edgeB),e.m_bodyB.m_jointList=e.m_edgeB;var i=t.bodyA,o=t.bodyB;if(!t.collideConnected)for(var n=o.GetContactList();n;)n.other===i&&n.contact.FlagForFiltering(),n=n.next;return e},q.prototype.DestroyJoint=function(t){if(!this.IsLocked()){var e=t.m_collideConnected;t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),t===this.m_jointList&&(this.m_jointList=t.m_next);var i=t.m_bodyA,o=t.m_bodyB;if(i.SetAwake(!0),o.SetAwake(!0),t.m_edgeA.prev&&(t.m_edgeA.prev.next=t.m_edgeA.next),t.m_edgeA.next&&(t.m_edgeA.next.prev=t.m_edgeA.prev),t.m_edgeA===i.m_jointList&&(i.m_jointList=t.m_edgeA.next),t.m_edgeA.prev=null,t.m_edgeA.next=null,t.m_edgeB.prev&&(t.m_edgeB.prev.next=t.m_edgeB.next),t.m_edgeB.next&&(t.m_edgeB.next.prev=t.m_edgeB.prev),t.m_edgeB===o.m_jointList&&(o.m_jointList=t.m_edgeB.next),t.m_edgeB.prev=null,t.m_edgeB.next=null,s.b2JointFactory.Destroy(t,null),--this.m_jointCount,!e)for(var n=o.GetContactList();n;)n.other===i&&n.contact.FlagForFiltering(),n=n.next}},q.prototype.CreateParticleSystem=function(t){if(this.IsLocked())return null;var e=new l.b2ParticleSystem(t,this);return e.m_prev=null,e.m_next=this.m_particleSystemList,this.m_particleSystemList&&(this.m_particleSystemList.m_prev=e),this.m_particleSystemList=e},q.prototype.DestroyParticleSystem=function(t){this.IsLocked()||(t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),t===this.m_particleSystemList&&(this.m_particleSystemList=t.m_next))},q.prototype.CalculateReasonableParticleIterations=function(t){if(null===this.m_particleSystemList)return 1;return _.b2CalculateParticleIterations(this.m_gravity.Length(),function(t){for(var e=c.b2_maxFloat,i=t.GetParticleSystemList();null!==i;i=i.m_next)e=J.b2Min(e,i.GetRadius());return e}(this),t)},q.prototype.Step=function(t,e,i,o){void 0===o&&(o=this.CalculateReasonableParticleIterations(t));var n=q.Step_s_stepTimer.Reset();this.m_newFixture&&(this.m_contactManager.FindNewContacts(),this.m_newFixture=!1),this.m_locked=!0;var s=q.Step_s_step;s.dt=t,s.velocityIterations=e,s.positionIterations=i,s.particleIterations=o,s.inv_dt=0<t?1/t:0,s.dtRatio=this.m_inv_dt0*t,s.warmStarting=this.m_warmStarting;var r=q.Step_s_timer.Reset();if(this.m_contactManager.Collide(),this.m_profile.collide=r.GetMilliseconds(),this.m_stepComplete&&0<s.dt){for(var a=q.Step_s_timer.Reset(),m=this.m_particleSystemList;m;m=m.m_next)m.Solve(s);this.Solve(s),this.m_profile.solve=a.GetMilliseconds()}if(this.m_continuousPhysics&&0<s.dt){var c=q.Step_s_timer.Reset();this.SolveTOI(s),this.m_profile.solveTOI=c.GetMilliseconds()}0<s.dt&&(this.m_inv_dt0=s.inv_dt),this.m_clearForces&&this.ClearForces(),this.m_locked=!1,this.m_profile.step=n.GetMilliseconds()},q.prototype.ClearForces=function(){for(var t=this.m_bodyList;t;t=t.m_next)t.m_force.SetZero(),t.m_torque=0},q.prototype.DrawParticleSystem=function(t){var e=t.GetParticleCount();if(e){var i=t.GetRadius(),o=t.GetPositionBuffer();if(t.m_colorBuffer.data){var n=t.GetColorBuffer();this.m_debugDraw.DrawParticles(o,i,n,e)}else this.m_debugDraw.DrawParticles(o,i,null,e)}},q.prototype.DrawDebugData=function(){if(null!==this.m_debugDraw){var t=this.m_debugDraw.GetFlags(),e=q.DrawDebugData_s_color.SetRGB(0,0,0);if(1&t)for(var i=this.m_bodyList;i;i=i.m_next){var o=i.m_xf;this.m_debugDraw.PushTransform(o);for(var n=i.GetFixtureList();n;n=n.m_next)i.IsActive()?0===i.GetType()?e.SetRGB(.5,.9,.5):1===i.GetType()?e.SetRGB(.5,.5,.9):i.IsAwake()?e.SetRGB(.9,.7,.7):e.SetRGB(.6,.6,.6):e.SetRGB(.5,.5,.3),this.DrawShape(n,e);this.m_debugDraw.PopTransform(o)}if(32&t)for(var s=this.m_particleSystemList;s;s=s.m_next)this.DrawParticleSystem(s);if(2&t)for(var r=this.m_jointList;r;r=r.m_next)this.DrawJoint(r);if(4&t){e.SetRGB(.9,.3,.9);var a=this.m_contactManager.m_broadPhase,m=q.DrawDebugData_s_vs;for(i=this.m_bodyList;i;i=i.m_next)if(i.IsActive())for(n=i.GetFixtureList();n;n=n.m_next)for(var c=0;c<n.m_proxyCount;++c){var _=n.m_proxies[c],l=a.GetFatAABB(_.proxy);m[0].Set(l.lowerBound.x,l.lowerBound.y),m[1].Set(l.upperBound.x,l.lowerBound.y),m[2].Set(l.upperBound.x,l.upperBound.y),m[3].Set(l.lowerBound.x,l.upperBound.y),this.m_debugDraw.DrawPolygon(m,4,e)}}if(16&t)for(i=this.m_bodyList;i;i=i.m_next){(o=q.DrawDebugData_s_xf).q.Copy(i.m_xf.q),o.p.Copy(i.GetWorldCenter()),this.m_debugDraw.DrawTransform(o)}}},q.prototype.QueryAABB=function(i,t){var o=this.m_contactManager.m_broadPhase;if(o.Query(function(t){var e=o.GetUserData(t).fixture;return i instanceof m.b2QueryCallback?i.ReportFixture(e):i(e)},t),i instanceof m.b2QueryCallback)for(var e=this.m_particleSystemList;e;e=e.m_next)i.ShouldQueryParticleSystem(e)&&e.QueryAABB(i,t)},q.prototype.QueryShape=function(i,o,n){var s=this.m_contactManager.m_broadPhase;var t=q.QueryShape_s_aabb;if(o.ComputeAABB(t,n,0),s.Query(function(t){var e=s.GetUserData(t).fixture;return!r.b2TestOverlapShape(o,0,e.GetShape(),0,n,e.GetBody().GetTransform())||(i instanceof m.b2QueryCallback?i.ReportFixture(e):i(e))},t),i instanceof m.b2QueryCallback)for(var e=this.m_particleSystemList;e;e=e.m_next)i.ShouldQueryParticleSystem(e)&&e.QueryAABB(i,t)},q.prototype.QueryPoint=function(i,o){var n=this.m_contactManager.m_broadPhase;var t=q.QueryPoint_s_aabb;if(t.lowerBound.Set(o.x-z.b2_linearSlop,o.y-z.b2_linearSlop),t.upperBound.Set(o.x+z.b2_linearSlop,o.y+z.b2_linearSlop),n.Query(function(t){var e=n.GetUserData(t).fixture;return!e.TestPoint(o)||(i instanceof m.b2QueryCallback?i.ReportFixture(e):i(e))},t),i instanceof m.b2QueryCallback)for(var e=this.m_particleSystemList;e;e=e.m_next)i.ShouldQueryParticleSystem(e)&&e.QueryAABB(i,t)},q.prototype.RayCast=function(m,c,_){var l=this.m_contactManager.m_broadPhase;var t=q.RayCast_s_input;if(t.maxFraction=1,t.p1.Copy(c),t.p2.Copy(_),l.RayCast(function(t,e){var i=l.GetUserData(e),o=i.fixture,n=i.childIndex,s=q.RayCast_s_output;if(o.RayCast(s,t,n)){var r=s.fraction,a=q.RayCast_s_point;return a.Set((1-r)*c.x+r*_.x,(1-r)*c.y+r*_.y),m instanceof h.b2RayCastCallback?m.ReportFixture(o,a,s.normal,r):m(o,a,s.normal,r)}return t.maxFraction},t),m instanceof h.b2RayCastCallback)for(var e=this.m_particleSystemList;e;e=e.m_next)m.ShouldQueryParticleSystem(e)&&e.RayCast(m,c,_)},q.prototype.RayCastOne=function(t,e){var n=null,s=1;return this.RayCast(function(t,e,i,o){return o<s&&(s=o,n=t),s},t,e),n},q.prototype.RayCastAll=function(t,e,n){return void 0===n&&(n=[]),this.RayCast(function(t,e,i,o){return n.push(t),1},t,e),n},q.prototype.GetBodyList=function(){return this.m_bodyList},q.prototype.GetJointList=function(){return this.m_jointList},q.prototype.GetParticleSystemList=function(){return this.m_particleSystemList},q.prototype.GetContactList=function(){return this.m_contactManager.m_contactList},q.prototype.SetAllowSleeping=function(t){if(t!==this.m_allowSleep&&(this.m_allowSleep=t,!this.m_allowSleep))for(var e=this.m_bodyList;e;e=e.m_next)e.SetAwake(!0)},q.prototype.GetAllowSleeping=function(){return this.m_allowSleep},q.prototype.SetWarmStarting=function(t){this.m_warmStarting=t},q.prototype.GetWarmStarting=function(){return this.m_warmStarting},q.prototype.SetContinuousPhysics=function(t){this.m_continuousPhysics=t},q.prototype.GetContinuousPhysics=function(){return this.m_continuousPhysics},q.prototype.SetSubStepping=function(t){this.m_subStepping=t},q.prototype.GetSubStepping=function(){return this.m_subStepping},q.prototype.GetProxyCount=function(){return this.m_contactManager.m_broadPhase.GetProxyCount()},q.prototype.GetBodyCount=function(){return this.m_bodyCount},q.prototype.GetJointCount=function(){return this.m_jointCount},q.prototype.GetContactCount=function(){return this.m_contactManager.m_contactCount},q.prototype.GetTreeHeight=function(){return this.m_contactManager.m_broadPhase.GetTreeHeight()},q.prototype.GetTreeBalance=function(){return this.m_contactManager.m_broadPhase.GetTreeBalance()},q.prototype.GetTreeQuality=function(){return this.m_contactManager.m_broadPhase.GetTreeQuality()},q.prototype.SetGravity=function(t,e){if(void 0===e&&(e=!0),!J.b2Vec2.IsEqualToV(this.m_gravity,t)&&(this.m_gravity.Copy(t),e))for(var i=this.m_bodyList;i;i=i.m_next)i.SetAwake(!0)},q.prototype.GetGravity=function(){return this.m_gravity},q.prototype.IsLocked=function(){return this.m_locked},q.prototype.SetAutoClearForces=function(t){this.m_clearForces=t},q.prototype.GetAutoClearForces=function(){return this.m_clearForces},q.prototype.ShiftOrigin=function(t){if(!this.IsLocked()){for(var e=this.m_bodyList;e;e=e.m_next)e.m_xf.p.SelfSub(t),e.m_sweep.c0.SelfSub(t),e.m_sweep.c.SelfSub(t);for(var i=this.m_jointList;i;i=i.m_next)i.ShiftOrigin(t);this.m_contactManager.m_broadPhase.ShiftOrigin(t)}},q.prototype.GetContactManager=function(){return this.m_contactManager},q.prototype.GetProfile=function(){return this.m_profile},q.prototype.Dump=function(t){if(!this.m_locked){t("const g: b2Vec2 = new b2Vec2(%.15f, %.15f);\n",this.m_gravity.x,this.m_gravity.y),t("this.m_world.SetGravity(g);\n"),t("const bodies: b2Body[] = [];\n"),t("const joints: b2Joint[] = [];\n");for(var e=0,i=this.m_bodyList;i;i=i.m_next)i.m_islandIndex=e,i.Dump(t),++e;e=0;for(var o=this.m_jointList;o;o=o.m_next)o.m_index=e,++e;for(o=this.m_jointList;o;o=o.m_next)6!==o.m_type&&(t("{\n"),o.Dump(t),t("}\n"));for(o=this.m_jointList;o;o=o.m_next)6===o.m_type&&(t("{\n"),o.Dump(t),t("}\n"))}},q.prototype.DrawJoint=function(t){var e=t.GetBodyA(),i=t.GetBodyB(),o=e.m_xf,n=i.m_xf,s=o.p,r=n.p,a=t.GetAnchorA(q.DrawJoint_s_p1),m=t.GetAnchorB(q.DrawJoint_s_p2),c=q.DrawJoint_s_color.SetRGB(.5,.8,.8);switch(t.m_type){case 3:this.m_debugDraw.DrawSegment(a,m,c);break;case 4:var _=t,l=_.GetGroundAnchorA(),h=_.GetGroundAnchorB();this.m_debugDraw.DrawSegment(l,a,c),this.m_debugDraw.DrawSegment(h,m,c),this.m_debugDraw.DrawSegment(l,h,c);break;case 5:this.m_debugDraw.DrawSegment(a,m,c);break;default:this.m_debugDraw.DrawSegment(s,a,c),this.m_debugDraw.DrawSegment(a,m,c),this.m_debugDraw.DrawSegment(r,m,c)}},q.prototype.DrawShape=function(t,e){var i=t.GetShape();switch(i.m_type){case 0:var o=i,n=o.m_p,s=o.m_radius,r=J.b2Vec2.UNITX;this.m_debugDraw.DrawSolidCircle(n,s,r,e);break;case 1:var a=i,m=a.m_vertex1,c=a.m_vertex2;this.m_debugDraw.DrawSegment(m,c,e);break;case 3:var _=i,l=_.m_count;m=(f=_.m_vertices)[0];this.m_debugDraw.DrawCircle(m,.05,e);for(var h=1;h<l;++h){c=f[h];this.m_debugDraw.DrawSegment(m,c,e),this.m_debugDraw.DrawCircle(c,.05,e),m=c}break;case 2:var u=i,p=u.m_count,f=u.m_vertices;this.m_debugDraw.DrawSolidPolygon(f,p,e)}},q.prototype.Solve=function(t){for(var e=this.m_bodyList;e;e=e.m_next)e.m_xf0.Copy(e.m_xf);this.m_profile.solveInit=0,this.m_profile.solveVelocity=0,this.m_profile.solvePosition=0;var i=this.m_island;i.Initialize(this.m_bodyCount,this.m_contactManager.m_contactCount,this.m_jointCount,null,this.m_contactManager.m_contactListener);for(e=this.m_bodyList;e;e=e.m_next)e.m_islandFlag=!1;for(var o=this.m_contactManager.m_contactList;o;o=o.m_next)o.m_islandFlag=!1;for(var n=this.m_jointList;n;n=n.m_next)n.m_islandFlag=!1;for(var s=this.s_stack,r=this.m_bodyList;r;r=r.m_next)if(!r.m_islandFlag&&r.IsAwake()&&r.IsActive()&&0!==r.GetType()){i.Clear();var a=0;for((s[a++]=r).m_islandFlag=!0;0<a;){e=s[--a];if(i.AddBody(e),e.SetAwake(!0),0!==e.GetType()){for(var m=e.m_contactList;m;m=m.next){var c=m.contact;if(!c.m_islandFlag&&(c.IsEnabled()&&c.IsTouching())){var _=c.m_fixtureA.m_isSensor,l=c.m_fixtureB.m_isSensor;if(!_&&!l)i.AddContact(c),c.m_islandFlag=!0,(u=m.other).m_islandFlag||((s[a++]=u).m_islandFlag=!0)}}for(var h=e.m_jointList;h;h=h.next){var u;if(!h.joint.m_islandFlag)(u=h.other).IsActive()&&(i.AddJoint(h.joint),h.joint.m_islandFlag=!0,u.m_islandFlag||((s[a++]=u).m_islandFlag=!0))}}}var p=new b.b2Profile;i.Solve(p,t,this.m_gravity,this.m_allowSleep),this.m_profile.solveInit+=p.solveInit,this.m_profile.solveVelocity+=p.solveVelocity,this.m_profile.solvePosition+=p.solvePosition;for(var f=0;f<i.m_bodyCount;++f){0===(e=i.m_bodies[f]).GetType()&&(e.m_islandFlag=!1)}}for(f=0;f<s.length&&s[f];++f)s[f]=null;var d=new y.b2Timer;for(e=this.m_bodyList;e;e=e.m_next)e.m_islandFlag&&0!==e.GetType()&&e.SynchronizeFixtures();this.m_contactManager.FindNewContacts(),this.m_profile.broadphase=d.GetMilliseconds()},q.prototype.SolveTOI=function(t){var e=this.m_island;if(e.Initialize(2*z.b2_maxTOIContacts,z.b2_maxTOIContacts,0,null,this.m_contactManager.m_contactListener),this.m_stepComplete){for(var i=this.m_bodyList;i;i=i.m_next)i.m_islandFlag=!1,i.m_sweep.alpha0=0;for(var o=this.m_contactManager.m_contactList;o;o=o.m_next)o.m_toiFlag=!1,o.m_islandFlag=!1,o.m_toiCount=0,o.m_toi=1}for(;;){var n=null,s=1;for(o=this.m_contactManager.m_contactList;o;o=o.m_next)if(o.IsEnabled()&&!(o.m_toiCount>z.b2_maxSubSteps)){var r=1;if(o.m_toiFlag)r=o.m_toi;else{var a=o.GetFixtureA(),m=o.GetFixtureB();if(a.IsSensor()||m.IsSensor())continue;var c=a.GetBody(),_=m.GetBody(),l=c.m_type,h=_.m_type,u=c.IsAwake()&&0!==l,p=_.IsAwake()&&0!==h;if(!u&&!p)continue;var f=c.IsBullet()||2!==l,d=_.IsBullet()||2!==h;if(!f&&!d)continue;var y=c.m_sweep.alpha0;c.m_sweep.alpha0<_.m_sweep.alpha0?(y=_.m_sweep.alpha0,c.m_sweep.Advance(y)):_.m_sweep.alpha0<c.m_sweep.alpha0&&(y=c.m_sweep.alpha0,_.m_sweep.Advance(y));var b=o.GetChildIndexA(),V=o.GetChildIndexB(),v=q.SolveTOI_s_toi_input;v.proxyA.SetShape(a.GetShape(),b),v.proxyB.SetShape(m.GetShape(),V),v.sweepA.Copy(c.m_sweep),v.sweepB.Copy(_.m_sweep),v.tMax=1;var x=q.SolveTOI_s_toi_output;j.b2TimeOfImpact(x,v);var C=x.t;r=3===x.state?J.b2Min(y+(1-y)*C,1):1,o.m_toi=r,o.m_toiFlag=!0}r<s&&(n=o,s=r)}if(null===n||1-10*z.b2_epsilon<s){this.m_stepComplete=!0;break}var S=n.GetFixtureA(),B=n.GetFixtureB(),A=S.GetBody(),g=B.GetBody(),w=q.SolveTOI_s_backup1.Copy(A.m_sweep),M=q.SolveTOI_s_backup2.Copy(g.m_sweep);if(A.Advance(s),g.Advance(s),n.Update(this.m_contactManager.m_contactListener),n.m_toiFlag=!1,++n.m_toiCount,n.IsEnabled()&&n.IsTouching()){A.SetAwake(!0),g.SetAwake(!0),e.Clear(),e.AddBody(A),e.AddBody(g),e.AddContact(n),A.m_islandFlag=!0,g.m_islandFlag=!0,n.m_islandFlag=!0;for(var P=0;P<2;++P){if(2===(k=0===P?A:g).m_type)for(var I=k.m_contactList;I&&e.m_bodyCount!==e.m_bodyCapacity&&e.m_contactCount!==e.m_contactCapacity;I=I.next){var D=I.contact;if(!D.m_islandFlag){var G=I.other;if(2!==G.m_type||k.IsBullet()||G.IsBullet()){var R=D.m_fixtureA.m_isSensor,F=D.m_fixtureB.m_isSensor;if(!R&&!F){var T=q.SolveTOI_s_backup.Copy(G.m_sweep);G.m_islandFlag||G.Advance(s),D.Update(this.m_contactManager.m_contactListener),D.IsEnabled()&&D.IsTouching()?(D.m_islandFlag=!0,e.AddContact(D),G.m_islandFlag||(G.m_islandFlag=!0,0!==G.m_type&&G.SetAwake(!0),e.AddBody(G))):(G.m_sweep.Copy(T),G.SynchronizeTransform())}}}}}var L=q.SolveTOI_s_subStep;L.dt=(1-s)*t.dt,L.inv_dt=1/L.dt,L.dtRatio=1,L.positionIterations=20,L.velocityIterations=t.velocityIterations,L.particleIterations=t.particleIterations,L.warmStarting=!1,e.SolveTOI(L,A.m_islandIndex,g.m_islandIndex);for(P=0;P<e.m_bodyCount;++P){var k;if((k=e.m_bodies[P]).m_islandFlag=!1,2===k.m_type){k.SynchronizeFixtures();for(I=k.m_contactList;I;I=I.next)I.contact.m_toiFlag=!1,I.contact.m_islandFlag=!1}}if(this.m_contactManager.FindNewContacts(),this.m_subStepping){this.m_stepComplete=!1;break}}else n.SetEnabled(!1),A.m_sweep.Copy(w),g.m_sweep.Copy(M),A.SynchronizeTransform(),g.SynchronizeTransform()}},q.Step_s_step=new b.b2TimeStep,q.Step_s_stepTimer=new y.b2Timer,q.Step_s_timer=new y.b2Timer,q.DrawDebugData_s_color=new i.b2Color(0,0,0),q.DrawDebugData_s_vs=J.b2Vec2.MakeArray(4),q.DrawDebugData_s_xf=new J.b2Transform,q.QueryShape_s_aabb=new r.b2AABB,q.QueryPoint_s_aabb=new r.b2AABB,q.RayCast_s_input=new r.b2RayCastInput,q.RayCast_s_output=new r.b2RayCastOutput,q.RayCast_s_point=new J.b2Vec2,q.DrawJoint_s_p1=new J.b2Vec2,q.DrawJoint_s_p2=new J.b2Vec2,q.DrawJoint_s_color=new i.b2Color(.5,.8,.8),q.SolveTOI_s_subStep=new b.b2TimeStep,q.SolveTOI_s_backup=new J.b2Sweep,q.SolveTOI_s_backup1=new J.b2Sweep,q.SolveTOI_s_backup2=new J.b2Sweep,q.SolveTOI_s_toi_input=new j.b2TOIInput,q.SolveTOI_s_toi_output=new j.b2TOIOutput,q}(),t("b2World",u)}}}),System.register("Dynamics/b2Body",["Common/b2Math","Collision/Shapes/b2Shape","Dynamics/b2Fixture"],function(e,t){var s,i,o,n,r;t&&t.id;return{setters:[function(t){s=t},function(t){i=t},function(t){o=t}],execute:function(){var t;(t=n||(n={}))[t.b2_unknown=-1]="b2_unknown",t[t.b2_staticBody=0]="b2_staticBody",t[t.b2_kinematicBody=1]="b2_kinematicBody",t[t.b2_dynamicBody=2]="b2_dynamicBody",e("b2BodyType",n),e("b2BodyDef",function(){this.type=0,this.position=new s.b2Vec2(0,0),this.angle=0,this.linearVelocity=new s.b2Vec2(0,0),this.angularVelocity=0,this.linearDamping=0,this.angularDamping=0,this.allowSleep=!0,this.awake=!0,this.fixedRotation=!1,this.bullet=!1,this.active=!0,this.userData=null,this.gravityScale=1}),r=function(){function n(t,e){this.m_type=0,this.m_islandFlag=!1,this.m_awakeFlag=!1,this.m_autoSleepFlag=!1,this.m_bulletFlag=!1,this.m_fixedRotationFlag=!1,this.m_activeFlag=!1,this.m_toiFlag=!1,this.m_islandIndex=0,this.m_xf=new s.b2Transform,this.m_xf0=new s.b2Transform,this.m_sweep=new s.b2Sweep,this.m_linearVelocity=new s.b2Vec2,this.m_angularVelocity=0,this.m_force=new s.b2Vec2,this.m_torque=0,this.m_world=null,this.m_prev=null,this.m_next=null,this.m_fixtureList=null,this.m_fixtureCount=0,this.m_jointList=null,this.m_contactList=null,this.m_mass=1,this.m_invMass=1,this.m_I=0,this.m_invI=0,this.m_linearDamping=0,this.m_angularDamping=0,this.m_gravityScale=1,this.m_sleepTime=0,this.m_userData=null,t.bullet&&(this.m_bulletFlag=!0),t.fixedRotation&&(this.m_fixedRotationFlag=!0),t.allowSleep&&(this.m_autoSleepFlag=!0),t.awake&&(this.m_awakeFlag=!0),t.active&&(this.m_activeFlag=!0),this.m_world=e,this.m_xf.p.Copy(t.position),this.m_xf.q.SetAngle(t.angle),this.m_xf0.Copy(this.m_xf),this.m_sweep.localCenter.SetZero(),this.m_sweep.c0.Copy(this.m_xf.p),this.m_sweep.c.Copy(this.m_xf.p),this.m_sweep.a0=t.angle,this.m_sweep.a=t.angle,this.m_sweep.alpha0=0,this.m_linearVelocity.Copy(t.linearVelocity),this.m_angularVelocity=t.angularVelocity,this.m_linearDamping=t.linearDamping,this.m_angularDamping=t.angularDamping,this.m_gravityScale=t.gravityScale,this.m_force.SetZero(),this.m_torque=0,this.m_sleepTime=0,this.m_type=t.type,2===t.type?(this.m_mass=1,this.m_invMass=1):(this.m_mass=0,this.m_invMass=0),this.m_I=0,this.m_invI=0,this.m_userData=t.userData,this.m_fixtureList=null,this.m_fixtureCount=0}return n.prototype.CreateFixture=function(t,e){if(t instanceof o.b2FixtureDef)return this.CreateFixtureDef(t);if(t instanceof i.b2Shape&&"number"==typeof e)return this.CreateFixtureShapeDensity(t,e);throw new Error},n.prototype.CreateFixtureDef=function(t){if(this.m_world.IsLocked())return null;var e=new o.b2Fixture;if(e.Create(this,t),this.m_activeFlag){var i=this.m_world.m_contactManager.m_broadPhase;e.CreateProxies(i,this.m_xf)}return e.m_next=this.m_fixtureList,this.m_fixtureList=e,++this.m_fixtureCount,e.m_body=this,0<e.m_density&&this.ResetMassData(),this.m_world.m_newFixture=!0,e},n.prototype.CreateFixtureShapeDensity=function(t,e){void 0===e&&(e=0);var i=n.CreateFixtureShapeDensity_s_def;return i.shape=t,i.density=e,this.CreateFixtureDef(i)},n.prototype.DestroyFixture=function(t){if(!this.m_world.IsLocked()){for(var e=this.m_fixtureList,i=null;null!==e;){if(e===t){i?i.m_next=t.m_next:this.m_fixtureList=t.m_next;break}e=(i=e).m_next}for(var o=this.m_contactList;o;){var n=o.contact;o=o.next;var s=n.GetFixtureA(),r=n.GetFixtureB();t!==s&&t!==r||this.m_world.m_contactManager.Destroy(n)}if(this.m_activeFlag){var a=this.m_world.m_contactManager.m_broadPhase;t.DestroyProxies(a)}t.Destroy(),t.m_body=null,t.m_next=null,--this.m_fixtureCount,this.ResetMassData()}},n.prototype.SetTransformVec=function(t,e){this.SetTransformXY(t.x,t.y,e)},n.prototype.SetTransformXY=function(t,e,i){if(!this.m_world.IsLocked()){this.m_xf.q.SetAngle(i),this.m_xf.p.Set(t,e),this.m_xf0.Copy(this.m_xf),s.b2Transform.MulXV(this.m_xf,this.m_sweep.localCenter,this.m_sweep.c),this.m_sweep.a=i,this.m_sweep.c0.Copy(this.m_sweep.c),this.m_sweep.a0=i;for(var o=this.m_world.m_contactManager.m_broadPhase,n=this.m_fixtureList;n;n=n.m_next)n.Synchronize(o,this.m_xf,this.m_xf);this.m_world.m_contactManager.FindNewContacts()}},n.prototype.SetTransform=function(t){this.SetTransformVec(t.p,t.GetAngle())},n.prototype.GetTransform=function(){return this.m_xf},n.prototype.GetPosition=function(){return this.m_xf.p},n.prototype.SetPosition=function(t){this.SetTransformVec(t,this.GetAngle())},n.prototype.SetPositionXY=function(t,e){this.SetTransformXY(t,e,this.GetAngle())},n.prototype.GetAngle=function(){return this.m_sweep.a},n.prototype.SetAngle=function(t){this.SetTransformVec(this.GetPosition(),t)},n.prototype.GetWorldCenter=function(){return this.m_sweep.c},n.prototype.GetLocalCenter=function(){return this.m_sweep.localCenter},n.prototype.SetLinearVelocity=function(t){0!==this.m_type&&(0<s.b2Vec2.DotVV(t,t)&&this.SetAwake(!0),this.m_linearVelocity.Copy(t))},n.prototype.GetLinearVelocity=function(){return this.m_linearVelocity},n.prototype.SetAngularVelocity=function(t){0!==this.m_type&&(0<t*t&&this.SetAwake(!0),this.m_angularVelocity=t)},n.prototype.GetAngularVelocity=function(){return this.m_angularVelocity},n.prototype.GetDefinition=function(t){return t.type=this.GetType(),t.allowSleep=this.m_autoSleepFlag,t.angle=this.GetAngle(),t.angularDamping=this.m_angularDamping,t.gravityScale=this.m_gravityScale,t.angularVelocity=this.m_angularVelocity,t.fixedRotation=this.m_fixedRotationFlag,t.bullet=this.m_bulletFlag,t.awake=this.m_awakeFlag,t.linearDamping=this.m_linearDamping,t.linearVelocity.Copy(this.GetLinearVelocity()),t.position.Copy(this.GetPosition()),t.userData=this.GetUserData(),t},n.prototype.ApplyForce=function(t,e,i){void 0===i&&(i=!0),2===this.m_type&&(i&&!this.m_awakeFlag&&this.SetAwake(!0),this.m_awakeFlag&&(this.m_force.x+=t.x,this.m_force.y+=t.y,this.m_torque+=(e.x-this.m_sweep.c.x)*t.y-(e.y-this.m_sweep.c.y)*t.x))},n.prototype.ApplyForceToCenter=function(t,e){void 0===e&&(e=!0),2===this.m_type&&(e&&!this.m_awakeFlag&&this.SetAwake(!0),this.m_awakeFlag&&(this.m_force.x+=t.x,this.m_force.y+=t.y))},n.prototype.ApplyTorque=function(t,e){void 0===e&&(e=!0),2===this.m_type&&(e&&!this.m_awakeFlag&&this.SetAwake(!0),this.m_awakeFlag&&(this.m_torque+=t))},n.prototype.ApplyLinearImpulse=function(t,e,i){void 0===i&&(i=!0),2===this.m_type&&(i&&!this.m_awakeFlag&&this.SetAwake(!0),this.m_awakeFlag&&(this.m_linearVelocity.x+=this.m_invMass*t.x,this.m_linearVelocity.y+=this.m_invMass*t.y,this.m_angularVelocity+=this.m_invI*((e.x-this.m_sweep.c.x)*t.y-(e.y-this.m_sweep.c.y)*t.x)))},n.prototype.ApplyLinearImpulseToCenter=function(t,e){void 0===e&&(e=!0),2===this.m_type&&(e&&!this.m_awakeFlag&&this.SetAwake(!0),this.m_awakeFlag&&(this.m_linearVelocity.x+=this.m_invMass*t.x,this.m_linearVelocity.y+=this.m_invMass*t.y))},n.prototype.ApplyAngularImpulse=function(t,e){void 0===e&&(e=!0),2===this.m_type&&(e&&!this.m_awakeFlag&&this.SetAwake(!0),this.m_awakeFlag&&(this.m_angularVelocity+=this.m_invI*t))},n.prototype.GetMass=function(){return this.m_mass},n.prototype.GetInertia=function(){return this.m_I+this.m_mass*s.b2Vec2.DotVV(this.m_sweep.localCenter,this.m_sweep.localCenter)},n.prototype.GetMassData=function(t){return t.mass=this.m_mass,t.I=this.m_I+this.m_mass*s.b2Vec2.DotVV(this.m_sweep.localCenter,this.m_sweep.localCenter),t.center.Copy(this.m_sweep.localCenter),t},n.prototype.SetMassData=function(t){if(!this.m_world.IsLocked()&&2===this.m_type){this.m_invMass=0,this.m_I=0,this.m_invI=0,this.m_mass=t.mass,this.m_mass<=0&&(this.m_mass=1),this.m_invMass=1/this.m_mass,0<t.I&&!this.m_fixedRotationFlag&&(this.m_I=t.I-this.m_mass*s.b2Vec2.DotVV(t.center,t.center),this.m_invI=1/this.m_I);var e=n.SetMassData_s_oldCenter.Copy(this.m_sweep.c);this.m_sweep.localCenter.Copy(t.center),s.b2Transform.MulXV(this.m_xf,this.m_sweep.localCenter,this.m_sweep.c),this.m_sweep.c0.Copy(this.m_sweep.c),s.b2Vec2.AddVCrossSV(this.m_linearVelocity,this.m_angularVelocity,s.b2Vec2.SubVV(this.m_sweep.c,e,s.b2Vec2.s_t0),this.m_linearVelocity)}},n.prototype.ResetMassData=function(){if(this.m_mass=0,this.m_invMass=0,this.m_I=0,this.m_invI=0,this.m_sweep.localCenter.SetZero(),0===this.m_type||1===this.m_type)return this.m_sweep.c0.Copy(this.m_xf.p),this.m_sweep.c.Copy(this.m_xf.p),void(this.m_sweep.a0=this.m_sweep.a);for(var t=n.ResetMassData_s_localCenter.SetZero(),e=this.m_fixtureList;e;e=e.m_next)if(0!==e.m_density){var i=e.GetMassData(n.ResetMassData_s_massData);this.m_mass+=i.mass,t.x+=i.center.x*i.mass,t.y+=i.center.y*i.mass,this.m_I+=i.I}0<this.m_mass?(this.m_invMass=1/this.m_mass,t.x*=this.m_invMass,t.y*=this.m_invMass):(this.m_mass=1,this.m_invMass=1),0<this.m_I&&!this.m_fixedRotationFlag?(this.m_I-=this.m_mass*s.b2Vec2.DotVV(t,t),this.m_invI=1/this.m_I):(this.m_I=0,this.m_invI=0);var o=n.ResetMassData_s_oldCenter.Copy(this.m_sweep.c);this.m_sweep.localCenter.Copy(t),s.b2Transform.MulXV(this.m_xf,this.m_sweep.localCenter,this.m_sweep.c),this.m_sweep.c0.Copy(this.m_sweep.c),s.b2Vec2.AddVCrossSV(this.m_linearVelocity,this.m_angularVelocity,s.b2Vec2.SubVV(this.m_sweep.c,o,s.b2Vec2.s_t0),this.m_linearVelocity)},n.prototype.GetWorldPoint=function(t,e){return s.b2Transform.MulXV(this.m_xf,t,e)},n.prototype.GetWorldVector=function(t,e){return s.b2Rot.MulRV(this.m_xf.q,t,e)},n.prototype.GetLocalPoint=function(t,e){return s.b2Transform.MulTXV(this.m_xf,t,e)},n.prototype.GetLocalVector=function(t,e){return s.b2Rot.MulTRV(this.m_xf.q,t,e)},n.prototype.GetLinearVelocityFromWorldPoint=function(t,e){return s.b2Vec2.AddVCrossSV(this.m_linearVelocity,this.m_angularVelocity,s.b2Vec2.SubVV(t,this.m_sweep.c,s.b2Vec2.s_t0),e)},n.prototype.GetLinearVelocityFromLocalPoint=function(t,e){return this.GetLinearVelocityFromWorldPoint(this.GetWorldPoint(t,e),e)},n.prototype.GetLinearDamping=function(){return this.m_linearDamping},n.prototype.SetLinearDamping=function(t){this.m_linearDamping=t},n.prototype.GetAngularDamping=function(){return this.m_angularDamping},n.prototype.SetAngularDamping=function(t){this.m_angularDamping=t},n.prototype.GetGravityScale=function(){return this.m_gravityScale},n.prototype.SetGravityScale=function(t){this.m_gravityScale=t},n.prototype.SetType=function(t){if(!this.m_world.IsLocked()&&this.m_type!==t){this.m_type=t,this.ResetMassData(),0===this.m_type&&(this.m_linearVelocity.SetZero(),this.m_angularVelocity=0,this.m_sweep.a0=this.m_sweep.a,this.m_sweep.c0.Copy(this.m_sweep.c),this.SynchronizeFixtures()),this.SetAwake(!0),this.m_force.SetZero(),this.m_torque=0;for(var e=this.m_contactList;e;){var i=e;e=e.next,this.m_world.m_contactManager.Destroy(i.contact)}this.m_contactList=null;for(var o=this.m_world.m_contactManager.m_broadPhase,n=this.m_fixtureList;n;n=n.m_next)for(var s=n.m_proxyCount,r=0;r<s;++r)o.TouchProxy(n.m_proxies[r].proxy)}},n.prototype.GetType=function(){return this.m_type},n.prototype.SetBullet=function(t){this.m_bulletFlag=t},n.prototype.IsBullet=function(){return this.m_bulletFlag},n.prototype.SetSleepingAllowed=function(t){(this.m_autoSleepFlag=t)||this.SetAwake(!0)},n.prototype.IsSleepingAllowed=function(){return this.m_autoSleepFlag},n.prototype.SetAwake=function(t){t?this.m_awakeFlag||(this.m_awakeFlag=!0,this.m_sleepTime=0):(this.m_awakeFlag=!1,this.m_sleepTime=0,this.m_linearVelocity.SetZero(),this.m_angularVelocity=0,this.m_force.SetZero(),this.m_torque=0)},n.prototype.IsAwake=function(){return this.m_awakeFlag},n.prototype.SetActive=function(t){if(t!==this.IsActive())if(this.m_activeFlag=t)for(var e=this.m_world.m_contactManager.m_broadPhase,i=this.m_fixtureList;i;i=i.m_next)i.CreateProxies(e,this.m_xf);else{for(e=this.m_world.m_contactManager.m_broadPhase,i=this.m_fixtureList;i;i=i.m_next)i.DestroyProxies(e);for(var o=this.m_contactList;o;){var n=o;o=o.next,this.m_world.m_contactManager.Destroy(n.contact)}this.m_contactList=null}},n.prototype.IsActive=function(){return this.m_activeFlag},n.prototype.SetFixedRotation=function(t){this.m_fixedRotationFlag!==t&&(this.m_fixedRotationFlag=t,this.m_angularVelocity=0,this.ResetMassData())},n.prototype.IsFixedRotation=function(){return this.m_fixedRotationFlag},n.prototype.GetFixtureList=function(){return this.m_fixtureList},n.prototype.GetJointList=function(){return this.m_jointList},n.prototype.GetContactList=function(){return this.m_contactList},n.prototype.GetNext=function(){return this.m_next},n.prototype.GetUserData=function(){return this.m_userData},n.prototype.SetUserData=function(t){this.m_userData=t},n.prototype.GetWorld=function(){return this.m_world},n.prototype.Dump=function(t){var e=this.m_islandIndex;t("{\n"),t("  const bd: b2BodyDef = new b2BodyDef();\n");var i="";switch(this.m_type){case 0:i="b2BodyType.b2_staticBody";break;case 1:i="b2BodyType.b2_kinematicBody";break;case 2:i="b2BodyType.b2_dynamicBody"}t("  bd.type = %s;\n",i),t("  bd.position.Set(%.15f, %.15f);\n",this.m_xf.p.x,this.m_xf.p.y),t("  bd.angle = %.15f;\n",this.m_sweep.a),t("  bd.linearVelocity.Set(%.15f, %.15f);\n",this.m_linearVelocity.x,this.m_linearVelocity.y),t("  bd.angularVelocity = %.15f;\n",this.m_angularVelocity),t("  bd.linearDamping = %.15f;\n",this.m_linearDamping),t("  bd.angularDamping = %.15f;\n",this.m_angularDamping),t("  bd.allowSleep = %s;\n",this.m_autoSleepFlag?"true":"false"),t("  bd.awake = %s;\n",this.m_awakeFlag?"true":"false"),t("  bd.fixedRotation = %s;\n",this.m_fixedRotationFlag?"true":"false"),t("  bd.bullet = %s;\n",this.m_bulletFlag?"true":"false"),t("  bd.active = %s;\n",this.m_activeFlag?"true":"false"),t("  bd.gravityScale = %.15f;\n",this.m_gravityScale),t("\n"),t("  bodies[%d] = this.m_world.CreateBody(bd);\n",this.m_islandIndex),t("\n");for(var o=this.m_fixtureList;o;o=o.m_next)t("  {\n"),o.Dump(t,e),t("  }\n");t("}\n")},n.prototype.SynchronizeFixtures=function(){var t=n.SynchronizeFixtures_s_xf1;t.q.SetAngle(this.m_sweep.a0),s.b2Rot.MulRV(t.q,this.m_sweep.localCenter,t.p),s.b2Vec2.SubVV(this.m_sweep.c0,t.p,t.p);for(var e=this.m_world.m_contactManager.m_broadPhase,i=this.m_fixtureList;i;i=i.m_next)i.Synchronize(e,t,this.m_xf)},n.prototype.SynchronizeTransform=function(){this.m_xf.q.SetAngle(this.m_sweep.a),s.b2Rot.MulRV(this.m_xf.q,this.m_sweep.localCenter,this.m_xf.p),s.b2Vec2.SubVV(this.m_sweep.c,this.m_xf.p,this.m_xf.p)},n.prototype.ShouldCollide=function(t){return(0!==this.m_type||0!==t.m_type)&&this.ShouldCollideConnected(t)},n.prototype.ShouldCollideConnected=function(t){for(var e=this.m_jointList;e;e=e.next)if(e.other===t&&!e.joint.m_collideConnected)return!1;return!0},n.prototype.Advance=function(t){this.m_sweep.Advance(t),this.m_sweep.c.Copy(this.m_sweep.c0),this.m_sweep.a=this.m_sweep.a0,this.m_xf.q.SetAngle(this.m_sweep.a),s.b2Rot.MulRV(this.m_xf.q,this.m_sweep.localCenter,this.m_xf.p),s.b2Vec2.SubVV(this.m_sweep.c,this.m_xf.p,this.m_xf.p)},n.CreateFixtureShapeDensity_s_def=new o.b2FixtureDef,n.SetMassData_s_oldCenter=new s.b2Vec2,n.ResetMassData_s_localCenter=new s.b2Vec2,n.ResetMassData_s_oldCenter=new s.b2Vec2,n.ResetMassData_s_massData=new i.b2MassData,n.SynchronizeFixtures_s_xf1=new s.b2Transform,n}(),e("b2Body",r)}}}),System.register("Dynamics/Contacts/b2Contact",["Common/b2Settings","Common/b2Math","Collision/b2Collision","Collision/b2TimeOfImpact"],function(t,e){var s,i,o,b,r,a,n;e&&e.id;function m(t,e){return i.b2Sqrt(t*e)}function c(t,e){return e<t?t:e}return t("b2MixFriction",m),t("b2MixRestitution",c),{setters:[function(t){s=t},function(t){i=t},function(t){b=o=t},function(t){r=t}],execute:function(){t("b2ContactEdge",a=function(){this.other=null,this.contact=null,this.prev=null,this.next=null}),n=function(){function n(){this.m_islandFlag=!1,this.m_touchingFlag=!1,this.m_enabledFlag=!1,this.m_filterFlag=!1,this.m_bulletHitFlag=!1,this.m_toiFlag=!1,this.m_prev=null,this.m_next=null,this.m_nodeA=new a,this.m_nodeB=new a,this.m_fixtureA=null,this.m_fixtureB=null,this.m_indexA=0,this.m_indexB=0,this.m_manifold=new o.b2Manifold,this.m_toiCount=0,this.m_toi=0,this.m_friction=0,this.m_restitution=0,this.m_tangentSpeed=0,this.m_oldManifold=new o.b2Manifold}return n.prototype.GetManifold=function(){return this.m_manifold},n.prototype.GetWorldManifold=function(t){var e=this.m_fixtureA.GetBody(),i=this.m_fixtureB.GetBody(),o=this.m_fixtureA.GetShape(),n=this.m_fixtureB.GetShape();t.Initialize(this.m_manifold,e.GetTransform(),o.m_radius,i.GetTransform(),n.m_radius)},n.prototype.IsTouching=function(){return this.m_touchingFlag},n.prototype.SetEnabled=function(t){this.m_enabledFlag=t},n.prototype.IsEnabled=function(){return this.m_enabledFlag},n.prototype.GetNext=function(){return this.m_next},n.prototype.GetFixtureA=function(){return this.m_fixtureA},n.prototype.GetChildIndexA=function(){return this.m_indexA},n.prototype.GetFixtureB=function(){return this.m_fixtureB},n.prototype.GetChildIndexB=function(){return this.m_indexB},n.prototype.Evaluate=function(t,e,i){},n.prototype.FlagForFiltering=function(){this.m_filterFlag=!0},n.prototype.SetFriction=function(t){this.m_friction=t},n.prototype.GetFriction=function(){return this.m_friction},n.prototype.ResetFriction=function(){this.m_friction=m(this.m_fixtureA.m_friction,this.m_fixtureB.m_friction)},n.prototype.SetRestitution=function(t){this.m_restitution=t},n.prototype.GetRestitution=function(){return this.m_restitution},n.prototype.ResetRestitution=function(){this.m_restitution=c(this.m_fixtureA.m_restitution,this.m_fixtureB.m_restitution)},n.prototype.SetTangentSpeed=function(t){this.m_tangentSpeed=t},n.prototype.GetTangentSpeed=function(){return this.m_tangentSpeed},n.prototype.Reset=function(t,e,i,o){this.m_islandFlag=!1,this.m_touchingFlag=!1,this.m_enabledFlag=!0,this.m_filterFlag=!1,this.m_bulletHitFlag=!1,this.m_toiFlag=!1,this.m_fixtureA=t,this.m_fixtureB=i,this.m_indexA=e,this.m_indexB=o,this.m_manifold.pointCount=0,this.m_prev=null,this.m_next=null,this.m_nodeA.contact=null,this.m_nodeA.prev=null,this.m_nodeA.next=null,this.m_nodeA.other=null,this.m_nodeB.contact=null,this.m_nodeB.prev=null,this.m_nodeB.next=null,this.m_nodeB.other=null,this.m_toiCount=0,this.m_friction=m(this.m_fixtureA.m_friction,this.m_fixtureB.m_friction),this.m_restitution=c(this.m_fixtureA.m_restitution,this.m_fixtureB.m_restitution)},n.prototype.Update=function(t){var e=this.m_oldManifold;this.m_oldManifold=this.m_manifold,this.m_manifold=e,this.m_enabledFlag=!0;var i=!1,o=this.m_touchingFlag,n=this.m_fixtureA.IsSensor(),s=this.m_fixtureB.IsSensor(),r=n||s,a=this.m_fixtureA.GetBody(),m=this.m_fixtureB.GetBody(),c=a.GetTransform(),_=m.GetTransform();if(r){var l=this.m_fixtureA.GetShape(),h=this.m_fixtureB.GetShape();i=b.b2TestOverlapShape(l,this.m_indexA,h,this.m_indexB,c,_),this.m_manifold.pointCount=0}else{this.Evaluate(this.m_manifold,c,_),i=0<this.m_manifold.pointCount;for(var u=0;u<this.m_manifold.pointCount;++u){var p=this.m_manifold.points[u];p.normalImpulse=0,p.tangentImpulse=0;for(var f=p.id,d=0;d<this.m_oldManifold.pointCount;++d){var y=this.m_oldManifold.points[d];if(y.id.key===f.key){p.normalImpulse=y.normalImpulse,p.tangentImpulse=y.tangentImpulse;break}}}i!==o&&(a.SetAwake(!0),m.SetAwake(!0))}this.m_touchingFlag=i,!o&&i&&t&&t.BeginContact(this),o&&!i&&t&&t.EndContact(this),!r&&i&&t&&t.PreSolve(this,this.m_oldManifold)},n.prototype.ComputeTOI=function(t,e){var i=n.ComputeTOI_s_input;i.proxyA.SetShape(this.m_fixtureA.GetShape(),this.m_indexA),i.proxyB.SetShape(this.m_fixtureB.GetShape(),this.m_indexB),i.sweepA.Copy(t),i.sweepB.Copy(e),i.tMax=s.b2_linearSlop;var o=n.ComputeTOI_s_output;return r.b2TimeOfImpact(o,i),o.t},n.ComputeTOI_s_input=new r.b2TOIInput,n.ComputeTOI_s_output=new r.b2TOIOutput,n}(),t("b2Contact",n)}}}),System.register("Collision/b2CollideCircle",["Common/b2Settings","Common/b2Math"],function(t,e){var C,S,c,_,B,A,g;e&&e.id;return t("b2CollideCircles",function(t,e,i,o,n){t.pointCount=0;var s=S.b2Transform.MulXV(i,e.m_p,c),r=S.b2Transform.MulXV(n,o.m_p,_),a=S.b2Vec2.DistanceSquaredVV(s,r),m=e.m_radius+o.m_radius;m*m<a||(t.type=0,t.localPoint.Copy(e.m_p),t.localNormal.SetZero(),t.pointCount=1,t.points[0].localPoint.Copy(o.m_p),t.points[0].id.key=0)}),t("b2CollidePolygonAndCircle",function(t,e,i,o,n){t.pointCount=0;for(var s=S.b2Transform.MulXV(n,o.m_p,B),r=S.b2Transform.MulTXV(i,s,A),a=0,m=-C.b2_maxFloat,c=e.m_radius+o.m_radius,_=e.m_count,l=e.m_vertices,h=e.m_normals,u=0;u<_;++u){var p=S.b2Vec2.DotVV(h[u],S.b2Vec2.SubVV(r,l[u],S.b2Vec2.s_t0));if(c<p)return;m<p&&(m=p,a=u)}var f=a,d=(f+1)%_,y=l[f],b=l[d];if(m<C.b2_epsilon)return t.pointCount=1,t.type=1,t.localNormal.Copy(h[a]),S.b2Vec2.MidVV(y,b,t.localPoint),t.points[0].localPoint.Copy(o.m_p),void(t.points[0].id.key=0);var V=S.b2Vec2.DotVV(S.b2Vec2.SubVV(r,y,S.b2Vec2.s_t0),S.b2Vec2.SubVV(b,y,S.b2Vec2.s_t1)),v=S.b2Vec2.DotVV(S.b2Vec2.SubVV(r,b,S.b2Vec2.s_t0),S.b2Vec2.SubVV(y,b,S.b2Vec2.s_t1));if(V<=0){if(S.b2Vec2.DistanceSquaredVV(r,y)>c*c)return;t.pointCount=1,t.type=1,S.b2Vec2.SubVV(r,y,t.localNormal).SelfNormalize(),t.localPoint.Copy(y),t.points[0].localPoint.Copy(o.m_p),t.points[0].id.key=0}else if(v<=0){if(S.b2Vec2.DistanceSquaredVV(r,b)>c*c)return;t.pointCount=1,t.type=1,S.b2Vec2.SubVV(r,b,t.localNormal).SelfNormalize(),t.localPoint.Copy(b),t.points[0].localPoint.Copy(o.m_p),t.points[0].id.key=0}else{var x=S.b2Vec2.MidVV(y,b,g);if(c<(m=S.b2Vec2.DotVV(S.b2Vec2.SubVV(r,x,S.b2Vec2.s_t1),h[f])))return;t.pointCount=1,t.type=1,t.localNormal.Copy(h[f]).SelfNormalize(),t.localPoint.Copy(x),t.points[0].localPoint.Copy(o.m_p),t.points[0].id.key=0}}),{setters:[function(t){C=t},function(t){S=t}],execute:function(){c=new S.b2Vec2,_=new S.b2Vec2,B=new S.b2Vec2,A=new S.b2Vec2,g=new S.b2Vec2}}}),System.register("Dynamics/Contacts/b2CircleContact",["Collision/b2CollideCircle","Dynamics/Contacts/b2Contact"],function(t,e){var s,i,o;e&&e.id;return{setters:[function(t){s=t},function(t){i=t}],execute:function(){o=function(n){function e(){return n.call(this)||this}return __extends(e,n),e.Create=function(t){return new e},e.Destroy=function(t,e){},e.prototype.Reset=function(t,e,i,o){n.prototype.Reset.call(this,t,e,i,o)},e.prototype.Evaluate=function(t,e,i){var o=this.m_fixtureA.GetShape(),n=this.m_fixtureB.GetShape();s.b2CollideCircles(t,o,e,n,i)},e}(i.b2Contact),t("b2CircleContact",o)}}}),System.register("Collision/b2CollidePolygon",["Common/b2Settings","Common/b2Math","Collision/b2Collision"],function(t,e){var j,N,E,y,b,V,v,x,C,O,X,U,W,Z,H,Q,Y,K,$,tt,et,it,ot;e&&e.id;function S(t,e,i,o,n){for(var s=t.m_vertices,r=t.m_normals,a=o.m_count,m=o.m_vertices,c=N.b2Rot.MulRV(e.q,r[i],y),_=N.b2Rot.MulTRV(n.q,c,b),l=0,h=j.b2_maxFloat,u=0;u<a;++u){var p=N.b2Vec2.DotVV(m[u],_);p<h&&(h=p,l=u)}var f=N.b2Transform.MulXV(e,s[i],V),d=N.b2Transform.MulXV(n,m[l],v);return N.b2Vec2.DotVV(N.b2Vec2.SubVV(d,f,N.b2Vec2.s_t0),c)}function nt(t,e,i,o,n){for(var s=e.m_count,r=e.m_normals,a=N.b2Vec2.SubVV(N.b2Transform.MulXV(n,o.m_centroid,N.b2Vec2.s_t0),N.b2Transform.MulXV(i,e.m_centroid,N.b2Vec2.s_t1),x),m=N.b2Rot.MulTRV(i.q,a,C),c=0,_=-j.b2_maxFloat,l=0;l<s;++l){var h=N.b2Vec2.DotVV(r[l],m);_<h&&(_=h,c=l)}var u=S(e,i,c,o,n),p=(c+s-1)%s,f=S(e,i,p,o,n),d=(c+1)%s,y=S(e,i,d,o,n),b=0,V=0,v=0;if(u<f&&y<f)v=-1,b=p,V=f;else{if(!(u<y))return t[0]=c,u;v=1,b=d,V=y}for(;V<(u=S(e,i,c=-1===v?(b+s-1)%s:(b+1)%s,o,n));)b=c,V=u;return t[0]=b,V}return t("b2CollidePolygons",function(t,e,i,o,n){t.pointCount=0;var s=e.m_radius+o.m_radius,r=Z;r[0]=0;var a=nt(r,e,i,o,n);if(!(s<a)){var m=H;m[0]=0;var c=nt(m,o,n,e,i);if(!(s<c)){var _,l,h,u,p=0,f=0;.98*a+.001<c?(_=o,l=e,h=n,u=i,p=m[0],t.type=2,f=1):(_=e,l=o,h=i,u=n,p=r[0],t.type=1,f=0);var d=X;!function(t,e,i,o,n,s){for(var r=e.m_normals,a=n.m_count,m=n.m_vertices,c=n.m_normals,_=N.b2Rot.MulTRV(s.q,N.b2Rot.MulRV(i.q,r[o],N.b2Vec2.s_t0),O),l=0,h=j.b2_maxFloat,u=0;u<a;++u){var p=N.b2Vec2.DotVV(_,c[u]);p<h&&(h=p,l=u)}var f=l,d=(f+1)%a,y=t[0];N.b2Transform.MulXV(s,m[f],y.v);var b=y.id.cf;b.indexA=o,b.indexB=f,b.typeA=1,b.typeB=0;var V=t[1];N.b2Transform.MulXV(s,m[d],V.v);var v=V.id.cf;v.indexA=o,v.indexB=d,v.typeA=1,v.typeB=0}(d,_,h,p,l,u);var y=_.m_count,b=_.m_vertices,V=p,v=(p+1)%y,x=b[V],C=b[v],S=N.b2Vec2.SubVV(C,x,Q);S.Normalize();var B=N.b2Vec2.CrossVOne(S,Y),A=N.b2Vec2.MidVV(x,C,K),g=N.b2Rot.MulRV(h.q,S,tt),w=N.b2Vec2.CrossVOne(g,$),M=N.b2Transform.MulXV(h,x,it),P=N.b2Transform.MulXV(h,C,ot),I=N.b2Vec2.DotVV(w,M),D=-N.b2Vec2.DotVV(g,M)+s,G=N.b2Vec2.DotVV(g,P)+s,R=U,F=W,T=N.b2Vec2.NegV(g,et);if(!(E.b2ClipSegmentToLine(R,d,T,D,V)<2||E.b2ClipSegmentToLine(F,R,g,G,v)<2)){t.localNormal.Copy(B),t.localPoint.Copy(A);for(var L=0,k=0;k<j.b2_maxManifoldPoints;++k){var q=F[k];if(N.b2Vec2.DotVV(w,q.v)-I<=s){var z=t.points[L];if(N.b2Transform.MulTXV(u,q.v,z.localPoint),z.id.Copy(q.id),f){var J=z.id.cf;z.id.cf.indexA=J.indexB,z.id.cf.indexB=J.indexA,z.id.cf.typeA=J.typeB,z.id.cf.typeB=J.typeA}++L}}t.pointCount=L}}}}),{setters:[function(t){j=t},function(t){N=t},function(t){E=t}],execute:function(){y=new N.b2Vec2,b=new N.b2Vec2,V=new N.b2Vec2,v=new N.b2Vec2,x=new N.b2Vec2,C=new N.b2Vec2,O=new N.b2Vec2,X=E.b2ClipVertex.MakeArray(2),U=E.b2ClipVertex.MakeArray(2),W=E.b2ClipVertex.MakeArray(2),Z=[0],H=[0],Q=new N.b2Vec2,Y=new N.b2Vec2,K=new N.b2Vec2,$=new N.b2Vec2,tt=new N.b2Vec2,et=new N.b2Vec2,it=new N.b2Vec2,ot=new N.b2Vec2}}}),System.register("Dynamics/Contacts/b2PolygonContact",["Collision/b2CollidePolygon","Dynamics/Contacts/b2Contact"],function(t,e){var s,i,o;e&&e.id;return{setters:[function(t){s=t},function(t){i=t}],execute:function(){o=function(n){function e(){return n.call(this)||this}return __extends(e,n),e.Create=function(t){return new e},e.Destroy=function(t,e){},e.prototype.Reset=function(t,e,i,o){n.prototype.Reset.call(this,t,e,i,o)},e.prototype.Evaluate=function(t,e,i){var o=this.m_fixtureA.GetShape(),n=this.m_fixtureB.GetShape();s.b2CollidePolygons(t,o,e,n,i)},e}(i.b2Contact),t("b2PolygonContact",o)}}}),System.register("Dynamics/Contacts/b2PolygonAndCircleContact",["Collision/b2CollideCircle","Dynamics/Contacts/b2Contact"],function(t,e){var s,i,o;e&&e.id;return{setters:[function(t){s=t},function(t){i=t}],execute:function(){o=function(n){function e(){return n.call(this)||this}return __extends(e,n),e.Create=function(t){return new e},e.Destroy=function(t,e){},e.prototype.Reset=function(t,e,i,o){n.prototype.Reset.call(this,t,e,i,o)},e.prototype.Evaluate=function(t,e,i){var o=this.m_fixtureA.GetShape(),n=this.m_fixtureB.GetShape();s.b2CollidePolygonAndCircle(t,o,e,n,i)},e}(i.b2Contact),t("b2PolygonAndCircleContact",o)}}}),System.register("Collision/b2CollideEdge",["Common/b2Settings","Common/b2Math","Collision/b2Collision"],function(t,e){var R,F,i,T,w,M,P,I,D,G,L,k,o,n,s,r,a,m,c;e&&e.id;return t("b2CollideEdgeAndCircle",function(t,e,i,o,n){t.pointCount=0;var s=F.b2Transform.MulTXV(i,F.b2Transform.MulXV(n,o.m_p,F.b2Vec2.s_t0),w),r=e.m_vertex1,a=e.m_vertex2,m=F.b2Vec2.SubVV(a,r,M),c=F.b2Vec2.DotVV(m,F.b2Vec2.SubVV(a,s,F.b2Vec2.s_t0)),_=F.b2Vec2.DotVV(m,F.b2Vec2.SubVV(s,r,F.b2Vec2.s_t0)),l=e.m_radius+o.m_radius,h=k;if(h.cf.indexB=0,_<=(h.cf.typeB=0)){var u=r,p=F.b2Vec2.SubVV(s,u,P);if(l*l<F.b2Vec2.DotVV(p,p))return;if(e.m_hasVertex0){var f=e.m_vertex0,d=r,y=F.b2Vec2.SubVV(d,f,I);if(0<F.b2Vec2.DotVV(y,F.b2Vec2.SubVV(d,s,F.b2Vec2.s_t0)))return}return h.cf.indexA=0,h.cf.typeA=0,t.pointCount=1,t.type=0,t.localNormal.SetZero(),t.localPoint.Copy(u),t.points[0].id.Copy(h),void t.points[0].localPoint.Copy(o.m_p)}if(c<=0){var b=a,V=F.b2Vec2.SubVV(s,b,P);if(l*l<F.b2Vec2.DotVV(V,V))return;if(e.m_hasVertex3){var v=e.m_vertex3,x=a,C=F.b2Vec2.SubVV(v,x,D);if(0<F.b2Vec2.DotVV(C,F.b2Vec2.SubVV(s,x,F.b2Vec2.s_t0)))return}return h.cf.indexA=1,h.cf.typeA=0,t.pointCount=1,t.type=0,t.localNormal.SetZero(),t.localPoint.Copy(b),t.points[0].id.Copy(h),void t.points[0].localPoint.Copy(o.m_p)}var S=F.b2Vec2.DotVV(m,m),B=G;B.x=1/S*(c*r.x+_*a.x),B.y=1/S*(c*r.y+_*a.y);var A=F.b2Vec2.SubVV(s,B,P);if(!(l*l<F.b2Vec2.DotVV(A,A))){var g=L.Set(-m.y,m.x);F.b2Vec2.DotVV(g,F.b2Vec2.SubVV(s,r,F.b2Vec2.s_t0))<0&&g.Set(-g.x,-g.y),g.Normalize(),h.cf.indexA=0,h.cf.typeA=1,t.pointCount=1,t.type=1,t.localNormal.Copy(g),t.localPoint.Copy(r),t.points[0].id.Copy(h),t.points[0].localPoint.Copy(o.m_p)}}),t("b2CollideEdgeAndPolygon",function(t,e,i,o,n){c.Collide(t,e,i,o,n)}),{setters:[function(t){R=t},function(t){F=t},function(t){T=i=t}],execute:function(){var t,e;w=new F.b2Vec2,M=new F.b2Vec2,P=new F.b2Vec2,I=new F.b2Vec2,D=new F.b2Vec2,G=new F.b2Vec2,L=new F.b2Vec2,k=new i.b2ContactID,(t=o||(o={}))[t.e_unknown=0]="e_unknown",t[t.e_edgeA=1]="e_edgeA",t[t.e_edgeB=2]="e_edgeB",n=function(){this.type=0,this.index=0,this.separation=0},s=function(){this.vertices=F.b2Vec2.MakeArray(R.b2_maxPolygonVertices),this.normals=F.b2Vec2.MakeArray(R.b2_maxPolygonVertices),this.count=0},r=function(){this.i1=0,this.i2=0,this.v1=new F.b2Vec2,this.v2=new F.b2Vec2,this.normal=new F.b2Vec2,this.sideNormal1=new F.b2Vec2,this.sideOffset1=0,this.sideNormal2=new F.b2Vec2,this.sideOffset2=0},(e=a||(a={}))[e.e_isolated=0]="e_isolated",e[e.e_concave=1]="e_concave",e[e.e_convex=2]="e_convex",m=function(){function G(){this.m_polygonB=new s,this.m_xf=new F.b2Transform,this.m_centroidB=new F.b2Vec2,this.m_v0=new F.b2Vec2,this.m_v1=new F.b2Vec2,this.m_v2=new F.b2Vec2,this.m_v3=new F.b2Vec2,this.m_normal0=new F.b2Vec2,this.m_normal1=new F.b2Vec2,this.m_normal2=new F.b2Vec2,this.m_normal=new F.b2Vec2,this.m_type1=0,this.m_type2=0,this.m_lowerLimit=new F.b2Vec2,this.m_upperLimit=new F.b2Vec2,this.m_radius=0,this.m_front=!1}return G.prototype.Collide=function(t,e,i,o,n){F.b2Transform.MulTXX(i,n,this.m_xf),F.b2Transform.MulXV(this.m_xf,o.m_centroid,this.m_centroidB),this.m_v0.Copy(e.m_vertex0),this.m_v1.Copy(e.m_vertex1),this.m_v2.Copy(e.m_vertex2),this.m_v3.Copy(e.m_vertex3);var s=e.m_hasVertex0,r=e.m_hasVertex3,a=F.b2Vec2.SubVV(this.m_v2,this.m_v1,G.s_edge1);a.Normalize(),this.m_normal1.Set(a.y,-a.x);var m=F.b2Vec2.DotVV(this.m_normal1,F.b2Vec2.SubVV(this.m_centroidB,this.m_v1,F.b2Vec2.s_t0)),c=0,_=0,l=!1,h=!1;if(s){var u=F.b2Vec2.SubVV(this.m_v1,this.m_v0,G.s_edge0);u.Normalize(),this.m_normal0.Set(u.y,-u.x),l=0<=F.b2Vec2.CrossVV(u,a),c=F.b2Vec2.DotVV(this.m_normal0,F.b2Vec2.SubVV(this.m_centroidB,this.m_v0,F.b2Vec2.s_t0))}if(r){var p=F.b2Vec2.SubVV(this.m_v3,this.m_v2,G.s_edge2);p.Normalize(),this.m_normal2.Set(p.y,-p.x),h=0<F.b2Vec2.CrossVV(a,p),_=F.b2Vec2.DotVV(this.m_normal2,F.b2Vec2.SubVV(this.m_centroidB,this.m_v2,F.b2Vec2.s_t0))}s&&r?l&&h?(this.m_front=0<=c||0<=m||0<=_,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal0),this.m_upperLimit.Copy(this.m_normal2)):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal1).SelfNeg(),this.m_upperLimit.Copy(this.m_normal1).SelfNeg())):l?(this.m_front=0<=c||0<=m&&0<=_,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal0),this.m_upperLimit.Copy(this.m_normal1)):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal2).SelfNeg(),this.m_upperLimit.Copy(this.m_normal1).SelfNeg())):h?(this.m_front=0<=_||0<=c&&0<=m,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal1),this.m_upperLimit.Copy(this.m_normal2)):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal1).SelfNeg(),this.m_upperLimit.Copy(this.m_normal0).SelfNeg())):(this.m_front=0<=c&&0<=m&&0<=_,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal1),this.m_upperLimit.Copy(this.m_normal1)):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal2).SelfNeg(),this.m_upperLimit.Copy(this.m_normal0).SelfNeg())):s?l?(this.m_front=0<=c||0<=m,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal0)):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal1)),this.m_upperLimit.Copy(this.m_normal1).SelfNeg()):(this.m_front=0<=c&&0<=m,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal1),this.m_upperLimit.Copy(this.m_normal1).SelfNeg()):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal1),this.m_upperLimit.Copy(this.m_normal0).SelfNeg())):r?h?(this.m_front=0<=m||0<=_,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal1).SelfNeg(),this.m_upperLimit.Copy(this.m_normal2)):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal1).SelfNeg(),this.m_upperLimit.Copy(this.m_normal1))):(this.m_front=0<=m&&0<=_,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal1).SelfNeg()):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal2).SelfNeg()),this.m_upperLimit.Copy(this.m_normal1)):(this.m_front=0<=m,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal1).SelfNeg(),this.m_upperLimit.Copy(this.m_normal1).SelfNeg()):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal1),this.m_upperLimit.Copy(this.m_normal1))),this.m_polygonB.count=o.m_count;for(var f=0;f<o.m_count;++f)F.b2Transform.MulXV(this.m_xf,o.m_vertices[f],this.m_polygonB.vertices[f]),F.b2Rot.MulRV(this.m_xf.q,o.m_normals[f],this.m_polygonB.normals[f]);this.m_radius=2*R.b2_polygonRadius,t.pointCount=0;var d=this.ComputeEdgeSeparation(G.s_edgeAxis);if(0!==d.type&&!(d.separation>this.m_radius)){var y=this.ComputePolygonSeparation(G.s_polygonAxis);if(!(0!==y.type&&y.separation>this.m_radius)){var b;b=0===y.type?d:y.separation>.98*d.separation+.001?y:d;var V=G.s_ie,v=G.s_rf;if(1===b.type){t.type=1;var x=0,C=F.b2Vec2.DotVV(this.m_normal,this.m_polygonB.normals[0]);for(f=1;f<this.m_polygonB.count;++f){var S=F.b2Vec2.DotVV(this.m_normal,this.m_polygonB.normals[f]);S<C&&(C=S,x=f)}var B=x,A=(B+1)%this.m_polygonB.count;(g=V[0]).v.Copy(this.m_polygonB.vertices[B]),g.id.cf.indexA=0,g.id.cf.indexB=B,g.id.cf.typeA=1,g.id.cf.typeB=0,(w=V[1]).v.Copy(this.m_polygonB.vertices[A]),w.id.cf.indexA=0,w.id.cf.indexB=A,w.id.cf.typeA=1,w.id.cf.typeB=0,this.m_front?(v.i1=0,v.i2=1,v.v1.Copy(this.m_v1),v.v2.Copy(this.m_v2),v.normal.Copy(this.m_normal1)):(v.i1=1,v.i2=0,v.v1.Copy(this.m_v2),v.v2.Copy(this.m_v1),v.normal.Copy(this.m_normal1).SelfNeg())}else{var g,w;t.type=2,(g=V[0]).v.Copy(this.m_v1),g.id.cf.indexA=0,g.id.cf.indexB=b.index,g.id.cf.typeA=0,(w=V[g.id.cf.typeB=1]).v.Copy(this.m_v2),w.id.cf.indexA=0,w.id.cf.indexB=b.index,w.id.cf.typeA=0,w.id.cf.typeB=1,v.i1=b.index,v.i2=(v.i1+1)%this.m_polygonB.count,v.v1.Copy(this.m_polygonB.vertices[v.i1]),v.v2.Copy(this.m_polygonB.vertices[v.i2]),v.normal.Copy(this.m_polygonB.normals[v.i1])}v.sideNormal1.Set(v.normal.y,-v.normal.x),v.sideNormal2.Copy(v.sideNormal1).SelfNeg(),v.sideOffset1=F.b2Vec2.DotVV(v.sideNormal1,v.v1),v.sideOffset2=F.b2Vec2.DotVV(v.sideNormal2,v.v2);var M=G.s_clipPoints1,P=G.s_clipPoints2;if(!(T.b2ClipSegmentToLine(M,V,v.sideNormal1,v.sideOffset1,v.i1)<R.b2_maxManifoldPoints||T.b2ClipSegmentToLine(P,M,v.sideNormal2,v.sideOffset2,v.i2)<R.b2_maxManifoldPoints)){1===b.type?(t.localNormal.Copy(v.normal),t.localPoint.Copy(v.v1)):(t.localNormal.Copy(o.m_normals[v.i1]),t.localPoint.Copy(o.m_vertices[v.i1]));var I=0;for(f=0;f<R.b2_maxManifoldPoints;++f){if(F.b2Vec2.DotVV(v.normal,F.b2Vec2.SubVV(P[f].v,v.v1,F.b2Vec2.s_t0))<=this.m_radius){var D=t.points[I];1===b.type?(F.b2Transform.MulTXV(this.m_xf,P[f].v,D.localPoint),D.id=P[f].id):(D.localPoint.Copy(P[f].v),D.id.cf.typeA=P[f].id.cf.typeB,D.id.cf.typeB=P[f].id.cf.typeA,D.id.cf.indexA=P[f].id.cf.indexB,D.id.cf.indexB=P[f].id.cf.indexA),++I}}t.pointCount=I}}}},G.prototype.ComputeEdgeSeparation=function(t){var e=t;e.type=1,e.index=this.m_front?0:1,e.separation=R.b2_maxFloat;for(var i=0;i<this.m_polygonB.count;++i){var o=F.b2Vec2.DotVV(this.m_normal,F.b2Vec2.SubVV(this.m_polygonB.vertices[i],this.m_v1,F.b2Vec2.s_t0));o<e.separation&&(e.separation=o)}return e},G.prototype.ComputePolygonSeparation=function(t){var e=t;e.type=0,e.index=-1,e.separation=-R.b2_maxFloat;for(var i=G.s_perp.Set(-this.m_normal.y,this.m_normal.x),o=0;o<this.m_polygonB.count;++o){var n=F.b2Vec2.NegV(this.m_polygonB.normals[o],G.s_n),s=F.b2Vec2.DotVV(n,F.b2Vec2.SubVV(this.m_polygonB.vertices[o],this.m_v1,F.b2Vec2.s_t0)),r=F.b2Vec2.DotVV(n,F.b2Vec2.SubVV(this.m_polygonB.vertices[o],this.m_v2,F.b2Vec2.s_t0)),a=F.b2Min(s,r);if(a>this.m_radius)return e.type=2,e.index=o,e.separation=a,e;if(0<=F.b2Vec2.DotVV(n,i)){if(F.b2Vec2.DotVV(F.b2Vec2.SubVV(n,this.m_upperLimit,F.b2Vec2.s_t0),this.m_normal)<-R.b2_angularSlop)continue}else if(F.b2Vec2.DotVV(F.b2Vec2.SubVV(n,this.m_lowerLimit,F.b2Vec2.s_t0),this.m_normal)<-R.b2_angularSlop)continue;a>e.separation&&(e.type=2,e.index=o,e.separation=a)}return e},G.s_edge1=new F.b2Vec2,G.s_edge0=new F.b2Vec2,G.s_edge2=new F.b2Vec2,G.s_ie=T.b2ClipVertex.MakeArray(2),G.s_rf=new r,G.s_clipPoints1=T.b2ClipVertex.MakeArray(2),G.s_clipPoints2=T.b2ClipVertex.MakeArray(2),G.s_edgeAxis=new n,G.s_polygonAxis=new n,G.s_n=new F.b2Vec2,G.s_perp=new F.b2Vec2,G}(),c=new m}}}),System.register("Dynamics/Contacts/b2EdgeAndCircleContact",["Collision/b2CollideEdge","Dynamics/Contacts/b2Contact"],function(t,e){var s,i,o;e&&e.id;return{setters:[function(t){s=t},function(t){i=t}],execute:function(){o=function(n){function e(){return n.call(this)||this}return __extends(e,n),e.Create=function(t){return new e},e.Destroy=function(t,e){},e.prototype.Reset=function(t,e,i,o){n.prototype.Reset.call(this,t,e,i,o)},e.prototype.Evaluate=function(t,e,i){var o=this.m_fixtureA.GetShape(),n=this.m_fixtureB.GetShape();s.b2CollideEdgeAndCircle(t,o,e,n,i)},e}(i.b2Contact),t("b2EdgeAndCircleContact",o)}}}),System.register("Dynamics/Contacts/b2EdgeAndPolygonContact",["Collision/b2CollideEdge","Dynamics/Contacts/b2Contact"],function(t,e){var s,i,o;e&&e.id;return{setters:[function(t){s=t},function(t){i=t}],execute:function(){o=function(n){function e(){return n.call(this)||this}return __extends(e,n),e.Create=function(t){return new e},e.Destroy=function(t,e){},e.prototype.Reset=function(t,e,i,o){n.prototype.Reset.call(this,t,e,i,o)},e.prototype.Evaluate=function(t,e,i){var o=this.m_fixtureA.GetShape(),n=this.m_fixtureB.GetShape();s.b2CollideEdgeAndPolygon(t,o,e,n,i)},e}(i.b2Contact),t("b2EdgeAndPolygonContact",o)}}}),System.register("Dynamics/Contacts/b2ChainAndCircleContact",["Collision/b2CollideEdge","Collision/Shapes/b2EdgeShape","Dynamics/Contacts/b2Contact"],function(t,e){var a,i,o,n;e&&e.id;return{setters:[function(t){a=t},function(t){i=t},function(t){o=t}],execute:function(){n=function(n){function r(){return n.call(this)||this}return __extends(r,n),r.Create=function(t){return new r},r.Destroy=function(t,e){},r.prototype.Reset=function(t,e,i,o){n.prototype.Reset.call(this,t,e,i,o)},r.prototype.Evaluate=function(t,e,i){var o=this.m_fixtureA.GetShape(),n=this.m_fixtureB.GetShape(),s=r.Evaluate_s_edge;o.GetChildEdge(s,this.m_indexA),a.b2CollideEdgeAndCircle(t,s,e,n,i)},r.Evaluate_s_edge=new i.b2EdgeShape,r}(o.b2Contact),t("b2ChainAndCircleContact",n)}}}),System.register("Dynamics/Contacts/b2ChainAndPolygonContact",["Collision/b2CollideEdge","Collision/Shapes/b2EdgeShape","Dynamics/Contacts/b2Contact"],function(t,e){var a,i,o,n;e&&e.id;return{setters:[function(t){a=t},function(t){i=t},function(t){o=t}],execute:function(){n=function(n){function r(){return n.call(this)||this}return __extends(r,n),r.Create=function(t){return new r},r.Destroy=function(t,e){},r.prototype.Reset=function(t,e,i,o){n.prototype.Reset.call(this,t,e,i,o)},r.prototype.Evaluate=function(t,e,i){var o=this.m_fixtureA.GetShape(),n=this.m_fixtureB.GetShape(),s=r.Evaluate_s_edge;o.GetChildEdge(s,this.m_indexA),a.b2CollideEdgeAndPolygon(t,s,e,n,i)},r.Evaluate_s_edge=new i.b2EdgeShape,r}(o.b2Contact),t("b2ChainAndPolygonContact",n)}}}),System.register("Dynamics/Contacts/b2ContactFactory",["Common/b2Settings","Dynamics/Contacts/b2CircleContact","Dynamics/Contacts/b2PolygonContact","Dynamics/Contacts/b2PolygonAndCircleContact","Dynamics/Contacts/b2EdgeAndCircleContact","Dynamics/Contacts/b2EdgeAndPolygonContact","Dynamics/Contacts/b2ChainAndCircleContact","Dynamics/Contacts/b2ChainAndPolygonContact"],function(t,e){var m,i,o,n,s,r,a,c,_,l;e&&e.id;return{setters:[function(t){m=t},function(t){i=t},function(t){o=t},function(t){n=t},function(t){s=t},function(t){r=t},function(t){a=t},function(t){c=t}],execute:function(){t("b2ContactRegister",_=function(){this.pool=null,this.createFcn=null,this.destroyFcn=null,this.primary=!1}),l=function(){function t(t){this.m_allocator=null,this.m_allocator=t,this.InitializeRegisters()}return t.prototype.AddType=function(e,t,i,o){var n=this,s=m.b2MakeArray(256,function(t){return e(n.m_allocator)});function r(t){return 0<s.length?s.pop():e(t)}function a(t,e){s.push(t)}this.m_registers[i][o].pool=s,this.m_registers[i][o].createFcn=r,this.m_registers[i][o].destroyFcn=a,this.m_registers[i][o].primary=!0,i!==o&&(this.m_registers[o][i].pool=s,this.m_registers[o][i].createFcn=r,this.m_registers[o][i].destroyFcn=a,this.m_registers[o][i].primary=!1)},t.prototype.InitializeRegisters=function(){this.m_registers=[];for(var t=0;t<4;t++){this.m_registers[t]=[];for(var e=0;e<4;e++)this.m_registers[t][e]=new _}this.AddType(i.b2CircleContact.Create,i.b2CircleContact.Destroy,0,0),this.AddType(n.b2PolygonAndCircleContact.Create,n.b2PolygonAndCircleContact.Destroy,2,0),this.AddType(o.b2PolygonContact.Create,o.b2PolygonContact.Destroy,2,2),this.AddType(s.b2EdgeAndCircleContact.Create,s.b2EdgeAndCircleContact.Destroy,1,0),this.AddType(r.b2EdgeAndPolygonContact.Create,r.b2EdgeAndPolygonContact.Destroy,1,2),this.AddType(a.b2ChainAndCircleContact.Create,a.b2ChainAndCircleContact.Destroy,3,0),this.AddType(c.b2ChainAndPolygonContact.Create,c.b2ChainAndPolygonContact.Destroy,3,2)},t.prototype.Create=function(t,e,i,o){var n=t.GetType(),s=i.GetType(),r=this.m_registers[n][s],a=r.createFcn(this.m_allocator);return r.primary?a.Reset(t,e,i,o):a.Reset(i,o,t,e),a},t.prototype.Destroy=function(t){var e=t.m_fixtureA,i=t.m_fixtureB;0<t.m_manifold.pointCount&&!e.IsSensor()&&!i.IsSensor()&&(e.GetBody().SetAwake(!0),i.GetBody().SetAwake(!0));var o=e.GetType(),n=i.GetType();this.m_registers[o][n].destroyFcn(t,this.m_allocator)},t}(),t("b2ContactFactory",l)}}}),System.register("Dynamics/b2ContactManager",["Collision/b2BroadPhase","Dynamics/Contacts/b2ContactFactory","Dynamics/b2WorldCallbacks"],function(t,e){var i,o,n,s;e&&e.id;return{setters:[function(t){i=t},function(t){o=t},function(t){n=t}],execute:function(){s=function(){function t(){this.m_broadPhase=new i.b2BroadPhase,this.m_contactList=null,this.m_contactCount=0,this.m_contactFilter=n.b2ContactFilter.b2_defaultFilter,this.m_contactListener=n.b2ContactListener.b2_defaultListener,this.m_allocator=null,this.m_contactFactory=null,this.m_contactFactory=new o.b2ContactFactory(this.m_allocator)}return t.prototype.AddPair=function(t,e){var i=t,o=e,n=i.fixture,s=o.fixture,r=i.childIndex,a=o.childIndex,m=n.GetBody(),c=s.GetBody();if(m!==c){for(var _=c.GetContactList();_;){if(_.other===m){var l=_.contact.GetFixtureA(),h=_.contact.GetFixtureB(),u=_.contact.GetChildIndexA(),p=_.contact.GetChildIndexB();if(l===n&&h===s&&u===r&&p===a)return;if(l===s&&h===n&&u===a&&p===r)return}_=_.next}if(!this.m_contactFilter||this.m_contactFilter.ShouldCollide(n,s)){var f=this.m_contactFactory.Create(n,r,s,a);null!==f&&(n=f.GetFixtureA(),s=f.GetFixtureB(),r=f.GetChildIndexA(),a=f.GetChildIndexB(),m=n.m_body,c=s.m_body,f.m_prev=null,f.m_next=this.m_contactList,null!==this.m_contactList&&(this.m_contactList.m_prev=f),((this.m_contactList=f).m_nodeA.contact=f).m_nodeA.other=c,f.m_nodeA.prev=null,f.m_nodeA.next=m.m_contactList,null!==m.m_contactList&&(m.m_contactList.prev=f.m_nodeA),m.m_contactList=f.m_nodeA,(f.m_nodeB.contact=f).m_nodeB.other=m,f.m_nodeB.prev=null,f.m_nodeB.next=c.m_contactList,null!==c.m_contactList&&(c.m_contactList.prev=f.m_nodeB),c.m_contactList=f.m_nodeB,n.IsSensor()||s.IsSensor()||(m.SetAwake(!0),c.SetAwake(!0)),++this.m_contactCount)}}},t.prototype.FindNewContacts=function(){this.m_broadPhase.UpdatePairs(this)},t.prototype.Destroy=function(t){var e=t.GetFixtureA(),i=t.GetFixtureB(),o=e.GetBody(),n=i.GetBody();this.m_contactListener&&t.IsTouching()&&this.m_contactListener.EndContact(t),t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),t===this.m_contactList&&(this.m_contactList=t.m_next),t.m_nodeA.prev&&(t.m_nodeA.prev.next=t.m_nodeA.next),t.m_nodeA.next&&(t.m_nodeA.next.prev=t.m_nodeA.prev),t.m_nodeA===o.m_contactList&&(o.m_contactList=t.m_nodeA.next),t.m_nodeB.prev&&(t.m_nodeB.prev.next=t.m_nodeB.next),t.m_nodeB.next&&(t.m_nodeB.next.prev=t.m_nodeB.prev),t.m_nodeB===n.m_contactList&&(n.m_contactList=t.m_nodeB.next),this.m_contactFactory.Destroy(t),--this.m_contactCount},t.prototype.Collide=function(){for(var t=this.m_contactList;t;){var e=t.GetFixtureA(),i=t.GetFixtureB(),o=t.GetChildIndexA(),n=t.GetChildIndexB(),s=e.GetBody(),r=i.GetBody();if(t.m_filterFlag){if(this.m_contactFilter&&!this.m_contactFilter.ShouldCollide(e,i)){t=(c=t).m_next,this.Destroy(c);continue}t.m_filterFlag=!1}var a=s.IsAwake()&&0!==s.m_type,m=r.IsAwake()&&0!==r.m_type;if(a||m){var c,_=e.m_proxies[o].proxy,l=i.m_proxies[n].proxy;if(this.m_broadPhase.TestOverlap(_,l))t.Update(this.m_contactListener),t=t.m_next;else t=(c=t).m_next,this.Destroy(c)}else t=t.m_next}},t}(),t("b2ContactManager",s)}}}),System.register("Collision/b2BroadPhase",["Collision/b2Collision","Collision/b2DynamicTree"],function(t,e){var n,i,c,o;e&&e.id;function _(t,e){return t.proxyA.m_id===e.proxyA.m_id?t.proxyB.m_id-e.proxyB.m_id:t.proxyA.m_id-e.proxyA.m_id}return t("b2PairLessThan",_),{setters:[function(t){n=t},function(t){i=t}],execute:function(){t("b2Pair",c=function(){this.proxyA=null,this.proxyB=null}),o=function(){function t(){this.m_tree=new i.b2DynamicTree,this.m_proxyCount=0,this.m_moveCount=0,this.m_moveBuffer=[],this.m_pairCount=0,this.m_pairBuffer=[]}return t.prototype.CreateProxy=function(t,e){var i=this.m_tree.CreateProxy(t,e);return++this.m_proxyCount,this.BufferMove(i),i},t.prototype.DestroyProxy=function(t){this.UnBufferMove(t),--this.m_proxyCount,this.m_tree.DestroyProxy(t)},t.prototype.MoveProxy=function(t,e,i){this.m_tree.MoveProxy(t,e,i)&&this.BufferMove(t)},t.prototype.TouchProxy=function(t){this.BufferMove(t)},t.prototype.GetFatAABB=function(t){return this.m_tree.GetFatAABB(t)},t.prototype.GetUserData=function(t){return this.m_tree.GetUserData(t)},t.prototype.TestOverlap=function(t,e){var i=this.m_tree.GetFatAABB(t),o=this.m_tree.GetFatAABB(e);return n.b2TestOverlapAABB(i,o)},t.prototype.GetProxyCount=function(){return this.m_proxyCount},t.prototype.UpdatePairs=function(t){this.m_pairCount=0;for(var e=function(t){var i=n.m_moveBuffer[t];if(null===i)return"continue";var o=n,e=n.m_tree.GetFatAABB(i);n.m_tree.Query(function(t){if(t.m_id===i.m_id)return!0;o.m_pairCount===o.m_pairBuffer.length&&(o.m_pairBuffer[o.m_pairCount]=new c);var e=o.m_pairBuffer[o.m_pairCount];return t.m_id<i.m_id?(e.proxyA=t,e.proxyB=i):(e.proxyA=i,e.proxyB=t),++o.m_pairCount,!0},e)},n=this,i=0;i<this.m_moveCount;++i)e(i);this.m_moveCount=0,this.m_pairBuffer.length=this.m_pairCount,this.m_pairBuffer.sort(_);for(var o=0;o<this.m_pairCount;){var s=this.m_pairBuffer[o],r=this.m_tree.GetUserData(s.proxyA),a=this.m_tree.GetUserData(s.proxyB);for(t.AddPair(r,a),++o;o<this.m_pairCount;){var m=this.m_pairBuffer[o];if(m.proxyA.m_id!==s.proxyA.m_id||m.proxyB.m_id!==s.proxyB.m_id)break;++o}}},t.prototype.Query=function(t,e){this.m_tree.Query(t,e)},t.prototype.RayCast=function(t,e){this.m_tree.RayCast(t,e)},t.prototype.GetTreeHeight=function(){return this.m_tree.GetHeight()},t.prototype.GetTreeBalance=function(){return this.m_tree.GetMaxBalance()},t.prototype.GetTreeQuality=function(){return this.m_tree.GetAreaRatio()},t.prototype.ShiftOrigin=function(t){this.m_tree.ShiftOrigin(t)},t.prototype.BufferMove=function(t){this.m_moveBuffer[this.m_moveCount]=t,++this.m_moveCount},t.prototype.UnBufferMove=function(t){var e=this.m_moveBuffer.indexOf(t);this.m_moveBuffer[e]=null},t}(),t("b2BroadPhase",o)}}}),System.register("Rope/b2Rope",["Common/b2Settings","Common/b2Math","Common/b2Draw"],function(t,e){var B,A,o,i;e&&e.id;return{setters:[function(t){B=t},function(t){A=t},function(t){o=t}],execute:function(){t("b2RopeDef",function(){this.vertices=[],this.count=0,this.masses=[],this.gravity=new A.b2Vec2(0,0),this.damping=.1,this.k2=.9,this.k3=.1}),i=function(){function S(){this.m_count=0,this.m_ps=null,this.m_p0s=null,this.m_vs=null,this.m_ims=null,this.m_Ls=null,this.m_as=null,this.m_gravity=new A.b2Vec2,this.m_damping=0,this.m_k2=1,this.m_k3=.1}return S.prototype.GetVertexCount=function(){return this.m_count},S.prototype.GetVertices=function(){return this.m_ps},S.prototype.Initialize=function(t){this.m_count=t.count,this.m_ps=A.b2Vec2.MakeArray(this.m_count),this.m_p0s=A.b2Vec2.MakeArray(this.m_count),this.m_vs=A.b2Vec2.MakeArray(this.m_count),this.m_ims=B.b2MakeNumberArray(this.m_count);for(var e=0;e<this.m_count;++e){this.m_ps[e].Copy(t.vertices[e]),this.m_p0s[e].Copy(t.vertices[e]),this.m_vs[e].SetZero();var i=t.masses[e];this.m_ims[e]=0<i?1/i:0}var o=this.m_count-1,n=this.m_count-2;this.m_Ls=B.b2MakeNumberArray(o),this.m_as=B.b2MakeNumberArray(n);for(e=0;e<o;++e){var s=this.m_ps[e],r=this.m_ps[e+1];this.m_Ls[e]=A.b2Vec2.DistanceVV(s,r)}for(e=0;e<n;++e){s=this.m_ps[e],r=this.m_ps[e+1];var a=this.m_ps[e+2],m=A.b2Vec2.SubVV(r,s,A.b2Vec2.s_t0),c=A.b2Vec2.SubVV(a,r,A.b2Vec2.s_t1),_=A.b2Vec2.CrossVV(m,c),l=A.b2Vec2.DotVV(m,c);this.m_as[e]=A.b2Atan2(_,l)}this.m_gravity.Copy(t.gravity),this.m_damping=t.damping,this.m_k2=t.k2,this.m_k3=t.k3},S.prototype.Step=function(t,e){if(0!==t){for(var i=Math.exp(-t*this.m_damping),o=0;o<this.m_count;++o)this.m_p0s[o].Copy(this.m_ps[o]),0<this.m_ims[o]&&this.m_vs[o].SelfMulAdd(t,this.m_gravity),this.m_vs[o].SelfMul(i),this.m_ps[o].SelfMulAdd(t,this.m_vs[o]);for(o=0;o<e;++o)this.SolveC2(),this.SolveC3(),this.SolveC2();var n=1/t;for(o=0;o<this.m_count;++o)A.b2Vec2.MulSV(n,A.b2Vec2.SubVV(this.m_ps[o],this.m_p0s[o],A.b2Vec2.s_t0),this.m_vs[o])}},S.prototype.SolveC2=function(){for(var t=this.m_count-1,e=0;e<t;++e){var i=this.m_ps[e],o=this.m_ps[e+1],n=A.b2Vec2.SubVV(o,i,S.s_d),s=n.Normalize(),r=this.m_ims[e],a=this.m_ims[e+1];if(r+a!==0){var m=r/(r+a),c=a/(r+a);i.SelfMulSub(this.m_k2*m*(this.m_Ls[e]-s),n),o.SelfMulAdd(this.m_k2*c*(this.m_Ls[e]-s),n)}}},S.prototype.SetAngle=function(t){for(var e=this.m_count-2,i=0;i<e;++i)this.m_as[i]=t},S.prototype.SolveC3=function(){for(var t=this.m_count-2,e=0;e<t;++e){var i=this.m_ps[e],o=this.m_ps[e+1],n=this.m_ps[e+2],s=this.m_ims[e],r=this.m_ims[e+1],a=this.m_ims[e+2],m=A.b2Vec2.SubVV(o,i,S.s_d1),c=A.b2Vec2.SubVV(n,o,S.s_d2),_=m.LengthSquared(),l=c.LengthSquared();if(_*l!=0){var h=A.b2Vec2.CrossVV(m,c),u=A.b2Vec2.DotVV(m,c),p=A.b2Atan2(h,u),f=A.b2Vec2.MulSV(-1/_,m.SelfSkew(),S.s_Jd1),d=A.b2Vec2.MulSV(1/l,c.SelfSkew(),S.s_Jd2),y=A.b2Vec2.NegV(f,S.s_J1),b=A.b2Vec2.SubVV(f,d,S.s_J2),V=d,v=s*A.b2Vec2.DotVV(y,y)+r*A.b2Vec2.DotVV(b,b)+a*A.b2Vec2.DotVV(V,V);if(0!==v){v=1/v;for(var x=p-this.m_as[e];x>B.b2_pi;)x=(p-=2*B.b2_pi)-this.m_as[e];for(;x<-B.b2_pi;)x=(p+=2*B.b2_pi)-this.m_as[e];var C=-this.m_k3*v*x;i.SelfMulAdd(s*C,y),o.SelfMulAdd(r*C,b),n.SelfMulAdd(a*C,V)}}}},S.prototype.Draw=function(t){for(var e=new o.b2Color(.4,.5,.7),i=0;i<this.m_count-1;++i)t.DrawSegment(this.m_ps[i],this.m_ps[i+1],e)},S.s_d=new A.b2Vec2,S.s_d1=new A.b2Vec2,S.s_d2=new A.b2Vec2,S.s_Jd1=new A.b2Vec2,S.s_Jd2=new A.b2Vec2,S.s_J1=new A.b2Vec2,S.s_J2=new A.b2Vec2,S}(),t("b2Rope",i)}}}),System.register("Box2D",["Common/b2Settings","Common/b2Math","Common/b2Draw","Common/b2Timer","Common/b2GrowableStack","Common/b2BlockAllocator","Common/b2StackAllocator","Collision/b2Collision","Collision/b2Distance","Collision/b2BroadPhase","Collision/b2DynamicTree","Collision/b2TimeOfImpact","Collision/b2CollideCircle","Collision/b2CollidePolygon","Collision/b2CollideEdge","Collision/Shapes/b2Shape","Collision/Shapes/b2CircleShape","Collision/Shapes/b2PolygonShape","Collision/Shapes/b2EdgeShape","Collision/Shapes/b2ChainShape","Dynamics/b2Fixture","Dynamics/b2Body","Dynamics/b2World","Dynamics/b2WorldCallbacks","Dynamics/b2Island","Dynamics/b2TimeStep","Dynamics/b2ContactManager","Dynamics/Contacts/b2Contact","Dynamics/Contacts/b2ContactFactory","Dynamics/Contacts/b2ContactSolver","Dynamics/Contacts/b2CircleContact","Dynamics/Contacts/b2PolygonContact","Dynamics/Contacts/b2PolygonAndCircleContact","Dynamics/Contacts/b2EdgeAndCircleContact","Dynamics/Contacts/b2EdgeAndPolygonContact","Dynamics/Contacts/b2ChainAndCircleContact","Dynamics/Contacts/b2ChainAndPolygonContact","Dynamics/Joints/b2Joint","Dynamics/Joints/b2JointFactory","Dynamics/Joints/b2AreaJoint","Dynamics/Joints/b2DistanceJoint","Dynamics/Joints/b2FrictionJoint","Dynamics/Joints/b2GearJoint","Dynamics/Joints/b2MotorJoint","Dynamics/Joints/b2MouseJoint","Dynamics/Joints/b2PrismaticJoint","Dynamics/Joints/b2PulleyJoint","Dynamics/Joints/b2RevoluteJoint","Dynamics/Joints/b2RopeJoint","Dynamics/Joints/b2WeldJoint","Dynamics/Joints/b2WheelJoint","Particle/b2Particle","Particle/b2ParticleGroup","Particle/b2ParticleSystem","Rope/b2Rope"],function(o,t){t&&t.id;function e(t){var e={};for(var i in t)"default"!==i&&(e[i]=t[i]);o(e)}return{setters:[function(t){e(t)},function(t){e(t)},function(t){e(t)},function(t){e(t)},function(t){e(t)},function(t){e(t)},function(t){e(t)},function(t){e(t)},function(t){e(t)},function(t){e(t)},function(t){e(t)},function(t){e(t)},function(t){e(t)},function(t){e(t)},function(t){e(t)},function(t){e(t)},function(t){e(t)},function(t){e(t)},function(t){e(t)},function(t){e(t)},function(t){e(t)},function(t){e(t)},function(t){e(t)},function(t){e(t)},function(t){e(t)},function(t){e(t)},function(t){e(t)},function(t){e(t)},function(t){e(t)},function(t){e(t)},function(t){e(t)},function(t){e(t)},function(t){e(t)},function(t){e(t)},function(t){e(t)},function(t){e(t)},function(t){e(t)},function(t){e(t)},function(t){e(t)},function(t){e(t)},function(t){e(t)},function(t){e(t)},function(t){e(t)},function(t){e(t)},function(t){e(t)},function(t){e(t)},function(t){e(t)},function(t){e(t)},function(t){e(t)},function(t){e(t)},function(t){e(t)},function(t){e(t)},function(t){e(t)},function(t){e(t)},function(t){e(t)}],execute:function(){}}});